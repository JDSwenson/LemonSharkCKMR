---
title: "Data_analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
```

```{r read-in-files, include=FALSE}
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(plotly)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")
purpose.combo <- "Examine model sensitivity to imprecision in life history traits" #What am I comparing right now? This will be used to name output files


#----------------Read in files ------------------------------
#------------- MCMC parameters ----------------#
ni <- 40000 # number of post-burn-in samples per chain
nb <- 50000 # number of burn-in samples
nt <- 20     # thinning rate
nc <- 2      # number of chains
MCMC.settings <- paste0("thin", nt, "_draw", ni, "_burn", nb)

#Initialize values
purpose1.lab = purpose2.lab = purpose3.lab = purpose4.lab <- NULL

#------------- Simulation parameters and labels  ----------------#
date.of.simulation1 <- "05Jul2022"
purpose1 <- "Obj3.1_target.YOY_1"
purpose1.lab <- "Target YOY 1"
model.type1 <- "HS.only"

date.of.simulation2 <- "05Jul2022"
purpose2 <- "Obj3.1_target.YOY_2"
purpose2.lab <- "Target YOY 2"
model.type2 <- "HS.only"

date.of.simulation3 <- "14Jun2022"
purpose3 <- "test.fixed.lambda_target.YOY"
purpose3.lab <- "Target YOY | Fixed lambda"
model.type3 <- "HS.only"

date.of.simulation4 <- "14Jun2022"
purpose4 <- "test.fixed.lambda_sample.all.ages"
purpose4.lab <- "All ages sampled | Fixed lambda"
model.type4 <- "HS.only"

seeds <- "Seeds2022.04.15"
sim.samples <- "1prop.sampled" #Label on file output
samples.lab <- "1 percent sampled" #Label for dataframe and figures


MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.3_life_history_sensitivity/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.3_life_history_sensitivity/Model.results/"
results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.3_life_history_sensitivity/Model.results/figures/"
results_prefix <- "CKMR_results"
MCMC_prefix <- "CKMR_modelout"
parents_prefix <- "parents_breakdown/CKMR_parents.breakdown"
sample.prefix <- "sample_info/CKMR_sample.info"
survival.prefix <- "survival/CKMR_survival"
pop.size.prefix <- "pop_size/CKMR_pop.size"
mom.comps.prefix <- "comparisons/mom.comps"
dad.comps.prefix <- "comparisons/dad.comps"


#Set results to NULL and the script will run regardless of how many actual results are being compared
results.1 = results.2 = results.3 = results.4 <- NULL

results.1 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation1, "_", seeds, "_", purpose1, ".csv")) %>% 
  mutate(model_type = model.type1, 
         purpose.lab = purpose1.lab)

results.2 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation2, "_", seeds, "_", purpose2, ".csv")) %>% 
  mutate(model_type = model.type2,
         purpose.lab = purpose2.lab)


results.3 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation3, "_", seeds, "_", purpose3, ".csv")) %>% 
  mutate(model_type = model.type3,
         purpose.lab = purpose3.lab) %>% 
      mutate(total_samples = total_juvenile_samples + total_adult_samples)

results.4 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation4, "_", seeds, "_", purpose4, ".csv")) %>% 
    mutate(model_type = model.type4,
           purpose.lab = purpose4.lab) %>% 
      mutate(total_samples = total_juvenile_samples + total_adult_samples)
#------------------------------- MCMC output -----------------------------------#
#date.of.simulation <- "07Apr2022"
#Trial 1
# s1.1 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation1, "_", seeds, "_", sim.samples.1, "_", MCMC.settings, "_", purpose1))
# 
# s1.2 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation1, "_", seeds, "_", sim.samples.2, "_", MCMC.settings, "_", purpose1))
# 
# s1.3 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation1, "_", seeds, "_", sim.samples.3, "_", MCMC.settings, "_", purpose1))
# 
# s1.4 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation1, "_", seeds, "_", sim.samples.4, "_", MCMC.settings, "_", purpose1))
# 
# #Trial 2
# s2.1 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation2, "_", seeds, "_", sim.samples.1, "_", MCMC.settings, "_", purpose2))
# 
# s2.2 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation2, "_", seeds, "_", sim.samples.2, "_", MCMC.settings, "_", purpose2))
# 
# s2.3 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation2, "_", seeds, "_", sim.samples.3, "_", MCMC.settings, "_", purpose2))
# 
# s2.4 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation2, "_", seeds, "_", sim.samples.4, "_", MCMC.settings, "_", purpose2))
# 
# #Trial 3
# #date.of.simulation <- "05Apr2022"
# s3.1 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation3, "_", seeds, "_", sim.samples.1, "_", MCMC.settings, "_", purpose3))
# 
# s3.2 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation3, "_", seeds, "_", sim.samples.2, "_", MCMC.settings, "_", purpose3))
# 
# s3.3 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation3, "_", seeds, "_", sim.samples.3, "_", MCMC.settings, "_", purpose3))
# 
# s3.4 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation3, "_", seeds, "_", sim.samples.4, "_", MCMC.settings, "_", purpose3))
# 
# #Trial 4
#  s4.1 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation4, "_", seeds, "_", sim.samples.1, "_", MCMC.settings, "_", purpose4))
# 
#  s4.2 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation4, "_", seeds, "_", sim.samples.2, "_", MCMC.settings, "_", purpose4))
# 
#  s4.3 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation4, "_", seeds, "_", sim.samples.3, "_", MCMC.settings, "_", purpose4))
#  
#   s4.4 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation4, "_", seeds, "_", sim.samples.4, "_", MCMC.settings, "_", purpose4))

#------------------------------- Population size details -----------------------------------#
#date.of.simulation <- "07Apr2022"
# pop.size.1 <- readRDS(paste0(results_location, pop.size.prefix, "_", date.of.simulation1, "_", seeds, "_", purpose1))
# 
# pop.size.2 <- readRDS(paste0(results_location, pop.size.prefix, "_", date.of.simulation2, "_", seeds, "_", purpose2))
# 
# pop.size.3 <- readRDS(paste0(results_location, pop.size.prefix, "_", date.of.simulation3, "_", seeds, "_", purpose3))
# 
# pop.size.4 <- readRDS(paste0(results_location, pop.size.prefix, "_", date.of.simulation4, "_", seeds, "_", purpose4))
# 
# #------------------------------ Pairwise comparison matrices -------------------------------#
# #Mom
# mom.comps.1 <- readRDS(paste0(results_location, mom.comps.prefix, "_", date.of.simulation1, "_", seeds, "_", purpose1))
# 
# mom.comps.2 <- readRDS(paste0(results_location, mom.comps.prefix, "_", date.of.simulation2, "_", seeds, "_", purpose2))
# 
# mom.comps.3 <- readRDS(paste0(results_location, mom.comps.prefix, "_", date.of.simulation3, "_", seeds, "_", purpose3))
# 
# mom.comps.4 <- readRDS(paste0(results_location, mom.comps.prefix, "_", date.of.simulation4, "_", seeds, "_", purpose4))
# 
# #Dad
# dad.comps.1 <- readRDS(paste0(results_location, dad.comps.prefix, "_", date.of.simulation1, "_", seeds, "_", purpose1))
# 
# dad.comps.2 <- readRDS(paste0(results_location, dad.comps.prefix, "_", date.of.simulation2, "_", seeds, "_", purpose2))
# 
# dad.comps.3 <- readRDS(paste0(results_location, dad.comps.prefix, "_", date.of.simulation3, "_", seeds, "_", purpose3))
# 
# dad.comps.4 <- readRDS(paste0(results_location, dad.comps.prefix, "_", date.of.simulation4, "_", seeds, "_", purpose4))

```

```{r Quick analysis of results}
####------------------------------- Quick analysis of results -----------------------------------####

results.all <- results.1 %>% 
  bind_rows(results.2, results.3, results.4) %>% 
     mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1)) %>% #Can change truth to breed.truth if looking for number of active breeders
     mutate(in_interval = ifelse(HPD2.5 < all.truth & all.truth < HPD97.5, "Y", "N")) %>% 
  mutate(cv = (sd/mean)*100)

results.all$samples.lab <- factor(results.all$samples.lab, levels = c(samples1.lab, samples2.lab, samples3.lab, samples4.lab))
results.all %>% dplyr::filter(is.na(samples.lab == TRUE)) #Should not be any

results.all$purpose.lab <- factor(results.all$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))
results.all %>% dplyr::filter(is.na(purpose.lab == TRUE)) #Should not be any
#Specify parameters
#jags_params <- c("Nfa", "Nfb", "Nm", "surv", "lam", "psi", "pb") #if estimating all parameters with the HS|PO model
jags_params <- c("Nf", "psi", "Nm", "surv", "lam") #If estimating all parameters with the HS only model

head(results.all)


#View instances where the model failed to converge
results.all %>% dplyr::filter(Rhat > 1.01) %>% nrow()

results.all.filt <- results.all %>% dplyr::filter(Rhat < 1.01)

```



```{r surface plots}
#To make a surface plot of relative bias, I'd need to have relative bias as the axes, and probability as the values in the cells

plot_ly(x = results.all.filt$juvenile.survival.cv, y = results.all.filt$adult.survival.cv, z = as.numeric(results.all.filt$adult.fecundity.cv)) %>% add_surface()

```

```{r Density plots}
results.all.filt %>% group_by(parameter, juvenile.survival.cv, adult.survival.cv, adult.fecundity.cv, purpose) %>% 
  summarize(median(relative_bias)) %>% 
  View()

#Density plots
(p2.Nfb <- results.all.filt %>% dplyr::filter(parameter == "Nfb") %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("C) Nf") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-100, 100) + 
    facet_wrap(~samples.lab))

(p2.Nm <- results.all %>% dplyr::filter(parameter == "Nm") %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("D) Nm") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Set1") +
  xlim(-100, 100) + 
  facet_wrap(~samples.lab))

(p2.surv <- results.all %>% dplyr::filter(parameter == "surv") %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("B) Survival") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Set1") +
  xlim(-25, 25) + 
  facet_wrap(~samples.lab))


(p2.psi <- results.all %>% dplyr::filter(parameter == "psi") %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("Percent biennial breeders (psi)") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-100, 100) + 
    facet_wrap(~samples.lab))


(p2.lam <- results.all %>% dplyr::filter(parameter == "lam") %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("Lambda") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-10, 10) + 
    facet_wrap(~samples.lab))



# (p2.Nfa <- results.all %>% dplyr::filter(parameter == "Nfa") %>% 
#     ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
#     geom_density(alpha = 0.6) + 
#     ggtitle("Nf - total") + 
#     labs(x = "Relative bias of posterior median") +
#     geom_vline(xintercept=c(0), linetype="dotted") +
#     theme_bw() + 
#     theme(legend.title = element_blank()) + 
#     scale_fill_brewer(palette = "Set1") +
#     xlim(-100, 100) + 
#     facet_wrap(~samples.lab))
# 
# 
# (p2.pb <- results.all %>% dplyr::filter(parameter == "pb") %>% 
#     ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
#     geom_density(alpha = 0.6) + 
#     ggtitle("Percent breeders") + 
#     labs(x = "Relative bias of posterior median") +
#     geom_vline(xintercept=c(0), linetype="dotted") +
#     theme_bw() + 
#     theme(legend.title = element_blank()) + 
#     scale_fill_brewer(palette = "Set1") +
#     xlim(-100, 100) + 
#     facet_wrap(~samples.lab))

RelBias.Density.Plots.N <- ggarrange(p2.Nfb, p2.Nm, common.legend = TRUE, legend = "none")
#Save plots so I can load them quickly later
Density.plot.list <- list(p2.Nfb, p2.psi, p2.Nm, p2.surv, p2.lam)
#Save the plots as a list, so I can load them later and plot with ggarrange/annotate_figure
saveRDS(Density.plot.list, file = paste0(results_plots_location, "plot_lists/", purpose.combo, "_Relative_bias_density_plots"))
```

```{r print figures}
#Male and female HPDI and relative bias for low and high sample sizes
ggarrange(p.Nfb, p.Nm, p2.Nfb, p2.Nm, common.legend = TRUE, nrow = 2, ncol = 2, legend = "bottom")

#Survival HPDI and relative bias for all four sample sizes
ggarrange(p.surv, p2.surv, common.legend = TRUE, nrow = 2, legend = "bottom")

#annotate_figure(p = HPDI.plots.N, fig.lab = "A)", fig.lab.pos = "top.left", fig.lab.size = 18, fig.lab.face = "bold")
```


```{r Plot-kin-pairs, echo=FALSE}
####---------------------Density plots of kin detected----------------------------------------------####

###ADD POPs to each graph
(Nfb_HSPs <- results.all %>% dplyr::filter(parameter == "Nfb",
                                           purpose.lab == purpose1.lab | purpose.lab == purpose3.lab) %>% 
  ggplot(aes(x = HSPs_detected, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("Maternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    facet_wrap(~samples.lab)) + 
  scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250))


(Nm_HSPs <- results.all %>% dplyr::filter(parameter == "Nm",
                                          purpose.lab == purpose1.lab | purpose.lab == purpose3.lab) %>% 
  ggplot(aes(x = HSPs_detected, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("Paternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    facet_wrap(~samples.lab)) + 
    scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250))


#---------------------Prepare data for plotting----------------------------------------------#
#Format PO dataframe
results.PO <- results.all %>% dplyr::select(parameter, total_samples, kin.detected = POPs_detected,  unique_parents_in_sample, iteration, cv, purpose = purpose2) %>% 
  mutate(type = "PO")

#Format HS dataframe
results.HS <- results.all %>% dplyr::select(parameter, total_samples, kin.detected = HSPs_detected,  unique_parents_in_sample, iteration, cv, purpose = purpose2) %>% 
  mutate(type = "HS")

#Combine PO and HS dataframe for plotting
results.kin <- rbind(results.PO, results.HS) %>% 
  mutate(total_samples = paste0(total_samples, " samples"))

results.kin$total_samples <- factor(results.kin$total_samples, levels = c("200 samples", "600 samples", "1000 samples"))
results.kin$purpose <- factor(results.kin$purpose, levels = c("Down sampled", "All samples"))

#---------------------Create density plots----------------------------------------------#
#Maternal
k1 <- results.kin %>% dplyr::filter(parameter == "Nf", type == "PO") %>%
  ggplot(aes(x = kin.detected, color = purpose, fill = purpose)) + 
  geom_density(alpha = 0.6) + 
  ggtitle(label = "MOPs detected") + 
  xlim(0, 60) + 
  facet_wrap(~total_samples, ncol = 1) + 
  theme(legend.title = element_blank())

k2 <- results.kin %>% dplyr::filter(parameter == "Nf", type == "HS") %>%
  ggplot(aes(x = kin.detected, color = purpose, fill = purpose)) + 
  geom_density(alpha = 0.6) + 
  ggtitle(label = "Maternal HSPs detected") + 
  xlim(0, 500) + 
  facet_wrap(~total_samples, ncol = 1) + 
  theme(legend.title = element_blank())

m.kin <- ggarrange(k1, k2, ncol = 2, common.legend = TRUE)
annotate_figure(m.kin, fig.lab = "Mother kin pairs", fig.lab.pos = "top.left", fig.lab.size = 18, fig.lab.face = "bold")



#Paternal
k3 <- results.kin %>% dplyr::filter(parameter == "Nm", type == "PO") %>%
  ggplot(aes(x = kin.detected, color = purpose, fill = purpose)) + 
  geom_density(alpha = 0.6) + 
  ggtitle(label = "FOPs detected") + 
  xlim(0, 60) + 
  facet_wrap(~total_samples, ncol = 1) + 
  theme(legend.title = element_blank())

k4 <- results.kin %>% dplyr::filter(parameter == "Nm", type == "HS") %>%
  ggplot(aes(x = kin.detected, color = purpose, fill = purpose)) + 
  geom_density(alpha = 0.6) + 
  ggtitle(label = "FHSPs detected") + 
  xlim(0, 500) + 
  facet_wrap(~total_samples, ncol = 1)

f.kin <- ggarrange(k3, k4, ncol = 2, common.legend = TRUE)
annotate_figure(f.kin, fig.lab = "Father kin pairs", fig.lab.pos = "top.left", fig.lab.size = 18, fig.lab.face = "bold")

#---------------------Create pdf of kin pair density plots----------------------------------------------#
#Specify file
KinPairs.file <- paste0(results_plots_location, "Distribution_of_kin_", today, "_", purpose.combo, ".pdf")
pdf(file = KinPairs.file, width = 11, height = 14) #Open pdf

annotate_figure(m.kin, fig.lab = "Mother kin pairs", fig.lab.pos = "top.left", fig.lab.size = 18, fig.lab.face = "bold")
annotate_figure(f.kin, fig.lab = "Father kin pairs", fig.lab.pos = "top.left", fig.lab.size = 18, fig.lab.face = "bold")

dev.off() #close pdf





#-----------------------Examine expected vs observed kin pairs--------------------
#Make better labels for plotting
results.all$sample.label <- factor(paste0(results.all$total_samples, " samples"), levels = c("200 samples", "600 samples", "1000 samples"))

#Calcualte % difference in expected vs observed kin
results.all2 <- results.all %>% mutate(HS_exp_obs_diff = (Exp_HSPs - HSPs_detected)/Exp_HSPs,
                                      PO_exp_obs_diff = (Exp_POPs - POPs_detected)/Exp_POPs) %>%
  mutate(PO_exp_obs_diff = replace_na(PO_exp_obs_diff, 0)) %>% 
  mutate(all_exp_obs_diff = HS_exp_obs_diff + PO_exp_obs_diff)


# results.all %>% mutate(HS_exp_obs_diff = Exp_HSPs - HSPs_detected,
#                        PO_exp_obs_diff = Exp_POPs - POPs_detected) %>%
#   mutate(all_exp_obs_diff = HS_exp_obs_diff + PO_exp_obs_diff) %>% 
#   dplyr::select(purpose,
#                 parameter, 
#                 Q50, 
#                 truth, 
#                 Exp_POPs, 
#                 POPs_detected, 
#                 PO_exp_obs_diff, 
#                 Exp_HSPs, 
#                 HSPs_detected, 
#                 HS_exp_obs_diff, 
#                 total_samples, 
#                 relative_bias, 
#                 in_interval) %>% 
#   View()

#----------------Make scatter plot of expected vs observed 
#Purpose 1
(EO1 <- results.all2 %>% dplyr::filter(purpose.lab == purpose1.lab,
                                       parameter == "Nfb" | parameter == "Nm") %>% 
  ggplot(aes(x = HS_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = purpose1.lab, x = "Percent difference", y = "Relative bias") + 
  theme(legend.title = element_blank()))

#Purpose 2
(EO2 <- results.all2 %>% dplyr::filter(purpose.lab == purpose2.lab,
                                       parameter == "Nfb" | parameter == "Nm") %>% 
  ggplot(aes(x = all_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = purpose2.lab, x = "Percent difference", y = "Relative bias"))

#Purpose 3
(EO3 <- results.all2 %>% dplyr::filter(purpose.lab == purpose3.lab,
                                        parameter == "Nfb" | parameter == "Nm") %>% 
  ggplot(aes(x = all_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(x = "Percent difference", y = "Relative bias"))

#Purpose 4
(EO4 <- results.all2 %>% dplyr::filter(purpose.lab == purpose4.lab,
                                        parameter == "Nfb" | parameter == "Nm") %>% 
  ggplot(aes(x = all_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = purpose4.lab, x = "Percent difference", y = "Relative bias"))


(EO.all <- ggarrange(EO1, EO2, EO3, EO4, common.legend = TRUE, legend = "bottom"))
annotate_figure(EO.all, fig.lab = "Relative bias by percent difference in expected vs observed kin pairs", fig.lab.pos = "top.left", fig.lab.size = 14, fig.lab.face = "bold")
```

```{r troubleshooting results}
results.1.troubleshoot <- results.all %>% dplyr::filter(purpose.lab == purpose1.lab,
                              in_interval == "N") %>% 
  mutate(direction = ifelse(HPD2.5 > truth, "high", "low")) 

results.1.troubleshoot %>%
  group_by(parameter, direction) %>% 
  summarize(n())

ts.iterations <- results.1.troubleshoot %>% group_by(iteration) %>% 
  summarize(num = n()) %>% 
  dplyr::filter(num > 1) %>% 
  pull(iteration)
  



results.1.ts <- results.all %>% dplyr::filter(purpose.lab == purpose1.lab,
                                              iteration %in% ts.iterations) %>% 
    mutate(HPDI.direction = ifelse(HPD2.5 > truth, "high",
                                   ifelse(HPD97.5 < truth, "low", "in.interval"))) %>% 
    mutate(bias.direction = ifelse(relative_bias < 0, "low",
                                   ifelse(relative_bias > 0, "high", "perfect")))

#Isolate iterations that are especially wonky  
results.1.ts %>% group_by(iteration, HPDI.direction) %>% 
  summarize(number = n()) %>% 
  dplyr::filter(HPDI.direction != "in.interval",
                number > 5)


results.1.ts %>% dplyr::filter(iteration == 88 | iteration == 173) %>% 
  View()

mom.comps.1

results.1.ts %>% dplyr::filter(parameter == "Nfb") %>% 
  summarize(mean(Q50))

results.1.ts %>% dplyr::filter(parameter == "psi") %>% 
  summarize(mean(Q50))


testing <- results2 %>% dplyr::filter(total_juvenile_samples == 570 | total_juvenile_samples == 632, parameter == "Nfb" | parameter == "psi" | parameter == "surv" | parameter == "Nm")

testing %>% dplyr::arrange(iteration, parameter) %>% 
  dplyr::select(parameter,
                Q2.5,
                Q50,
                Q97.5,
                sd,
                HPD2.5,
                mean,
                HPD97.5,
                truth,
                Exp_HSPs,
                HSPs_detected,
                prop_sampled_juvs,
                iteration,
                relative_bias,
                pop) %>%
  View()

dad_comps <- readRDS("~/R/working_directory/temp_results/comparisons/dad.comps_04May2022_Seeds2022.04.15_Troubleshoot")

mom_comps <- readRDS("~/R/working_directory/temp_results/comparisons/mom.comps_04May2022_Seeds2022.04.15_Troubleshoot")


dad_comps %>% group_by(iteration, mort.yrs, pop.growth.yrs) %>%
  summarize(total.yes = sum(yes), total.all = sum(all)) %>% 
  summarize(sum.yes = sum(total.yes), sum.all = sum(total.all)) %>% 
  mutate(percent.yes= (sum.yes/sum.all)*100)


mom_comps %>% group_by(iteration, mort.yrs, pop.growth.yrs) %>%
  summarize(total.yes = sum(yes), total.all = sum(all)) %>% 
  summarize(sum.yes = sum(total.yes), sum.all = sum(total.all)) %>% 
  mutate(percent.yes= (sum.yes/sum.all)*100)
```