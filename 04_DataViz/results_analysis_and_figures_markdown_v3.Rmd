---
title: "CKMR results 07/21/2022"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 3
    fig_caption: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(scales)
library(ggridges)
library(ggpattern)
library(ggalt)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/"
```



```{r set-file-locations and read in files, include = FALSE}
#------------- Simulation parameters and labels  ----------------#
results.files <- list.files(path = paste0(results_location),
                            recursive = FALSE,
                            pattern = "*.csv",
                            full.names = TRUE)

results.raw <- map_dfr(results.files, read_csv, guess_max = 30000) %>%  #Have to specify guess_max or else the function will guess column type using the first 1,000 columns and assume the POP columns are logical (bc the first several thousand are NA)
  dplyr::select(-c(HSPs_expected, POPs_expected)) #remove columns containing "expected" values for HSPs and POPs (they come from a vestigial function in the simulation scripts)

naive_scenarios <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4", "scenario_3.1.1", "scenario_3.2.1", "scenario_3.3.1", "scenario_3.4.1", "scenario_3.5.1", "scenario_3.6.1", "scenario_3.7.1") #Note that scenario 3.7.1 is not technically "naive" (bc the population simulation was all annual breeders). However we will label it as such in the code, and this label will be used later when we label it as an annual model in graphs for Objective 3.

objective1 <- c("scenario_1_model.validation", "scenario_1.2.1", "scenario_1.2.2", "scenario_1.2.3")
objective2 <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4", "scenario_2.2.1", "scenario_2.2.2", "scenario_2.3.3", "scenario_2.2.4", "scenario_2.4.1", "scenario_2.4.2", "scenario_2.4.3", "scenario_2.4.4")
objective3 <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2", "scenario_3.5.1", "scenario_3.5.2", "scenario_3.6.1", "scenario_3.6.2", "scenario_3.7.1", "scenario_3.7.2")
objective4 <- c("scenario_4.1", "scenario_4.2", "scenario_4.3", "scenario_4.4", "scenario_4.5", "scenario_4.6")

#Add labels for naive and adapted; CHANGE Nft and Nmt to Nf and Nm for consistency across scenarios
results.raw <- results.raw %>% mutate(model = ifelse(scenario %in% naive_scenarios, "naive", "adapted")) %>% 
  mutate(objective = ifelse(scenario %in% objective1, "objective1", 
                            ifelse(scenario %in% objective2, "objective2",
                                   ifelse(scenario %in% objective3, "objective3", 
                                          ifelse(scenario %in% objective4, "objective4", NA))))) %>% 
  mutate(parameter = ifelse(parameter == "Nft", "Nf",
                            ifelse(parameter == "Nmt", "Nm", parameter))) %>% 
      mutate(iterID = paste0(sampling.scheme, "_", estimation.sim, "_", sample.prop, "_", scenario, "_", iteration))


```

Columns in the results.raw dataframe are:
parameter: self-explanatory
estimation.sim: year in which abundance is estimated, standardized (in a way) so we can compare across sampling schemes
Q50: median parameter estimate from JAGS
all.truth: true parameter value from the population simulation
HPD2.5: 2.5% highest posterior density interval
HPD97.5: 97.5% highest posterior density interval
T0: the first year of data for the specified simulation - varies broadly with sampling scheme, and occasionally within sampling schemes with each set of samples
estimation.year: the specific year in which abundance is being estimated
sampling.scheme: sampling scheme employed
iteration: iteration index
full.siblings: number of full siblings identified
diff.cohort_full.siblings: number of full siblings from different cohorts
imposters: number of aunt|uncle / niece|nephew pairs masquerading as full siblings
mean: mean of posterior distribution
sd: standard deviation of posterior distribution
Q2.5: 2.5th quantile
Q97.5: 97.5th quantile
Rhat: Rhat convergence diagnostic
neff: number of effective samples from the posterior distribution
sample.prop: proportion of the population sampled
seed: seed used for every set.seed call in the simulation
HSPs_detected: number of half-sibling pairs detected
POPs_detected: number of parent-offspring pairs detected - only relevant for the sample.ALL.ages simulations
scenario: scenario corresponds to the metadata in the Simulation_log_key.xlsx file and is used to set simulation settings in the specify.simulation.R script
relative_bias: relative bias, calculated using the median (Q50) of the posterior distribution and the true value in all.truth.
in_interval: is the truth in the 95% HPDI?
model: "naive" or "adapted"
objective: objective addressed by running the simulation 




```{r double-check columns and look for NAs, include = FALSE}
colnames(results.raw)

#Check to make sure we have an appropriate number of simulations and minimal NAs
results.raw %>% dplyr::count(sampling.scheme)
results.raw %>% dplyr::count(estimation.year)
results.raw %>% dplyr::count(sample.prop)
results.raw %>% dplyr::count(estimation.sim)
results.raw %>% dplyr::count(parameter)
results.raw %>% dplyr::count(is.na(relative_bias))
#results.raw %>% dplyr::count(scenario) %>% View()
results.raw %>% dplyr::filter(objective == "objective1") %>% 
  dplyr::count(estimation.sim)
results.raw %>% dplyr::count(scenario)
results.raw %>% dplyr::count(objective)
results.raw %>% dplyr::count(iteration) %>% 
  dplyr::filter(iteration == 1 | iteration == 500)
#results.raw %>% dplyr::count(seed) %>% View()

#Total number of individual simulations run
#Note that some of the simulations for objective 2 gave rise to duplicate estimates in year 0: one that was labeled as e.g., "Nf0" and one that was labeled as "Nft". These estimates are the same, and downstream steps filter to only include one (so there's no double-counting)
results.raw %>% dplyr::filter(parameter == "Nf") %>% dplyr::count(sampling.scheme, estimation.sim, sample.prop, scenario) %>% 
  summarize(sum(n))

#Count number of times the model failed to converge
results.raw %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(scenario) %>% 
  arrange(desc(n))

#Total percent of failed sims
results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  summarize(percent.failed = sum(failed)/((sum(failed) + sum(passed)))*100)
  

#Scenario-specific failure rates
results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  mutate(percent_failed = (failed/(failed+passed))*100) %>% 
  arrange(desc(percent_failed))

#What percent of convergence failures come from scenario2.3? This is the scenario with the diffuse prior on lambda
results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  mutate(percent_failed = (failed/(failed+passed))*100) %>% 
  arrange(desc(percent_failed)) %>% 
  summarize(total.failed = sum(failed),
            scenario2.3.failed = sum(failed[scenario %in% c("scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4")])) %>% 
  summarize(percent.failed.from.scenario2.3 = scenario2.3.failed/total.failed)

#Filter out instances that failed to converge
#What percentage of parameter estimates failed to converge (is multiplied by 100)
results.raw %>% dplyr::filter(Rhat > 1.01) %>%
  dplyr::count(sampling.scheme, estimation.sim, sample.prop, scenario) %>% 
  summarize((sum(n)/nrow(results.raw))*100)

#Save iterations that failed to converge
convergence_failures.df <- results.raw %>% dplyr::filter(Rhat > 1.01) %>% 
  distinct(sampling.scheme, estimation.sim, sample.prop, scenario, iteration) %>% 
  mutate(iterID = paste0(sampling.scheme, "_", estimation.sim, "_", sample.prop, "_", scenario, "_", iteration))

#Remove iterations that failed to converge (confirmed this removes all parameter estimates from the iteration)
results <- results.raw %>% anti_join(convergence_failures.df, by = "iterID")
```


```{r check summary statistics}
results %>% dplyr::count(parameter)

results %>% group_by(parameter, scenario, sampling.scheme, estimation.sim) %>% 
  summarize(median.relative.bias = median(relative_bias)) %>% 
  dplyr::filter(parameter %in% c("Nf", "Nm", "survival")) %>% 
  print(n = 50)

#check out median relative bias by parameter, model, and estimation.sim for Nm and Nf
results %>% dplyr::filter(parameter %in% c("Nft", "Nmt")) %>%
  group_by(parameter, model, estimation.sim, objective) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))

results %>% dplyr::filter(parameter %in% c("Nf", "Nm")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(percent.in.interval = (sum(in_interval == "Y")/n())*100) %>% 
  arrange(desc(percent.in.interval))

#check out median relative bias by parameter, model, and estimation.sim for survival and lambda
results %>% dplyr::filter(parameter %in% c("survival", "lambda")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))

results %>% dplyr::filter(parameter %in% c("survival", "lambda")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(percent.in.interval = (sum(in_interval == "Y")/n())*100) %>% 
  arrange(desc(percent.in.interval))

```


Format data for model validation (objective 1).
```{r Obj1 data format and analysis, echo=FALSE, out.width = "120%"}
colnames(results)
results %>% dplyr::count(sample.prop)

#Add columns to dataframe that are better suited for plot labels
obj1_results <- results %>% dplyr::filter(objective == "objective1") %>% 
  mutate(sample.prop.lab = ifelse(sample.prop == 0.5, "0.5% sampled", 
                                  ifelse(sample.prop == 1, "1.0% sampled",
                                         ifelse(sample.prop == 1.5, "1.5% sampled", 
                                                ifelse(sample.prop == 2, "2.0% sampled", NA))))) %>% 
  mutate(cv = (sd/mean) * 100) %>% 
  mutate(aunt.label = ifelse(scenario == "scenario_1.2.2", "Include aunt/niece",
                             ifelse(scenario == "scenario_1.2.3", "Filter aunt/niece by age", "No aunt/niece"))) %>% 
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA))))

obj1_results %>% dplyr::group_by(sample.prop.lab, sampling.scheme.label, parameter) %>% 
  summarize(n())


obj1_results %>% dplyr::count(sample.prop)

#obj1_results %>% dplyr::count(imposters, scenario) %>% View()

obj1_results %>% group_by(scenario, sampling.scheme) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))





#-----------------------Prep samples-----------------------------
#Specify sample file and read in -- just use stable population growth for now. Age distribution of samples should be similar across the simulations.
sampFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/sample.info_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
samples.df_all <- readRDS(file = sampFile.stable)


#-----------------------Quick graph check to change as needed--------------------------
obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter == "survival") %>% 
  ggplot(aes(x = relative_bias,
             fill = sampling.scheme)) + 
  geom_density(alpha = 0.6) + 
  labs(x="Relative bias", y="Parameter") +
#  theme_ridges() + 
  facet_wrap(~sample.prop.lab) + 
  theme_bw() +
#  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(legend.position = "bottom")


#-------------------Calculate mean number of samples
samples.df_all %>% dplyr::filter(sampling.scheme == "sample.all.juvenile.ages", sample.prop == 1.5) %>% 
  dplyr::count(iteration) %>% 
  summarize(mean(n))

#------------------Check offspring per parent
rentFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/parents.breakdown_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
rents.df_all <- readRDS(file = rentFile.stable)

#How many fathers on average, min, and max
rents.df_all %>% dplyr::filter(parent.sex == "father") %>% 
  summarize(median = median(num.off),
            min = min(num.off),
            max = max(num.off))

```

```{r Obj 1 viz}
#Palette I want to use for Objective 1
brewer.pal.info #See different palette options from Rcolorbrewer
cp <- brewer.pal(3, "Set2") #Choose palette + number of colors
#scales::show_col(cp)

######################################################################################################### Objective 1 Main Figure ####################################################################################################################
#-------------------Objective 1 Density plot of relative bias-------------------------#
fig2.a <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = sampling.scheme.label)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Parameter") +
#  theme_ridges() + 
  facet_wrap(~sample.prop.lab) + 
  theme_bw() +
  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "none")
  
  
fig2.a


#-------------------Objective 1 Violin plot of CV-------------------------#
fig2.b <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme.label))) +
  geom_violin(aes(y=cv), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="CV") +
  theme_bw() +
  scale_fill_manual(values = cp) +
  #ggtitle("B)") +
  facet_wrap(~sample.prop.lab) +
  theme() +
  scale_y_log10() +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "none")

fig2.b


#-------------------Objective 1 Density plot of HSPs-------------------------#
breaks.2c = seq(50, 400, by = 50)
labels.2c <- sprintf("%.0f", breaks.2c)
labels.2c[c(1, 3, 5, 7)] <- ""

fig2.c <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
  ggplot(aes(x = HSPs_detected, fill = sampling.scheme.label)) +
    geom_density(alpha = 0.6) + 
#    ggtitle("C)") + 
    labs(x = "HSPs") +
    theme_bw() + 
    ylab("Density") +
    scale_fill_manual(values = cp) +
    scale_color_manual(values = cp) +
    facet_wrap(~sample.prop.lab, scales = "free_y") + 
  scale_x_continuous(breaks = breaks.2c,
                     labels = labels.2c) +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.001)) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom")
  
  
fig2.c

#-------------------Objective 1 Density plot of POPs-------------------------#
fig2.d <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
  ggplot(aes(x = POPs_detected, fill = sampling.scheme.label)) +
    geom_density(alpha = 0.6) + 
    #ggtitle("D)") + 
    labs(x = "POPs") +
    theme_bw() + 
#    theme(legend.title = element_blank(), #For ggarrange
#          axis.title.y = element_blank()) + 
    scale_fill_manual(values = cp) +
    scale_color_manual(values = cp) +
      ylab("Density") +
    facet_wrap(~sample.prop.lab, scales = "free_y") +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

#Old theme   
# theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size = 15),
#         strip.text.y = element_text(size = 15),
#         legend.text = element_text(size = 15),
#         plot.title = element_text(size=25),
#         legend.title = element_blank(),
#           legend.position = "bottom")

fig2.d

#-------------------Combine Obj1 plots and save-------------------------#
ggarrange(fig2.a, fig2.b, fig2.c, fig2.d, common.legend = TRUE, nrow = 2, ncol = 2, legend = "bottom") #OK to ignore warnings; the first two are values > the x axis limit in 1A); the 7998 missing values are from plotting POPs

ggsave("Figure_2ALL_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 500, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 5000, height = 3000, units = "px")


######################################################################################################### Objective 1 Supplementary Figure(s) ########################################################################################################

#-------------------Aunt|uncle / niece|nephew comparison-------------------------#
#-------------------Relative bias w and w/o aunt/niece
p_aunt.niece.bias <- obj1_results %>% dplyr::filter(aunt.label != "No aunt/niece",
                               parameter == "Nf" | parameter == "Nm",
                               sample.prop == 2) %>% 
  mutate(aunt.label = factor(aunt.label, levels = c("Include aunt/niece", "Filter aunt/niece by age"))) %>% 
  ggplot(aes(x = relative_bias,
             fill = aunt.label)) + 
  geom_density(alpha = 0.7) + 
  labs(x="Relative bias", y="Density") +
#  theme_ridges() + 
  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme.label)) + 
  theme_bw() +
  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 25),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25))


p_aunt.niece.bias

#-------------------Plot of numbers of aunt/niece pairs in dataset
bin.num <- obj1_results %>% summarize(max(imposters, na.rm = TRUE))

p_aunt.niece.count <- obj1_results %>% dplyr::filter(aunt.label != "No aunt/niece",
                               parameter == "Nf",
                               imposters > 0) %>% 
  mutate(aunt.label = factor(aunt.label, levels = c("Include aunt/niece", "Filter aunt/niece by age"))) %>% 
  ggplot(aes(x = imposters,
             fill = aunt.label)) + 
  geom_histogram(alpha = 0.7, color = "black", binwidth = 1) + 
  labs(x="Number of aunt/niece pairs", y="Iterations") +
  facet_grid(rows = vars(sample.prop.lab), cols = vars(sampling.scheme.label)) + 
  theme_bw() +
#  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 25),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25))
  
p_aunt.niece.count

#-------------------Combine aunt/niece plots and save-------------------------#
ggarrange(p_aunt.niece.count, p_aunt.niece.bias, common.legend = TRUE, nrow = 2, legend = "bottom", heights = c(2, 1))

ggsave("SuppFig_aunt.niece_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 15, height = 12)


#-------------------Table for aunt/niece comparisons
obj1_results %>% dplyr::filter(aunt.label != "No aunt/niece",
                               sample.prop == 2) %>% 
  group_by(sampling.scheme, aunt.label) %>% 
  summarize(median.relative.bias = median(relative_bias),
            mean.imposters = round(mean(imposters, na.rm = TRUE), 0)) %>% 
  writexl::write_xlsx(path = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/aunt.niece_table.xlsx")

#-------------------Plot of numbers of full sibs in dataset
cp.sibs <- brewer.pal(3, "Spectral") #Choose palette + number of colors

p.full.sibs <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1", parameter == "Nf") %>% 
  pivot_longer(cols = c(full.siblings, diff.cohort_full.siblings), names_to = "sib.years", values_to = "num.full.sibs") %>%
  ggplot(aes(fill = sib.years)) + 
  geom_histogram(aes(x = num.full.sibs), alpha = 0.7, color = "black", binwidth = 1, position = "identity") + 
  labs(x="Number of full siblings", y="Iterations") +
  facet_grid(rows = vars(sample.prop.lab), cols = vars(sampling.scheme.label)) + 
  theme_bw() +
#  xlim(-100, 100) +
  scale_fill_manual(values = cp.sibs[c(1, 3)], labels = c("different cohort", "all")) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_blank(),
        plot.title = element_text(size=25))


p.full.sibs

#This might help if need different cohort and all full sibs in long format
#  pivot_longer(cols = c(full.siblings, diff.cohort_full.siblings), names_to = "sib.years", values_to = "num.full.sibs") %>% 
  # ggplot(aes(x = num.full.sibs,
  #            y = sib.years,
  #            fill = sampling.scheme.label)) + 
  # geom_density_ridges(alpha = 0.6) +

ggsave("SuppFig2_FullSibs_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw", width = 3694, height = 2200, units = "px")
```


Format data for tests of population growth (Objective 2)
```{r Obj2 analysis and dataframe prep}
#Need to recalculate truth for naive scenarios -- truth from simulation output was averaged, and we want year-specific truths.
truth.location <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/Obj2.truth/" #Location of population simulation output files

#Read in popsize dataframes that contain year-specific truth
obj2truth.slight.decline <- readRDS(paste0(truth.location, "pop.size_03Aug2023_Seeds2022.04.15_lambda.slight.decrease_annual.breeding")) %>% 
  mutate(population.growth = "slight decline")

obj2truth.slight.increase <- readRDS(paste0(truth.location, "pop.size_03Aug2023_Seeds2022.04.15_lambda.slight.increase_annual.breeding")) %>% 
  mutate(population.growth = "slight increase")

obj2truth.severe.decline <- readRDS(paste0(truth.location, "pop.size_03Aug2023_Seeds2022.04.15_lambda.extreme_annual.breeding")) %>% 
  mutate(population.growth = "severe decline")

#Combine into one dataframe
truth.obj2 <- bind_rows(obj2truth.slight.decline, obj2truth.slight.increase, obj2truth.severe.decline) %>% 
  mutate(population.growth = factor(population.growth, levels = c("stable", "slight increase", "slight decline", "severe decline"))) %>% 
  mutate(estimation.year = year)

#Set up vectors of population growth scenarios
slight_decline_scenarios <- c("scenario_2.1.1", "scenario_2.2.1", "scenario_2.3.1", "scenario_2.4.1")
slight_increase_scenarios <- c("scenario_2.1.2", "scenario_2.2.2", "scenario_2.3.2", "scenario_2.4.2")
severe_decline_scenarios <- c("scenario_2.1.3", "scenario_2.2.3", "scenario_2.3.3", "scenario_2.4.3")
stable_popgrowth_scenarios <- c("scenario_2.1.4", "scenario_2.2.4", "scenario_2.3.4", "scenario_2.4.4")

#Specify Conn scenarios
conn_scenarios <- c("scenario_2.4.1", "scenario_2.4.2", "scenario_2.4.3", "scenario_2.4.4")

#Set up vectors of lambda prior scenarios
no_lambda_scenarios <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4")
narrow_lambda_scenarios <- c("scenario_2.2.1", "scenario_2.2.2", "scenario_2.2.3", "scenario_2.2.4", "scenario_2.4.1", "scenario_2.4.2", "scenario_2.4.4")
diffuse_lambda_scenarios <- c("scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4", "scenario_2.4.3")

#Format data and give labels that are more amenable to plotting. Pretty sure the "estimation.sim" column was wrongly tallied, so fix that here
obj2_results <- results %>% dplyr::filter(objective == "objective2") %>% 
  mutate(population.growth = ifelse(scenario %in% stable_popgrowth_scenarios, "stable",
                                    ifelse(scenario %in% slight_decline_scenarios, "slight decline",
                                           ifelse(scenario %in% slight_increase_scenarios, "slight increase",
                                                  ifelse(scenario %in% severe_decline_scenarios, "severe decline", NA))))) %>% 
  mutate(population.growth = factor(population.growth, levels = c("stable", "slight increase", "slight decline", "severe decline"))) %>%
  mutate(estimation.sim = ifelse(estimation.year == 90, "present",
                                       ifelse(estimation.year == 85, "present-5",
                                              ifelse(estimation.year == 78 | estimation.year == 67, "T0-10",
                                                     ifelse(estimation.year == 88 | estimation.year == 77, "T0", NA))))) %>% 
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
  mutate(method = ifelse(scenario %in% c("scenario_2.2.1", "scenario_2.2.2", "scenario_2.3.3", "scenario_2.2.4"), "vary N0",
                         ifelse(scenario %in% conn_scenarios, "vary Nt", "naive")))

#Note that there are half as many instances of stable population growth because the naive model isn't included.
#Need to pull out "Nf0" estimates from scenario 2.4.3 and save as Nf in year T0
Nft_T0_2.4.3 <- obj2_results %>% dplyr::filter(parameter == "Nf0", scenario == "scenario_2.4.3") %>% 
  group_by(parameter, estimation.sim, estimation.year, sampling.scheme, iteration) %>%
  dplyr::slice_sample(n = 1) %>% 
  ungroup() %>% 
  mutate(parameter = "Nf",
         estimation.sim = "T0")


obj2_results <- obj2_results %>% dplyr::filter(!parameter %in% c("Nf0", "Nm0")) %>% 
  bind_rows(Nft_T0_2.4.3) %>% 
  mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present")))

  #Check on things - make sure there are equal numbers of parameter estimates for each group (there should be)
obj2_results %>% dplyr::count(estimation.sim, population.growth, parameter, model) %>% 
  print(n = 100)
# mutate(model.label = ifelse(scenario %in% no_lambda_scenarios, "naive",
  #                             ifelse(scenario %in% narrow_lambda_scenarios, "adapted (narrow lambda prior)", 
  #                                    ifelse(scenario %in% diffuse_lambda_scenarios, "adapted (diffuse lambda prior)", NA)))) %>% 
    # mutate(model.label = factor(model.label, levels = c("naive", "adapted (narrow lambda prior)", "adapted (diffuse lambda prior)"))) %>% 



#Update truth values for naive scenarios to be year-specific rather than averages
obj2.naive.results.wrong.truth <- obj2_results %>% 
  dplyr::filter(model == "naive", 
                population.growth != "stable") %>% 
  mutate(surv.truth = all.truth) %>% 
  dplyr::select(-all.truth)

obj2.naive.results.right.truth <- truth.obj2 %>% 
  dplyr::filter(estimation.year %in% obj2.naive.results.wrong.truth$estimation.year) %>% 
  dplyr::select(Male.adult.pop, Female.adult.pop, estimation.year, iteration, population.growth)


obj2_results2 <- obj2.naive.results.wrong.truth %>%
  left_join(obj2.naive.results.right.truth, by = c("population.growth", "iteration", "estimation.year")) %>% 
  mutate(all.truth = ifelse(parameter == "Nf", Female.adult.pop,
                            ifelse(parameter == "Nm", Male.adult.pop, 
                                   ifelse(parameter == "survival", surv.truth, NA)))) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop)) %>% 
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1))
  
#Remove from obj2_results the results from scenarios with average truth values so they can be replaced with year-specific truths. All columns except for truth are the same.
obj2_results <- obj2_results %>% dplyr::filter(!scenario %in% c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3")) %>% 
  bind_rows(obj2_results2) %>% 
  mutate(model = ifelse(scenario %in% naive_scenarios, "naive", 
                        ifelse(scenario %in% conn_scenarios, "adapted", NA))) %>% 
  mutate(model = factor(model, levels = c("naive", "adapted"), labels = c("naive", "adapted")))


#Change label of Nft to Nf. For scenario_2.4.3, did NOT estimate abundance in year 0 as Nt due to time constraints (and the estimates are the same); just kept that as N0.
obj2_results <- obj2_results %>% mutate(parameter = ifelse(parameter == "Nft", "Nf",
                                           ifelse(parameter == "Nmt", "Nm",
                                                  ifelse(parameter == "Nf0" & scenario == "scenario_2.4.3" & estimation.sim == "T0", "Nf",
                                                         ifelse(parameter == "Nm0" & scenario == "scenario_2.4.3" & estimation.sim == "T0", "Nm", parameter)))))

####This code is an alternative to the above code for creating variables for a figure that compares our adapted model to Paul's
# obj2_results <- obj2_results %>% dplyr::filter(!scenario %in% c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3")) %>% 
#   bind_rows(obj2_results2) %>% 
#   mutate(model = ifelse(scenario %in% naive_scenarios, "naive", 
#                         ifelse(scenario %in% conn_scenarios, "Conn", "adapted"))) %>% 
#   mutate(model = factor(model, levels = c("naive", "adapted", "Conn"), labels = c("naive", "adapted", "Conn")))



#-----------Prep sample file for analysis of age distribution---------------------
#Just use stable population growth for now. Age distribution of samples should be similar across the simulations.
sampFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/sample.info_06Sep2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
samples.df_all <- readRDS(file = sampFile.stable)

#Below is just for visualization
#Occasionally there is a different ref.yr for sample.ALL.ages (77), but it's one year away from the dominant ref.yr (76) and there are only a few instances. It helps for visualization to make the same so there aren't two vertical lines in an upcoming plot.
#Also, apparently only saved ref.yr for the last iteration. It's fine for viz purposes, but that's why there are so many NAs.
samples.df_all %>% dplyr::count(ref.yr)

samples.df_all <- samples.df_all %>% 
   mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
  mutate(ref.yr = ifelse(sampling.scheme == "sample.ALL.ages" & is.na(ref.yr) == FALSE, 76, ref.yr)) %>% 
  mutate(est.year.calibrate = ref.yr + 1)


#Get numbers of samples of each age class
(sample.ages <- samples.df_all %>% group_by(sampling.scheme, age.x) %>% summarize(number = n()))


#Make sure we have the right number of all scenarios
obj2_results %>% dplyr::count(scenario, sampling.scheme, model) %>% 
  print(n = 36)

#Results are more variable for the population decline scenario; it's bc there was more variation in the observed population growth. Check mean, sd, and range of lambda and survival truth
obj2_results %>% dplyr::filter(parameter %in% c("lambda", "survival")) %>% 
  group_by(population.growth, parameter) %>% 
  summarize(mean.truth = mean(all.truth),
            sd.truth = sd(all.truth),
            min.truth = min(all.truth),
            max.truth = max(all.truth)) %>% 
  mutate(truth.range = max.truth - min.truth) %>% 
  dplyr::select(population.growth,
                parameter,
                mean.truth, 
                sd.truth,
                truth.range) %>% 
  arrange(parameter, population.growth)

lambda.df <- readRDS(paste0(results_location, "lambda.df"))

#Get more precise variation in lambda
#Remove severe decline scenario bc survival was only changed for the last ten years of the simulation. So it gives mean values that are very similar to the slight decline scenario.
pop.size_all <- readRDS(paste0(results_location, "pop.size_all")) %>% 
  dplyr::filter(population.growth != "severe decline")

#Summarize mean adult and mean total lambda across all years and iterations
pop.size_all %>% group_by(population.growth, iteration) %>% 
  summarize(mean.adult.lambda_iteration = mean(adult.lambda, na.rm = TRUE),
            sd.adult.lambda_iteration = sd(adult.lambda, na.rm = TRUE),
            mean.total.lambda_iteration = mean(total.lambda, na.rm = TRUE),
            sd.total.lambda_iteration = sd(total.lambda, na.rm = TRUE)) %>% 
  group_by(population.growth) %>% 
  summarize(mean.adult.lambda = mean(mean.adult.lambda_iteration, na.rm = TRUE),
            sd.adult.lambda = sd(sd.adult.lambda_iteration, na.rm = TRUE),
            mean.total.lambda = mean(mean.total.lambda_iteration, na.rm = TRUE),
            sd.total.lambda = sd(sd.total.lambda_iteration, na.rm = TRUE))

#Add/edit Paul Conn simulations
#obj2_results <- obj2_results %>% mutate(model = ifelse(scenario %in% conn_scenarios, "Conn", model))



#Check that Paul Conn's model registered appropriately -- the NAs correspond to the old model where we varied N0 instead of Nt. We remove these before plotting below.
#Also, there will be fewer instances of the adapted model bc I did not estimate Nt for t0 in scenario_2.4.3 -- it was the last simulation I ran and I realized I could streamline things by removing the (pointless) scenario where I set Nt to N0. Other results confirm that estimates of N0 are the same as when I set Nt to the same year.
obj2_results %>% dplyr::filter(parameter == "survival", population.growth != "stable", parameter != "Nf0") %>% dplyr::count(model)

#Check that all scenarios are included in the non-NA scenarios
#Do NOT need scenario_2.1.4 bc that's just the stable population growth, not lambda scenario (same as objective 1, so no need to bring in here)
obj2_results %>% dplyr::filter(is.na(model) != TRUE) %>% dplyr::count(scenario)
```

```{r Obj2 plots, echo=FALSE, out.width = "120%"}
colnames(results)
options(scipen = 100000)
  
#Palette I want to use
brewer.pal.info #See different palette options from Rcolorbrewer
cp2 <- brewer.pal(3, "RdYlBu") #Choose palette + number of colors
scales::show_col(cp2)

######################################################################################################### Objective 2 Main Figure ####################################################################################################################
#-------------------Objective 2 Density plots of relative bias-----------------------#
(fig3a <- obj2_results %>% dplyr::filter(parameter %in% c("Nf"),
                                          population.growth != "stable",
                                          scenario %in% c(no_lambda_scenarios, conn_scenarios)) %>% #Added scenario filter so we only have one density plot per situation -- narrow prior for slight growth/decline and diffuse prior for severe decline.
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = model)) + #Changed TO model from model.label
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
  #theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp2[c(1, 3)], #Change to subset for red and blue if just doing two: [c(1,3)]
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw()) +
    theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 25),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 25),
        axis.text.y = element_text(face = "bold"),
        legend.position = "bottom")


#Save each plot for Obj2 individually and combine in Affinity Designer
ggsave("Figure_3a_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#-------------------Histogram of ages-----------------------#
num.bins <- length(min(samples.df_all$birth.year):max(samples.df_all$birth.year))

age.dist_plot <- samples.df_all %>% gghistogram(x = "birth.year", y = "..density..", bins = num.bins, facet.by = "sampling.scheme.label", color = "darkslategray4", fill = "darkslategray4", ggtheme = theme_bw()) +
  geom_vline(aes(xintercept= est.year.calibrate), color = "darkslategrey", linetype = "longdash", size = 1.1) +
#  geom_vline(aes(xintercept = ref.yr - 10), color = "darkturquoise", linetype = "longdash", size = 1.1, alpha = 0.6) +
#  geom_vline(xintercept = 85, color = "indianred4", linetype = "longdash", size = 1.1, alpha = 0.6) +
#  geom_vline(xintercept = 90, color = "seagreen4", linetype = "longdash", size = 1.1, alpha = 0.6) +
  scale_y_continuous(labels = label_comma(), expand = expansion(mult = c(0.01, .05))) +
  xlab("Birth year") +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 25),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 25))

age.dist_plot

#Save each plot for Obj2 individually and combine in Affinity Designer
ggsave("SuppFig_age.dist_Obj2_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 6, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

cp <- brewer.pal(3, "Set2") #Choose palette + number of colors

#-------------------Plot of Lambda bias-----------------------#
obj2_results %>% dplyr::filter(parameter %in% c("lambda"),
                                          scenario %in% conn_scenarios,
                               estimation.sim == "present") %>% #Added scenario filter so we only have one density plot for each situation. Want the situations to match up with Figure 3.
  ggplot(aes(fill = sampling.scheme.label)) + #Changed TO model from model.label
  #geom_density(aes(x = relative_bias), alpha = 0.6) + 
  #facet_grid(rows = vars(population.growth)) +
  #labs(x="Relative bias") +
    #scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
      #geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  geom_violin(aes(x = population.growth, y = relative_bias),
              draw_quantiles = 0.5) +
  labs(x="Population growth") +
  scale_fill_manual(values = cp, #Changed to subset for red and blue 
                    name = "Sampling scheme") +
    ylab("Relative bias") +
      geom_hline(yintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
    theme_bw() +

    theme(plot.title = element_text(face = "bold", 
                                    size = 20,
                                    vjust = -6,
                                    hjust = 0.01),
        axis.text = element_text(size = 20),
        axis.title.x = element_text(size = 25,
                                  vjust = -1),
        axis.title.y = element_text(size = 25),
#        strip.text.x = element_text(size=15),
#        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 25),
        legend.position = "bottom") +
  ggtitle(expression(paste(lambda)))

ggsave("Fig3e_lambda_Obj2_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 6, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

##################################################################################
####################### Objective 2 Supplementary Figure(s) ######################
##################################################################################

obj2_results %>% dplyr::filter(parameter %in% c("Nf"),
                                          population.growth == "stable",
                               scenario %in% conn_scenarios) %>% 
  dplyr::count(scenario)

##Look at stable population growth
obj2_results %>% dplyr::filter(parameter %in% c("Nf"),
                               population.growth == "stable",
                               scenario %in% conn_scenarios) %>% #Added scenario filter so we only have one density plot per situation -- narrow prior for slight growth/decline and diffuse prior for severe decline.
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = sampling.scheme.label)) + #Changed TO model from model.label
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
#  facet_grid(cols = vars(sampling.scheme.label)) +
  #theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp, #Change to subset for red and blue if just doing two: [c(1,3)]
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw() +
  ggtitle("Nf") +
    theme(plot.title = element_text(face = "bold", 
                                    size = 20,
                                    vjust = -6,
                                    hjust = 0.01),
      axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
      axis.text.y = element_text(face = "bold"))

#Save each plot for Obj2 individually and combine in Affinity Designer
ggsave("SuppFig3a_StablePop_Obj2_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 12, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-------------------Plots of survival and abundance-----------------------#
obj2_results %>% dplyr::filter(parameter %in% c("survival"),
                               scenario %in% conn_scenarios,
                               estimation.year == 90) %>% #Added scenario filter so we only have one density plot for each situation. Want the situations to match up with Figure 3.
  ggplot(aes(fill = sampling.scheme.label)) + #Changed TO model from model.label
  #geom_density(aes(x = relative_bias), alpha = 0.6) + 
  #facet_grid(rows = vars(population.growth)) +
  #labs(x="Relative bias") +
    #scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
      #geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  geom_violin(aes(x = population.growth, y = relative_bias),
              draw_quantiles = 0.5) +
  labs(x="Population growth") +
  scale_fill_manual(values = cp, #Changed to subset for red and blue 
                    name = "Sampling scheme") +
    ylab("Relative bias") +
      geom_hline(yintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
    theme_bw() +

    theme(plot.title = element_text(face = "bold", 
                                    size = 20,
                                    vjust = -6,
                                    hjust = 0.01),
        axis.text = element_text(size = 12),
        axis.title.x = element_text(size = 20,
                                  vjust = -0.15),
        axis.title.y = element_text(size = 20),
#        strip.text.x = element_text(size=15),
#        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        legend.position = "right") +
  ggtitle(expression(paste(phi)))

ggsave("SuppFig3b_survival_Obj2_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 12, height = 5, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


# p.obj2_Nm <- obj2_results %>% dplyr::filter(parameter %in% c("Nm"), population.growth != "stable") %>% #Added scenario filter so we only have one density plot for each situation. Want the situations to match up with Figure 3.
#   ggplot(aes(x = relative_bias,
#              y = estimation.sim.label, 
#              fill = model)) + #Changed TO model from model.label
#   geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#   labs(x="Relative bias", y="Estimation year") +
#   facet_grid(rows = vars(population.growth), 
#              cols = vars(sampling.scheme.label)) +
#   xlim(-100, 100) +
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
#   scale_fill_manual(values = cp2[c(1,3)], #Changed to subset for red and blue 
#                     name = "Model") +
#   scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
#     theme_bw() +
#     theme(plot.title = element_text(face = "bold", 
#                                     size = 25),
#           axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_blank(),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20, face = "bold")) +
#   ggtitle(expression(paste("Estimates of Nm")))
# 
# ggarrange(p.obj2_Nm, p.obj2_surv, common.legend = TRUE, legend = "bottom")

# ggsave("SuppFig3b_NmSurv_Obj2_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 500, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 8)




#-------------------Cross correlation -----------------------------------#
crossCorr.all <- readRDS(file = paste0(MCMC_location, "crossCorr/cross.corr_pop.growth_scenarios_ALL_UPDATED_2023.10.05"))

cc.table <- crossCorr.all %>% as_tibble() %>% 
  dplyr::filter(parameter == "Nf0") %>% 
  group_by(parameter, sampling.scheme) %>% 
  summarize(mean_correlation_survival = mean(survival),
            mean_correlation_lambda = mean(lambda)) %>% 
    dplyr::mutate(T0 = ifelse(sampling.scheme %in% c("sample all juveniles", "sample all ages"), 77, 88)) %>% 
  dplyr::select(parameter, mean_correlation_survival, mean_correlation_lambda, T0, sampling.scheme) 

cc.table %>% 
  write_xlsx(path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/peer_review_USE/crossCorr_table.xlsx")


#-------------------Lambda comparison: avg vs indv-----------------------#
# lambda.df %>% 
#   ggplot(aes(x = factor(lambda.yrs), y = relative_bias, fill = factor(pop.growth))) +
# # geom_violin(draw_quantiles = 0.5, position = position_dodge(0.75), width = 4) +
#   #geom_violin(draw_quantiles = 0.5, width = 4) +
#   geom_jitter(width = 0.2, aes(col = factor(pop.growth)), alpha = 0.5) +
#   geom_boxplot() +
# #  geom_hline(yintercept=0, col="black", size=1.25) +
#   labs(x = "lambda years", y = "relative bias") +
#   theme_bw() +
#   theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size = 15),
#         strip.text.y = element_text(size = 15),
#         legend.text = element_text(size = 15),
#         plot.title = element_text(size=25),
#         legend.title = element_blank())
# 
# #Scatter plot of exact relative bias
# lambda.df %>% 
#   ggplot(aes(x = factor(pop.growth), y = relative_bias, fill = factor(pop.growth))) + 
#   geom_jitter() +
#   facet_wrap(~lambda.yrs)
# 
# 
# #-------------Compare total lambda vs adult lambda----------------
# yr0 <- 1
# yrs <- 90
# 
# pop.size_all <- pop.size_all %>% mutate(juv.pop.size = population_size - Total.adult.pop)
# 
# #Initialize df for saving values
# adult.lam_90 = total.lam_90 = juv.lam_90 <- NULL
# 
# 
# #NEED TO REFINE THIS 09/18/2023
# for(pg in 1:4){
#   pop.g.levels <- pop.size_all %>% distinct(population.growth) %>% pull(population.growth)
#   
#   pop.g <- pop.g.levels[pg]
#   
#   pop.g.df <- pop.size_all %>% dplyr::filter(population.growth == "pop.g")
#     
# for(i in 1:max(pop.size_all$iteration)){
#   #Subset for iteration of interest
#   iter <- pop.g.df %>% dplyr::filter(iteration == i)
#   
#   #Change calculation of lambda
#   mean.adult.lam_90 <- (iter$Total.adult.pop[yrs]/iter$Total.adult.pop[1])^(1/(yrs - yr0))
#   adult.lam_90 <- c(adult.lam_90, mean.adult.lam_90)
# 
#   mean.total.lam_90 <- (iter$population_size[yrs]/iter$population_size[1])^(1/(yrs - yr0))
#   total.lam_90 <- c(total.lam_90, mean.total.lam_90)
#   
#   mean.juv.lam_90 <- (iter$juv.pop.size[yrs]/iter$juv.pop.size[1])^(1/(yrs - yr0))
#   juv.lam_90 <- c(juv.lam_90, mean.juv.lam_90)
#   
# }
# 
# }
# 
# 
# #Compare lambda for difference age classes
# N90_lambda <- data.frame(total.lam_90, adult.lam_90, juv.lam_90) %>% 
#   mutate(total_v_adult = total.lam_90 - adult.lam_90,
#          total_v_juv = total.lam_90 - juv.lam_90,
#          adult_v_juv = adult.lam_90 - juv.lam_90)
# 
# #Scatter plot
# N90_lambda %>% pivot_longer(cols = c(total_v_adult, total_v_juv, adult_v_juv),
#                             names_to = c("comparison"),
#                             values_to = "difference") %>% 
#   ggplot(aes(x = difference, y = factor(comparison), fill = factor(comparison))) +
#   geom_jitter(aes(col = factor(comparison))) +
#   geom_boxplot(alpha = 0.3)
# 
# 

#Comparison of vary N0 vs vary Nt
(fig.compare <- obj2_results %>% dplyr::filter(parameter %in% c("Nf"),
                                               !scenario %in% naive_scenarios) %>% #Added scenario filter so we only have one density plot per situation -- narrow prior for slight growth/decline and diffuse prior for severe decline.
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = method)) + #Changed TO model from model.label
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
  #theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp2[c(1, 3)], #Change to subset for red and blue if just doing two: [c(1,3)]
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw()) +
    theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 25),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 25),
        axis.text.y = element_text(face = "bold"))

#Save each plot for Obj2 individually and combine in Affinity Designer
ggsave("SuppFig4_t0vNtComp_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
```


Format data for tests of multiennial breeding (Objective 3)
```{r Obj3 data prep}
##################### Objective 3 ############################
#---------------------Prep results----------------------------
psi1_scenarios <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.5.1", "scenario_3.5.2", "scenario_3.7.1", "scenario_3.7.2")
psi1stoch_scenarios <- c("scenario_3.6.1", "scenario_3.6.2")
psi0.9_scenarios <- c("scenario_3.2.1", "scenario_3.2.2")
psi0.75_scenarios <- c("scenario_3.3.1", "scenario_3.3.2")
psi0.50_scenarios <- c("scenario_3.4.1", "scenario_3.4.2")

all.psi.scenarios <- c("scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2")

annual_scenarios <- c("scenario_3.7.1", "scenario_3.7.2")
biennial_scenarios <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2")
biennial_stoch_scenarios <- c("scenario_3.6.1", "scenario_3.6.2")
triennial_scenarios <- c("scenario_3.5.1", "scenario_3.5.2")

#Create labels for plotting
obj3_results <- results %>% dplyr::filter(objective == "objective3") %>% 
  mutate(psi.label = ifelse(scenario %in% psi1_scenarios & !scenario %in% annual_scenarios, "1",
                            ifelse(scenario %in% psi1stoch_scenarios, "1*",
                                   ifelse(scenario %in% psi0.9_scenarios, "0.90",
                                          ifelse(scenario %in% psi0.75_scenarios, "0.75",
                                                 ifelse(scenario %in% psi0.50_scenarios, "0.50", 
                                                        ifelse(scenario %in% annual_scenarios, "0", NA))))))) %>%
  mutate(psi.label = factor(psi.label, levels = c("1", "1*", "0.90", "0.75", "0.50", "0"))) %>% 
  mutate(breeding.schedule = ifelse(scenario %in% annual_scenarios, "annual",
                                    ifelse(scenario %in% biennial_scenarios, "biennial", 
                                           ifelse(scenario %in% triennial_scenarios, "triennial", 
                                                  ifelse(scenario %in% biennial_stoch_scenarios, "biennial*", NA))))) %>% 
  mutate(model.label = ifelse(scenario %in% naive_scenarios, "naive", "adapted")) %>% 
  mutate(model.label = factor(model.label, levels = c("naive", "adapted"))) %>%
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA))))# %>% 
    #mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present")))

#Check one scenario if desired
# obj3_results %>% dplyr::filter(scenario == "scenario_3.6.2") %>% 
#   dplyr::filter(parameter == "psi" | parameter == "Nf" | parameter == "Nfb1")

# obj3_results %>% dplyr::filter(scenario %in% c("scenario_3.7.1", "scenario_3.7.2"), sampling.scheme == "sample.all.juvenile.ages",
#                                iteration == 2,
#                                estimation.sim == "T0") %>% 
#   arrange(parameter) %>% 
#   View()

#Re-calculate true value of psi as proportion of positive HS pairs that are on-cycle - UPDATED Dec 10, 2023
mom.comps.obj3 <- readRDS(file = paste0(results_location, "objective3_mom.comps.all"))

total.mom.pos.obj3 <- mom.comps.obj3 %>% dplyr::filter(type == "HS") %>% 
  dplyr::group_by(scenario, iteration, sampling.scheme) %>% 
  summarize(total_pos = sum(yes))

mom.pos.BI.obj3 <- mom.comps.obj3 %>% dplyr::filter(type == "HS") %>% 
  dplyr::group_by(scenario, iteration, sampling.scheme, BI) %>% 
  summarize(BI_pos = sum(yes))

psi.calcs <- mom.pos.BI.obj3 %>% dplyr::filter(BI == "on") %>%
  left_join(total.mom.pos.obj3, by = c("scenario", "iteration", "sampling.scheme")) %>% 
  mutate(psi.truth = BI_pos / total_pos,
         parameter = "psi")

obj3_results <- obj3_results %>% left_join(psi.calcs, by = c("scenario", "iteration", "sampling.scheme", "parameter")) %>% 
  mutate(all.truth = ifelse(parameter == "psi", psi.truth, all.truth)) %>% 
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1))

obj3_results %>% dplyr::filter(parameter == "psi", sampling.scheme == "sample.ALL.ages") %>% group_by(sampling.scheme, scenario) %>% summarize(median(all.truth), median(Q50)) %>% print(n = 30)

#plot lambda vs psi
lambda <- obj3_results %>% dplyr::filter(scenario == "scenario_3.4.2", parameter == "lambda")

psi <- obj3_results %>% dplyr::filter(scenario == "scenario_3.4.2", parameter == "psi")

#Should be spread out with no correlation
plot(x = lambda$Q50, y = psi$Q50)

obj3_results  

#Calculate naive "truth" for psi as the proportion of positive comparisons that come from on-cycle mothers.
total.HSPs <- mom.comps.obj3 %>% dplyr::filter(scenario == "scenario_3.6.2", 
                                               yes > 0) %>% 
  group_by(sampling.scheme, iteration) %>% 
  summarize(all.yes = sum(yes)) %>% 
  summarize(mean.yes = mean(all.yes))

on.HSPs <- mom.comps.obj3 %>% dplyr::filter(scenario == "scenario_3.6.2") %>% 
  group_by(sampling.scheme, BI, iteration) %>% 
  summarize(all.yes.BI = sum(yes)) %>% 
  summarize(mean.yes.BI = mean(all.yes.BI))

psi.truth <- total.HSPs %>% left_join(on.HSPs, by = "sampling.scheme") %>% 
  dplyr::filter(BI == "on") %>% 
  mutate(truth = mean.yes.BI/mean.yes)
```


```{r Obj3 Viz}
#Palette I want to use
cp3 <- brewer.pal(3, "RdBu") #Choose palette + number of colors
cp3.sub <- cp3[c(1,3)]
scales::show_col(cp3.sub)

######################################################################################################### Objective 3 Main Figure ####################################################################################################################
#-------------------Objective 3 Density plots of relative bias-----------------------#
psi.df <- obj3_results %>% dplyr::filter(psi.label %in% c("1", "1*", "0"),
                                         estimation.year == 90,
                                         parameter == "psi")

(fig4a <- obj3_results %>% dplyr::filter(parameter %in% c("Nf", "Nm", "survival"),
                                         breeding.schedule %in% c("annual", "biennial", "biennial*", "triennial"),
                                         !scenario %in% all.psi.scenarios) %>% 
  ggplot(aes(x=factor(breeding.schedule, levels = c("triennial", "biennial", "biennial*", "annual")), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_pointrange(data = psi.df, 
                  aes(y = Q50, ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5), 
                  alpha = 0.2,
                  colour = "#67A9CF") +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Breeding cycle", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(factor(parameter, levels = c("Nf", "Nm", "survival", "psi"))), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model"))

ggsave("Figure_4_Obj3_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#ggsave("Figure_4_Obj3_2023.10.06.jpg", plot = last_plot(), device = "jpg", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


##################################################################################
####################### Objective 3 Supplementary Figure(s) ######################
##################################################################################

#-------------------Mixed breeding --------------------#  
psi.df2 <- obj3_results %>% dplyr::filter(psi.label %in% c("0.90", "0.75", "0.50"),
                                         estimation.year == 90,
                                         parameter == "psi")

(fig4_others <- obj3_results %>% dplyr::filter(psi.label %in% c("0.90", "0.75", "0.50"),
                                         estimation.year == 90,
                                         parameter %in% c("Nf", "Nm", "survival")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_boxplot(data = psi.df2, aes(x=factor(psi.label), y=relative_bias), draw_quantiles = 0.5, notch = TRUE) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(factor(parameter, levels = c("Nf", "Nm", "survival", "psi"))), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  guides(fill=guide_legend(title="Model")))

ggsave("SuppFig10_variablepsi_Obj3_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#      ggsave("Figure_4a_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 6, units = "in")


# #-------------------Plot of triennial breeding --------------------#  
# (tri.fig <- obj3_results %>% dplyr::filter(parameter %in% c("Nf", "Nm", "survival", "lambda"),
#                                          breeding.schedule == "triennial",
#                                          estimation.sim.label %in% c("present")) %>%
#    mutate(parameter = factor(parameter, levels = c("Nf", "Nm", "survival", "lambda"), labels = c("Nf", "Nm", "survival", "lambda"))) %>% 
#   ggplot(aes(x=factor(model.label), fill = model.label)) +
#   geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
#   geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
#   labs(x="Model", y="Relative bias") +
#   scale_fill_manual(values = cp3.sub) +
#   facet_grid(cols = vars(sampling.scheme.label), rows = vars(parameter), scales = "free") +
#   theme_bw() +
#   theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20),
#         plot.title = element_text(size=25))) +
#   guides(fill=guide_legend(title="Model")) +
#   ggtitle("Triennial breeding")
# 
# ggsave("SuppFig_triennial.breeding_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
# 
# 
# 
# #-------------------Plot of Lambda bias-----------------------#
# (figS3.lambda <- obj3_results %>% dplyr::filter(parameter %in% c("lambda"),
#                                          breeding.schedule != "triennial",
#                                          estimation.sim.label %in% c("T0", "present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
#   ggplot(aes(x=factor(psi.label), fill = model.label)) +
#   geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
#   geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
#   labs(x="Proportion biennial breeders", y="Relative bias") +
#   scale_fill_manual(values = cp3.sub) +
#   facet_grid(cols = vars(sampling.scheme.label), rows = vars(estimation.sim.label), scales = "fixed") +
#   theme_bw() +
#   theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20),
#         plot.title = element_text(size=25))) +
#   guides(fill=guide_legend(title="Model")) +
#   ggtitle("Lambda")
# 
# 
# ggsave("SuppFig_Lambda_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
# 
# 
# 
# #-------------------Plot of survival bias-----------------------#
# (figS3.survival <- obj3_results %>% dplyr::filter(parameter %in% c("survival"),
#                                          breeding.schedule != "triennial",
#                                          estimation.sim.label %in% c("T0", "present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
#   ggplot(aes(x=factor(psi.label), fill = model.label)) +
#   geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
#   geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
#   labs(x="Proportion biennial breeders", y="Relative bias") +
#   scale_fill_manual(values = cp3.sub) +
#   facet_grid(cols = vars(sampling.scheme.label), rows = vars(estimation.sim.label), scales = "fixed") +
#   theme_bw() +
#   theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20),
#         plot.title = element_text(size=25))) +
#   guides(fill=guide_legend(title="Model")) +
#   ggtitle("Survival")
# 
# 
# ggsave("SuppFig_survival_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
# 
# 
# #-------------------Plot of psi bias-----------------------#
psi.df <- obj3_results %>% dplyr::filter(psi.label %in% c("1", "1*", "0"),
                                         estimation.year == 90,
                                         parameter == "psi")
#This df has the mean truth for each sampling scheme (calculated across all iterations). Use it to manually add value for truth into plot.
psi.truth


(figS6_psi <- obj3_results %>% dplyr::filter(psi.label %in% c("1", "1*", "0"),
                                         estimation.year == 90,
                                         parameter == "psi") %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5. Derived truth from calculations of 
    dplyr::mutate(plot.truth = ifelse(breeding.schedule %in% c("triennial", "biennial", "annual"), 1,
                                      ifelse(breeding.schedule == "biennial*" & sampling.scheme.label == "sample all ages", 0.775,
                                             ifelse(breeding.schedule == "biennial*" & sampling.scheme.label == "sample juveniles", 0.765,
                                                    ifelse(breeding.schedule == "biennial*" & sampling.scheme.label == "target YOY", 0.673, NA))))) %>% 
  ggplot(aes(x=factor(breeding.schedule, levels = c("triennial", "biennial", "biennial*", "annual")))) +
  geom_pointrange(aes(y = Q50, ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5), 
                  alpha = 0.2,
                  colour = "#67A9CF") +
  geom_point(aes(y = plot.truth), colour = "darkred", pch = 3, size = 4) +
  #geom_hline(yintercept=1, col="blue", size=1, linetype = "dashed") +
  labs(x="Breeding schedule", y="Q50") +
  #scale_color_manual(values = cp3.sub[2]) +
  facet_grid(cols = vars(sampling.scheme.label), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.position = "none",
        plot.title = element_text(size=25)))
 
# 
ggsave("SuppFig5_Obj3_psi_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 12, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
# #-----------Plot of bias in Nfb, calculated in two ways -----------#
# (figS3.Nfb <- obj3_results %>% dplyr::filter(parameter %in% c("Nfb1", "Nfb2"),
#                                          breeding.schedule != "triennial",
#                                          estimation.sim.label %in% c("present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
#   ggplot(aes(x=factor(psi.label), fill = model.label)) +
#   geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
#   geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
#   labs(x="Proportion biennial breeders", y="Relative bias") +
#   scale_fill_manual(values = cp3.sub) +
#   facet_grid(cols = vars(sampling.scheme.label), rows = vars(parameter), scales = "fixed") +
#   theme_bw() +
#   theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20),
#         plot.title = element_text(size=25))) +
#   guides(fill=guide_legend(title="Model")) +
#   ggtitle("Survival")
# 
# ggsave("SuppFig_Nfb_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
```

```{r Obj4 data prep}
##################### Objective 4 ############################
#---------------------Prep results----------------------------
accurate.annual.scenario <- results %>% dplyr::filter(scenario == "scenario_2.4.4") %>% #stable population growth with narrow prior
  mutate(scenario = "accurate.annual",
         parameter = ifelse(parameter == "Nft", "Nf", 
                            ifelse(parameter == "Nmt", "Nm", parameter)))
accurate.biennial.scenario <- results %>% dplyr::filter(scenario == "scenario_3.1.2") %>% #stable population growth and biennial breeding/model
  mutate(scenario = "accurate.biennial")

cv5_scenarios <- c("scenario_4.1", "scenario_4.4")
cv10_scenarios <- c("scenario_4.2", "scenario_4.5")
cv20_scenarios <- c("scenario_4.3", "scenario_4.6")

annual_scenariosObj4 <- c("scenario_4.4", "scenario_4.5", "scenario_4.6", "accurate.annual")
biennial_scenariosObj4 <- c("scenario_4.1", "scenario_4.2", "scenario_4.3", "accurate.biennial")

obj4_results <- results %>% dplyr::filter(objective == "objective4") %>% 
  bind_rows(accurate.annual.scenario, accurate.biennial.scenario)

obj4_results <- obj4_results %>% 
  mutate(model.label = ifelse(scenario %in% annual_scenariosObj4, "annual", "multiennial")) %>% 
  mutate(cv.label = ifelse(scenario %in% cv5_scenarios, "5% CV",
                           ifelse(scenario %in% cv10_scenarios, "10% CV",
                                  ifelse(scenario %in% cv20_scenarios, "20% CV",
                                         ifelse(scenario == "accurate.annual" | scenario == "accurate.biennial", "accurate", NA))))) %>% 
  #mutate(model.label = factor(model.label, levels = c("annual", "multiennial"))) %>% #Don't think we need this for plotting, but will leave commented just in case.
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
  mutate(cv.label = factor(cv.label, levels = c("accurate", "5% CV", "10% CV", "20% CV"), labels = c("accurate", "5% CV", "10% CV", "20% CV")))

obj4_results %>% dplyr::count(estimation.year, scenario)

#Apparently I only saved the last iteration of samples and only for the sample.ALL.ages scenario ... must overwrite in the script. For this supplemental figure, we can just use the figure from the first draft: haven't changed these simulations.
# obj4.samples_5cv <- readRDS(paste0(results_location, "samples/samples.missassigned_06Aug2023_Seeds2022.04.15_scenario_4.1_multiennial.model")) %>% mutate(age.cv = "5% CV")
# 
# obj4.samples_10cv <- readRDS(paste0(results_location, "samples/samples.missassigned_06Aug2023_Seeds2022.04.15_scenario_4.2_multiennial.model")) %>% mutate(age.cv = "10% CV")
# 
# obj4.samples_20cv <- readRDS(paste0(results_location, "samples/samples.missassigned_06Aug2023_Seeds2022.04.15_scenario_4.3_multiennial.model")) %>% mutate(age.cv = "20% CV")
# 
# obj4.samples <- bind_rows(obj4.samples_5cv, obj4.samples_10cv, obj4.samples_20cv) %>% 
#   mutate(age.cv = factor(age.cv, levels = c("5% CV", "10% CV", "20% CV"), labels = c("5% CV", "10% CV", "20% CV")))
```

```{r Obj4 Viz}
      #---------Objective 4-------------------------#
      #brewer.pal.info #See different palette options from Rcolorbrewer
      cp4 <- brewer.pal(3, "Paired") #Choose palette + number of colors
#scales::show_col(cp4)

##################################################################################
####################### Objective 4 Main Figure ##################################
##################################################################################
#-------------------Objective 4 Density plots of relative bias-----------------------#
      (fig4b <- obj4_results %>% dplyr::filter(parameter == "Nf" | parameter == "survival", estimation.year == 90) %>% 
  ggplot(aes(x=cv.label, fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Age-length uncertainty") +
  scale_fill_manual(values = cp4) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
  legend.position = "top")) +
  guides(fill=guide_legend(title="Population + model"))

ggsave("Figure_5b_aging.error_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 12, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

##################################################################################
####################### Objective 4 Supplementary Figure(s) ##################################
##################################################################################
#---------------Von Bert and age misassignment --------------------
#Sept 14, 2023: I can use the same figure from before for the vonbert curve and age misassignment (previously Fig S5)      
#VonBert curve + ages misassigned
# ages <- 0:50
# vonBert <- vbFuns(param = "Typical")
# tmp <- growthFunShow("vonBertalanffy","Typical")
# 
# plot(vonBert(t = ages, Linf = 317.65, K = 0.057, t0 = -2.302), pch = 19, type = "b", main = tmp, ylab = "Length", xlab = "Age")
# 
# #Save previous plot manually
# 
#       #Graph 2: real age on x axis, misassigned age on y axis
# (figS5 <- obj4.samples %>%
#    mutate(age.cv = factor(age.cv, levels = c("5% CV", "10% CV", "20% CV"))) %>% 
#     mutate(sampling.scheme = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages",
#                                     ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", "target YOY"))) %>% 
#   ggplot(aes(x = yrs.off,
#              y = age.x)) + 
#   geom_jitter(alpha = 0.6) + 
#   labs(x="Years off", y="True age") +
#  # theme_ridges() + 
#   facet_grid(rows = vars(age.cv), cols = vars(sampling.scheme)) +
# #  xlim(-100, 100) +
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
#   theme_bw() +
#       theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15)))
# 
#       
#             ggsave("Figure_S5b_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#Graph 2: real age on x axis, misassigned age on y axis
# figs4.b <- obj4_samps %>% dplyr::filter(lambda.prior == "none") %>% #There aren't many individuals older than 25
#   ggplot(aes(x = yrs.off,
#              y = age.x)) + 
#   geom_jitter(alpha = 0.6) + 
#   labs(x="Years off", y="Age") +
#  # theme_ridges() + 
#   facet_wrap(~sampling.scheme) + 
#   facet_grid(rows = vars(miss.cv), cols = vars(sampling.scheme)) +
# #  xlim(-100, 100) +
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
#   scale_fill_manual(values = plot.colors.fig3) +
#   
# 
# figs4.b
# 
# ggarrange(figs4.a, figs4.b)

#ggsave("Figure_s4b_2022.09.26.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-------------------Lambda, Nm, and survival--------------------------
      
      (Obj4_supp.results <- obj4_results %>% dplyr::filter(parameter %in% c("Nm", "survival", "lambda"), estimation.year == 90) %>% 
  ggplot(aes(x=factor(cv.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Age-length uncertainty") +
  scale_fill_manual(values = cp4) +
  facet_grid(cols = vars(sampling.scheme), 
             rows = vars(factor(parameter, levels = c("Nm", "survival", "lambda"))), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        legend.position = "top")) +
  guides(fill=guide_legend(title="Population + model"))
            

  ggsave("SuppFig_other.parameters_Obj4_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 12, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
```



```{r objective 5 data read and format}
###############################################################-
############# Load lemon shark sim results and data ###########
###############################################################-

#--------------Load lemon shark simulation results-----------#
#-----------------Keeping full siblings-------------------
ls_dataSim_allSibs <- read_csv(file = paste0(results_location, "lemon_shark_sims/peer_review_rd2/LS_sims/lemon_shark_time_series_sims_results_Conn5_allSibs.csv")) %>%
  mutate(time_window = ifelse(time_window == "all available samples" ,"all available samples",
                              ifelse(time_window == "three year block", "three year window",
                                     ifelse(time_window == "five year block", "five year window", NA)))) %>% 
    mutate(iterID = paste0(T0, "_", iteration, "_", time_window))

#Filter out iterations with Rhat > 1.01
#Check time windows that failed to converge. "Estimation year" was different across parameters - estimates in T0 were assigned that year as the estimation year, and estimates in year t were assigned that year. If it's just the three or five year windows that fail to converge, then we can remove iterations with Rhat > 1.01 just using T0 as the unique identifier, since it changes with each estimation year; if estimates using all available samples fail, then we need a different approach, since T0 remains the same for all estimates.
ls_dataSim_allSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(time_window)

#Looks like there are no failures to converge for the full dataset, so we can just uniquely identify using T0. CONFIRMED that the below works to remove all parameter estimates from iterations where one parameter failed to converge.

#Save iterations that failed to converge
convergence_failures_allSibs.df <- ls_dataSim_allSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  distinct(T0, iteration, time_window) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))

#Remove iterations that failed to converge
ls_dataSim_allSibs <- ls_dataSim_allSibs %>% anti_join(convergence_failures_allSibs.df, by = "iterID")

#Save first year in which abundance was estimated
min.yr <- ls_dataSim_allSibs %>% dplyr::filter(parameter == "Nfbt") %>% summarize(min.yr = min(estimation.year)) %>% 
  pull(min.yr)

#----------------------Load population size for trajectory------------
ls_dataTrend_allSibs <- readRDS(file = paste0(results_location, "lemon_shark_sims/peer_review_rd2/LS_sims/lemon_shark_time_series_sims_popsize_Conn5_allSibs"))

#Format population size dataframe so it can be used in tandem with dataframe of estimates
ls_dataTrend_allSibs.df <- ls_dataTrend_allSibs %>% dplyr::group_by(year) %>% 
  dplyr::summarize(Nf.trend = round(mean(Female.adult.pop), 0),
                   Nm.trend = round(mean(Male.adult.pop), 0),
                   Nfb.trend = round(mean(Num.mothers), 0)
                   ) %>% 
  mutate(Nf.trend.trans = Nf.trend,
         Nm.trend.trans = Nm.trend,
         Nfb.trend.trans = Nfb.trend) %>% 
  dplyr::filter(year >= min.yr) %>% 
  mutate(type = "lambda trend")

#--------------------Single iteration abundance trend---------------
#-------Single iteration abundance trend----------------#
(iter <- sample(c(1:100), size = 1)) #Iteration 16 is a good one for visualization
iter <- 16

ls_estimatesSim_allSibs <- ls_dataSim_allSibs %>% pivot_longer(cols = c(Q50, all.truth), names_to = "type", values_to = "estimate") %>% 
  dplyr::filter(type == "Q50")

ls_truthSim_allSibs <- ls_dataSim_allSibs %>% pivot_longer(cols = c(Q50, all.truth), names_to = "type", values_to = "estimate") %>% 
  dplyr::filter(type == "all.truth") %>%
  dplyr::select(parameter, truth = estimate, estimation.year, type, time_window, iteration) %>% 
  mutate(type = ifelse(parameter %in% c("Nft", "Nf0", "Nmt", "Nm0", "Nfbt", "Nfb0", "psi"), "truth",NA))

ls_truthSim.abund_allSibs <- ls_truthSim_allSibs %>% dplyr::filter(parameter %in% c("Nft", "Nf0", "Nmt", "Nm0", "Nfbt"))

ls_truthSim.otherParams_allSibs <- ls_truthSim_allSibs %>% dplyr::filter(parameter %in% c("survival", "lambda"))


# #------------------Removing full siblings---------------------
ls_dataSim_filterSibs <- read_csv(file = paste0(results_location, "/lemon_shark_sims/peer_review_rd2/LS_sims/lemon_shark_time_series_sims_results_Conn5_filterSibs.csv")) %>%
  mutate(time_window = ifelse(time_window == "all available samples" ,"all available samples",
                              ifelse(time_window == "three year block", "three year window",
                                     ifelse(time_window == "five year block", "five year window", NA)))) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))
  
#Filter out iterations with Rhat > 1.01
ls_dataSim_filterSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(time_window)
#Looks like there are no failures to converge for the full dataset, so we can just uniquely identify using T0. CONFIRMED that the below works to remove all parameter estimates from iterations where one parameter failed to converge.

#Save iterations that failed to converge
convergence_failures_filterSibs.df <- ls_dataSim_filterSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  distinct(T0, iteration, time_window) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))

#Remove iterations that failed to converge
ls_dataSim_filterSibs <- ls_dataSim_filterSibs %>% anti_join(convergence_failures_filterSibs.df, by = "iterID")

#----------------------Load population size for trajectory-----------------
ls_dataTrend_filterSibs <- readRDS(file = paste0(results_location, "lemon_shark_sims/peer_review_rd2/LS_sims/lemon_shark_time_series_sims_popsize_Conn5_filterSibs"))

#Format population size dataframe so it can be used in tandem with dataframe of estimates
ls_dataTrend_filterSibs.df <- ls_dataTrend_filterSibs %>% dplyr::group_by(year) %>% 
  dplyr::summarize(Nf.trend = round(mean(Female.adult.pop), 0),
                   Nm.trend = round(mean(Male.adult.pop), 0),
                   Nfb.trend = round(mean(Num.mothers), 0)
                   ) %>% 
  mutate(Nf.trend.trans = Nf.trend,
         Nm.trend.trans = Nm.trend,
         Nfb.trend.trans = Nfb.trend) %>% 
  dplyr::filter(year >= min.yr) %>% 
  mutate(type = "lambda trend")

#--------------------Single interation abundance trend------------
#-------Single iteration abundance trend----------------#
(iter <- sample(c(1:100), size = 1)) #Iteration 16 is a good one for visualization
iter <- 16

ls_estimatesSim_filterSibs <- ls_dataSim_filterSibs %>% pivot_longer(cols = c(Q50, all.truth), names_to = "type", values_to = "estimate") %>% 
  dplyr::filter(type == "Q50")

ls_truthSim_filterSibs <- ls_dataSim_filterSibs %>% pivot_longer(cols = c(Q50, all.truth), names_to = "type", values_to = "estimate") %>% 
  dplyr::filter(type == "all.truth") %>%
  dplyr::select(parameter, truth = estimate, estimation.year, type, time_window, iteration) %>% 
  mutate(type = ifelse(parameter %in% c("Nft", "Nf0", "Nmt", "Nm0", "Nfbt", "Nfb0", "psi"), "truth",NA))

ls_truthSim.abund_filterSibs <- ls_truthSim_filterSibs %>% dplyr::filter(parameter %in% c("Nft", "Nf0", "Nmt", "Nm0", "Nfbt"))

ls_truthSim.otherParams_filterSibs <- ls_truthSim_filterSibs %>% dplyr::filter(parameter %in% c("survival", "lambda"))
```



```{r Load lemon shark data estimates}
#--------------------All sibs -------------------------------
#----------------Keep all samples
ls_data_allSibs <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/LS_data_ConnModel_allSibs_2023.12.08.csv") %>%
  #mutate(num.samps = num.samps_all) %>%
  #dplyr::select(-c(num.samps_all)) %>%
  dplyr::filter(estimation.year >= 1997) %>%
  mutate(time_window = ifelse(time_window == "all available samples" ,"all available samples",
                              ifelse(time_window == "three year block", "three year window",
                                     ifelse(time_window == "five year block", "five year window", NA)))) %>% 
  mutate(iterID = paste0(time_window, "_", T0))
  
#Filter out iterations with Rhat > 1.01
ls_data_allSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(time_window, T0, estimation.year)
#Looks like there are no failures to converge for the full dataset, so we can just uniquely identify using T0. CONFIRMED that the below works to remove all parameter estimates from iterations where one parameter failed to converge.

#Save iterations that failed to converge. Want to mark these but not necessarily remove them for the full dataset
# convergence_failures_LSdata_allSibs.df <- ls_data_allSibs %>% dplyr::filter(Rhat > 1.01) %>% 
#   distinct(T0, time_window) %>% 
#   mutate(iterID = paste0(time_window, "_", T0))

#Remove iterations that failed to converge
# ls_data_allSibs <- ls_data_allSibs %>% anti_join(convergence_failures_LSdata_allSibs.df, by = "iterID")


#----------------Downsample
ls_data.Down_allSibs <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/LS_data_ConnModel_allSibs_2023.12.08_downsample.csv") %>%
  mutate(mom_HSPs = mom_HSPs.down,
         num.samps = num.samps_down) %>%
  dplyr::select(-c(mom_HSPs.down, num.samps_down)) %>%
  dplyr::filter(estimation_year >= 1997) %>%
  mutate(time_window = ifelse(time_window == "all available samples" ,"all available samples",
                              ifelse(time_window == "three year block", "three year window",
                                     ifelse(time_window == "five year block", "five year window", NA)))) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))
  
#Filter out iterations with Rhat > 1.01
ls_data.Down_allSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(time_window, T0, estimation.year)

#Save iterations that failed to converge
convergence_failures_LSdata.Down_allSibs.df <- ls_data.Down_allSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  distinct(T0, iteration, time_window) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))

#Remove iterations that failed to converge
ls_data.Down_allSibs <- ls_data.Down_allSibs %>% anti_join(convergence_failures_LSdata.Down_allSibs.df, by = "iterID")

#Take mean abundance estimates over 100 iterations
 ls_data.Down4viz_allSibs <- ls_data.Down_allSibs %>% group_by(time_window, estimation.year, parameter) %>% 
  summarize(mean_Q50 = mean(Q50, na.rm = TRUE),
            mean_HPD2.5 = mean(HPD2.5, na.rm = TRUE),
            mean_HPD97.5 = mean(HPD97.5, na.rm = TRUE),
            mean_samps = mean(num.samps, na.rm = TRUE),
            mean_MHSPs = mean(mom_HSPs, na.rm = TRUE))

ls_data_allSibs
ls_data.Down_allSibs

ls_data.Down_allSibs %>% dplyr::filter(parameter == "Nfbt", time_window == "all available samples", estimation_year == 2012)

#--------------------Filter sibs -------------------------------
#--------------Keep all filtered sibs
ls_data_filterSibs <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/LS_data_ConnModel_filterSibs_2023.12.08.csv") %>%
 #mutate(num.samps = num.samps_all) %>%
 #dplyr::select(-c(num.samps_all)) %>%
 dplyr::filter(estimation.year >= 1997) %>%
 mutate(time_window = ifelse(time_window == "all available samples" ,"all available samples",
                             ifelse(time_window == "three year block", "three year window",
                                    ifelse(time_window == "five year block", "five year window", NA)))) %>% 
  mutate(iterID = paste0(time_window, T0))
  
#Filter out iterations with Rhat > 1.01. 
ls_data_filterSibs %>% dplyr::filter(Rhat > 1.01) %>%
  dplyr::count(time_window, T0, estimation.year)
#Looks like there are no failures to converge for the full dataset, so we can just uniquely identify using T0. CONFIRMED that the below works to remove all parameter estimates from iterations where one parameter failed to converge.

#Save iterations that failed to converge - Want to mark these but not necessarily remove them for the full dataset
# convergence_failures_LSdata_filterSibs.df <- ls_data_filterSibs %>% dplyr::filter(Rhat > 1.01) %>% 
#   distinct(T0, time_window) %>% 
#   mutate(iterID = paste0(time_window, T0))

#Remove iterations that failed to converge
# ls_data_filterSibs <- ls_data_filterSibs %>% 
#   anti_join(convergence_failures_LSdata_filterSibs.df, by = "iterID")

#-----------------Downsample then filter sibs
ls_data.Down_filterSibs <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/LS_data_ConnModel_filterSibs_2023.12.08_downsample.csv") %>%
  mutate(mom_HSPs = mom_HSPs.down,
         num.samps = num.samps_down) %>%
  dplyr::select(-c(mom_HSPs.down, num.samps_down)) %>%
  dplyr::filter(estimation_year >= 1997) %>%
  mutate(time_window = ifelse(time_window == "all available samples" ,"all available samples",
                              ifelse(time_window == "three year block", "three year window",
                                     ifelse(time_window == "five year block", "five year window", NA)))) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))
  
#Filter out iterations with Rhat > 1.01
ls_data.Down_filterSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(time_window, T0, estimation.year)
#Looks like there are no failures to converge for the full dataset, so we can just uniquely identify using T0. CONFIRMED that the below works to remove all parameter estimates from iterations where one parameter failed to converge.

#Save iterations that failed to converge
convergence_failures_LSdata.Down_filterSibs.df <- ls_data.Down_filterSibs %>% dplyr::filter(Rhat > 1.01) %>% 
  distinct(T0, iteration, time_window) %>% 
  mutate(iterID = paste0(T0, "_", iteration, "_", time_window))

#Remove iterations that failed to converge
ls_data.Down_filterSibs <- ls_data.Down_filterSibs %>% anti_join(convergence_failures_LSdata.Down_filterSibs.df, by = "iterID")


ls_data_filterSibs
ls_data.Down_filterSibs

 ls_data.Down4viz_filterSibs <- ls_data.Down_filterSibs %>% group_by(time_window, estimation.year, parameter) %>% 
  summarize(mean_Q50 = mean(Q50, na.rm = TRUE),
            mean_HPD2.5 = mean(HPD2.5, na.rm = TRUE),
            mean_HPD97.5 = mean(HPD97.5, na.rm = TRUE),
            mean_samps = mean(num.samps, na.rm = TRUE),
            mean_MHSPs = mean(mom_HSPs, na.rm = TRUE))
# 
# #Use these dfs to get numbers for a table
 ls_data_filterSibs %>% dplyr::filter(parameter == "Nfbt") %>% dplyr::select(time_window, estimation.year, Q50, HPD2.5, HPD97.5, num.samps_all, HSPs_detected) %>% 
   dplyr::filter(time_window == "three year window")
 
 #Run the below, then copy into a separate tab in the "sim.stats.xlsx" workbook, labeled with which samples were retained.
 #Copy concatenate function into "95% HPDI" column to automate that column, and then can copy and paste into Word.
 #If there are instances where the model failed to converge at Rhat 1.01 in the real dataset (i.e. no bootstrapping), then will need to 
ls_data.Down4viz_filterSibs %>% dplyr::filter(parameter == "Nfbt") %>% dplyr::select(time_window, estimation.year, mean_Q50, mean_HPD2.5, mean_HPD97.5, mean_samps, mean_MHSPs) %>% 
   writexl::write_xlsx(path = "/Users/John/Documents/R/sim.stats2.xlsx")
 
 #
 
 
 
   
 ls_data.Down4viz_filterSibs %>% dplyr::filter(parameter == "Nfbt", 
                                            time_window == "all available samples") %>% dplyr::mutate(mean_Q50 = round(mean_Q50, 0),
                                                                                                      mean_HPD2.5 = round(mean_HPD2.5, 0),
                                                                                                      mean_HPD97.5 = round(mean_HPD97.5, 0),
                                                                                                      mean_MHSPs = round(mean_MHSPs, 0)) %>% 
   dplyr::select(time_window, estimation.year, mean_Q50) %>% 
   print(n = 20)

 
 #The script skipped some years for some reason? Don't have time to re-run everything, so gonna check which years were skipped and focus on those
 ls_data.Down_allSibs %>% dplyr::count(estimation.year)
 ls_data.Down_filterSibs %>% dplyr::count(estimation.year)
```




```{r objective 5 simulation and data checks}
source("04_DataViz/functions/plot.functions.R")

#------------------- Simulation figs --------------------------
brewer.pal.info #See different palette options from Rcolorbrewer
cp5 <- brewer.pal(3, "Dark2") #Choose palette + number of colors
cp5[4] <- "black" #If not including average trendline on second plot
#cp5[4] <- "darkslateblue" #If including average trendline on second plot
#cp5[5] <- "black" #If including average trendline on second plot
scales::show_col(cp5)

#------- Keep all sibs -----------------------------------
#------- Plot parameter estimates to check for correlation
lambda.estimates <- ls_data_allSibs %>% dplyr::filter(parameter == "lambda") %>% 
  dplyr::rename(Lambda = Q50) %>% 
  dplyr::select(Lambda, time_window)
psi.estimates <- ls_data_allSibs %>% dplyr::filter(parameter == "psi") %>% 
  dplyr::rename(Psi = Q50) %>% 
  dplyr::select(Psi)

lamPsi.plot <- bind_cols(lambda.estimates, psi.estimates)

lamPsi.plot %>% 
  ggplot(aes(x = Lambda, y = Psi)) +
  geom_point(aes(color = time_window)) +
    geom_smooth(method = "loess", 
              se = FALSE, 
              aes(linetype = time_window,
                  color = time_window)) +
  ggtitle("All sibs")
  

#------- Box plot of relative bias for Nfb----------------#
plot.Nfb(ls_dataSim_allSibs)

#------- Box plot of lambda estimates ----------------#
plot.lambda(ls_dataSim_allSibs)

#------- Box plot of relative bias for survival ----------------#
plot.survival(ls_dataSim_allSibs)

plot.psi(ls_data_allSibs)

#-----------------Single iteration abundance trend----------------
params <- c("Nfbt")

iter <- 20

  ls_truthSim.abund.Plot_allSibs <- ls_truthSim.abund_allSibs %>% dplyr::filter(parameter %in% params,
                                                                                iteration == iter)
  
plot.single.iter(ls_estimatesSim_allSibs)
```






```{r objective 5 simulation viz}
#------------------- Simulation figs --------------------------
brewer.pal.info #See different palette options from Rcolorbrewer
cp5 <- brewer.pal(3, "Dark2") #Choose palette + number of colors
cp5[4] <- "black" #If not including average trendline on second plot
#cp5[4] <- "darkslateblue" #If including average trendline on second plot
#cp5[5] <- "black" #If including average trendline on second plot
scales::show_col(cp5)

#------- Keep all sibs -----------------------------------
#------- Box plot of relative bias for Nfb----------------#
ls_Nfb_boxplot_allSibs <- ls_dataSim_allSibs %>% dplyr::filter(parameter %in% c("Nft")) %>% 
  ggplot() +
  geom_boxplot(aes(x=factor(estimation.year), 
                   fill = time_window, 
                   y=relative_bias), 
               notch = TRUE, 
               outlier.alpha = 0.1) +
  geom_hline(yintercept=0, 
             col="blue", 
             size=1.25, 
             linetype = "dashed") +
  labs(y="Relative bias", 
       x = "Year") +
  scale_y_continuous(limits = c(-50, 150),
                     breaks = c(-50, -25, 0, 25, 50, 75, 100, 125, 150)) +
  scale_fill_manual(values = cp5) +
  geom_vline(xintercept=7, col="darkslategrey", size=1.25, linetype = "longdash") +
    geom_vline(xintercept=12, col="darkslategrey", size=1.25, linetype = "longdash") +
  #facet_wrap(~parameter, scales = "free", ncol = 2) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        #axis.title.y = element_text(size = 20),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        #legend.position = "none",
        plot.title = element_text(size=25),
        axis.title.y.right = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  guides(fill=guide_legend(title="Sample window")) +
  ggtitle("a) Nf")

ls_Nfb_boxplot_allSibs

#------- Box plot of relative bias for lambda ----------------#
ls_lambda_boxplot_allSibs <- ls_dataSim_allSibs %>% dplyr::filter(parameter %in% c("lambda")) %>% 
  ggplot() +
  geom_boxplot(aes(x=factor(estimation.year), fill = time_window, y=relative_bias),
               notch = TRUE, 
               outlier.alpha = 0.1) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Year") +
  scale_y_continuous(limits = c(-25, 50), breaks = c(-25, -25, 0, 25, 50),
                         sec.axis = sec_axis(~. *1, name = "abundance")
) +
geom_path(data = ls_dataTrend_allSibs.df, #Include if we want a trend line of the average realized abundance
          aes(x = factor(year),
              y = Nfb.trend.trans,
              color = type,
              group = 1),
          size = 1.25,
          linetype = "solid") +
    scale_color_manual(values = "firebrick4", name = element_blank()) +
 # facet_wrap(~parameter,
 #            scales = "free") +
  scale_fill_manual(values = cp5) +
  #facet_wrap(~parameter, scales = "free", ncol = 2) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        #axis.title = element_text(size = 20),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  geom_vline(xintercept=7, col="darkslategrey", size=1.25, linetype = "longdash") +
    geom_vline(xintercept=12, col="darkslategrey", size=1.25, linetype = "longdash") +
  guides(fill=guide_legend(title="Sample window")) +
  ggtitle(expression(paste("b) ", lambda)))


#------- Box plot of relative bias for survival ----------------#
#Survival
ls_survival_boxplot_allSibs <- ls_dataSim_allSibs %>% dplyr::filter(parameter %in% c("survival")) %>% 
  ggplot() +
  geom_boxplot(aes(x=factor(estimation.year), fill = time_window, y=relative_bias),
               notch = TRUE, 
               outlier.alpha = 0.1) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Year") +
  scale_y_continuous(limits = c(-50, 50), breaks = c(-50, -25, 0, 25, 50),
                         sec.axis = sec_axis(~. *1, name = "abundance")
) +
  scale_fill_manual(values = cp5) +
  geom_vline(xintercept=7, col="darkslategrey", size=1.25, linetype = "longdash") +
    geom_vline(xintercept=12, col="darkslategrey", size=1.25, linetype = "longdash") +
  #facet_wrap(~parameter, scales = "free", ncol = 2) +
  theme_bw() +
theme(axis.text = element_text(size = 12),
        #axis.title = element_text(size = 20),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  guides(fill=guide_legend(title="Sample window")) +
  ggtitle(expression(paste("c) ", phi)))

(LS.sim_boxplots_allSibs <- ggarrange(ls_Nfb_boxplot_allSibs, ls_lambda_boxplot_allSibs, ls_survival_boxplot_allSibs, common.legend = FALSE, nrow = 3, legend = "right"))

(LS.sim_boxplots.annotated_allSibs <- annotate_figure(LS.sim_boxplots_allSibs, left = text_grob("Relative Bias", rot = 90, size = 18, face = "bold", family = "sans")))

#ggsave("Fig6_LS_sim_allSibs_boxplots_2023.10.06.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 10, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

ggsave("Fig6_LS_sim_allSibs_boxplots_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 10, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-----------------Single iteration abundance trend----------------
params <- c("Nfbt")

iter <- 99

ls_truthSim.abund.Plot_allSibs <- ls_truthSim.abund_allSibs %>% dplyr::filter(parameter %in% params,
                                                              iteration == iter)

fig5sim_allSibs <- ls_estimatesSim_allSibs %>% dplyr::filter(iteration == iter,
                                             parameter %in% params) %>% 
  ggplot(aes(x = estimation.year, 
             y = estimate,
             color = time_window)) +
  geom_pointrange(aes(ymin = HPD2.5, 
                      ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", 
              se = FALSE, 
              aes(linetype = time_window)) +
  geom_line(data = ls_truthSim.abund.Plot_allSibs,
            aes(y = truth, 
                color = type),
            size = 1) +
  scale_x_continuous(breaks = seq(from = 74, to=90, by=1)) +
  # geom_path(data = ls_dataTrend.df, #Include if we want a trend line of the average realized abundance
  #           aes(x = year,
  #               y = Nfb.trend.trans,
  #               color = type,
  #               group = 1),
  #           size = 1.25,
  #           linetype = "solid") +
#  facet_wrap(~parameter, 
#             scales = "free") +
  theme_bw() +
#  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(name = "Sample window", values = cp5) +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  xlab("Year") +
  ylab("Female abundance") +
  guides(linetype = "none") #Can decide what to keep or remove from legend with this

fig5sim_allSibs

#ggsave("SuppFig6_LS_sim_Nfb_allSibs_singleTrend_2023.10.08.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

ggsave("SuppFig7_LS_sim_Nfb_allSibs_singleTrend_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")



#------- Filter sibs -----------------------------------
#------- Box plot of relative bias for Nfb----------------#
ls_Nfb_boxplot_filterSibs <- ls_dataSim_filterSibs %>% dplyr::filter(parameter %in% c("Nft")) %>% 
  ggplot() +
  geom_boxplot(aes(x=factor(estimation.year), 
                   fill = time_window, 
                   y=relative_bias), 
               notch = TRUE, 
               outlier.alpha = 0.1) +
  geom_hline(yintercept=0, 
             col="blue", 
             size=1.25, 
             linetype = "dashed") +
  labs(y="Relative bias", 
       x = "Year") +
  scale_y_continuous(limits = c(-50, 150),
                     breaks = c(-50, -25, 0, 25, 50, 75, 100, 125, 150)) +
  scale_fill_manual(values = cp5) +
  geom_vline(xintercept=7, col="darkslategrey", size=1.25, linetype = "longdash") +
    geom_vline(xintercept=12, col="darkslategrey", size=1.25, linetype = "longdash") +
  #facet_wrap(~parameter, scales = "free", ncol = 2) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        #axis.title.y = element_text(size = 20),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        #legend.position = "none",
        plot.title = element_text(size=25),
        axis.title.y.right = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  guides(fill=guide_legend(title="Sample window")) +
  ggtitle("a) Nf")

ls_Nfb_boxplot_filterSibs


#------- Box plot of relative bias for lambda ----------------#
ls_lambda_boxplot_filterSibs <- ls_dataSim_filterSibs %>% dplyr::filter(parameter %in% c("lambda")) %>% 
  ggplot() +
  geom_boxplot(aes(x=factor(estimation.year), fill = time_window, y=relative_bias),
               notch = TRUE, 
               outlier.alpha = 0.1) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Year") +
  scale_y_continuous(limits = c(-25, 50), breaks = c(-25, -25, 0, 25, 50),
                         sec.axis = sec_axis(~. *1, name = "abundance")
) +
geom_path(data = ls_dataTrend_filterSibs.df, #Include if we want a trend line of the average realized abundance
          aes(x = factor(year),
              y = Nfb.trend.trans,
              color = type,
              group = 1),
          size = 1.25,
          linetype = "solid") +
    scale_color_manual(values = "firebrick4", name = element_blank()) +
 # facet_wrap(~parameter,
 #            scales = "free") +
  scale_fill_manual(values = cp5) +
  #facet_wrap(~parameter, scales = "free", ncol = 2) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        #axis.title = element_text(size = 20),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  geom_vline(xintercept=7, col="darkslategrey", size=1.25, linetype = "longdash") +
    geom_vline(xintercept=12, col="darkslategrey", size=1.25, linetype = "longdash") +
  guides(fill=guide_legend(title="Sample window")) +
  ggtitle(expression(paste("b) ", lambda)))


#------- Box plot of relative bias for survival ----------------#
#Survival
ls_survival_boxplot_filterSibs <- ls_dataSim_filterSibs %>% dplyr::filter(parameter %in% c("survival")) %>% 
  ggplot() +
  geom_boxplot(aes(x=factor(estimation.year), fill = time_window, y=relative_bias),
               notch = TRUE, 
               outlier.alpha = 0.1) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Year") +
  scale_y_continuous(limits = c(-50, 50), breaks = c(-50, -25, 0, 25, 50),
                         sec.axis = sec_axis(~. *1, name = "abundance")
) +
  scale_fill_manual(values = cp5) +
  geom_vline(xintercept=7, col="darkslategrey", size=1.25, linetype = "longdash") +
    geom_vline(xintercept=12, col="darkslategrey", size=1.25, linetype = "longdash") +
  #facet_wrap(~parameter, scales = "free", ncol = 2) +
  theme_bw() +
theme(axis.text = element_text(size = 12),
        #axis.title = element_text(size = 20),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  guides(fill=guide_legend(title="Sample window")) +
  ggtitle(expression(paste("c) ", phi)))

(LS.sim_boxplots_filterSibs <- ggarrange(ls_Nfb_boxplot_filterSibs, ls_lambda_boxplot_filterSibs, ls_survival_boxplot_filterSibs, common.legend = FALSE, nrow = 3, legend = "right"))

(LS.sim_boxplots.annotated_filterSibs <- annotate_figure(LS.sim_boxplots_filterSibs, left = text_grob("Relative Bias", rot = 90, size = 18, face = "bold", family = "sans")))

#ggsave("Fig6_LS_sim_filterSibs_boxplots_2023.10.06.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 10, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

ggsave("SuppFig8_LS_sim_filterSibs_boxplots_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 10, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#-----------------Single iteration abundance trend----------------
params <- c("Nfbt")

iter <- 99

ls_truthSim.abund.Plot_filterSibs <- ls_truthSim.abund_filterSibs %>% dplyr::filter(parameter %in% params,
                                                              iteration == iter)

fig5sim_filterSibs <- ls_estimatesSim_filterSibs %>% dplyr::filter(iteration == iter,
                                             parameter %in% params) %>% 
  ggplot(aes(x = estimation.year, 
             y = estimate,
             color = time_window)) +
  geom_pointrange(aes(ymin = HPD2.5, 
                      ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", 
              se = FALSE, 
              aes(linetype = time_window)) +
  geom_line(data = ls_truthSim.abund.Plot_filterSibs,
            aes(y = truth, 
                color = type),
            size = 1) +
  scale_x_continuous(breaks = seq(from = 74, to=90, by=1)) +
  # geom_path(data = ls_dataTrend.df, #Include if we want a trend line of the average realized abundance
  #           aes(x = year,
  #               y = Nfb.trend.trans,
  #               color = type,
  #               group = 1),
  #           size = 1.25,
  #           linetype = "solid") +
#  facet_wrap(~parameter, 
#             scales = "free") +
  theme_bw() +
#  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(name = "Sample window", values = cp5) +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  xlab("Year") +
  ylab("Female abundance") +
  guides(linetype = "none") #Can decide what to keep or remove from legend with this

fig5sim_filterSibs

#ggsave("SuppFig6_LS_sim_Nfb_filterSibs_singleTrend_2023.10.08.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

ggsave("SuppFig8d_LS_sim_Nfb_filterSibs_singleTrend_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")



######################################################################################################### Objective 5 Supplementary Figure(s) ####################################################################################################################
# #Now show estimates of other parameters
# cp5.2 <- c("firebrick1", "dodgerblue", "firebrick4", "dodgerblue4") #Choose palette + number of colors
# 
# suppfig_LSsim_otherParams <- ls_estimatesSim %>% dplyr::filter(iteration == iter,
#                                              parameter %in% c("survival", "lambda")) %>% 
#   ggplot(aes(x = estimation.year, 
#              y = estimate,
#              color = time_window)) +
#   geom_pointrange(aes(ymin = HPD2.5, 
#                       ymax = HPD97.5),
#                   position = position_dodge(width = 0.5)) +
#   geom_smooth(method = "gam", 
#               se = FALSE, 
#               linetype = "dashed") +
#   geom_line(data = ls_truthSim.otherParams,
#             aes(y = truth, 
#                 color = type),
#             size = 1) +
#   facet_wrap(~parameter, 
#              scales = "free") +
#   theme_bw() +
# #  labs(x = "Estimation year", y = "Female abundance") +
#   scale_color_manual(name = "Time window", values = cp5.2) +
# #  ggtitle("a)") +
#   theme(axis.text = element_text(size = 15),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size = 15),
#         strip.text.y = element_text(size = 15),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20),
#         plot.title = element_text(size=25)) +
#   guides(linetype = "none") #Can decide what to keep or remove from legend with this
# 
# suppfig_LSsim_otherParams
# 
# ggsave("LemonSharkSim_SuppFig.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
```







```{r Objective 5 LS data viz}
#------------------- Data figs --------------------------
brewer.pal.info #See different palette options from Rcolorbrewer
cp5 <- brewer.pal(3, "Dark2") #Choose palette + number of colors
cp5[4] <- "black" #If not including average trendline on second plot
#cp5[4] <- "darkslateblue" #If including average trendline on second plot
#cp5[5] <- "black" #If including average trendline on second plot
scales::show_col(cp5)

#---------------------LEMON SHARK DATA-----------------
x.ticks <- c(seq(1997, 2015, by = 1))
x.tick.labels <- c("", "", "", "2000", rep("", times = 4), "2005", rep("", times = 4), "2010", rep("", times = 4), "2015")

#Values from DiBattista et. al.
real.truth <- tibble(estimation.year = c(seq(from = 1997, to = 2007, by = 1)),
                     parameter = "Nfbt",
                     time_window = "z     pedigree abundance",
                     Q50 = c(18, 10, 19, 12, 17, 14, 17, 14, 22, 23, 19))

#Remove outlier datapoint from three year window
ls_data_allSibs_plotNf <- ls_data_allSibs %>% dplyr::filter(parameter == "Nfbt", Q50 < 100)

#----------Keep all sibs; keep all samples
fig5a_allSibs <- ls_data_allSibs_plotNf %>% 
  dplyr::filter(parameter == "Nfbt") %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
  geom_line(data = real.truth, aes(color = time_window), size = 1.5) +
  #facet_wrap(~years.lab) +
  theme_bw() +
#  ylim(0, 60) +
  coord_cartesian(ylim = c(0,60)) +
  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
       legend.text = element_text(size = 15),
       legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels) +
  ggtitle("d) Nfb")

fig5a_allSibs

ggsave("Fig6d_LS_data_allSibs_Nfb_trend_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 4, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-----------------------Survival------------------------------------#
fig5.survival_allSibs <- ls_data_allSibs %>% 
  dplyr::filter(parameter == "survival") %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  #ylim(0, 75) +
  labs(x = "Estimation year", y = "Survival") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels)

fig5.survival_allSibs

ggsave("SuppFig9a_LS_data_allSibs_survival_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#-----------------------Lambda------------------------------------#
fig5.lambda_allSibs <- ls_data_allSibs %>% 
  dplyr::filter(parameter == "lambda") %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  #ylim(0, 75) +
  labs(x = "Estimation year", y = "lambda") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels) +
  ggtitle("Lambda")

fig5.lambda_allSibs


#-----------------------Psi------------------------------------#
fig5.psi_allSibs <- ls_data_allSibs %>% 
  dplyr::filter(parameter == "psi") %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  #ylim(0, 75) +
  labs(x = "Estimation year", y = "psi") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels) +
  ggtitle("Psi")

fig5.psi_allSibs


#----------Filter sibs; keep all samples
#Remove outlier datapoint from three year window
ls_data_filterSibs_plotNf <- ls_data_filterSibs %>% dplyr::filter(parameter == "Nfbt", Q50 < 100)


fig5a_filterSibs <- ls_data_filterSibs_plotNf %>% 
  dplyr::filter(parameter == "Nfbt") %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
  geom_line(data = real.truth, aes(color = time_window), size = 1.5) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  coord_cartesian(ylim = c(0,60)) +
#  ylim(0, 60) +
  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
       legend.text = element_text(size = 15),
       legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels) +
  ggtitle("d) Nfb")

fig5a_filterSibs

ggsave("SuppFig7b_LS_data_filterSibs_Nfb_trend_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 4, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-----------------------Survival------------------------------------#
fig5.survival_filterSibs <- ls_data_filterSibs %>% 
  dplyr::filter(parameter == "survival") %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  #ylim(0, 75) +
  labs(x = "Estimation year", y = "Survival") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels)

fig5.survival_filterSibs

ggsave("SuppFig9b_LS_data_filterSibs_survival_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")





#----------Keep all sibs; downsample
cp5 <- brewer.pal(3, "Dark2") #Choose palette + number of colors
cp5[3] <- "black" #If not including average trendline on second plot

#Nfbt
p.LS.down_Nfbt_allSibs <- ls_data.Down4viz_allSibs %>% 
  dplyr::filter(parameter %in% c("Nfbt"), 
                !time_window %in% c("three year window")) %>%
  dplyr::rename(Q50 = mean_Q50) %>% 
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = mean_HPD2.5, ymax = mean_HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
#  facet_wrap(~parameter, scales = "free") +
  theme_bw() +
    geom_line(data = real.truth, aes(color = time_window), size = 1.5) +
  #ylim(0, 75) +
  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels)

p.LS.down_Nfbt_allSibs

#Survival
p.LS.down_survival_allSibs <- ls_data.Down4viz_allSibs %>% 
  dplyr::filter(parameter %in% c("survival"),
                !time_window %in% c("three year window")) %>%
  ggplot(aes(x = estimation.year, y = mean_Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = mean_HPD2.5, ymax = mean_HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "gam", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
#  facet_wrap(~parameter, scales = "free") +
  theme_bw() +
#  ylim(0, 75) +
  labs(x = "Estimation year", y = "Survival") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels)

p.LS.down_survival_allSibs


(p.LS.Down_allSibs <- ggarrange(p.LS.down_Nfbt_allSibs, p.LS.down_survival_allSibs, common.legend = TRUE, nrow = 2, legend = "right"))


#ggarrange(fig5a, fig5b, common.legend = TRUE, legend = "bottom")

ggsave("SuppFig8a_LSData_Down_allSibs_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 12, height = 6, units = "in")


#----------Filter sibs; downsample
#Nfbt
p.LS.down_Nfbt_filterSibs <- ls_data.Down4viz_filterSibs %>% 
  dplyr::rename(Q50 = mean_Q50) %>% 
  dplyr::filter(parameter %in% c("Nfbt"), 
                !time_window %in% c("three year window")) %>%
  ggplot(aes(x = estimation.year, y = Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = mean_HPD2.5, ymax = mean_HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "loess", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
#  facet_wrap(~parameter, scales = "free") +
  theme_bw() +
  geom_line(data = real.truth, aes(color = time_window), size = 1.5) +
#  ylim(0, 75) +
  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels)

p.LS.down_Nfbt_filterSibs

#Survival
p.LS.down_survival_filterSibs <- ls_data.Down4viz_filterSibs %>% 
  dplyr::filter(parameter %in% c("survival"),
                !time_window %in% c("three year window")) %>%
  ggplot(aes(x = estimation.year, y = mean_Q50, color = time_window)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = mean_HPD2.5, ymax = mean_HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "gam", se = FALSE, aes(linetype = time_window), show.legend = FALSE) +
#  facet_wrap(~parameter, scales = "free") +
  theme_bw() +
#  ylim(0, 75) +
  labs(x = "Estimation year", y = "Survival") +
  scale_color_manual(values = cp5, name = "Sample window") +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  scale_x_continuous(breaks = x.ticks,
                     labels = x.tick.labels)

p.LS.down_survival_filterSibs


(p.LS.Down_filterSibs <- ggarrange(p.LS.down_Nfbt_filterSibs, p.LS.down_survival_filterSibs, common.legend = TRUE, nrow = 2, legend = "right"))


#ggarrange(fig5a, fig5b, common.legend = TRUE, legend = "bottom")

ggsave("SuppFig9b_LSData_Down_filterSibs_2023.12.10.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 12, height = 6, units = "in")

#










#Make table of full dataset and downsampled dataset results
#Start with bind rows bc it's before converting Dataset to a factor
table4 <- bind_rows(ls_data.full4viz, ls_data.Fulldown4viz, ls_data.five4viz) %>%
  dplyr::filter(parameter == "Nfb2") %>% 
  mutate(HPDI = paste0("(", round(HPD2.5, 0)," - ", round(HPD97.5, 0), ")")) %>%
  dplyr::select(Median = Q50,
                HPDI,
                `Estimation year` = estimation_year,
                `Number of samples` = num.samps,
                `Mom HSPs` = mom_HSPs,
                Dataset)

write_csv(table4, file = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/tables/table4_2023.01.02.csv")
```



```{r potential supplementary tables and graphs}
MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/"

#----------------------- Cross-correlation --------------------------
pop.growth_all <- readRDS(file = paste0(MCMC_location, "cross.corr_pop.growth_all_20230919"))
multiennial.model_all <- readRDS(file = paste0(MCMC_location, "cross.corr_multiennial.model_all_20230919"))

cross.corr_all <- bind_rows(pop.growth_all, multiennial.model_all) %>% 
  as_tibble()

cross.corr_all %>% dplyr::filter(scenario == "scenario_3.1.2", parameter == "survival")


```


```{r Check on model output}
model.out.all <- readRDS("G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/Model.output/all_model_results_allSibs_2023.12.08")

crosscorr(model.out.all[[15]]$samples)

model.out.block5 <- readRDS("G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/Model.output/block5_model_results_allSibs_2023.12.08")

crosscorr(model.out.block5[[15]]$samples)

model.out.block3 <- readRDS("G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/Model.output/block3_model_results_allSibs_2023.12.08")

crosscorr(model.out.block3[[15]]$samples)


mcmc.all = mcmc.block5 = mcmc.block3 <- NULL

yr <- 1997

for(cr in 1:length(model.out.all)){

   mcmc.all[[cr]] <- as.data.frame(crosscorr(model.out.all[[cr]]$samples))
  #   mutate(est_yr = yr, 
  #          time_window = "all available samples") %>% 
  #   rownames_to_column(var = "parameter")
  
  mcmc.block5[[cr]] <- as.data.frame(crosscorr(model.out.block5[[cr]]$samples))
    # mutate(est_yr = yr,
    #        time_window = "five year window") %>% 
    # rownames_to_column(var = "parameter")
  
  mcmc.block3[[cr]] <- as.data.frame(crosscorr(model.out.block3[[cr]]$samples))
    # mutate(est_yr = yr,
    #        time_window = "three year window") %>% 
    # rownames_to_column(var = "parameter")

  yr <- yr+1
}

#Have to get rid of the rownames_to_column function above to calculate means below
(all_cross.mean <- as.data.frame(Reduce("+", mcmc.all) / length(mcmc.all)) %>% 
  mutate(time_window = "all available samples") %>% 
  rownames_to_column(var = "parameter"))

(block5_cross.mean <- as.data.frame(Reduce("+", mcmc.block5) / length(mcmc.block5)) %>% 
  mutate(time_window = "five year window") %>% 
  rownames_to_column(var = "parameter"))

(block3_cross.mean <- as.data.frame(Reduce("+", mcmc.block3) / length(mcmc.block3)) %>% 
  mutate(time_window = "three year window") %>% 
  rownames_to_column(var = "parameter"))

cross.corr_all.mean <- bind_rows(all_cross.mean, block5_cross.mean, block3_cross.mean) %>%
  dplyr::select(-deviance) %>% 
  dplyr::filter(parameter != "deviance")

write_csv(cross.corr_all.mean, file = paste0(results_location,"lemon_shark_sims/peer_review_rd2/LS_data/cross.corr_allsibs_mean.csv"))

#To look at cross-correlation by year and time window
cross.corr_all <- as_tibble(bind_rows(mcmc.all, mcmc.block5, mcmc.block3))

#Need to filter out for the parameters we want to check
cross.corr_all %>% dplyr::filter(parameter != "psi",
                                 time_window != "three year window") %>% 
  arrange(desc(psi)) %>% 
  print(n = 100)


#---------------Filter siblings-------------------------------
model.out.all <- readRDS("G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/Model.output/all_model_results_filterSibs_2023.12.08")

crosscorr(model.out.all[[15]]$samples)

model.out.block5 <- readRDS("G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/Model.output/block5_model_results_filterSibs_2023.12.08")

crosscorr(model.out.block5[[15]]$samples)

model.out.block3 <- readRDS("G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_sims/peer_review_rd2/LS_data/Model.output/block3_model_results_filterSibs_2023.12.08")

crosscorr(model.out.block3[[15]]$samples)


mcmc.all = mcmc.block5 = mcmc.block3 <- NULL

yr <- 1997

for(cr in 1:length(model.out.all)){

   mcmc.all[[cr]] <- as.data.frame(crosscorr(model.out.all[[cr]]$samples))
  #   mutate(est_yr = yr, 
  #          time_window = "all available samples") %>% 
  #   rownames_to_column(var = "parameter")
  
  mcmc.block5[[cr]] <- as.data.frame(crosscorr(model.out.block5[[cr]]$samples))
    # mutate(est_yr = yr,
    #        time_window = "five year window") %>% 
    # rownames_to_column(var = "parameter")
  
  mcmc.block3[[cr]] <- as.data.frame(crosscorr(model.out.block3[[cr]]$samples))
    # mutate(est_yr = yr,
    #        time_window = "three year window") %>% 
    # rownames_to_column(var = "parameter")

  yr <- yr+1
}

#Have to get rid of the rownames_to_column function above to calculate means below
(all_cross.mean <- as.data.frame(Reduce("+", mcmc.all) / length(mcmc.all)) %>% 
  mutate(time_window = "all available samples") %>% 
  rownames_to_column(var = "parameter"))

(block5_cross.mean <- as.data.frame(Reduce("+", mcmc.block5) / length(mcmc.block5)) %>% 
  mutate(time_window = "five year window") %>% 
  rownames_to_column(var = "parameter"))

(block3_cross.mean <- as.data.frame(Reduce("+", mcmc.block3) / length(mcmc.block3)) %>% 
  mutate(time_window = "three year window") %>% 
  rownames_to_column(var = "parameter"))

cross.corr_all.mean <- bind_rows(all_cross.mean, block5_cross.mean, block3_cross.mean) %>% 
  dplyr::select(-deviance) %>% 
  dplyr::filter(parameter != "deviance")

write_csv(cross.corr_all.mean, file = paste0(results_location,"lemon_shark_sims/peer_review_rd2/LS_data/cross.corr_filtersibs_mean.csv"))

```










```{r calculate relative bias and % in HPDI}
#To get this in the table, I ran the script and then manually translated over the to table in Word. Perhaps there's a way I can just export this to a CSV file and copy and paste ... 
#Check percent in interval; can change proportion sampled
obj1_results %>% dplyr::filter(prop.sampled == 1.5) %>% 
  dplyr::filter(survival.prior == "informed", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, prop.sampled) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#-------------Objective 2 --------------------#
#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj2_results <- obj2_results %>% dplyr::filter(Rhat < 1.01)

#2.1 - slight population decline; tight prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "slight decline", lambda.prior == "tight (0.95 - 1.05)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 - slight population growth; tight prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "slight increase", lambda.prior == "tight (0.95 - 1.05)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.3 - severe population decline; diffuse prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "severe decline", lambda.prior == "diffuse (0.80 - 1.20)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)



#3.1: psi = 1
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 1, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.2: psi = 0.90
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.9, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.2: psi = 0.75
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.75, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.4: psi = 0.50
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.5, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.5: mating periodicity = 3; psi = 1
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 1, parameter == "Nf", model == "multiennial", mating.periodicity == 3) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.6: psi = 1*
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == "1*", parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.1: 5% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "5% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.1: 5% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "5% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#4.2: 10% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "10% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.2: 10% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "10% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#4.3: 20% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "20% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.3: 20% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "20% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

```