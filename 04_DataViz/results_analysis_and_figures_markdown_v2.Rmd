---
title: "CKMR results 07/21/2022"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 3
    fig_caption: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(scales)
library(ggridges)
library(ggpattern)
library(ggalt)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

```


```{r set-file-locations and read in files, include = FALSE}
#------------- Simulation parameters and labels  ----------------#
MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/"

results.files <- list.files(path = paste0(results_location),
                            recursive = FALSE,
                            pattern = "*.csv",
                            full.names = TRUE)

results.raw <- map_dfr(results.files, read_csv, guess_max = 30000) #Have to specify guess_max or else the function will guess column type using the first 1,000 columns and assume the POP columns are logical (bc the first several thousand are NA)

naive_scenarios <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4", "scenario_3.1.1", "scenario_3.2.1", "scenario_3.3.1", "scenario_3.4.1", "scenario_3.5.1", "scenario_3.6.1", "scenario_3.7.1") #Note that scenario 3.7.1 is not technically "naive", but for the test it was used for it is. So we will label it as such, and this label will be used later when we label it as an annual model in graphs for Objective 3.

objective1 <- c("scenario_1_model.validation", "scenario_1.2.1", "scenario_1.2.2", "scenario_1.2.3")
objective2 <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4", "scenario_2.2.1", "scenario_2.2.2", "scenario_2.2.3", "scenario_2.2.4", "scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4", "scenario_2.4.1", "scenario_2.4.2", "scenario_2.4.3", "scenario_2.4.4")
objective3 <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2", "scenario_3.5.1", "scenario_3.5.2", "scenario_3.6.1", "scenario_3.6.2", "scenario_3.7.1", "scenario_3.7.2")
objective4 <- c("scenario_4.1", "scenario_4.2", "scenario_4.3", "scenario_4.4", "scenario_4.5", "scenario_4.6")

results.raw <- results.raw %>% mutate(model = ifelse(scenario %in% naive_scenarios, "naive", "adapted")) %>% 
  mutate(objective = ifelse(scenario %in% objective1, "objective1", 
                            ifelse(scenario %in% objective2, "objective2",
                                   ifelse(scenario %in% objective3, "objective3", 
                                          ifelse(scenario %in% objective4, "objective4", NA)))))


```

```{r double-check columns and look for NAs, include = FALSE}
colnames(results.raw)

#Check to make sure we have an appropriate number of simulations and minimal NAs
results.raw %>% dplyr::count(sampling.scheme)
results.raw %>% dplyr::count(estimation.year)
results.raw %>% dplyr::count(sample.prop)
results.raw %>% dplyr::count(estimation.sim)
results.raw %>% dplyr::count(parameter)
results.raw %>% dplyr::count(is.na(relative_bias))
#results.raw %>% dplyr::count(scenario) %>% View()
results.raw %>% dplyr::filter(objective == "objective1") %>% 
  count(estimation.sim)
results.raw %>% dplyr::count(scenario)
results.raw %>% dplyr::count(objective)
results.raw %>% dplyr::count(iteration) %>% 
  dplyr::filter(iteration == 1 | iteration == 500)
#results.raw %>% dplyr::count(seed) %>% View()

#Total number of individual simulations run
results.raw %>% dplyr::filter(parameter == "Nf") %>% dplyr::count(sampling.scheme, estimation.sim, sample.prop, scenario) %>% 
  summarize(sum(n))

#Count number of times the model failed to converge
results.raw %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(scenario) %>% 
  arrange(desc(n))

#Total percent of failed sims
results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  summarize(percent.failed = sum(failed)/((sum(failed) + sum(passed)))*100)
  

#Scenario-specific failure rates
results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  mutate(percent_failed = (failed/(failed+passed))*100) %>% 
  arrange(desc(percent_failed))

#What percent of convergence failures come from scenario2.3? This is the scenario with the diffuse prior on lambda
results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  mutate(percent_failed = (failed/(failed+passed))*100) %>% 
  arrange(desc(percent_failed)) %>% 
  summarize(total.failed = sum(failed),
            scenario2.3.failed = sum(failed[scenario %in% c("scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4")])) %>% 
  summarize(percent.failed.from.scenario2.3 = scenario2.3.failed/total.failed)

#Filter out instances that failed to converge
results <- results.raw %>% dplyr::filter(Rhat <= 1.01)
```


```{r check summary statistics}
results %>% dplyr::count(parameter)

results %>% group_by(parameter, scenario, sampling.scheme, estimation.sim) %>% 
  summarize(median.relative.bias = median(relative_bias)) %>% 
  dplyr::filter(parameter %in% c("Nf", "Nm", "survival")) %>% 
  print(n = 50)

#check out median relative bias by parameter, model, and estimation.sim for Nm and Nf
results %>% dplyr::filter(parameter %in% c("Nf", "Nm")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))

results %>% dplyr::filter(parameter %in% c("Nf", "Nm")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(percent.in.interval = (sum(in_interval == "Y")/n())*100) %>% 
  arrange(desc(percent.in.interval))

#check out median relative bias by parameter, model, and estimation.sim for survival and lambda
results %>% dplyr::filter(parameter %in% c("survival", "lambda")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))

results %>% dplyr::filter(parameter %in% c("survival", "lambda")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(percent.in.interval = (sum(in_interval == "Y")/n())*100) %>% 
  arrange(desc(percent.in.interval))

```


Format data for model validation (objective 1).
```{r Obj1 data format and analysis, echo=FALSE, out.width = "120%"}
colnames(results)
results %>% dplyr::count(sample.prop)

#Add columns to dataframe that are better suited for plot labels
obj1_results <- results %>% dplyr::filter(objective == "objective1") %>% 
  mutate(sample.prop.lab = ifelse(sample.prop == 0.5, "0.5% sampled", 
                                  ifelse(sample.prop == 1, "1.0% sampled",
                                         ifelse(sample.prop == 1.5, "1.5% sampled", 
                                                ifelse(sample.prop == 2, "2.0% sampled", NA))))) %>% 
  mutate(cv = (sd/mean) * 100) %>% 
  mutate(aunt.label = ifelse(scenario == "scenario_1.2.2", "Include aunt/niece",
                             ifelse(scenario == "scenario_1.2.3", "Filter aunt/niece by age", "No aunt/niece"))) %>% 
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA))))

obj1_results %>% dplyr::group_by(sample.prop.lab, sampling.scheme.label, parameter) %>% 
  summarize(n())


obj1_results %>% dplyr::count(sample.prop)

obj1_results %>% dplyr::count(imposters, scenario) %>% View()

obj1_results %>% group_by(scenario, sampling.scheme) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))





#-----------------------Prep samples-----------------------------
#Specify sample file and read in -- just use stable population growth for now. Age distribution of samples should be similar across the simulations.
sampFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/sample.info_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
samples.df_all <- readRDS(file = sampFile.stable)


#-----------------------Quick graph check to change as needed--------------------------
obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter == "survival") %>% 
  ggplot(aes(x = relative_bias,
             fill = sampling.scheme)) + 
  geom_density(alpha = 0.6) + 
  labs(x="Relative bias", y="Parameter") +
#  theme_ridges() + 
  facet_wrap(~sample.prop.lab) + 
  theme_bw() +
#  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(legend.position = "bottom")
```

```{r Obj 1 viz}

#Palette I want to use for Objective 1
brewer.pal.info #See different palette options from Rcolorbrewer
cp <- brewer.pal(3, "Set2") #Choose palette + number of colors
scales::show_col(cp)

##################################################################################
####################### Objective 1 Main Figure ##################################
##################################################################################
#-------------------Objective 1 Density plot of relative bias-------------------------#
fig2.a <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = sampling.scheme.label)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Parameter") +
#  theme_ridges() + 
  facet_wrap(~sample.prop.lab) + 
  theme_bw() +
  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "none")
  
  
fig2.a


#-------------------Objective 1 Violin plot of CV-------------------------#
fig2.b <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme.label))) +
  geom_violin(aes(y=cv), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="CV") +
  theme_bw() +
  scale_fill_manual(values = cp) +
  #ggtitle("B)") +
  facet_wrap(~sample.prop.lab) +
  theme() +
  scale_y_log10() +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "none")

fig2.b


#-------------------Objective 1 Density plot of HSPs-------------------------#
breaks.2c = seq(50, 400, by = 50)
labels.2c <- sprintf("%.0f", breaks.2c)
labels.2c[c(1, 3, 5, 7)] <- ""

fig2.c <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
  ggplot(aes(x = HSPs_detected, fill = sampling.scheme.label)) +
    geom_density(alpha = 0.6) + 
#    ggtitle("C)") + 
    labs(x = "HSPs") +
    theme_bw() + 
    ylab("Density") +
    scale_fill_manual(values = cp) +
    scale_color_manual(values = cp) +
    facet_wrap(~sample.prop.lab, scales = "free_y") + 
  scale_x_continuous(breaks = breaks.2c,
                     labels = labels.2c) +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.001)) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom")
  
  
fig2.c

#-------------------Objective 1 Density plot of POPs-------------------------#
fig2.d <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1",
                                         parameter != "survival") %>% 
  ggplot(aes(x = POPs_detected, fill = sampling.scheme.label)) +
    geom_density(alpha = 0.6) + 
    #ggtitle("D)") + 
    labs(x = "POPs") +
    theme_bw() + 
#    theme(legend.title = element_blank(), #For ggarrange
#          axis.title.y = element_blank()) + 
    scale_fill_manual(values = cp) +
    scale_color_manual(values = cp) +
      ylab("Density") +
    facet_wrap(~sample.prop.lab, scales = "free_y") +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

#Old theme   
# theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size = 15),
#         strip.text.y = element_text(size = 15),
#         legend.text = element_text(size = 15),
#         plot.title = element_text(size=25),
#         legend.title = element_blank(),
#           legend.position = "bottom")

fig2.d

#-------------------Combine Obj1 plots and save-------------------------#
ggarrange(fig2.a, fig2.b, fig2.c, fig2.d, common.legend = TRUE, nrow = 2, ncol = 2, legend = "bottom") #OK to ignore warnings; the first two are values > the x axis limit in 1A); the 7998 missing values are from plotting POPs

ggsave("Figure_2ALL_2023.09.14.tiff", plot = last_plot(), device = "tiff", dpi = 500, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 5000, height = 3000, units = "px")


##################################################################################
####################### Objective 1 Supplementary Figure(s) ######################
##################################################################################

#-------------------Aunt|uncle / niece|nephew comparison-------------------------#
#-------------------Relative bias w and w/o aunt/niece
p_aunt.niece.bias <- obj1_results %>% dplyr::filter(aunt.label != "No aunt/niece",
                               parameter == "Nf" | parameter == "Nm",
                               sample.prop == 2) %>% 
  mutate(aunt.label = factor(aunt.label, levels = c("Include aunt/niece", "Filter aunt/niece by age"))) %>% 
  ggplot(aes(x = relative_bias,
             fill = aunt.label)) + 
  geom_density(alpha = 0.7) + 
  labs(x="Relative bias", y="Density") +
#  theme_ridges() + 
  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme.label)) + 
  theme_bw() +
  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

p_aunt.niece.bias

#-------------------Plot of numbers of aunt/niece pairs in dataset
bin.num <- obj1_results %>% summarize(max(imposters, na.rm = TRUE))

p_aunt.niece.count <- obj1_results %>% dplyr::filter(aunt.label != "No aunt/niece",
                               parameter == "Nf",
                               imposters > 0) %>% 
  mutate(aunt.label = factor(aunt.label, levels = c("Include aunt/niece", "Filter aunt/niece by age"))) %>% 
  ggplot(aes(x = imposters,
             fill = aunt.label)) + 
  geom_histogram(alpha = 0.7, color = "black", binwidth = 1) + 
  labs(x="Number of aunt/nice pairs", y="Iterations") +
  facet_grid(rows = vars(sample.prop.lab), cols = vars(sampling.scheme.label)) + 
  theme_bw() +
#  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom")
  
p_aunt.niece.count

#-------------------Combine aunt/niece plots and save-------------------------#
ggarrange(p_aunt.niece.count, p_aunt.niece.bias, common.legend = TRUE, nrow = 2, legend = "bottom", heights = c(2, 1))

ggsave("SuppFig_aunt.niece_2023.09.14.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 3694, height = 2200, units = "px")


#-------------------Table for aunt/niece comparisons
obj1_results %>% dplyr::filter(aunt.label != "No aunt/niece",
                               sample.prop == 2) %>% 
  group_by(sampling.scheme, aunt.label) %>% 
  summarize(median.relative.bias = median(relative_bias),
            mean.imposters = round(mean(imposters, na.rm = TRUE), 0)) %>% 
  writexl::write_xlsx(path = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/aunt.niece_table.xlsx")

#-------------------Plot of numbers of full sibs in dataset
cp.sibs <- brewer.pal(3, "Spectral") #Choose palette + number of colors

p.full.sibs <- obj1_results %>% dplyr::filter(scenario == "scenario_1.2.1", parameter == "Nf") %>% 
  pivot_longer(cols = c(full.siblings, diff.cohort_full.siblings), names_to = "sib.years", values_to = "num.full.sibs") %>%
  ggplot(aes(fill = sib.years)) + 
  geom_histogram(aes(x = num.full.sibs), alpha = 0.7, color = "black", binwidth = 1, position = "identity") + 
  labs(x="Number of full siblings", y="Iterations") +
  facet_grid(rows = vars(sample.prop.lab), cols = vars(sampling.scheme.label)) + 
  theme_bw() +
#  xlim(-100, 100) +
  scale_fill_manual(values = cp.sibs[c(1, 3)], labels = c("different cohort", "all")) +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

p.full.sibs

#This might help if need different cohort and all full sibs in long format
#  pivot_longer(cols = c(full.siblings, diff.cohort_full.siblings), names_to = "sib.years", values_to = "num.full.sibs") %>% 
  # ggplot(aes(x = num.full.sibs,
  #            y = sib.years,
  #            fill = sampling.scheme.label)) + 
  # geom_density_ridges(alpha = 0.6) +

ggsave("SuppFig_FullSibs_2023.10.02.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw", width = 3694, height = 2200, units = "px")
```


Format data for tests of population growth (Objective 2)
```{r Obj2 analysis and dataframe prep}
#Need to recalculate truth for naive scenarios -- truth from simulation output was averaged, and we want year-specific truths.
truth.location <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/Obj2.truth/" #Location of population simulation output files

#Read in popsize dataframes that contain year-specific truth
obj2truth.slight.decline <- readRDS(paste0(truth.location, "pop.size_03Aug2023_Seeds2022.04.15_lambda.slight.decrease_annual.breeding")) %>% 
  mutate(population.growth = "slight decline")

obj2truth.slight.increase <- readRDS(paste0(truth.location, "pop.size_03Aug2023_Seeds2022.04.15_lambda.slight.increase_annual.breeding")) %>% 
  mutate(population.growth = "slight increase")

obj2truth.severe.decline <- readRDS(paste0(truth.location, "pop.size_03Aug2023_Seeds2022.04.15_lambda.extreme_annual.breeding")) %>% 
  mutate(population.growth = "severe decline")

#Combine into one dataframe
truth.obj2 <- bind_rows(obj2truth.slight.decline, obj2truth.slight.increase, obj2truth.severe.decline) %>% 
  mutate(population.growth = factor(population.growth, levels = c("stable", "slight increase", "slight decline", "severe decline"))) %>% 
  mutate(estimation.year = year)

#Set up vectors of population growth scenarios
slight_decline_scenarios <- c("scenario_2.1.1", "scenario_2.2.1", "scenario_2.3.1", "scenario_2.4.1")
slight_increase_scenarios <- c("scenario_2.1.2", "scenario_2.2.2", "scenario_2.3.2", "scenario_2.4.2")
severe_decline_scenarios <- c("scenario_2.1.3", "scenario_2.2.3", "scenario_2.3.3", "scenario_2.4.3")
stable_popgrowth_scenarios <- c("scenario_2.1.4", "scenario_2.2.4", "scenario_2.3.4", "scenario_2.4.4")

#Specify Conn scenarios
conn_scenarios <- c("scenario_2.4.1", "scenario_2.4.2", "scenario_2.4.3", "scenario_2.4.4")

#Set up vectors of lambda prior scenarios
no_lambda_scenarios <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4")
narrow_lambda_scenarios <- c("scenario_2.2.1", "scenario_2.2.2", "scenario_2.2.3", "scenario_2.2.4", "scenario_2.4.1", "scenario_2.4.2", "scenario_2.4.3", "scenario_2.4.4")
diffuse_lambda_scenarios <- c("scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4")

#Format data and give labels that are more amenable to plotting
obj2_results <- results.raw %>% dplyr::filter(objective == "objective2") %>% 
  mutate(population.growth = ifelse(scenario %in% stable_popgrowth_scenarios, "stable",
                                    ifelse(scenario %in% slight_decline_scenarios, "slight decline",
                                           ifelse(scenario %in% slight_increase_scenarios, "slight increase",
                                                  ifelse(scenario %in% severe_decline_scenarios, "severe decline", NA))))) %>% 
  mutate(model.label = ifelse(scenario %in% no_lambda_scenarios, "naive",
                              ifelse(scenario %in% narrow_lambda_scenarios, "adapted (narrow lambda prior)", 
                                     ifelse(scenario %in% diffuse_lambda_scenarios, "adapted (diffuse lambda prior)", NA)))) %>% 
  mutate(population.growth = factor(population.growth, levels = c("stable", "slight increase", "slight decline", "severe decline"))) %>%
    mutate(model.label = factor(model.label, levels = c("naive", "adapted (narrow lambda prior)", "adapted (diffuse lambda prior)"))) %>% 
  mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present"))) %>% 
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA))))

#Update truth values for naive scenarios to be year-specific rather than averages
obj2.naive.results.wrong.truth <- obj2_results %>% 
  dplyr::filter(model.label == "naive", 
                population.growth != "stable") %>% 
  mutate(surv.truth = all.truth) %>% 
  dplyr::select(-all.truth)

obj2.naive.results.right.truth <- truth.obj2 %>% 
  dplyr::filter(estimation.year %in% obj2.naive.results.wrong.truth$estimation.year) %>% 
  dplyr::select(Male.adult.pop, Female.adult.pop, estimation.year, iteration, population.growth)


obj2_results2 <- obj2.naive.results.wrong.truth %>%
  left_join(obj2.naive.results.right.truth, by = c("population.growth", "iteration", "estimation.year")) %>% 
  mutate(all.truth = ifelse(parameter == "Nf", Female.adult.pop,
                            ifelse(parameter == "Nm", Male.adult.pop, 
                                   ifelse(parameter == "survival", surv.truth, NA)))) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop)) %>% 
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1))
  
#Remove from obj2_results the results from scenarios with average truth values so they can be replaced with year-specific truths. All columns except for truth are the same.
obj2_results <- obj2_results %>% dplyr::filter(!scenario %in% c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3")) %>% 
  bind_rows(obj2_results2) %>% 
  mutate(model = ifelse(scenario %in% naive_scenarios, "naive", 
                        ifelse(scenario %in% conn_scenarios, "Conn", "adapted"))) %>% 
  mutate(model = factor(model, levels = c("naive", "adapted", "Conn"), labels = c("naive", "adapted", "Conn")))


#-----------Prep sample file for analysis of age distribution---------------------
#Just use stable population growth for now. Age distribution of samples should be similar across the simulations.
sampFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/sample.info_06Sep2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
samples.df_all <- readRDS(file = sampFile.stable)

#Occasionally there is a different ref.yr for sample.ALL.ages (77), but it's one year away from the dominant ref.yr (76) and there are only a few instances. It helps for visualization to make the same so there aren't two vertical lines in an upcoming plot.
#Also, apparently only saved ref.yr for the last iteration. It's fine for viz purposes, but that's why there are so many NAs.
samples.df_all %>% dplyr::count(ref.yr)

samples.df_all <- samples.df_all %>% 
   mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
  mutate(ref.yr = ifelse(sampling.scheme == "sample.ALL.ages" & is.na(ref.yr) == FALSE, 76, ref.yr))


#Get numbers of samples of each age class
(sample.ages <- samples.df_all %>% group_by(sampling.scheme, age.x) %>% summarize(number = n()))


#Make sure we have the right number of all scenarios
obj2_results %>% dplyr::count(scenario, sampling.scheme, model) %>% 
  print(n = 36)

#Results are more variable for the population decline scenario; it's bc there was more variation in the observed population growth. Check mean, sd, and range of lambda and survival truth
obj2_results %>% dplyr::filter(parameter %in% c("lambda", "survival")) %>% 
  group_by(population.growth, parameter) %>% 
  summarize(mean.truth = mean(all.truth),
            sd.truth = sd(all.truth),
            min.truth = min(all.truth),
            max.truth = max(all.truth)) %>% 
  mutate(truth.range = max.truth - min.truth) %>% 
  dplyr::select(population.growth,
                parameter,
                mean.truth, 
                sd.truth,
                truth.range) %>% 
  arrange(parameter, population.growth)

lambda.df <- readRDS(paste0(results_location, "lambda.df"))

#Get more precise variation in lambda
#Remove severe decline scenario bc survival was only changed for the last ten years of the simulation. So it gives mean values that are very similar to the slight decline scenario.
pop.size_all <- readRDS(paste0(results_location, "pop.size_all")) %>% 
  dplyr::filter(population.growth != "severe decline")

#Summarize mean adult and mean total lambda across all years and iterations
pop.size_all %>% group_by(population.growth, iteration) %>% 
  summarize(mean.adult.lambda_iteration = mean(adult.lambda, na.rm = TRUE),
            sd.adult.lambda_iteration = sd(adult.lambda, na.rm = TRUE),
            mean.total.lambda_iteration = mean(total.lambda, na.rm = TRUE),
            sd.total.lambda_iteration = sd(total.lambda, na.rm = TRUE)) %>% 
  group_by(population.growth) %>% 
  summarize(mean.adult.lambda = mean(mean.adult.lambda_iteration, na.rm = TRUE),
            sd.adult.lambda = sd(sd.adult.lambda_iteration, na.rm = TRUE),
            mean.total.lambda = mean(mean.total.lambda_iteration, na.rm = TRUE),
            sd.total.lambda = sd(sd.total.lambda_iteration, na.rm = TRUE))

#Add/edit Paul Conn simulations
#obj2_results <- obj2_results %>% mutate(model = ifelse(scenario %in% conn_scenarios, "Conn", model))

obj2_results <- obj2_results %>% mutate(parameter = ifelse(parameter == "Nft", "Nf",
                                           ifelse(parameter == "Nmt", "Nm",
                                                  parameter)))

#Check that Paul Conn's model registered appropriately
obj2_results %>% dplyr::count(scenario, model)
```

```{r Obj2 plots, echo=FALSE, out.width = "120%"}
colnames(results)
options(scipen = 100000)
  
#Palette I want to use
brewer.pal.info #See different palette options from Rcolorbrewer
cp2 <- brewer.pal(3, "RdYlBu") #Choose palette + number of colors
scales::show_col(cp2)

######################################################################################################### Objective 2 Main Figure ####################################################################################################################
#-------------------Objective 2 Density plots of relative bias-----------------------#
(fig3.1 <- obj2_results %>% dplyr::filter(parameter %in% c("Nf"),
                                          population.growth != "stable",
                                          scenario %in% c(no_lambda_scenarios, conn_scenarios, "scenario_2.2.1", "scenario_2.2.2", "scenario_2.3.3")) %>% #Added scenario filter so we only have one density plot per situation -- narrow prior for slight growth/decline and diffuse prior for severe decline.
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = model)) + #Changed TO model from model.label
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
  #theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp2, #Change to subset for red and blue if just doing two: [c(1,3)]
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw()) +
    theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        axis.text.y = element_text(colour = c("darkturquoise", "darkslategrey", "indianred4", "seagreen4"), 
                                   face = "bold"))

##Look at stable population growth
obj2_results %>% dplyr::filter(parameter %in% c("Nf"),
                                          population.growth == "stable") %>% #Added scenario filter so we only have one density plot per situation -- narrow prior for slight growth/decline and diffuse prior for severe decline.
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = model)) + #Changed TO model from model.label
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
  #theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp2, #Change to subset for red and blue if just doing two: [c(1,3)]
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw()) +
    theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        axis.text.y = element_text(colour = c("darkturquoise", "darkslategrey", "indianred4", "seagreen4"), 
                                   face = "bold"))

#Save each plot for Obj2 individually and combine in Affinity Designer
#ggsave("Figure_3.1_2023.09.14.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-------------------Histogram of ages-----------------------#
num.bins <- length(min(samples.df_all$birth.year):max(samples.df_all$birth.year))

age.dist_plot <- samples.df_all %>% gghistogram(x = "birth.year", bins = num.bins, facet.by = "sampling.scheme.label", color = "darkslategray4", fill = "darkslategray4", ggtheme = theme_bw()) +
  geom_vline(aes(xintercept= ref.yr), color = "darkslategrey", linetype = "longdash", size = 1.1) +
  geom_vline(aes(xintercept = ref.yr - 10), color = "darkturquoise", linetype = "longdash", size = 1.1, alpha = 0.6) +
  geom_vline(xintercept = 85, color = "indianred4", linetype = "longdash", size = 1.1, alpha = 0.6) +
  geom_vline(xintercept = 90, color = "seagreen4", linetype = "longdash", size = 1.1, alpha = 0.6) +
  scale_y_continuous(labels = label_comma(), expand = expansion(mult = c(0.01, .05))) +
  xlab("Birth year") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))

  
#Save each plot for Obj2 individually and combine in Affinity Designer
#ggsave("Fig2_age.dist_2023.09.14.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 6, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

      
##################################################################################
####################### Objective 2 Supplementary Figure(s) ######################
##################################################################################
#-------------------Plot of Lambda bias-----------------------#
obj2_results %>% dplyr::filter(parameter %in% c("lambda"),
                                          !scenario %in% c(no_lambda_scenarios, "scenario_2.2.3", "scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.4")) %>% #Added scenario filter so we only have one density plot for each situation. Want the situations to match up with Figure 3.
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = model)) + #Changed TO model from model.label
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
  labs(x="Relative bias", y="Estimation year") +
  facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp2[c(1,3)], #Changed to subset for red and blue 
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw() +
    theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20)) +
  ggtitle(expression(paste("Estimates of ", lambda)))

#ggsave("SuppFig_lambda_Obj2.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#-------------------Lambda comparison: avg vs indv-----------------------#
lambda.df %>% 
  ggplot(aes(x = factor(lambda.yrs), y = relative_bias, fill = factor(pop.growth))) +
# geom_violin(draw_quantiles = 0.5, position = position_dodge(0.75), width = 4) +
  #geom_violin(draw_quantiles = 0.5, width = 4) +
  geom_jitter(width = 0.2, aes(col = factor(pop.growth)), alpha = 0.5) +
  geom_boxplot() +
#  geom_hline(yintercept=0, col="black", size=1.25) +
  labs(x = "lambda years", y = "relative bias") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25),
        legend.title = element_blank())

#Scatter plot of exact relative bias
lambda.df %>% 
  ggplot(aes(x = factor(pop.growth), y = relative_bias, fill = factor(pop.growth))) + 
  geom_jitter() +
  facet_wrap(~lambda.yrs)


#-------------Compare total lambda vs adult lambda----------------
yr0 <- 1
yrs <- 90

pop.size_all <- pop.size_all %>% mutate(juv.pop.size = population_size - Total.adult.pop)

#Initialize df for saving values
adult.lam_90 = total.lam_90 = juv.lam_90 <- NULL


#NEED TO REFINE THIS 09/18/2023
for(pg in 1:4){
  pop.g.levels <- pop.size_all %>% distinct(population.growth) %>% pull(population.growth)
  
  pop.g <- pop.g.levels[pg]
  
  pop.g.df <- pop.size_all %>% dplyr::filter(population.growth == "pop.g")
    
for(i in 1:max(pop.size_all$iteration)){
  #Subset for iteration of interest
  iter <- pop.g.df %>% dplyr::filter(iteration == i)
  
  #Change calculation of lambda
  mean.adult.lam_90 <- (iter$Total.adult.pop[yrs]/iter$Total.adult.pop[1])^(1/(yrs - yr0))
  adult.lam_90 <- c(adult.lam_90, mean.adult.lam_90)

  mean.total.lam_90 <- (iter$population_size[yrs]/iter$population_size[1])^(1/(yrs - yr0))
  total.lam_90 <- c(total.lam_90, mean.total.lam_90)
  
  mean.juv.lam_90 <- (iter$juv.pop.size[yrs]/iter$juv.pop.size[1])^(1/(yrs - yr0))
  juv.lam_90 <- c(juv.lam_90, mean.juv.lam_90)
  
}

}


#Compare lambda for difference age classes
N90_lambda <- data.frame(total.lam_90, adult.lam_90, juv.lam_90) %>% 
  mutate(total_v_adult = total.lam_90 - adult.lam_90,
         total_v_juv = total.lam_90 - juv.lam_90,
         adult_v_juv = adult.lam_90 - juv.lam_90)

#Scatter plot
N90_lambda %>% pivot_longer(cols = c(total_v_adult, total_v_juv, adult_v_juv),
                            names_to = c("comparison"),
                            values_to = "difference") %>% 
  ggplot(aes(x = difference, y = factor(comparison), fill = factor(comparison))) +
  geom_jitter(aes(col = factor(comparison))) +
  geom_boxplot(alpha = 0.3)



```


Format data for tests of multiennial breeding (Objective 3)
```{r Obj3 data prep}
##################### Objective 3 ############################
#---------------------Prep results----------------------------
psi1_scenarios <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.5.1", "scenario_3.5.2", "scenario_3.7.1", "scenario_3.7.2")
psi1stoch_scenarios <- c("scenario_3.6.1", "scenario_3.6.2")
psi0.9_scenarios <- c("scenario_3.2.1", "scenario_3.2.2")
psi0.75_scenarios <- c("scenario_3.3.1", "scenario_3.3.2")
psi0.50_scenarios <- c("scenario_3.4.1", "scenario_3.4.2")

annual_scenarios <- c("scenario_3.7.1", "scenario_3.7.2")
biennial_scenarios <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2", "scenario_3.6.1", "scenario_3.6.2")
triennial_scenarios <- c("scenario_3.5.1", "scenario_3.5.2")

#Create labels for plotting
obj3_results <- results.raw %>% dplyr::filter(objective == "objective3") %>% 
  mutate(psi.label = ifelse(scenario %in% psi1_scenarios & !scenario %in% annual_scenarios, "1",
                            ifelse(scenario %in% psi1stoch_scenarios, "1*",
                                   ifelse(scenario %in% psi0.9_scenarios, "0.90",
                                          ifelse(scenario %in% psi0.75_scenarios, "0.75",
                                                 ifelse(scenario %in% psi0.50_scenarios, "0.50", 
                                                        ifelse(scenario %in% annual_scenarios, "0", NA))))))) %>%
  mutate(psi.label = factor(psi.label, levels = c("1", "1*", "0.90", "0.75", "0.50", "0"))) %>% 
  mutate(breeding.schedule = ifelse(scenario %in% annual_scenarios, "annual",
                                    ifelse(scenario %in% biennial_scenarios, "biennial", 
                                           ifelse(scenario %in% triennial_scenarios, "triennial", NA)))) %>% 
  mutate(model.label = ifelse(scenario %in% naive_scenarios, "annual", "multiennial")) %>% 
  #mutate(model.label = factor(model.label, levels = c("annual", "multiennial"))) %>% #Don't think we need this for plotting, but will leave commented just in case.
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
    mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present")))

#Check one scenario if desired
obj3_results %>% dplyr::filter(scenario == "scenario_3.6.2") %>% 
  dplyr::filter(parameter == "psi" | parameter == "Nf" | parameter == "Nfb1")

obj3_results %>% dplyr::filter(scenario %in% c("scenario_3.7.1", "scenario_3.7.2"), sampling.scheme == "sample.all.juvenile.ages",
                               iteration == 2,
                               estimation.sim == "T0") %>% 
  arrange(parameter) %>% 
  View()
```


```{r Obj3 Viz}
#Palette I want to use
cp3 <- brewer.pal(3, "RdBu") #Choose palette + number of colors
cp3.sub <- cp3[c(1,3)]
scales::show_col(cp3.sub)

######################################################################################################### Objective 3 Main Figure ####################################################################################################################
#-------------------Objective 3 Density plots of relative bias-----------------------#
(fig4a <- obj3_results %>% dplyr::filter(parameter == "Nf",
                                         breeding.schedule != "triennial",
                                         estimation.sim.label %in% c("T0", "present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(estimation.sim.label), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("a) Intermittent breeding")

ggsave("Figure_4a_2023.09.18.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#      ggsave("Figure_4a_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 6, units = "in")


##################################################################################
####################### Objective 3 Supplementary Figure(s) ######################
##################################################################################

#-------------------Plot of triennial breeding --------------------#  
(tri.fig <- obj3_results %>% dplyr::filter(parameter %in% c("Nf", "Nm", "survival", "lambda"),
                                         breeding.schedule == "triennial",
                                         estimation.sim.label %in% c("present")) %>%
   mutate(parameter = factor(parameter, levels = c("Nf", "Nm", "survival", "lambda"), labels = c("Nf", "Nm", "survival", "lambda"))) %>% 
  ggplot(aes(x=factor(model.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Model", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("Triennial breeding")

ggsave("SuppFig_triennial.breeding_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")



#-------------------Plot of Lambda bias-----------------------#
(figS3.lambda <- obj3_results %>% dplyr::filter(parameter %in% c("lambda"),
                                         breeding.schedule != "triennial",
                                         estimation.sim.label %in% c("T0", "present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(estimation.sim.label), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("Lambda")


ggsave("SuppFig_Lambda_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")



#-------------------Plot of survival bias-----------------------#
(figS3.survival <- obj3_results %>% dplyr::filter(parameter %in% c("survival"),
                                         breeding.schedule != "triennial",
                                         estimation.sim.label %in% c("T0", "present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(estimation.sim.label), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("Survival")


ggsave("SuppFig_survival_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#-------------------Plot of psi bias-----------------------#
      (figS3_psi <- obj3_results %>% dplyr::filter(parameter %in% c("psi"),
                                         breeding.schedule != "triennial",
                                         estimation.sim.label %in% c("T0", "present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_boxplot(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub[2]) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(estimation.sim.label), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.position = "none",
        plot.title = element_text(size=25)))



#-----------Plot of bias in Nfb, calculated in two ways -----------#
(figS3.Nfb <- obj3_results %>% dplyr::filter(parameter %in% c("Nfb1", "Nfb2"),
                                         breeding.schedule != "triennial",
                                         estimation.sim.label %in% c("present")) %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme.label), rows = vars(parameter), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("Survival")

ggsave("SuppFig_Nfb_Obj3.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 14, height = 6, units = "in", path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
```

```{r Obj4 data prep}
##################### Objective 4 ############################
#---------------------Prep results----------------------------
accurate.annual.scenario <- results.raw %>% dplyr::filter(scenario == "scenario_2.2.4") %>% #stable population growth with narrow prior
  mutate(scenario = "accurate.annual")
accurate.biennial.scenario <- results.raw %>% dplyr::filter(scenario == "scenario_3.1.2") %>% #stable population growth and biennial breeding/model
  mutate(scenario = "accurate.biennial")

cv5_scenarios <- c("scenario_4.1", "scenario_4.4")
cv10_scenarios <- c("scenario_4.2", "scenario_4.5")
cv20_scenarios <- c("scenario_4.3", "scenario_4.6")

annual_scenariosObj4 <- c("scenario_4.4", "scenario_4.5", "scenario_4.6", "accurate.annual")
biennial_scenariosObj4 <- c("scenario_4.1", "scenario_4.2", "scenario_4.3", "accurate.biennial")

obj4_results <- results.raw %>% dplyr::filter(objective == "objective4") %>% 
  bind_rows(accurate.annual.scenario, accurate.biennial.scenario)

obj4_results <- obj4_results %>% 
  mutate(model.label = ifelse(scenario %in% annual_scenariosObj4, "annual", "multiennial")) %>% 
  mutate(cv.label = ifelse(scenario %in% cv5_scenarios, "5% CV",
                           ifelse(scenario %in% cv10_scenarios, "10% CV",
                                  ifelse(scenario %in% cv20_scenarios, "20% CV",
                                         ifelse(scenario == "accurate.annual" | scenario == "accurate.biennial", "accurate", NA))))) %>% 
  #mutate(model.label = factor(model.label, levels = c("annual", "multiennial"))) %>% #Don't think we need this for plotting, but will leave commented just in case.
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
    mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present"))) %>% 
  mutate(cv.label = factor(cv.label, levels = c("accurate", "5% CV", "10% CV", "20% CV"), labels = c("accurate", "5% CV", "10% CV", "20% CV")))


#Apparently I only saved the last iteration of samples and only for the sample.ALL.ages scenario ... must overwrite in the script. For this supplemental figure, we can just use the figure from the first draft: haven't changed these simulations.
# obj4.samples_5cv <- readRDS(paste0(results_location, "samples/samples.missassigned_06Aug2023_Seeds2022.04.15_scenario_4.1_multiennial.model")) %>% mutate(age.cv = "5% CV")
# 
# obj4.samples_10cv <- readRDS(paste0(results_location, "samples/samples.missassigned_06Aug2023_Seeds2022.04.15_scenario_4.2_multiennial.model")) %>% mutate(age.cv = "10% CV")
# 
# obj4.samples_20cv <- readRDS(paste0(results_location, "samples/samples.missassigned_06Aug2023_Seeds2022.04.15_scenario_4.3_multiennial.model")) %>% mutate(age.cv = "20% CV")
# 
# obj4.samples <- bind_rows(obj4.samples_5cv, obj4.samples_10cv, obj4.samples_20cv) %>% 
#   mutate(age.cv = factor(age.cv, levels = c("5% CV", "10% CV", "20% CV"), labels = c("5% CV", "10% CV", "20% CV")))
```

```{r Obj4 Viz}
      #---------Objective 4-------------------------#
      #brewer.pal.info #See different palette options from Rcolorbrewer
      cp4 <- brewer.pal(3, "Paired") #Choose palette + number of colors
#scales::show_col(cp4)

##################################################################################
####################### Objective 4 Main Figure ##################################
##################################################################################
#-------------------Objective 4 Density plots of relative bias-----------------------#
      (fig4b <- obj4_results %>% dplyr::filter(parameter == "Nf" | parameter == "survival", estimation.sim.label == "T0") %>% 
  ggplot(aes(x=factor(cv.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Age-length uncertainty") +
  scale_fill_manual(values = cp4) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Population + model")) +
  ggtitle("b) Aging error")

ggsave("Figure_4b_aging.error_2023.09.18.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

##################################################################################
####################### Objective 4 Supplementary Figure(s) ##################################
##################################################################################
#---------------Von Bert and age misassignment --------------------
#Sept 14, 2023: I can use the same figure from before for the vonbert curve and age misassignment (previously Fig S5)      
#VonBert curve + ages misassigned
# ages <- 0:50
# vonBert <- vbFuns(param = "Typical")
# tmp <- growthFunShow("vonBertalanffy","Typical")
# 
# plot(vonBert(t = ages, Linf = 317.65, K = 0.057, t0 = -2.302), pch = 19, type = "b", main = tmp, ylab = "Length", xlab = "Age")
# 
# #Save previous plot manually
# 
#       #Graph 2: real age on x axis, misassigned age on y axis
# (figS5 <- obj4.samples %>%
#    mutate(age.cv = factor(age.cv, levels = c("5% CV", "10% CV", "20% CV"))) %>% 
#     mutate(sampling.scheme = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages",
#                                     ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", "target YOY"))) %>% 
#   ggplot(aes(x = yrs.off,
#              y = age.x)) + 
#   geom_jitter(alpha = 0.6) + 
#   labs(x="Years off", y="True age") +
#  # theme_ridges() + 
#   facet_grid(rows = vars(age.cv), cols = vars(sampling.scheme)) +
# #  xlim(-100, 100) +
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
#   theme_bw() +
#       theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15)))
# 
#       
#             ggsave("Figure_S5b_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#Graph 2: real age on x axis, misassigned age on y axis
# figs4.b <- obj4_samps %>% dplyr::filter(lambda.prior == "none") %>% #There aren't many individuals older than 25
#   ggplot(aes(x = yrs.off,
#              y = age.x)) + 
#   geom_jitter(alpha = 0.6) + 
#   labs(x="Years off", y="Age") +
#  # theme_ridges() + 
#   facet_wrap(~sampling.scheme) + 
#   facet_grid(rows = vars(miss.cv), cols = vars(sampling.scheme)) +
# #  xlim(-100, 100) +
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
#   scale_fill_manual(values = plot.colors.fig3) +
#   
# 
# figs4.b
# 
# ggarrange(figs4.a, figs4.b)

#ggsave("Figure_s4b_2022.09.26.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-------------------Lambda, Nm, and survival--------------------------
      
      (Obj4_supp.results <- obj4_results %>% dplyr::filter(parameter %in% c("Nm", "survival", "lambda"), estimation.sim.label == "present") %>% 
  ggplot(aes(x=factor(cv.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Age-length uncertainty") +
  scale_fill_manual(values = cp4) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Population + model")) +
  ggtitle("Aging error")
            

  ggsave("SuppFig_other.parameters_Obj4.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
  

```



PICK UP HERE AFTER 09/18/2023
```{r objective 5 viz}
###############################################################
############# Load lemon shark sim results and data ###########
###############################################################

#--------------Load lemon shark simulation results-----------#
lemonSim.files <- list.files(path = paste0(results_location),
                            recursive = FALSE,
                            pattern = "lemon_shark.*\\.csv$",
                            full.names = TRUE)

ls_dataSim <- map_dfr(lemonSim.files, read_csv) %>% 
  mutate(time_window = ifelse(time_window == "all samples", "all available", 
                              ifelse(estimation.yr - T0 == 1, "three year block",
                                      time_window))) %>%  #Had the wrong label for the three year block
  mutate(parameter = ifelse(parameter == "Nfb2", "Nfb", parameter))

ls_dataSim %>% dplyr::count(time_window)
ls_dataSim %>% dplyr::count(parameter)

#ls_dataSim <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/lemon_shark_time_series_sims.csv")


#--------------------Load lemon shark data estimates---------#
ls_dataFull <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/z_old_files/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.01.01_FullLitter_FullDataset_wLambda.csv") %>% 
  mutate(num.samps = num.samps_all) %>% 
  dplyr::select(-c(num.samps_all)) %>% 
  dplyr::filter(estimation_year >= 1997)

ls_data.Fulldown <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/z_old_files/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.01.01_FullLitter_DownsampledDataset_wLambda.csv") %>% 
  mutate(mom_HSPs = mom_HSPs.down,
         num.samps = num.samps_down) %>% 
  dplyr::select(-c(mom_HSPs.down, num.samps_down, num.samps_all, mom_HSPS.all)) %>%
  dplyr::filter(estimation_year >= 1997)


#One individual per litter - shows the same results as when using the full litter
 # ls_data <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.12.30_OneIndvPerLitter_wLambda.csv") %>% 
 #   mutate(num.samps = num.samps_all) %>% 
 #   dplyr::select(-c(num.samps_all))

#Five year intervals
ls_dataFive <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/z_old_files/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.01.01_FullLitter_FiveYearIntervals_wLambda.csv") %>% 
  mutate(num.samps = num.samps_all) %>% 
  dplyr::select(-c(num.samps_all)) %>% 
  dplyr::filter(estimation_year >= 1997)


# ls_data.Fivedown <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.12.30_FullLitter_FiveYearIntervals_Downsample_wLambda.csv") %>% 
#   mutate(mom_HSPs = mom_HSPs.down,
#          num.samps = num.samps_down) %>% 
#   dplyr::select(-c(mom_HSPs.down, num.samps_down, num.samps_all, mom_HSPS.all))


ls_data.full4viz <- ls_dataFull %>% dplyr::filter(estimation_year > 1996) %>% 
  mutate(Dataset = "Full")
ls_data.Fulldown4viz <- ls_data.Fulldown %>% dplyr::filter(estimation_year > 1996) %>% 
  mutate(Dataset = "Full | downsampled")

ls_data.five4viz <- ls_dataFive %>% dplyr::filter(estimation_year > 1996) %>% 
  mutate(Dataset = "Five year intervals")
# ls_data.Fivedown4viz <- ls_data.Fivedown %>% dplyr::filter(estimation_year > 1996) %>% 
#   mutate(Dataset = "Five year intervals | downsampled")

ls_data4viz <- bind_rows(ls_data.full4viz, 
                         ls_data.Fulldown4viz,
                         ls_data.five4viz) %>% 
  mutate(Dataset = factor(Dataset, levels = c("Full", "Full | downsampled", "Five year intervals")))

#------------------- Simulation figs --------------------------
brewer.pal.info #See different palette options from Rcolorbrewer
cp5 <- brewer.pal(3, "Dark2") #Choose palette + number of colors
cp5[4] <- "black"
scales::show_col(cp5)

#------- Box plot of relative bias for Nfb----------------#
ls_Nfb_boxplot <- ls_dataSim %>% dplyr::filter(parameter == "Nfb") %>% 
  ggplot(aes(x=factor(estimation.yr), fill = time_window)) +
  geom_boxplot(aes(y=relative_bias)) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Year") +
  scale_y_continuous(limits = c(-50, 200), breaks = c(-50, -25, 0, 25, 50, 75, 100, 125, 150, 175, 200)) +
  scale_fill_manual(values = cp5) +
  facet_wrap(~parameter, scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  guides(fill=guide_legend(title="Sample window"))

ls_Nfb_boxplot

  ggsave("LS_sim_boxplot.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
  
#Can try bringing in pop_size_tibble and plotting mean pop_size for each plotted year to show how abundance rose and fell in the sims.

#------- Box plot of relative bias for other parameters ----------------#
ls_supp_boxplot <- ls_dataSim %>% dplyr::filter(parameter %in% c("Nfb", "Nm")) %>% 
  ggplot(aes(x=factor(estimation.yr), fill = time_window)) +
  geom_boxplot(aes(y=relative_bias)) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Year") +
    scale_y_continuous(limits = c(-50, 200), breaks = c(-50, -25, 0, 25, 50, 75, 100, 125, 150, 175, 200)) +
  scale_fill_manual(values = cp5) +
  facet_wrap(~parameter, scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  guides(fill=guide_legend(title="Population + model"))

ls_supp_boxplot

#-------Single iteration abundance trend----------------#
(iter <- sample(c(1:91, 93:101), size = 1)) #Iteration 16 is a good one for visualization

ls_estimatesSim <- ls_dataSim %>% pivot_longer(cols = c(Q50, all.truth), names_to = "type", values_to = "estimate") %>% 
  dplyr::filter(type == "Q50",
                iteration == iter)

ls_truthSim <- ls_dataSim %>% pivot_longer(cols = c(Q50, all.truth), names_to = "type", values_to = "estimate") %>% 
  dplyr::filter(type == "all.truth",
                iteration == iter) %>%
  dplyr::select(parameter, truth = estimate, estimation.year, type, time_window) %>% 
  mutate(type = ifelse(parameter %in% c("Nf", "Nm", "Nfb1", "Nfb2", "psi"), "truth",
                       ifelse(time_window == "all samples", "truth: all samples",
                       ifelse(time_window == "five year block", "truth: five year block", NA))))

ls_truthSim.abund <- ls_truthSim %>% dplyr::filter(parameter %in% c("Nf", "Nm", "Nfb2"))

ls_truthSim.otherParams <- ls_truthSim %>% dplyr::filter(parameter %in% c("survival", "lambda"))

#Show abundance estimates first
fig5sim <- ls_estimatesSim %>% dplyr::filter(iteration == iter,
                                             parameter %in% c("Nf", "Nm", "Nfb2")) %>% 
  ggplot(aes(x = estimation.year, 
             y = estimate,
             color = time_window)) +
  geom_pointrange(aes(ymin = HPD2.5, 
                      ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "gam", 
              se = FALSE, 
              aes(linetype = time_window)) +
  geom_line(data = ls_truthSim.abund,
            aes(y = truth, 
                color = type),
            size = 1) +
  facet_wrap(~parameter, 
             scales = "free") +
  theme_bw() +
#  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(name = "Time window", values = cp5) +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  guides(linetype = "none") #Can decide what to keep or remove from legend with this

fig5sim

ggsave("LemonSharkSimFig.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#Now show estimates of other parameters
cp5.2 <- c("firebrick1", "dodgerblue", "firebrick4", "dodgerblue4") #Choose palette + number of colors

suppfig_LSsim_otherParams <- ls_estimatesSim %>% dplyr::filter(iteration == iter,
                                             parameter %in% c("survival", "lambda")) %>% 
  ggplot(aes(x = estimation.year, 
             y = estimate,
             color = time_window)) +
  geom_pointrange(aes(ymin = HPD2.5, 
                      ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "gam", 
              se = FALSE, 
              linetype = "dashed") +
  geom_line(data = ls_truthSim.otherParams,
            aes(y = truth, 
                color = type),
            size = 1) +
  facet_wrap(~parameter, 
             scales = "free") +
  theme_bw() +
#  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(name = "Time window", values = cp5.2) +
#  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25)) +
  guides(linetype = "none") #Can decide what to keep or remove from legend with this

suppfig_LSsim_otherParams

ggsave("LemonSharkSim_SuppFig.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 8, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")









#---------------------LEMON SHARK DATA-----------------
fig5a <- ls_data4viz %>% 
  dplyr::filter(parameter == "Nfb2") %>%
  ggplot(aes(x = estimation_year, y = Q50, color = Dataset)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "gam", se = FALSE, aes(linetype = Dataset)) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(values = cp5) +
  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))

fig5a

#ggsave("Figure_5a_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-----------------------Fig5b: Survival------------------------------------#
fig5b <- ls_data4viz %>% 
  dplyr::filter(parameter == "survival") %>%
  ggplot(aes(x = estimation_year, y = Q50, color = Dataset)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5, group = Dataset),
                  position = position_dodge(width = 1)) +
  geom_smooth(method = "gam", se = FALSE, aes(linetype = Dataset)) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  ylim(0.5, 1) +
  labs(x = "Estimation year", y = "Survival") +
  ggtitle("b)") +
  scale_color_manual(values = cp5) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))

fig5b

#ggsave("Figure_5b_2022.12.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

ggarrange(fig5a, fig5b, common.legend = TRUE, legend = "bottom")

ggsave("Figure_5_2023.01.02.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 12, height = 6, units = "in")


#Make table of full dataset and downsampled dataset results
#Start with bind rows bc it's before converting Dataset to a factor
table4 <- bind_rows(ls_data.full4viz, ls_data.Fulldown4viz, ls_data.five4viz) %>%
  dplyr::filter(parameter == "Nfb2") %>% 
  mutate(HPDI = paste0("(", round(HPD2.5, 0)," - ", round(HPD97.5, 0), ")")) %>%
  dplyr::select(Median = Q50,
                HPDI,
                `Estimation year` = estimation_year,
                `Number of samples` = num.samps,
                `Mom HSPs` = mom_HSPs,
                Dataset)

write_csv(table4, file = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/tables/table4_2023.01.02.csv")
```



```{r potential supplementary tables and graphs}
MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/"

#----------------------- Cross-correlation --------------------------
pop.growth_all <- readRDS(file = paste0(MCMC_location, "cross.corr_pop.growth_all_20230919"))
multiennial.model_all <- readRDS(file = paste0(MCMC_location, "cross.corr_multiennial.model_all_20230919"))

cross.corr_all <- bind_rows(pop.growth_all, multiennial.model_all) %>% 
  as_tibble()

cross.corr_all %>% dplyr::filter(scenario == "scenario_3.1.2", parameter == "survival")


```













```{r calculate relative bias and % in HPDI}
#To get this in the table, I ran the script and then manually translated over the to table in Word. Perhaps there's a way I can just export this to a CSV file and copy and paste ... 
#Check percent in interval; can change proportion sampled
obj1_results %>% dplyr::filter(prop.sampled == 1.5) %>% 
  dplyr::filter(survival.prior == "informed", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, prop.sampled) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#-------------Objective 2 --------------------#
#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj2_results <- obj2_results %>% dplyr::filter(Rhat < 1.01)

#2.1 - slight population decline; tight prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "slight decline", lambda.prior == "tight (0.95 - 1.05)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 - slight population growth; tight prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "slight increase", lambda.prior == "tight (0.95 - 1.05)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.3 - severe population decline; diffuse prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "severe decline", lambda.prior == "diffuse (0.80 - 1.20)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)



#3.1: psi = 1
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 1, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.2: psi = 0.90
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.9, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.2: psi = 0.75
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.75, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.4: psi = 0.50
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.5, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.5: mating periodicity = 3; psi = 1
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 1, parameter == "Nf", model == "multiennial", mating.periodicity == 3) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.6: psi = 1*
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == "1*", parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.1: 5% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "5% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.1: 5% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "5% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#4.2: 10% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "10% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.2: 10% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "10% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#4.3: 20% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "20% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.3: 20% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "20% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

```




```{r Supplementary calculations}
#2.1 naive - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#2.1 naive - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#Mean realized lambda 
obj2_results %>% dplyr::filter(population.growth == "severe decline",
                               est.yr == 85,
                               sampling.scheme == "target YOY",
                               lambda.prior == "diffuse (0.80 - 1.20)",
                               parameter == "lambda") %>% 
  summarize(mean(all.truth))

```






```{r Obj3 supplementary calculations}
#------------------------------------calculate average lambda over last 10 years------------------#
#Lambda should be the same for the parameters, sampling schemes, and lambda.prior, so just select one of each
obj3_results %>% dplyr::filter(parameter == "Nf", 
                                   sampling.scheme == "sample all juveniles",
                               est.yr == 85,
                               mating.periodicity == 3,
                               model == "multiennial") %>% 
  group_by(popsim.psi) %>% 
  summarize(mean.lam = mean(mean.adult.lambda_last.10),
            sd.lam = sd(mean.adult.lambda))



#-------------------------------------compare Ben and Liz viz----------------------------#
plot.colors.fig3 <- c("lightslateblue", "lightblue1", "darkslateblue", "aquamarine")
scales::show_col(plot.colors.fig3)

obj3_results.all <- bind_rows(obj3_results.ben, obj3_results.liz) %>% 
  dplyr::filter(psi.prior == "uniform",
                sim.psi == 1,
                lambda.prior == "none")


#-------------------Compare Ben and Liz models-------------------------#
#Abundance
obj3_results.all %>% dplyr::filter(parameter != "psi") %>% 
ggplot(aes(x=factor(parameter), fill = factor(model_used))) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="Relative bias") +
  scale_fill_manual(values = plot.colors.fig3) +
#  ggtitle("B)") +
#  ylim(-100, 100) +
  facet_grid(rows = vars(sampling.scheme), cols = vars(parameter), scales = "free") +
  #facet_wrap(~sampling.scheme) +
  theme(legend.title = element_blank())



#------------------------------Visualize Ben's estimates of psi-----------------
obj3_results.ben %>% dplyr::filter(psi.prior == "uniform") %>% 
  ggplot(aes(x = relative_bias,
             y = factor(sim.psi), 
             fill = factor(sim.psi))) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="non conformists") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = plot.colors.fig3, 
                    name = "simulation psi") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05)))


obj3_results %>% dplyr::filter(parameter %in% c("Nf", "Nm", "survival"),
                                         lambda.prior == "tight",
                                         model == "adapted") %>% 
  ggplot(aes(x = relative_bias,
             y = non.conformists, 
             fill = psi.prior)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="non conformists") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme)) +
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = plot.colors.fig3, 
                    name = "psi prior") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05)))


```


```{r Old code}
####OLD CODE
#Get pedigree info for aunt/niece ID -- don't think I need this anymore (09/06/2023). Had to identify them in the population simulations.
# rentFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/parents.breakdown_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"

# samples.test <- samples.df_all %>% dplyr::filter(sampling.scheme == "sample.ALL.ages", 
#                                  sample.prop == 1.5,
#                                  iteration > 490) %>%
#   distinct(indv.name, .keep_all = TRUE) #Remove individual recaptures or they'll be identified as full sibs below
# 
# #store parents of full siblings
# (sib.rents <- samples.test %>% 
#   group_by(mother.x, father.x) %>% 
#   summarize(n = n()) %>% 
#   dplyr::filter(n > 1) %>% 
#   arrange(desc(n)))
# 
# #Filter sample dataframe to only include sampled full sibs
# full.sibs.df <- samples.test %>% dplyr::filter(mother.x %in% sib.rents$mother.x & father.x %in% sib.rents$father.x)
# 
# #Now, let's see if any of these individuals had sampled offspring
# samples.test %>% dplyr::filter((mother.x %in% full.sibs.df$indv.name | father.x %in% full.sibs.df$indv.name))
# 
# full.sibs.df %>% inner_join(full.sibs.df, by = c("mother.x", "father.x")) %>% 
#   dplyr::filter(indv.name.x != indv.name.y) %>% 
#   dplyr::select(put.aunt.1 = indv.name.x, put.aunt.2 = indv.name.y) #Note it says aunt but could be uncle as well

#The code below helped me realize there are individual recaptures that register as full sibs to this point IF WE DON'T remove duplicate individuals (which we now do)
# full.sibs.df %>% inner_join(full.sibs.df, by = c("mother.x", "father.x")) %>% 
#   dplyr::filter(mother.x == sib.rents$mother.x[1] & father.x == sib.rents$father.x[1]) %>% 
#   dplyr::select(indv.name.x, indv.name.y, capture.year.x, capture.year.y)



```












```{r Obj2.make-Density-Plots, echo=FALSE, include=FALSE}
#Density plot for Nf
# (obj1.fig.Nf <- obj1_results %>% dplyr::filter(parameter == "Nf",
#                                               survival.prior == "diffuse") %>% 
#     ggplot(aes(x = relative_bias, color = sampling.scheme, fill = sampling.scheme)) +
#     geom_density(alpha = 0.6) + 
#     ggtitle("A) Nf") + 
#     labs(x = "Relative bias of posterior median") +
#     geom_vline(xintercept=c(0), linetype="dotted") +
#     theme_bw() + 
#     theme(legend.title = element_blank()) + 
#     scale_fill_manual(values = plot.colors.fig1) +
#     scale_color_manual(values = plot.colors.fig1) +
#     facet_wrap(~prop.sampled) +
#     xlim(-100, 100))

#-------------------Objective 2 Density plots-------------------------#
#Target YOY
obj2.YOY.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
  scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.YOY.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
    mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.YOY.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.YOY.plots <- ggarrange(obj2.YOY.p1, obj2.YOY.p2, obj2.YOY.p3, common.legend = TRUE, nrow = 3, legend = "bottom")



#Sample all juvenile ages
obj2.juvs.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.juvs.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.juvs.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.juv.plots <- ggarrange(obj2.juvs.p1, obj2.juvs.p2, obj2.juvs.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


#Sample ALL age classes
obj2.allages.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.allages.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.allages.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.allages.plots <- ggarrange(obj2.allages.p1, obj2.allages.p2, obj2.allages.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


# (fig1.p1.violin <- obj1_results %>% 
#   ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme))) +
#   geom_violin(aes(y=cv), draw_quantiles = 0.5) +
#   #ylim(-50, 160) +
#   geom_hline(yintercept=0, col="black", size=1.25) +
#   #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
#   labs(x="Parameter", y="CV", title="D) CV") +
#   scale_fill_manual(values = plot.colors.fig1) +
#   font("title", size = 10, face = "bold")) +
#   facet_wrap(~prop.sampled) +
#   theme(legend.title = element_blank())


```
\
\
The next graphs are examining how the model performs when population growth is positive, negative or neutral, comparing one model that accounts for this with a prior for lambda (uniform(0.95, 1.05)) and one that does not. In each case, the truth used to calculate relative bias is a specific year (vs the mean in model validation).
\
First, with targeted sampling of young-of-year, it looks like the model actually performs *worse* with lambda when the year of estimation is 10 years in the past. At 5 years past and present, the two appear to perform equivalently, suggesting that if limited population growth is expected, with targeted sampling of YOY at least, there's no real reason to include lambda in the model.
```{r Obj2.YOY-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.YOY.plots, top = text_grob("Target young-of-year", size = 14, face = "bold"))
```
\
\
The results are similar when all juvenile age classes are sampled, except estimates 10 years in the past are more accurate than with targeted sampling of young-of-year. This is likely a consequence of having more age classes over which to estimate survival and lambda.
```{r Obj2.juv-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.juv.plots, top = text_grob("Sample all juvenile ages", size = 14, face = "bold"))
```
\
\
The best performing model is the model that samples across age classes and includes parent-offspring pairs, as expected. Here, the model performs better with a diffuse prior on lambda than when lambda is not included.
```{r Obj2.allages-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.allages.plots, top = text_grob("sample all age classes", size = 14, face = "bold"))
```





Notes to self:
Objective 1: What drives bias when kin pairs match expectations?
Inconclusive so far (07/19/2022). I should return to this later
```{r, echo=FALSE, include=FALSE}
# obj1_results %>% dplyr::filter(HSPs_detected == HSPs_expected & sampling.scheme != "sample all age classes" & survival.prior == "diffuse") %>% 
#   dplyr::arrange(iteration) %>% 
#   dplyr::select(parameter, prop.sampled, iteration, sampling.scheme, relative_bias, survival.prior, HSPs_expected, HSPs_detected) %>% 
#   View()
# 
# mom_comps <- readRDS(paste0(obj1.2_results_location, mom.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# dad_comps <- readRDS(paste0(obj1.2_results_location, dad.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# plot.colors.fig1 <- c("aquamarine4", "indianred1", "indianred4")
# scales::show_col(plot.colors.fig1)
# 
# #Split "yes" up into separate rows so we can make a histogram of mort years
# mom_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)
# 
# dad_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)

#Interesting iterations: not bad bias
#iteration 36 (not bad bias): all parameters, 1_prop_sampled, sample_all_juvenile_ages;
#Nf, iteration_21, 1.0_prop_sampled, sample_all_juvenile_ages
#survival: iteration_28, 2.0_prop_sampled, sample_all_juvenile_ages
#Bad bias
##iteration 85 all parameters: 0.5_prop_sampled, sample_all_juvenile_ages;
#other bad biases: Nf, iteration 44, 1.0_prop_sampled, sample_all_juvenile_ages


```

Things to tackle next:
1. Objective 1: Look into the number of individual parents that are sampled in the initial model validation runs to see if we are oversampling some parents, particularly with targeted sampling of YOY.

```{r xtra/old code}
# plot.colors.figS1 <- c("lightblue1", "indianred3")
# scales::show_col(plot.colors.figS1)

# (figS1a <- obj2_results %>% dplyr::filter(parameter %in% c("lambda", "survival"),
#                                          lambda.prior == "diffuse (0.80 - 1.20)") %>% 
#   ggplot(aes(x = relative_bias,
#              y = est.yr.lab, 
#              fill = sampling.scheme)) + 
#   geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#   labs(x="Relative bias", y="Estimation year") +
# #  theme_ridges() + 
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
# #  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme)) +
#   facet_wrap(~parameter) +
#    theme(strip.text = element_text(size = 15),
#          legend.position = "bottom",
#          legend.title = element_blank(),
#          legend.text = element_text(size = 15),
#          axis.text = element_text(size = 15),
#          axis.title = element_text(size = 20)) +
#   #       axis.title.y = element_blank(),
#   #       axis.text.y = element_blank(),
#   #       axis.ticks.y = element_blank()) + 
#   scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
#   #xlim(-100, 200) +
#   scale_fill_manual(values = cp))


#SURVIVAL PLOT
# obj2_results %>% dplyr::filter(parameter %in% c("survival")) %>% #Added scenario filter so we don't have one density plot per lambda prior
#   ggplot(aes(x = relative_bias,
#              y = estimation.sim.label, 
#              fill = model.label)) + #Changed TO model from model.label
#   geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#   labs(x="Relative bias", y="Estimation year") +
# #  theme_ridges() + 
#   #facet_wrap(~sampling.scheme) + 
#   facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
#   #theme(strip.text.y = element_blank()) + 
#   #xlim(-100, 100) +
#   geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
#   scale_fill_manual(values = cp2, #Changed to subset for red and blue 
#                     name = "Model") +
#   scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
#     theme_bw() +
#     theme(axis.text = element_text(size = 12),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20)) +
#   ggtitle("Estimates of survival")

#ggsave("Figure_S1_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")



#Prep dataframe with percent of lambda estimates that were correct in each direction
#UPDATE Sept 14, 2023: Don't think I'll include this figure
# lambda.df <- obj2_results %>% dplyr::filter(parameter == "lambda",
#                                             scenario %in% narrow_lambda_scenarios) %>% 
#   mutate(status = ifelse(all.truth < 1 & Q50 < 1, "correct",
#                          ifelse(all.truth < 1 & Q50 > 1, "incorrect",
#                                 ifelse(all.truth > 1 & Q50 > 1, "correct", 
#                                        ifelse(all.truth > 1 & Q50 < 1, "incorrect",
#                                               ifelse(all.truth == 1, "whatevs", NA)))))) %>% #Some true values of lambda are 1 - don't want to use these
#   dplyr::filter(status != "whatevs", estimation.sim %in% c("T0", "present")) %>% 
#   group_by(population.growth, estimation.sim, sampling.scheme) %>% dplyr::summarize(percent.correct = round(sum(status == "correct")/n(), 1)) %>% 
#   mutate(percent.wrong = 1 - percent.correct)
# 
# #Prepare dataframe for plotting by pivoting
# lambda.df4plot <- lambda.df %>% dplyr::rename(correct = percent.correct, wrong = percent.wrong) %>% 
#   pivot_longer(cols = c(correct, wrong), names_to = "status", values_to = "percent_summ") %>% 
#   mutate(percent.label = paste0(percent_summ*100), "%")

#-------------------Plot of Lambda direction-----------------------#
#Sept 14, 2023: Think I'll leave this figure out ... 
#How often did the model predict the direction of lambda correctly? 
# plot.colors.fig3.2 <- c("tomato3", "steelblue2")
# scales::show_col(plot.colors.fig3.2)
# 
# (Supp_lambda.direction <- lambda.df4plot %>% 
#     dplyr::mutate(status = factor(status, levels = c("wrong", "correct"), labels = c("incorrect", "correct"))) %>% 
#   ggplot(aes(x = estimation.sim,
#              y = percent_summ, 
#              fill = status,
#              pattern = estimation.sim)) + 
#   geom_bar(position = "stack", 
#            stat = "identity", 
#            color = "black") +
#     geom_text(aes(label = percent.label),
#                   size = 4, 
#               fontface = "bold",
#             position = position_stack(vjust = 0.5)) +
#   facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme)) +
#     labs(x="\nEstimation year", y="Percent") +
#     #This adjusts the x axis labels to stagger them. "points" is the unit by which to stagger, but could use others e.g. cm, in, etc.
#     #theme(axis.text.x = element_text(vjust = grid::unit(c(-1, 0, 1), "points"))) +
# #  facet_wrap(~sampling.scheme) +
#   #xlim(-100, 200) +
#   scale_fill_manual(values = plot.colors.fig3.2)) +
#   theme_bw() +
#     theme(axis.text = element_text(size = 15),
#         axis.title = element_text(size = 20),
#         strip.text.x = element_text(size=15),
#         strip.text.y = element_text(size=15),
#         legend.text = element_text(size = 15),
#         legend.title = element_blank())


#ggsave("Figure_S2_2022.12.16.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 9, units = "in")

```