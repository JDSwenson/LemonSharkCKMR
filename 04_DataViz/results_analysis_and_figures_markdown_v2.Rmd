---
title: "CKMR results 07/21/2022"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 3
    fig_caption: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(scales)
library(ggridges)
library(ggpattern)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

```


```{r set-file-locations and read in files, include = FALSE}
#------------- Simulation parameters and labels  ----------------#
MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/output_peer_review/Model.results/"

results.files <- list.files(path = paste0(results_location),
                            recursive = FALSE,
                            pattern = "*.csv",
                            full.names = TRUE)

results.raw <- map_dfr(results.files, read_csv, guess_max = 30000) #Have to specify guess_max or else the function will guess column type using the first 1,000 columns and assume the POP columns are logical (bc the first several thousand are NA)

naive_scenarios <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4", "scenario_3.1.1", "scenario_3.2.1", "scenario_3.3.1", "scenario_3.4.1", "scenario_3.5.1", "scenario_3.6.1", "scenario_3.7.1") #Note that scenario 3.7.1 is not technically "naive", but for the test it was used for it is. So we will label it as such, and this label will be used later when we label it as an annual model in graphs for Objective 3.

objective1 <- c("scenario_1_model.validation", "scenario_1.2.1", "scenario_1.2.2", "scenario_1.2.3")
objective2 <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4", "scenario_2.2.1", "scenario_2.2.2", "scenario_2.2.3", "scenario_2.2.4", "scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4")
objective3 <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2", "scenario_3.5.1", "scenario_3.5.2", "scenario_3.6.1", "scenario_3.6.2", "scenario_3.7.1", "scenario_3.7.2")
objective4 <- c("scenario_4.1", "scenario_4.2", "scenario_4.3", "scenario_4.4", "scenario_4.5", "scenario_4.6")

results.raw <- results.raw %>% mutate(model = ifelse(scenario %in% naive_scenarios, "naive", "adapted")) %>% 
  mutate(objective = ifelse(scenario %in% objective1, "objective1", 
                            ifelse(scenario %in% objective2, "objective2",
                                   ifelse(scenario %in% objective3, "objective3", 
                                          ifelse(scenario %in% objective4, "objective4", NA)))))


```

```{r double-check columns and look for NAs, include = FALSE}
colnames(results.raw)

#Check to make sure we have an appropriate number of simulations and minimal NAs
results.raw %>% dplyr::count(sampling.scheme)
results.raw %>% dplyr::count(estimation.year)
results.raw %>% dplyr::count(sample.prop)
results.raw %>% dplyr::count(sampling.scheme)
results.raw %>% dplyr::count(estimation.sim)
results.raw %>% dplyr::count(is.na(relative_bias))
results.raw %>% dplyr::count(scenario) %>% View()
results.raw %>% dplyr::filter(scenario == "scenario_1_model.validation") %>% 
  count(estimation.sim)
results.raw %>% dplyr::count(scenario)
results.raw %>% dplyr::count(objective)
results.raw %>% dplyr::count(iteration) %>% View()
#results.raw %>% dplyr::count(seed) %>% View()

#Count number of times the model failed to converge
results.raw %>% dplyr::filter(Rhat > 1.01) %>% 
  dplyr::count(scenario) %>% 
  arrange(desc(n)) %>% 
  View()

results.raw %>% group_by(scenario) %>% 
  summarize(failed = sum(Rhat > 1.01), 
            passed = sum(Rhat <= 1.01)) %>% 
  mutate(percent_failed = (failed/(failed+passed))*100) %>% 
  arrange(desc(percent_failed))

#Filter out instances that failed to converge
results <- results.raw %>% dplyr::filter(Rhat <= 1.01)
```


```{r check summary statistics}
results %>% dplyr::count(parameter)

results %>% group_by(parameter, scenario, sampling.scheme, estimation.sim) %>% 
  summarize(median(relative_bias)) %>% 
  dplyr::filter(parameter %in% c("Nf", "Nm", "survival"))

#check out median relative bias by parameter, model, and estimation.sim for Nm and Nf
results %>% dplyr::filter(parameter %in% c("Nf", "Nm")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))

results %>% dplyr::filter(parameter %in% c("Nf", "Nm")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(percent.in.interval = (sum(in_interval == "Y")/n())*100) %>% 
  arrange(desc(percent.in.interval))

#check out median relative bias by parameter, model, and estimation.sim for survival and lambda
results %>% dplyr::filter(parameter %in% c("survival", "lambda")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(median_rel.bias = median(relative_bias)) %>% 
  arrange(desc(median_rel.bias))

results %>% dplyr::filter(parameter %in% c("survival", "lambda")) %>%
  group_by(parameter, model, estimation.sim) %>% 
  summarize(percent.in.interval = (sum(in_interval == "Y")/n())*100) %>% 
  arrange(desc(percent.in.interval))

```


This is the initial model validation graph, where lambda was approximately stable in the population simulations and the model didn't include lambda, but rather averaged over abundance values.
Still need to bring in aunt-niece pairs (09/06/2023)


```{r Obj1 data format and analysis, echo=FALSE, out.width = "120%"}
colnames(results)
results %>% dplyr::count(sample.prop)

obj1_results <- results %>% dplyr::filter(objective == "objective1") %>% 
  mutate(sample.prop.lab = ifelse(sample.prop == 0.5, "0.5% sampled", 
                                  ifelse(sample.prop == 1, "1.0% sampled",
                                         ifelse(sample.prop == 1.5, "1.5% sampled", 
                                                ifelse(sample.prop == 2, "2.0% sampled", NA))))) %>% 
  mutate(cv = (sd/mean) * 100)

obj1_results %>% dplyr::group_by(sample.prop.lab, sampling.scheme, parameter) %>% 
  summarize(n())

#-----------------------Prep samples-----------------------------
#Specify sample file and read in -- just use stable population growth for now. Age distribution of samples should be similar across the simulations.

#CHANGE this once the new population simulation finishes running from Sept 6, 2023. Mainly just need to change the simulation date.
sampFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/sample.info_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
samples.df_all <- readRDS(file = sampFile.stable)


#Get pedigree info for aunt/niece ID -- don't think I need this anymore (09/06/2023). Had to identify them in the population simulations.
# rentFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/parents.breakdown_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"

# samples.test <- samples.df_all %>% dplyr::filter(sampling.scheme == "sample.ALL.ages", 
#                                  sample.prop == 1.5,
#                                  iteration > 490) %>%
#   distinct(indv.name, .keep_all = TRUE) #Remove individual recaptures or they'll be identified as full sibs below
# 
# #store parents of full siblings
# (sib.rents <- samples.test %>% 
#   group_by(mother.x, father.x) %>% 
#   summarize(n = n()) %>% 
#   dplyr::filter(n > 1) %>% 
#   arrange(desc(n)))
# 
# #Filter sample dataframe to only include sampled full sibs
# full.sibs.df <- samples.test %>% dplyr::filter(mother.x %in% sib.rents$mother.x & father.x %in% sib.rents$father.x)
# 
# #Now, let's see if any of these individuals had sampled offspring
# samples.test %>% dplyr::filter((mother.x %in% full.sibs.df$indv.name | father.x %in% full.sibs.df$indv.name))
# 
# full.sibs.df %>% inner_join(full.sibs.df, by = c("mother.x", "father.x")) %>% 
#   dplyr::filter(indv.name.x != indv.name.y) %>% 
#   dplyr::select(put.aunt.1 = indv.name.x, put.aunt.2 = indv.name.y) #Note it says aunt but could be uncle as well

#The code below helped me realize there are individual recaptures that register as full sibs to this point IF WE DON'T remove duplicate individuals (which we now do)
# full.sibs.df %>% inner_join(full.sibs.df, by = c("mother.x", "father.x")) %>% 
#   dplyr::filter(mother.x == sib.rents$mother.x[1] & father.x == sib.rents$father.x[1]) %>% 
#   dplyr::select(indv.name.x, indv.name.y, capture.year.x, capture.year.y)

```

```{r Obj 1 viz}
#Palette I want to use
brewer.pal.info #See different palette options from Rcolorbrewer
cp <- brewer.pal(3, "Set2") #Choose palette + number of colors
scales::show_col(cp)


#-------------------Objective 1 Density plots-------------------------#
fig2.a <- obj1_results %>% dplyr::filter(parameter != "survival") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = sampling.scheme)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Parameter") +
#  theme_ridges() + 
  facet_wrap(~sample.prop.lab) + 
  theme_bw() +
  xlim(-100, 100) +
  scale_fill_manual(values = cp) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25),
        legend.title = element_blank(),
        legend.position = "none")

fig2.a

#ggsave("Figure_1a_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 3694, height = 1894, units = "px")

fig2.b <- obj1_results %>% dplyr::filter(parameter != "survival") %>% 
ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme))) +
  geom_violin(aes(y=cv), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="CV") +
  theme_bw() +
  scale_fill_manual(values = cp) +
  #ggtitle("B)") +
  facet_wrap(~sample.prop.lab) +
  theme() +
  scale_y_log10() +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25),
        legend.title = element_blank(),
        legend.position = "none")

fig2.b

#ggsave("Figure_1b_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 3694, height = 1894, units = "px")


fig2.c <- obj1_results %>% dplyr::filter(parameter != "survival") %>% 
  ggplot(aes(x = HSPs_detected, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
#    ggtitle("C)") + 
    labs(x = "HSPs") +
    theme_bw() + 
    ylab("Density") +
    scale_fill_manual(values = cp) +
    scale_color_manual(values = cp) +
    facet_wrap(~sample.prop.lab, scales = "free_y") + 
  scale_x_continuous(breaks = c(50, 100, 150, 200, 250, 300, 350)) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25),
        legend.title = element_blank(),
          legend.position = "bottom")

fig2.c

#ggsave("Figure_1c_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 3694, height = 1894, units = "px")


fig2.d <- obj1_results %>% dplyr::filter(parameter != "survival") %>% 
  ggplot(aes(x = POPs_detected, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    #ggtitle("D)") + 
    labs(x = "POPs") +
    theme_bw() + 
#    theme(legend.title = element_blank(), #For ggarrange
#          axis.title.y = element_blank()) + 
    scale_fill_manual(values = cp) +
    scale_color_manual(values = cp) +
      ylab("Density") +
    facet_wrap(~sample.prop.lab, scales = "free_y") +
   theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        plot.title = element_text(size=25),
        legend.title = element_blank(),
          legend.position = "bottom")

fig2.d

ggsave("Figure_1d_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 3694, height = 1894, units = "px")


ggarrange(fig2.a, fig2.b, fig2.c, fig2.d, common.legend = TRUE, nrow = 2, ncol = 2, legend = "bottom") #OK to ignore warnings; the first two are values > the x axis limit in 1A); the 7998 missing values are from plotting POPs

#ggsave("Figure_2ALL_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 500, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 5000, height = 3000, units = "px")


```

```{r Obj2 analysis and dataframe prep}
#---------------------Prep results---------------------------------
#Set up vectors of population growth scenarios
slight_decline_scenarios <- c("scenario_2.1.1", "scenario_2.2.1", "scenario_2.3.1")
slight_increase_scenarios <- c("scenario_2.1.2", "scenario_2.2.2", "scenario_2.3.2")
severe_decline_scenarios <- c("scenario_2.1.3", "scenario_2.2.3", "scenario_2.3.3")
stable_popgrowth_scenarios <- c("scenario_2.1.4", "scenario_2.2.4", "scenario_2.3.4") #Need to run these simulations


#Set up vectors of lambda priors
no_lambda_scenarios <- c("scenario_2.1.1", "scenario_2.1.2", "scenario_2.1.3", "scenario_2.1.4")
narrow_lambda_scenarios <- c("scenario_2.2.1", "scenario_2.2.2", "scenario_2.2.3", "scenario_2.2.4")
diffuse_lambda_scenarios <- c("scenario_2.3.1", "scenario_2.3.2", "scenario_2.3.3", "scenario_2.3.4")


obj2_results <- results %>% dplyr::filter(objective == "objective2") %>% 
  mutate(population.growth = ifelse(scenario %in% stable_popgrowth_scenarios, "stable",
                                    ifelse(scenario %in% slight_decline_scenarios, "slight decline",
                                           ifelse(scenario %in% slight_increase_scenarios, "slight increase",
                                                  ifelse(scenario %in% severe_decline_scenarios, "severe decline", NA))))) %>% 
  mutate(model.label = ifelse(scenario %in% no_lambda_scenarios, "naive",
                              ifelse(scenario %in% narrow_lambda_scenarios, "adapted (narrow lambda prior)", 
                                     ifelse(scenario %in% diffuse_lambda_scenarios, "adapted (diffuse lambda prior)", NA)))) %>% 
  mutate(population.growth = factor(population.growth, levels = c("stable", "slight increase", "slight decline", "severe decline"))) %>%
    mutate(model.label = factor(model.label, levels = c("naive", "adapted (narrow lambda prior)", "adapted (diffuse lambda prior)"))) %>% 
  mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present"))) %>% 
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA))))

#-----------------------Prep samples-----------------------------
#Specify sample file and read in -- just use stable population growth for now. Age distribution of samples should be similar across the simulations.

#CHANGE this once the new population simulation finishes running from Sept 6, 2023. Mainly just need to change the simulation date.
sampFile.stable <- "G://My Drive/Personal_Drive/R/CKMR/Population.simulations/Peer_review/sample.info_03Aug2023_Seeds2022.04.15_lambda.1_annual.breeding"
  
samples.df_all <- readRDS(file = sampFile.stable)

samples.df_all <- samples.df_all %>% 
   mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA))))


#Get numbers of samples of each age class
(sample.ages <- samples.df_all %>% group_by(sampling.scheme, age.x) %>% summarize(number = n()))
  
```

```{r Obj2 plots, echo=FALSE, out.width = "120%"}
colnames(results)
options(scipen = 100000)
  
#Palette I want to use
brewer.pal.info #See different palette options from Rcolorbrewer
cp2 <- brewer.pal(3, "RdYlBu") #Choose palette + number of colors
scales::show_col(cp2)



#-------------------Figure 3-------------------------#
(fig3.1 <- obj2_results %>% dplyr::filter(parameter %in% c("Nf")) %>%
  ggplot(aes(x = relative_bias,
             y = estimation.sim.label, 
             fill = model.label)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(population.growth), cols = vars(sampling.scheme.label)) +
  #theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = cp2, 
                    name = "Model") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
    theme_bw()) +
    theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))

      ggsave("Figure_3.1_2023.08.16.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 12, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#Histogram of ages
num.bins <- length(min(samples.df_all$birth.year):max(samples.df_all$birth.year))

samples.df_all %>% gghistogram(x = "birth.year", bins = num.bins, facet.by = "sampling.scheme.label", color = "darkslategray4", fill = "darkslategray4", ggtheme = theme_bw()) +
  geom_vline(aes(xintercept= ref.yr), color = "coral4", linetype = "solid", size = 1.1) +
  geom_vline(aes(xintercept = ref.yr - 10), color = "coral3", linetype = "dashed", size = 1.1, alpha = 0.6) +
  geom_vline(xintercept = c(85, 90), color = "coral2", linetype = "dashed", size = 1.1, alpha = 0.6) +
  scale_y_continuous(labels = label_comma(), expand = expansion(mult = c(0.01, .05)))

ggsave("Figure_3.2_2023.08.16.tiff", plot = last_plot(), device = "tiff", dpi = 300, width = 15, height = 6, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

      
      #---------Figure S1----------------------------
#Show model performance when there is an informed vs diffuse prior on lambda and "extreme" population decline
      #Palette I want to use
# brewer.pal.info #See different palette options from Rcolorbrewer
# cps1 <- brewer.pal(2, "PuOr") #Choose palette + number of colors
# scales::show_col(cps1)

plot.colors.figS1 <- c("lightblue1", "indianred3")
scales::show_col(plot.colors.figS1)

(figS1a <- obj2_results %>% dplyr::filter(parameter %in% c("lambda", "survival"),
                                         lambda.prior == "diffuse (0.80 - 1.20)") %>% 
  ggplot(aes(x = relative_bias,
             y = est.yr.lab, 
             fill = sampling.scheme)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
  labs(x="Relative bias", y="Estimation year") +
#  theme_ridges() + 
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
#  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme)) +
  facet_wrap(~parameter) +
   theme(strip.text = element_text(size = 15),
         legend.position = "bottom",
         legend.title = element_blank(),
         legend.text = element_text(size = 15),
         axis.text = element_text(size = 15),
         axis.title = element_text(size = 20)) +
  #       axis.title.y = element_blank(),
  #       axis.text.y = element_blank(),
  #       axis.ticks.y = element_blank()) + 
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
  #xlim(-100, 200) +
  scale_fill_manual(values = cp))

#ggsave("Figure_S1_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#--------------------------------Figure S2-------------------------------------
      #Plot comparisons
source(file = "~/R/working_directory/LemonSharkCKMR/03_DataViz/functions/Truth_comps_samples_analysis_ToSource.R")

#How often did the model predict the direction of lambda correctly? 
plot.colors.fig3.2 <- c("tomato3", "steelblue2")
scales::show_col(plot.colors.fig3.2)

(figS2 <- obj2_lam.results_4viz %>% 
    mutate(est.yr = factor(est.yr),
           degree.plot = ifelse(degree == "substantial decline", "severe decline", degree)) %>%
    mutate(degree.plot = factor(degree.plot, levels = c("slight change", "severe decline"))) %>% 
  mutate(perc.lab = paste0(percent.summ, "%")) %>% 
  ggplot(aes(x = est.yr,
             y = percent.summ, 
             fill = status,
             pattern = est.yr)) + 
  geom_bar(position = "stack", 
           stat = "identity", 
           color = "black") +
    geom_text(aes(label = perc.lab),
                  size = 4, 
              fontface = "bold",
            position = position_stack(vjust = 0.5)) +
  facet_grid(rows = vars(degree.plot), cols = vars(sampling.scheme)) +
    labs(x="\nEstimation year", y="Percent") +
    #This adjusts the x axis labels to stagger them. "points" is the unit by which to stagger, but could use others e.g. cm, in, etc.
    #theme(axis.text.x = element_text(vjust = grid::unit(c(-1, 0, 1), "points"))) +
#  facet_wrap(~sampling.scheme) +
  #xlim(-100, 200) +
  scale_fill_manual(values = plot.colors.fig3.2)) +
  theme_bw() +
    theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_blank())


#ggsave("Figure_S2_2022.12.16.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 9, units = "in")

```

```{r Obj3 and Obj 4 data prep}
##################### Objective 3 ############################
#---------------------Prep results----------------------------
psi1_scenarios <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.5.1", "scenario_3.5.2")
psi1stoch_scenarios <- c("scenario_3.6.1", "scenario_3.6.2")
psi0.9_scenarios <- c("scenario_3.2.1", "scenario_3.2.2")
psi0.75_scenarios <- c("scenario_3.3.1", "scenario_3.3.2")
psi0.50_scenarios <- c("scenario_3.4.1", "scenario_3.4.2")

annual_scenarios <- c("scenario_3.7.1", "scenario_3.7.2")
biennial_scenarios <- c("scenario_3.1.1", "scenario_3.1.2", "scenario_3.2.1", "scenario_3.2.2", "scenario_3.3.1", "scenario_3.3.2", "scenario_3.4.1", "scenario_3.4.2", "scenario_3.6.1", "scenario_3.6.2")
triennial_scenarios <- c("scenario_3.5.1", "scenario_3.5.2")

obj3_results <- results %>% dplyr::filter(objective == "objective3") %>% 
  mutate(psi.label = ifelse(scenario %in% psi1_scenarios, "1",
                            ifelse(scenario %in% psi1stoch_scenarios, "1*",
                                   ifelse(scenario %in% psi0.9_scenarios, "0.90",
                                          ifelse(scenario %in% psi0.75_scenarios, "0.75",
                                                 ifelse(scenario %in% psi0.50_scenarios, "0.50", 
                                                        ifelse(scenario %in% annual_scenarios, "0", NA))))))) %>%
  mutate(psi.label = factor(psi.label, levels = c("1", "1*", "0.90", "0.75", "0.50", "0"))) %>% 
  mutate(breeding.schedule = ifelse(scenario %in% annual_scenarios, "annual",
                                    ifelse(scenario %in% biennial_scenarios, "biennial", 
                                           ifelse(scenario %in% triennial_scenarios, "triennial", NA)))) %>% 
  mutate(model.label = ifelse(scenario %in% naive_scenarios, "annual", "multiennial")) %>% 
  #mutate(model.label = factor(model.label, levels = c("annual", "multiennial"))) %>% #Don't think we need this for plotting, but will leave commented just in case.
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
    mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present")))


##################### Objective 4 ############################
#---------------------Prep results----------------------------
accurate.annual.scenario <- results %>% dplyr::filter(scenario == "scenario_2.2.4") %>% #stable population growth with narrow prior
  mutate(scenario = "accurate.annual")
accurate.biennial.scenario <- results %>% dplyr::filter(scenario == "scenario_3.1.2") %>% #stable population growth and biennial breeding/model
  mutate(scenario = "accurate.biennial")

cv5_scenarios <- c("scenario_4.1", "scenario_4.4")
cv10_scenarios <- c("scenario_4.2", "scenario_4.5")
cv20_scenarios <- c("scenario_4.3", "scenario_4.6")

annual_scenariosObj4 <- c("scenario_4.4", "scenario_4.5", "scenario_4.6", "accurate.annual")
biennial_scenariosObj4 <- c("scenario_4.1", "scenario_4.2", "scenario_4.3", "accurate.biennial")

obj4_results <- results %>% dplyr::filter(objective == "objective4") %>% 
  bind_rows(accurate.annual.scenario, accurate.biennial.scenario)

obj4_results <- obj4_results %>% 
  mutate(model.label = ifelse(scenario %in% annual_scenariosObj4, "annual", "multiennial")) %>% 
  mutate(cv.label = ifelse(scenario %in% cv5_scenarios, "5% CV",
                           ifelse(scenario %in% cv10_scenarios, "10% CV",
                                  ifelse(scenario %in% cv20_scenarios, "20% CV",
                                         ifelse(scenario == "accurate.annual" | scenario == "accurate.biennial", "accurate", NA))))) %>% 
  #mutate(model.label = factor(model.label, levels = c("annual", "multiennial"))) %>% #Don't think we need this for plotting, but will leave commented just in case.
  mutate(sampling.scheme.label = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages", 
                                      ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", 
                                             ifelse(sampling.scheme == "target.YOY", "target YOY", NA)))) %>% 
    mutate(estimation.sim.label = factor(estimation.sim, levels = c("T0-10", "T0", "present-5", "present")))
```


```{r Obj3 and Obj 4 Viz}
#Palette I want to use
cp3 <- brewer.pal(3, "RdBu") #Choose palette + number of colors
cp3.sub <- cp3[c(1,3)]
scales::show_col(cp3.sub)

#---------Figure 4----------------------------
#---------Objective 3-------------------------#
(fig4a <- obj3_results %>% dplyr::filter(parameter == "Nf" | parameter == "Nm",
                                         breeding.schedule == "biennial",
                                         estimation.sim.label == "present") %>%  # May want to add a filter for year estimate: estimation.sim.label == present-5
  ggplot(aes(x=factor(psi.label), fill = model.label)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("a) Intermittent breeding")

#      ggsave("Figure_4a_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 6, units = "in")

      
      #---------Objective 4-------------------------#
      brewer.pal.info #See different palette options from Rcolorbrewer
      cp4 <- brewer.pal(3, "Paired") #Choose palette + number of colors
scales::show_col(cp4)

obj4_results %>% dplyr::filter(est.yr == 85) %>% 
  group_by(model, sampling.scheme, age.error_cv) %>% 
  summarize(number = n())

obj4_results_4plot <- obj4_results %>% mutate(sampling.scheme = ifelse(sampling.scheme == "sample ALL ages", "sample all ages", sampling.scheme)) %>% 
  mutate(age.error_cv = factor(age.error_cv, levels = c("accurate", "5% CV", "10% CV", "20% CV")))

      (fig4b <- obj4_results_4plot %>% dplyr::filter(parameter == "Nf" | parameter == "survival", est.yr == 85) %>% 
  ggplot(aes(x=factor(age.error_cv), fill = model)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Age-length uncertainty") +
  scale_fill_manual(values = cp4) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Population + model")) +
  ggtitle("b) Aging error")

      ggsave("Figure_4b_2022.12.16.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 6, units = "in")


  #------------------Figure S3--------------------------
      #biennial vs annual model w/ biennial breeding: lambda (violin), survival (violin), psi (boxplot)

(figS3a <- obj3_results_4plot %>% dplyr::filter(parameter %in% c("survival", "lambda"), breeding.schedule == "biennial", est.yr == 85) %>% 
   mutate(parameter = factor(parameter, levels = c("survival", "lambda"))) %>% 
  ggplot(aes(x=factor(popsim.psi), fill = model)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Model"))

      ggsave("Figure_S3a_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 14, height = 7.35, units = "in")
      
      #psi
      (figS3b <- obj3_results_4plot %>% dplyr::filter(parameter == "psi", breeding.schedule == "biennial", est.yr == 85) %>% 
  ggplot(aes(x=factor(popsim.psi), fill = model)) +
  geom_boxplot(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Proportion biennial breeders", y="Relative bias") +
  scale_fill_manual(values = cp3.sub[2]) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "fixed") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        legend.position = "none",
        plot.title = element_text(size=25)))

      ggsave("Figure_S3b_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
      
        #------------------Figure S4--------------------------
      #triennial breeding, all parameters
      (figS4 <- obj3_results_4plot %>% dplyr::filter(breeding.schedule == "triennial", est.yr == 85, parameter != "psi") %>% 
         mutate(parameter = factor(parameter, levels = c("Nf", "Nm", "survival", "lambda"))) %>% 
  ggplot(aes(x=model, fill = model)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(x="Model", y="Relative bias") +
  scale_fill_manual(values = cp3.sub) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        plot.title = element_text(size=25),
        legend.position = "none")) +
  guides(fill=guide_legend(title="Model")) +
  ggtitle("Intermittent breeding")

      ggsave("Figure_S4_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")
      
      #-------------------Figure S5---------------------------
      #VonBert curve + ages misassigned
      ages <- 0:50
vonBert <- vbFuns(param = "Typical")
tmp <- growthFunShow("vonBertalanffy","Typical")

plot(vonBert(t = ages, Linf = 317.65, K = 0.057, t0 = -2.302), pch = 19, type = "b", main = tmp, ylab = "Length", xlab = "Age")

#Save previous plot manually

      #Graph 2: real age on x axis, misassigned age on y axis
(figS5 <- obj4_samps %>%
   mutate(age.cv = factor(age.cv, levels = c("5% CV", "10% CV", "20% CV"))) %>% 
    mutate(sampling.scheme = ifelse(sampling.scheme == "sample.ALL.ages", "sample all ages",
                                    ifelse(sampling.scheme == "sample.all.juvenile.ages", "sample all juveniles", "target YOY"))) %>% 
  ggplot(aes(x = yrs.off,
             y = age.x)) + 
  geom_jitter(alpha = 0.6) + 
  labs(x="Years off", y="True age") +
 # theme_ridges() + 
  facet_grid(rows = vars(age.cv), cols = vars(sampling.scheme)) +
#  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) +
  theme_bw() +
      theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15)))

      
            ggsave("Figure_S5b_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

      
      
      #-------------------Figure S6---------------------------
      #Estimates of lambda and Nm when ages are misassigned
      
      (figS6 <- obj4_results_4plot %>% dplyr::filter(parameter %in% c("Nm", "lambda"), est.yr == 85) %>% 
  ggplot(aes(x=factor(age.error_cv), fill = model)) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  labs(y="Relative bias", x = "Age-length uncertainty") +
  scale_fill_manual(values = cp4) +
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))) +
  guides(fill=guide_legend(title="Population + model")) +
  ggtitle("Aging error")
            
ggsave("Figure_s6_2022.11.29.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")  
  
  
  
#--------------------------------------------------------------#






#Graph 2: real age on x axis, misassigned age on y axis
figs4.b <- obj4_samps %>% dplyr::filter(lambda.prior == "none") %>% #There aren't many individuals older than 25
  ggplot(aes(x = yrs.off,
             y = age.x)) + 
  geom_jitter(alpha = 0.6) + 
  labs(x="Years off", y="Age") +
 # theme_ridges() + 
  facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(miss.cv), cols = vars(sampling.scheme)) +
#  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = plot.colors.fig3) +
  

figs4.b

ggarrange(figs4.a, figs4.b)

ggsave("Figure_s4b_2022.09.26.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")


#--------------------Supplementary Obj4---------------------------
plot.colors.figs5 <- c("pink", "salmon", "tomato3", "indianred4")
scales::show_col(plot.colors.figs5)


```



```{r objective 5 viz}
#Full dataset
ls_dataFull <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.01.01_FullLitter_FullDataset_wLambda.csv") %>% 
  mutate(num.samps = num.samps_all) %>% 
  dplyr::select(-c(num.samps_all)) %>% 
  dplyr::filter(estimation_year >= 1997)

ls_data.Fulldown <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.01.01_FullLitter_DownsampledDataset_wLambda.csv") %>% 
  mutate(mom_HSPs = mom_HSPs.down,
         num.samps = num.samps_down) %>% 
  dplyr::select(-c(mom_HSPs.down, num.samps_down, num.samps_all, mom_HSPS.all)) %>%
  dplyr::filter(estimation_year >= 1997)


#One individual per litter - shows the same results as when using the full litter
 # ls_data <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.12.30_OneIndvPerLitter_wLambda.csv") %>% 
 #   mutate(num.samps = num.samps_all) %>% 
 #   dplyr::select(-c(num.samps_all))

#Five year intervals
ls_dataFive <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.01.01_FullLitter_FiveYearIntervals_wLambda.csv") %>% 
  mutate(num.samps = num.samps_all) %>% 
  dplyr::select(-c(num.samps_all)) %>% 
  dplyr::filter(estimation_year >= 1997)


# ls_data.Fivedown <- read_csv(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.5_lemon_shark_data/Model.results/CKMR_results_2022.12.30_FullLitter_FiveYearIntervals_Downsample_wLambda.csv") %>% 
#   mutate(mom_HSPs = mom_HSPs.down,
#          num.samps = num.samps_down) %>% 
#   dplyr::select(-c(mom_HSPs.down, num.samps_down, num.samps_all, mom_HSPS.all))


ls_data.full4viz <- ls_dataFull %>% dplyr::filter(estimation_year > 1996) %>% 
  mutate(Dataset = "Full")
ls_data.Fulldown4viz <- ls_data.Fulldown %>% dplyr::filter(estimation_year > 1996) %>% 
  mutate(Dataset = "Full | downsampled")

ls_data.five4viz <- ls_dataFive %>% dplyr::filter(estimation_year > 1996) %>% 
  mutate(Dataset = "Five year intervals")
# ls_data.Fivedown4viz <- ls_data.Fivedown %>% dplyr::filter(estimation_year > 1996) %>% 
#   mutate(Dataset = "Five year intervals | downsampled")

ls_data4viz <- bind_rows(ls_data.full4viz, 
                         ls_data.Fulldown4viz,
                         ls_data.five4viz) %>% 
  mutate(Dataset = factor(Dataset, levels = c("Full", "Full | downsampled", "Five year intervals")))

#------------------------------Fig 5a: Nf-----------------------------------------#
brewer.pal.info #See different palette options from Rcolorbrewer
cp5 <- brewer.pal(3, "Dark2") #Choose palette + number of colors
scales::show_col(cp5)

fig5a <- ls_data4viz %>% 
  dplyr::filter(parameter == "Nfb2") %>%
  ggplot(aes(x = estimation_year, y = Q50, color = Dataset)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5),
                  position = position_dodge(width = 0.5)) +
  geom_smooth(method = "gam", se = FALSE, aes(linetype = Dataset)) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  labs(x = "Estimation year", y = "Female abundance") +
  scale_color_manual(values = cp5) +
  ggtitle("a)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))

fig5a

#ggsave("Figure_5a_2022.01.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

#-----------------------Fig5b: Survival------------------------------------#
fig5b <- ls_data4viz %>% 
  dplyr::filter(parameter == "survival") %>%
  ggplot(aes(x = estimation_year, y = Q50, color = Dataset)) + 
  #geom_point() + 
  geom_pointrange(aes(ymin = HPD2.5, ymax = HPD97.5, group = Dataset),
                  position = position_dodge(width = 1)) +
  geom_smooth(method = "gam", se = FALSE, aes(linetype = Dataset)) +
  #facet_wrap(~years.lab) +
  theme_bw() +
  ylim(0.5, 1) +
  labs(x = "Estimation year", y = "Survival") +
  ggtitle("b)") +
  scale_color_manual(values = cp5) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        plot.title = element_text(size=25))

fig5b

#ggsave("Figure_5b_2022.12.01.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/")

ggarrange(fig5a, fig5b, common.legend = TRUE, legend = "bottom")

ggsave("Figure_5_2023.01.02.tiff", plot = last_plot(), device = "tiff", dpi = 300, path = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/raw/", width = 12, height = 6, units = "in")


#Make table of full dataset and downsampled dataset results
#Start with bind rows bc it's before converting Dataset to a factor
table4 <- bind_rows(ls_data.full4viz, ls_data.Fulldown4viz, ls_data.five4viz) %>%
  dplyr::filter(parameter == "Nfb2") %>% 
  mutate(HPDI = paste0("(", round(HPD2.5, 0)," - ", round(HPD97.5, 0), ")")) %>%
  dplyr::select(Median = Q50,
                HPDI,
                `Estimation year` = estimation_year,
                `Number of samples` = num.samps,
                `Mom HSPs` = mom_HSPs,
                Dataset)

write_csv(table4, file = "G://My Drive/Personal_Drive/R/CKMR/manuscript.figs/tables/table4_2023.01.02.csv")
```



```{r calculate relative bias and % in HPDI}
#To get this in the table, I ran the script and then manually translated over the to table in Word. Perhaps there's a way I can just export this to a CSV file and copy and paste ... 
#Check percent in interval; can change proportion sampled
obj1_results %>% dplyr::filter(prop.sampled == 1.5) %>% 
  dplyr::filter(survival.prior == "informed", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, prop.sampled) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#-------------Objective 2 --------------------#
#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj2_results <- obj2_results %>% dplyr::filter(Rhat < 1.01)

#2.1 - slight population decline; tight prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "slight decline", lambda.prior == "tight (0.95 - 1.05)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 - slight population growth; tight prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "slight increase", lambda.prior == "tight (0.95 - 1.05)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.3 - severe population decline; diffuse prior on lambda
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "severe decline", lambda.prior == "diffuse (0.80 - 1.20)", parameter == "Nf") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)



#3.1: psi = 1
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 1, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.2: psi = 0.90
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.9, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.2: psi = 0.75
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.75, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.4: psi = 0.50
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 0.5, parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.5: mating periodicity = 3; psi = 1
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == 1, parameter == "Nf", model == "multiennial", mating.periodicity == 3) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3.6: psi = 1*
obj3_results %>% dplyr::filter(est.yr == 85, popsim.psi == "1*", parameter == "Nf", model == "multiennial", mating.periodicity == 2) %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.1: 5% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "5% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.1: 5% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "5% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#4.2: 10% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "10% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.2: 10% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "10% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#4.3: 20% CV - annual breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "annual", age.error_cv != "accurate", age.error_cv == "20% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#4.3: 20% CV - biennial breeding
obj4_results %>% dplyr::filter(est.yr == 85, parameter == "Nf", model == "multiennial", age.error_cv != "accurate", age.error_cv == "20% CV") %>%
  group_by(parameter, sampling.scheme) %>% 
  dplyr::summarize(mean.bias = mean(relative_bias),
                   percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.cv = mean(cv),
                   mean.HSPs = mean(HSPs_detected),
                   mean.POPs = mean(POPs_detected)) %>%
  dplyr::arrange(parameter, sampling.scheme)

```




```{r Supplementary calculations}
#2.1 naive - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#2.1 naive - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#Mean realized lambda 
obj2_results %>% dplyr::filter(population.growth == "severe decline",
                               est.yr == 85,
                               sampling.scheme == "target YOY",
                               lambda.prior == "diffuse (0.80 - 1.20)",
                               parameter == "lambda") %>% 
  summarize(mean(all.truth))

```






```{r Obj3 supplementary calculations}
#------------------------------------calculate average lambda over last 10 years------------------#
#Lambda should be the same for the parameters, sampling schemes, and lambda.prior, so just select one of each
obj3_results %>% dplyr::filter(parameter == "Nf", 
                                   sampling.scheme == "sample all juveniles",
                               est.yr == 85,
                               mating.periodicity == 3,
                               model == "multiennial") %>% 
  group_by(popsim.psi) %>% 
  summarize(mean.lam = mean(mean.adult.lambda_last.10),
            sd.lam = sd(mean.adult.lambda))



#-------------------------------------compare Ben and Liz viz----------------------------#
plot.colors.fig3 <- c("lightslateblue", "lightblue1", "darkslateblue", "aquamarine")
scales::show_col(plot.colors.fig3)

obj3_results.all <- bind_rows(obj3_results.ben, obj3_results.liz) %>% 
  dplyr::filter(psi.prior == "uniform",
                sim.psi == 1,
                lambda.prior == "none")


#-------------------Compare Ben and Liz models-------------------------#
#Abundance
obj3_results.all %>% dplyr::filter(parameter != "psi") %>% 
ggplot(aes(x=factor(parameter), fill = factor(model_used))) +
  geom_violin(aes(y=relative_bias), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="blue", size=1.25, linetype = "dashed") +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="Relative bias") +
  scale_fill_manual(values = plot.colors.fig3) +
#  ggtitle("B)") +
#  ylim(-100, 100) +
  facet_grid(rows = vars(sampling.scheme), cols = vars(parameter), scales = "free") +
  #facet_wrap(~sampling.scheme) +
  theme(legend.title = element_blank())



#------------------------------Visualize Ben's estimates of psi-----------------
obj3_results.ben %>% dplyr::filter(psi.prior == "uniform") %>% 
  ggplot(aes(x = relative_bias,
             y = factor(sim.psi), 
             fill = factor(sim.psi))) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="non conformists") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(cols = vars(sampling.scheme), rows = vars(parameter), scales = "free") +
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = plot.colors.fig3, 
                    name = "simulation psi") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05)))


obj3_results %>% dplyr::filter(parameter %in% c("Nf", "Nm", "survival"),
                                         lambda.prior == "tight",
                                         model == "adapted") %>% 
  ggplot(aes(x = relative_bias,
             y = non.conformists, 
             fill = psi.prior)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="non conformists") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme)) +
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = plot.colors.fig3, 
                    name = "psi prior") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05)))


```















```{r Obj2.make-Density-Plots, echo=FALSE, include=FALSE}
#Density plot for Nf
# (obj1.fig.Nf <- obj1_results %>% dplyr::filter(parameter == "Nf",
#                                               survival.prior == "diffuse") %>% 
#     ggplot(aes(x = relative_bias, color = sampling.scheme, fill = sampling.scheme)) +
#     geom_density(alpha = 0.6) + 
#     ggtitle("A) Nf") + 
#     labs(x = "Relative bias of posterior median") +
#     geom_vline(xintercept=c(0), linetype="dotted") +
#     theme_bw() + 
#     theme(legend.title = element_blank()) + 
#     scale_fill_manual(values = plot.colors.fig1) +
#     scale_color_manual(values = plot.colors.fig1) +
#     facet_wrap(~prop.sampled) +
#     xlim(-100, 100))

#-------------------Objective 2 Density plots-------------------------#
#Target YOY
obj2.YOY.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
  scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.YOY.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
    mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.YOY.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.YOY.plots <- ggarrange(obj2.YOY.p1, obj2.YOY.p2, obj2.YOY.p3, common.legend = TRUE, nrow = 3, legend = "bottom")



#Sample all juvenile ages
obj2.juvs.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.juvs.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.juvs.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.juv.plots <- ggarrange(obj2.juvs.p1, obj2.juvs.p2, obj2.juvs.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


#Sample ALL age classes
obj2.allages.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.allages.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.allages.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.allages.plots <- ggarrange(obj2.allages.p1, obj2.allages.p2, obj2.allages.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


# (fig1.p1.violin <- obj1_results %>% 
#   ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme))) +
#   geom_violin(aes(y=cv), draw_quantiles = 0.5) +
#   #ylim(-50, 160) +
#   geom_hline(yintercept=0, col="black", size=1.25) +
#   #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
#   labs(x="Parameter", y="CV", title="D) CV") +
#   scale_fill_manual(values = plot.colors.fig1) +
#   font("title", size = 10, face = "bold")) +
#   facet_wrap(~prop.sampled) +
#   theme(legend.title = element_blank())


```
\
\
The next graphs are examining how the model performs when population growth is positive, negative or neutral, comparing one model that accounts for this with a prior for lambda (uniform(0.95, 1.05)) and one that does not. In each case, the truth used to calculate relative bias is a specific year (vs the mean in model validation).
\
First, with targeted sampling of young-of-year, it looks like the model actually performs *worse* with lambda when the year of estimation is 10 years in the past. At 5 years past and present, the two appear to perform equivalently, suggesting that if limited population growth is expected, with targeted sampling of YOY at least, there's no real reason to include lambda in the model.
```{r Obj2.YOY-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.YOY.plots, top = text_grob("Target young-of-year", size = 14, face = "bold"))
```
\
\
The results are similar when all juvenile age classes are sampled, except estimates 10 years in the past are more accurate than with targeted sampling of young-of-year. This is likely a consequence of having more age classes over which to estimate survival and lambda.
```{r Obj2.juv-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.juv.plots, top = text_grob("Sample all juvenile ages", size = 14, face = "bold"))
```
\
\
The best performing model is the model that samples across age classes and includes parent-offspring pairs, as expected. Here, the model performs better with a diffuse prior on lambda than when lambda is not included.
```{r Obj2.allages-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.allages.plots, top = text_grob("sample all age classes", size = 14, face = "bold"))
```





Notes to self:
Objective 1: What drives bias when kin pairs match expectations?
Inconclusive so far (07/19/2022). I should return to this later
```{r, echo=FALSE, include=FALSE}
# obj1_results %>% dplyr::filter(HSPs_detected == HSPs_expected & sampling.scheme != "sample all age classes" & survival.prior == "diffuse") %>% 
#   dplyr::arrange(iteration) %>% 
#   dplyr::select(parameter, prop.sampled, iteration, sampling.scheme, relative_bias, survival.prior, HSPs_expected, HSPs_detected) %>% 
#   View()
# 
# mom_comps <- readRDS(paste0(obj1.2_results_location, mom.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# dad_comps <- readRDS(paste0(obj1.2_results_location, dad.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# plot.colors.fig1 <- c("aquamarine4", "indianred1", "indianred4")
# scales::show_col(plot.colors.fig1)
# 
# #Split "yes" up into separate rows so we can make a histogram of mort years
# mom_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)
# 
# dad_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)

#Interesting iterations: not bad bias
#iteration 36 (not bad bias): all parameters, 1_prop_sampled, sample_all_juvenile_ages;
#Nf, iteration_21, 1.0_prop_sampled, sample_all_juvenile_ages
#survival: iteration_28, 2.0_prop_sampled, sample_all_juvenile_ages
#Bad bias
##iteration 85 all parameters: 0.5_prop_sampled, sample_all_juvenile_ages;
#other bad biases: Nf, iteration 44, 1.0_prop_sampled, sample_all_juvenile_ages


```

Things to tackle next:
1. Objective 1: Look into the number of individual parents that are sampled in the initial model validation runs to see if we are oversampling some parents, particularly with targeted sampling of YOY.
