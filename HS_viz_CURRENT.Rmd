---
title: "HS_viz"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir = "~/R/Results")
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#setwd("~/R/R_working_dir/CKMR/Results/")
```

01/19/2021
```{r}
#----------------------Viz script-----------------------
#Sex-specific
files <- list.files(path = "~/R/R_working_dir/CKMR/LemonSharkCKMR_GitHub/null/results", pattern = "*.csv", full.names = T)
fs_hs <- sapply(files, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

head(fs_hs)
tail(fs_hs)

fs_hs <- fs_hs %>% mutate(Pop_trend = ifelse(Pop_growth > 1.01, "positive", ifelse(Pop_growth > 1.008, "slight positive", "neutral")))

fs_hs %>% filter(Pop_trend == "neutral") %>% 
  summarize(n())

fs_hs %>% filter(Relative_bias > 100)

#fs_hs <- fs_hs %>% mutate(relative_bias =((CKMR_estimate-truth)/truth)*100)
  
#Total Abundance
#  files_totalA <- list.files(path = "~/R/R_working_dir/CKMR/Results/Single_est_N/2020.12.23_and_2021.01.04/pop_growth_est_together/", pattern = "*.2021.csv", full.names = T)
#fs_hs_totalA <- sapply(files_totalA, read_csv, simplify=FALSE) %>% 
#bind_rows() #%>% 
  #drop_na()

#head(fs_hs_totalA)
#tail(fs_hs_totalA)


#fs_all <- fs_hs_totalA %>%
#  full_join(fs_hs)

#Plot relative bias by sample size and sex
G <- ggplot(data=fs_hs, aes(x=factor(Samples))) +
  geom_boxplot(aes(y=Relative_bias, fill=Sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Sample size", y="Relative bias", title="Relative Bias By Sample Size (lambda fixed)") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("150", "450"))

    G + facet_wrap(~Pop_trend)
    
#Plot relative bias by kin pairs detected - scatter plot
G2 <- ggplot(data=fs_hs, aes(x=Parents_detected, color=Sex)) +
  geom_point(aes(y=Relative_bias)) +
  #ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G2 + facet_wrap(vars(Samples))

    #Violin plot
G3 <- ggplot(data=fs_hs, aes(x=factor(Samples))) +
  geom_violin(aes(y = Relative_bias, fill=Sex)) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  ylim(-100, 100) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Sample size", y="Relative bias", title="Relative Bias By Sample Size (lambda fixed)") +
  scale_fill_brewer(palette="Set2")

G3 + facet_wrap(~Pop_trend, nrow = 2)
```

01/08/2021
```{r}
#----------------------Viz script-----------------------
#Sex-specific
files <- list.files(path = "~/R/R_working_dir/CKMR/Results/Single_est_N/2020.12.23_and_2021.01.04/pop_growth_est_together/", pattern = "*.2020.csv", full.names = T)
fs_hs <- sapply(files, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

head(fs_hs)
tail(fs_hs)

#fs_hs <- fs_hs %>% mutate(relative_bias =((CKMR_estimate-truth)/truth)*100)
  
#Total Abundance
  files_totalA <- list.files(path = "~/R/R_working_dir/CKMR/Results/Single_est_N/2020.12.23_and_2021.01.04/pop_growth_est_together/", pattern = "*.2021.csv", full.names = T)
fs_hs_totalA <- sapply(files_totalA, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

head(fs_hs_totalA)
tail(fs_hs_totalA)


fs_all <- fs_hs_totalA %>%
  full_join(fs_hs)

#Plot relative bias by sample size and sex
G <- ggplot(data=fs_all, aes(x=factor(Samples))) +
  geom_boxplot(aes(y=Relative_bias, fill=Sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Sample size", y="Relative bias", title="Relative Bias By Sample Size (pop growth fixed for whole population)") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("150", "450"))

    G + facet_wrap(~Sex)
    
    #Plot relative bias by kin pairs detected - scatter plot
G2 <- ggplot(data=fs_all, aes(x=Parents_detected, color=Sex)) +
  geom_point(aes(y=Relative_bias)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G2 + facet_wrap(vars(Sample))

    #Plot relative bias by population growth - scatter plot
G3 <- ggplot(data=fs_all, aes(x=Pop_growth, color=Sex)) +
  geom_point(aes(y=Relative_bias)) +
  ylim(-100, 100) +
  labs(x="Population growth", y="Relative bias", title="Relative Bias by Population Growth (pop growth fixed for whole population)") +
  scale_colour_brewer(palette="Set2")


#-----------------Using sex-specific population growth ---------------
#Sex-specific
files2 <- list.files(path = "~/R/R_working_dir/CKMR/Results/Single_est_N/2020.12.23_and_2021.01.04/pop_growth_est_separate/", pattern = "*.2020.csv", full.names = T)
fs_hs2 <- sapply(files2, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

head(fs_hs2)
tail(fs_hs2)

#Plot relative bias by sample size and sex
G4 <- ggplot(data=fs_hs2, aes(x=factor(Samples))) +
  geom_boxplot(aes(y=Relative_bias, fill=Sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Samples per year (over 6 years)", y="Relative bias", title="Relative Bias By Sample Size (pop growth fixed for adult sexes separately)") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("150", "450"))
  
  G4 + facet_wrap(~Sex)
  
   #Plot relative bias by population growth - scatter plot
ggplot(data=fs_hs2, aes(x=Pop_growth, color=Sex)) +
  geom_point(aes(y=Relative_bias)) +
  ylim(-100, 100) +
  labs(x="Population growth", y="Relative bias", title="Relative Bias by Population Growth (pop growth fixed for adult sexes separately)") +
  scale_colour_brewer(palette="Set2")
```


12/03/2020
Simulations with varying population growth scenarios: one with positive population growth; one with negative, and one with no population growth.
Sex-specific, varied numbers of samples taken per year
```{r}
#----------------------Viz script-----------------------
#Sex-specific
files <- list.files(path = "~/R/R_working_dir/CKMR/Results/Single_est_N/2020.12.01_and_2020.12.03/", pattern = "*.2020.csv", full.names = T)
fs_hs <- sapply(files, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

head(fs_hs)
tail(fs_hs)

#fs_hs <- fs_hs %>% mutate(relative_bias =((CKMR_estimate-truth)/truth)*100)
  
#Total Abundance
  files_totalA <- list.files(path = "~/R/R_working_dir/CKMR/LemonSharkCKMR/results/", pattern = "*.02.2020.csv", full.names = T)
fs_hs_totalA <- sapply(files_totalA, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

fs_all <- fs_hs_totalA %>% mutate(relative_bias = ((CKMR_estimate-truth)/truth)*100) %>% 
  mutate(sex = "All") %>% 
  full_join(fs_hs)

#Plot relative bias by  and sex
G <- ggplot(data=fs_hs, aes(x=factor(Total_samples))) +
  geom_boxplot(aes(y=Relative_bias, fill=Sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Sample size", y="Relative bias", title="Relative Bias By Population Growth") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("150", "450"))

    G + facet_wrap(~Pop_growth)
    
    #Plot relative bias by kin pairs detected - scatter plot
G2 <- ggplot(data=fs_hs, aes(x=Parents_detected, color=Sex)) +
  geom_point(aes(y=Relative_bias)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G2 + facet_wrap(vars(Pop_growth))


#----------------Examine results---------------------------
head(fs_hs)


```



Null model simulations with total population size 5000, adult population size several hundred, using fishSim.
Sex-specific + TotalA time-series giving a separate estimate for three years.
Took sample sizes of 300 per year and 500 per year, spread over three years.
**Eliminated all SAMPLES that were NOT from the cohorts of interest**
```{r}
#Sex-specific
files <- list.files(path = "~/R/R_working_dir/CKMR/LemonSharkCKMR/results/", pattern = "*01.2020.csv", full.names = T)
fs_hs <- sapply(files, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

head(fs_hs)
fs_hs <- fs_hs %>% mutate(relative_bias = ((CKMR_estimate-truth)/truth)*100)
  
#Total Abundance
  files_totalA <- list.files(path = "~/R/R_working_dir/CKMR/LemonSharkCKMR/results/", pattern = "*.02.2020.csv", full.names = T)
fs_hs_totalA <- sapply(files_totalA, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  #drop_na()

fs_all <- fs_hs_totalA %>% mutate(relative_bias = ((CKMR_estimate-truth)/truth)*100) %>% 
  mutate(sex = "All") %>% 
  full_join(fs_hs)

#Plot relative bias by year and sex
G <- ggplot(data=fs_all, aes(x=factor(yr))) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias By Sample Size") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("30", "60", "90", "120", "150"))

    G + facet_wrap(~total_samples)
    
    #Plot relative bias by kin pairs detected - scatter plot
G2 <- ggplot(data=fs_hs, aes(x=parents_detected, color=sex)) +
  geom_point(aes(y=relative_bias)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G2 + facet_wrap(vars(yr))
```


Null model simulations with total population size 5000, adult population size several hundred, using fishSim.
TOTAL ABUNDANCE - not sex-specific.
Time-series giving a separate estimate for two years
Took sample sizes of 200 per year for three years.
```{r}
TotalA <- read.csv("~/R/R_working_dir/CKMR/Results/time_series/fishSim_HS_time_series_null_TotalA_600samps_06.30.2020.csv", header=TRUE)
head(TotalA)

TotalA <- TotalA %>% mutate(relative_bias = ((CKMR_estimate-truth)/truth)*100) 

TotalA %>%
  group_by(yr) %>% 
  summarize(mean(relative_bias))

####### Plot #######
#Plot relative bias by year
ggplot(data=TotalA, aes(x=factor(yr))) +
  geom_boxplot(aes(y=relative_bias)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  scale_fill_brewer(palette="Set2")

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=TA.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G + facet_wrap(vars(variable))
```


Null model simulations with total population size 5000, adult population size several hundred, using fishSim.
Sex-specific, time-series giving a separate estimate for three years.
Took sample sizes of 300 per year and 500 per year, spread over three years.
**Thought I had eliminated all SAMPLES that were NOT from the cohorts of interest, but actually didn't ... missed a line in the code so it was just the pairwise comparisons that were removed**
```{r}
fs_hs <- read.csv("fishSim_HS_time_series_null_900samps_06.29.2020.csv", header=TRUE)
head(fs_hs)
fs_hs <- fs_hs %>% mutate(relative_bias = ((CKMR_estimate-truth)/truth)*100)

#Plot relative bias by year and sex
ggplot(data=fs_hs, aes(x=factor(yr))) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias By Sample Size") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("30", "60", "90", "120", "150"))
```


Null model simulations with total population size 5000, adult population size several hundred, using fishSim.
Sex-specific, time-series giving a separate estimate for each year for three years.
Took sample sizes of 400, 600, 800, 1000, each split over two years
**Eliminated all PAIRWISE COMPARISONS from the years that are not being estimated**
```{r}
files <- list.files(path = "~/R/R_working_dir/CKMR/Results/time_series", pattern = "*24.2020.csv", full.names = T)

#Read in all csv files, bind together, drop NAs
#3 time estimate x 2 sexes x 2 sample sizes x 100 iterations = expected number of rows
fs_hs <- sapply(files, read_csv, simplify=FALSE) %>% 
bind_rows() #%>% 
  drop_na()

fs_hs <- read.csv("fishSim_HS_time_series_null_400samps_06.24.2020.csv", header=TRUE)
  
#Add column for relative bias
fs_hs <- fs_hs %>% mutate(relative_bias = ((CKMR_estimate-truth)/truth)*100)

#Rename sample numbers for plotting
fs_hs$total_samples <- factor(fs_hs$total_samples, levels = c(400, 600, 800), labels = c("400 samples", "600 samples", "800 samples"))

#Plot relative bias by year and sex
ggplot(data=fs_hs, aes(x=factor(yr))) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias By Sample Size") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("30", "60", "90", "120", "150"))
  
    G + facet_wrap(~total_samples)

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=fs_hs, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias, color=sex)) +
  #ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G + facet_wrap(vars(factor(total_samples)))
```


Null model simulations with small population size - constant abundance, no time-series
Took sample sizes of:
30, 60, 90, 120, 150 in a population of 200 total individuals
200 iterations
```{r, echo=FALSE}
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#Get all csv files from folder

#################Sex-specific model###################

#getwd()
#list.files("~/R/R_working_dir/CKMR/Results/HS_constant_abundance/")
files <- list.files(path = "~/R/R_working_dir/CKMR/Results/HS_constant_abundance/sex-specific", pattern = "*Halfsib", full.names = T)

#Read in all csv files, bind together, drop NAs and filter out 0s (accidentally added 800 rows of 0s for each sample size ...)
HS <- sapply(files, read_csv, simplify=FALSE) %>% 
bind_rows() %>% 
  drop_na() %>% 
  filter(N_est != 0)
  
nrow(HS)
ncol(HS)
head(HS)
tail(HS)

#Create column for relative bias
#HS <- HS %>% 
#  mutate(Relative_bias = round(((N_est - Truth)/Truth)*100,0))

###############Sex-combined model#################
files2 <- list.files(path = "~/R/R_working_dir/CKMR/Results/HS_constant_abundance/combined_sexes", pattern = "Halfsib", full.names = T)

TA <- sapply(files2, read_csv, simplify=FALSE) %>% 
bind_rows() %>% 
  drop_na() %>% 
  filter(Parents_detected != 0)

#Combine sex-specific and sex-combined results
all <- HS %>% 
  full_join(TA)

nrow(all)

######################## Plot #########################

#Plot relative bias by samples and sex
ggplot(data=all, aes(x=factor(Total_samples))) +
  geom_boxplot(aes(y=Relative_bias, fill=Sex)) +
  #ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Samples", y="Relative bias", title="Relative Bias By Sample Size") +
  scale_fill_brewer(palette="Set2") #+
  scale_x_discrete(labels = c("30", "60", "90", "120", "150"))

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=all, aes(x=Parents_detected)) +
  geom_point(aes(y=Relative_bias, color=Sex)) +
  #ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G + facet_wrap(vars(factor(Total_samples)))
```


HS Time series - Total Abundance, non sex-specific
```{r}
TotalA <- read.csv("~/R/R_working_dir/CKMR/Results/time_series/HS_time_series_TotalA_null_5.17.2020.csv", header=TRUE)
head(TotalA)


#Make vectors of column names
col_yrs <- paste0("N_adults_yr",4:7)
col_se <- paste0("N_adults_SE_yr",4:7)
col_truth <- paste0("N_adultsTruth_yr",4:7)
colname <- paste0(col_yrs[1],"_rel_bias")

for(i in 1:length(col_yrs)){ #years analyzed
  colname <- paste0(col_yrs[i],"_rel_bias")
  for(j in 1:nrow(TotalA)){
    TotalA[j, colname] <- ((TotalA[j, col_yrs[i]] - TotalA[j,col_truth[i]])/TotalA[j,col_truth[i]])*100
  }
}

t(TotalA)

#Create dataframe where females and males are combined into the same column - females first
TotalA2 <- NULL

TotalA2 <- data.frame(cbind(Yr4_rel_bias=TotalA[,24], parents_detected_yr4=TotalA[,4], Yr5_rel_bias=TotalA[,25], parents_detected_yr5=TotalA[,8], Yr6_rel_bias=TotalA[,26], parents_detected_yr6=TotalA[,12], Yr7_rel_bias=TotalA[,27], parents_detected_yr7=TotalA[,16], truth=5000))

head(TotalA2)

#to melt multiple columns, need to convert dataframe to data.table
TotalA2 <- as.data.table(TotalA2) 
head(TotalA2)
colnames(TotalA2)

#Melt columns together so different years are factors
var1 <- colnames(TotalA2)[c(1,3,5,7)] #store column names for relative bias
var2 <- colnames(TotalA2)[c(2, 4, 6, 8)] #store column names for parents detected
#var3 <- colnames(TotalA2)[c(9:12)] #store column names for cv

TA.m1 <- reshape2::melt(TotalA2, id.vars='truth', measure.vars=var1, value.name="relative_bias")
TA.m2 <- reshape2::melt(TotalA2, id.vars='truth', measure.vars=var2, value.name="parents_detected")
#HS.m3 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var3, value.name="cv")

TA.m <- NULL
TA.m <- cbind(TA.m1, parents_detected=TA.m2$parents_detected)

TA.m %>% group_by(variable) %>%
  summarize(mean=mean(relative_bias))
  
####### Plot #######
#Plot relative bias by year
ggplot(data=TA.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 4", "Year 5", "Year 6", "Year 7"))

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=TA.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G + facet_wrap(vars(variable))

```



HS time-series null model simulations
- Took 1414 samples total
- Just simulated sampling of cohorts; didn't bother repeating over years (don't need year of capture in the final model anyway)
- With seven cohorts represented (years 1:7)
- Same abundance each year: 5000 total: 3000 male and 2000 female
- Estimated abundance for years 4:7. Abundance is estimated for the youngest sibling.
```{r, echo=FALSE}
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#Set working directory
getwd()
setwd("~/R/R_working_dir/CKMR/Results/time_series")
list.files("~/R/R_working_dir/CKMR/Results/time_series")
HS_ts <- read.csv(file="~/R/R_working_dir/CKMR/Results/time_series/HS_time_series_null_poisson_05.01.2020.csv", header=TRUE)
HS_ts2 <- read.csv(file="~/R/R_working_dir/CKMR/Results/time_series/HS_time_series_null_5.04.2020.csv", header=TRUE)

HS_ts <- rbind(HS_ts, HS_ts2)

head(HS_ts)
tail(HS_ts)

#Make vectors of column names
col_f_yrs <- paste0("Nf_yr",4:7)
col_f_se <- paste0("NfSE_yr",4:7)
col_f_truth <- paste0("NfTruth_yr",4:7)
col_m_yrs <- paste0("Nm_yr",4:7)
col_m_se <- paste0("NmSE_yr",4:7)
col_m_truth <- paste0("NmTruth_yr",4:7)
colname <- paste0(col_f_yrs[1],"_rel_bias")

#This syntax works for subsetting ... for reference.
#HS_ts[,col_f_yrs[1]]
#And this works for assigning a name with a variable
#assign(paste0(col_f_yrs[1],"_rel_bias"), c(11:20))

#Create columns for relative bias for each abundance estimate
for(i in 1:length(col_f_yrs)){ #years analyzed
  colname_f <- paste0(col_f_yrs[i],"_rel_bias")
  colname_m <- paste0(col_m_yrs[i],"_rel_bias")
  for(j in 1:nrow(HS_ts)){
    HS_ts[j, colname_f] <- ((HS_ts[j, col_f_yrs[i]] - HS_ts[j,col_f_truth[i]])/HS_ts[j,col_f_truth[i]])*100
        HS_ts[j, colname_m] <- ((HS_ts[j, col_m_yrs[i]] - HS_ts[j,col_m_truth[i]])/HS_ts[j,col_m_truth[i]])*100
  }
}

#Create columns for CV for each abundance estimate
#for(i in 1:length(col_f_yrs)){ #years analyzed
#  colname_f <- paste0(col_f_yrs[i],"_cv")
#  colname_m <- paste0(col_m_yrs[i],"_cv")
#  for(j in 1:nrow(HS_ts)){
#    HS_ts[j, colname_f] <- (HS_ts[j, col_f_se[i]]/HS_ts[j,col_f_yrs[i]])*100
#        HS_ts[j, colname_m] <- (HS_ts[j, col_m_se[i]]/HS_ts[j,col_m_yrs[i]])*100
#  }
#}


head(HS_ts)
tail(HS_ts)
str(HS_ts)
colnames(HS_ts)

#### Combine relative bias, parents detected, and truth into one dataframe for Viz ####
total_abundance <- c(rep(5000, 4)) #Can't estimate for yr=1 because abundance is calculated at time of younger sibling's birth, and there is no scenario where the younger sibling was born in yr1. Also unlikely to get estimate for yr=2 because there are relatively few pairwise comparisons where the younger sibling was born in yr2. So length of vector should be n_yrs-2
N_f <- c(total_abundance/2.5)
N_m <- c(total_abundance-N_f)

#Create dataframe where females and males are combined into the same column - females first
HS_ts2 <- NULL

HS_ts2 <- data.frame(cbind(Yr4_rel_bias=c(HS_ts[,40], HS_ts[,41]), parents_detected_yr4=c(HS_ts[,4],HS_ts[,20]), Yr5_rel_bias=c(HS_ts[,42], HS_ts[,43]), parents_detected_yr5=c(HS_ts[,8],HS_ts[,24]), Yr6_rel_bias=c(HS_ts[,44], HS_ts[,45]), parents_detected_yr6=c(HS_ts[,12],HS_ts[,28]), Yr7_rel_bias=c(HS_ts[,46], HS_ts[,47]), parents_detected_yr7=c(HS_ts[,16],HS_ts[,32]), sex_truth=rep(c(N_f[1],N_m[1]), each=500), total_truth=total_abundance[1]))

HS_ts2$sex <- rep(c("F","M"), each=500) #Add column for sex

head(HS_ts)
head(HS_ts2)
tail(HS_ts)
tail(HS_ts2)

#to melt multiple columns, need to convert dataframe to data.table
HS_ts2 <- as.data.table(HS_ts2) 
head(HS_ts2)
colnames(HS_ts2)

#Melt columns together so different years are factors
var1 <- colnames(HS_ts2)[c(1,3,5,7)] #store column names for relative bias
var2 <- colnames(HS_ts2)[c(2, 4, 6, 8)] #store column names for parents detected
#var3 <- colnames(HS_ts2)[c(9:12)] #store column names for cv

HS.m1 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var1, value.name="relative_bias")
HS.m2 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var2, value.name="parents_detected")
#HS.m3 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var3, value.name="cv")

HS.m <- NULL
HS.m <- cbind(HS.m1, parents_detected=HS.m2$parents_detected, sex_truth=HS_ts2$sex_truth, total_truth=HS_ts2$total_truth)

#check that values match
head(HS.m)
head(HS_ts2) #line above should match first rows of females
tail(HS.m)
tail(HS_ts2) #line above should match last rows of males
nrow(HS.m) #should be iterations x 2(M+F) x number of years estimated (e.g. 500 iterations estimating 4 years should be 4,000 rows long)

#Use dataframe HS.m; HS_ts is the original
apply(HS_ts[, grep("^Dads", colnames(HS_ts))], 2, mean) #Calculate mean detected dads
apply(HS_ts[, grep("^Moms", colnames(HS_ts))], 2, mean) #Calculate mean detected moms


#### Examine and compare means of bias and parents detected ####

#Compare relative bias and parents detected for positive, negative and un-biased estimates
HS_unbiased <- HS.m[which(abs(HS.m$relative_bias) < 1),]
HS_pos_bias <- HS.m[which(HS.m$relative_bias > 50),]
HS_neg_bias <- HS.m[which(HS.m$relative_bias < -20),]
HS_pos_bias$bias <- c("positive")
HS_neg_bias$bias <- c("negative")
HS_unbiased$bias <- c("unbiased")
HS_bias <- cbind(HS_unbiased, HS_pos_bias, HS_neg_bias)

HS_unbiased %>% group_by(variable) %>% summarize(mean_parents = mean(parents_detected))
HS_pos_bias %>% group_by(variable) %>% summarize(mean_parents = mean(parents_detected))
HS_neg_bias %>% group_by(variable) %>% summarize(mean_parents = mean(parents_detected))

#mean(HS_ts$Nm_yr7_rel_bias[HS_ts$Dads_detected_yr7>40])

#Calculate mean relative bias and samples per year
HS_ts_sub <- HS_ts[, grep("rel_bias$", colnames(HS_ts))] #Subset for relative bias columns
apply(HS_ts_sub, 2, mean) #Calculate mean relative bias

HS_ts_sub <- HS_ts[, grep("samples$", colnames(HS_ts))] #Subset for samples per year
apply(HS_ts_sub, 2, mean) #Calculate mean samples per year


###################### Plot #################################
#Plot relative bias by year
ggplot(data=HS.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 4", "Year 5", "Year 6", "Year 7"))


#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=HS.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias, color=sex)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")

G + facet_wrap(vars(variable))

#Plot sex-specific and sex-combined results together
#Create dataframe with sex-specific info and also total abundance so they can be plotted together
TA.m$sex <- "combined sex"
nrow(HS.m)
all.m <- HS.m %>% 
  full_join(TA.m) %>% 
  select(c(variable, relative_bias, sex, parents_detected))

nrow(all.m)
tail(all.m)
head(all.m)

#Plot relative bias by year
ggplot(data=all.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.2, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 4", "Year 5", "Year 6", "Year 7"))


#Plot cv by year
#ggplot(data=HS.m, aes(x=variable)) +
#  geom_boxplot(aes(y=cv, fill=sex)) +
#  geom_hline(yintercept=20, col="red", size=1.25) +
#  labs(x="Year", y="CV", title="CV Per Year") +
#  scale_fill_brewer(palette="Set2") +
#  scale_x_discrete(labels = c("Year 4", "Year 5", "Year 6", "Year 7"))


#Plot CV by kin pairs detected - scatter plot
#ggplot(data=HS.m, aes(x=parents_detected)) +
#  geom_point(aes(y=cv)) +
#  labs(x="Parents detected", y="CV", title="CV by Kin Pairs") +
#  scale_colour_brewer(palette="Set2")

#facet_wrap(vars(variable))

#Plot CV by relative bias
#G <- ggplot(data=HS.m, aes(x=cv)) +
#  geom_point(aes(y=relative_bias, color=sex)) +
#  labs(x="CV", y="Relative Bias", title="Relative Bias by CV") +
#  scale_colour_brewer(palette="Set2") +
#  geom_hline(yintercept=0, col="black", size=1.25)

#G + facet_wrap(vars(variable))

#Plot relative bias by year - split by negative and positive bias
G <- ggplot() +
  geom_boxplot(data = HS_unbiased, aes(x = variable, y=parents_detected)) +
  ylim(0, 150) +
  labs(x="Year", y="parents detected", title="Parents detected by year and bias") +
  scale_x_discrete(labels = c("Year 4", "Year 5", "Year 6", "Year 7")) +
  geom_point(data = HS_pos_bias, aes(x = variable, y = parents_detected, color="yellow")) + 
  geom_point(data = HS_neg_bias, aes(x = variable, y = parents_detected, color="green")) +
    theme(legend.position="none")
                                                                                      
#Plot parents detected - box plot is unbiased estimates, points above box plot are negative biased estimates; points below are positive biased estimates
G + facet_wrap(vars(sex)) + 
  aes(fill=sex) + 
  scale_fill_brewer(palette="Set2", direction=-1, guide=FALSE)
```



































OLD
HS time-series null model simulations - TAKE 1
- Took 949 samples total
- Over four years (years 4:7)
- With seven cohorts represented (years 1:7)
- Different abundance each year
- Estimated abundance for years 3:7. Abundance is estimated for the youngest sibling, so can't use 1. And have few enough pairwise comparisons between 1 & 2 that using year 2 often reveals no kin pairs and throws an error.
```{r, echo=FALSE}
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#Set working directory
list.files()
setwd("../Results/time_series/")
HS_ts <- read.csv(file="HS_time_series_null_4.24.2020.csv", header=TRUE)

head(HS_ts)
tail(HS_ts)
HS_ts[HS_ts$Dads_detected_yr7>70,]

#Make vectors of column names
col_f_yrs <- paste0("Nf_yr",3:7)
col_f_truth <- paste0("NfTruth_yr",3:7)
col_m_yrs <- paste0("Nm_yr",3:7)
col_m_truth <- paste0("NmTruth_yr",3:7)
colname <- paste0(col_f_yrs[1],"_rel_bias")

#This syntax works for subsetting ... for reference.
#HS_ts[,col_f_yrs[1]]
#And this works for assigning a name with a variable
#assign(paste0(col_f_yrs[1],"_rel_bias"), c(11:20))

#Create columns for relative bias for each abundance estimate
for(i in 1:length(col_f_yrs)){ #years analyzed
  colname_f <- paste0(col_f_yrs[i],"_rel_bias")
  colname_m <- paste0(col_m_yrs[i],"_rel_bias")
  for(j in 1:nrow(HS_ts)){
    HS_ts[j, colname_f] <- ((HS_ts[j, col_f_yrs[i]] - HS_ts[j,col_f_truth[i]])/HS_ts[j,col_f_truth[i]])*100
        HS_ts[j, colname_m] <- ((HS_ts[j, col_m_yrs[i]] - HS_ts[j,col_m_truth[i]])/HS_ts[j,col_m_truth[i]])*100
  }
}

head(HS_ts)
tail(HS_ts)
str(HS_ts)
colnames(HS_ts)

#Combine relative bias, parents detected, and truth into one dataframe
total_abundance <- c(3000, 5000, 7000, 9000, 2000) #Can't estimate for yr=1 because abundance is calculated at time of younger sibling's birth, and there is no scenario where the younger sibling was born in yr1. Also unlikely to get estimate for yr=2 because there are relatively few pairwise comparisons where the younger sibling was born in yr2. So length of vector should be n_yrs-2
N_f <- c(total_abundance/2.5)
N_m <- c(total_abundance-N_f)

#Create dataframe where males and females are combined into the same column
HS_ts2 <- NULL
HS_ts2 <- data.frame(cbind(Yr3_rel_bias=c(HS_ts[,41], HS_ts[,42]),parents_detected_yr3=c(HS_ts[,4],HS_ts[,24]), Yr4_rel_bias=c(HS_ts[,43], HS_ts[,44]), parents_detected_yr4=c(HS_ts[,8],HS_ts[,28]), Yr5_rel_bias=c(HS_ts[,45], HS_ts[,46]), parents_detected_yr5=c(HS_ts[,12],HS_ts[,32]), Yr6_rel_bias=c(HS_ts[,47], HS_ts[,48]), parents_detected_yr6=c(HS_ts[,16],HS_ts[,36]), Yr7_rel_bias=c(HS_ts[,49], HS_ts[,50])), parents_detected_yr7=c(HS_ts[,20],HS_ts[,40]), yr3_truth=rep(c(N_f[1],N_m[1]), each=500), yr4_truth=rep(c(N_f[2],N_m[2]), each=500), yr5_truth=rep(c(N_f[3],N_m[3]), each=500), yr6_truth=rep(c(N_f[4],N_m[4]), each=500), yr7_truth=rep(c(N_f[5],N_m[5]), each=500), yr3_total_truth=total_abundance[1], yr4_total_truth=total_abundance[2], yr5_total_truth=total_abundance[3], yr6_total_truth=total_abundance[4], yr7_total_truth=total_abundance[5])

HS_ts2$sex <- rep(c("F","M"), each=500) #Add column for sex for visualizing
head(HS_ts)
head(HS_ts2)
tail(HS_ts)
tail(HS_ts2)
#mean(HS_ts$Nm_yr7_rel_bias[HS_ts$Dads_detected_yr7>40])

HS_ts2 <- as.data.table(HS_ts2) #to melt multiple columns, need to convert dataframe to data.table
colnames(HS_ts2)
head(HS_ts2)

#Melt columns together so different years are factors
var1 <- colnames(HS_ts2)[c(1,3,5,7,9)] #store column names for relative bias
var2 <- colnames(HS_ts2)[c(2, 4, 6, 8, 10)] #store column names for parents detected
var3 <- colnames(HS_ts2)[c(11:15)]
var4 <- colnames(HS_ts2)[c(16:20)]
  
HS.m1 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var1, value.name="relative_bias")
HS.m2 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var2, value.name="parents_detected")
HS.m3 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var3, value.name="sex_truth")
HS.m4 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var4, value.name="total_truth")
HS.m <- cbind(HS.m1, parents_detected=HS.m2$parents_detected, sex_truth=HS.m3$sex_truth, total_truth=HS.m4$total_truth)

HS.m <- cbind(HS.m, prop_sampled=round(949/HS.m$total_truth*100, 0))

#Make bins for kin detected
HS.m$rent_bins <- cut(HS.m$parents_detected, breaks=c(0, 30, 40, 50, 60, 70, 120), labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
tail(HS.m,50)

head(HS.m)
tail(HS.m)
tail(HS_ts2)
nrow(HS.m)

#Subset for relative bias columns
#HS_ts_sub <- HS_ts[, grep("rel_bias$", colnames(HS_ts))]

#apply(HS_ts_sub, 2, median) #Calculate mean relative bias
#which(HS_ts_sub$Nm_yr3_rel_bias == max(HS_ts_sub$Nm_yr3_rel_bias)) #Look for outliers

#Combine relative bias columns so we can make factor for sex
#HT <- NULL
#HT <- data.frame(cbind(Yr3_rel_bias=c(HS_ts_sub[,1], HS_ts_sub[,2]),Yr4_rel_bias=c(HS_ts_sub[,3], HS_ts_sub[,4]), Yr5_rel_bias=c(HS_ts_sub[,5], HS_ts_sub[,6]), Yr6_rel_bias=c(HS_ts_sub[,7], HS_ts_sub[,8]), Yr7_rel_bias=c(HS_ts_sub[,9], HS_ts_sub[,10])))
#HT$sex <- rep(c("F","M"), each=500)

#Rearrange dataframe so sex, yr, and relative bias are the (only) columns
#HT.m <- reshape2::melt(HT, id.vars='sex', measure.vars=c(colnames(HT)[1:5]))
#head(HT.m)

#Plot relative bias by year
ggplot(data=HS.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  theme(legend.position="none", plot.title = element_text(hjust=0.5)) +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 3", "Year 4", "Year 5", "Year 6", "Year 7"))

#Need to understand how the bias relates to number of half-siblings detected
#Use dataframe HS.m; HS_ts is the original
apply(HS_ts[, grep("^Dads", colnames(HS_ts))], 2, mean) #Calculate mean detected dads
apply(HS_ts[, grep("^Moms", colnames(HS_ts))], 2, mean) #Calculate mean detected moms

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=HS.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias, color=sex)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")
head(HS.m)
tail(HS.m)

G + facet_wrap(vars(variable))

#Plot relative bias by kin pairs - binned + box plot
ggplot(data=HS.m, aes(x=rent_bins)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Kin Pairs", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
View(HS.m)
```