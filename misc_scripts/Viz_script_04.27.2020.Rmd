Sample Size Simulation Results
========================================================

author: John Swenson
date: 4/1/2019
autosize: true

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir = "~/R/working_directory/Lemon_shark_CKMR")
```

HS time-series null model simulations
- Took 949 samples total
- Over four years (years 4:7)
- With seven cohorts represented (years 1:7)
- Estimated abundance for years 3:7. Abundance is estimated for the youngest sibling, so can't use 1. And have few enough pairwise comparisons between 1 & 2 that using year 2 often reveals no kin pairs and throws an error.
```{r, echo=FALSE}
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#Set working directory
list.files()
setwd("../Results/time_series/")
HS_ts <- read.csv(file="HS_time_series_null_4.24.2020.csv", header=TRUE)

head(HS_ts)
tail(HS_ts)
HS_ts[HS_ts$Dads_detected_yr7>70,]

#Make vectors of column names
col_f_yrs <- paste0("Nf_yr",3:7)
col_f_truth <- paste0("NfTruth_yr",3:7)
col_m_yrs <- paste0("Nm_yr",3:7)
col_m_truth <- paste0("NmTruth_yr",3:7)
colname <- paste0(col_f_yrs[1],"_rel_bias")

#This syntax works for subsetting ... for reference.
#HS_ts[,col_f_yrs[1]]
#And this works for assigning a name with a variable
#assign(paste0(col_f_yrs[1],"_rel_bias"), c(11:20))

#Create columns for relative bias for each abundance estimate
for(i in 1:length(col_f_yrs)){ #years analyzed
  colname_f <- paste0(col_f_yrs[i],"_rel_bias")
  colname_m <- paste0(col_m_yrs[i],"_rel_bias")
  for(j in 1:nrow(HS_ts)){
    HS_ts[j, colname_f] <- ((HS_ts[j, col_f_yrs[i]] - HS_ts[j,col_f_truth[i]])/HS_ts[j,col_f_truth[i]])*100
        HS_ts[j, colname_m] <- ((HS_ts[j, col_m_yrs[i]] - HS_ts[j,col_m_truth[i]])/HS_ts[j,col_m_truth[i]])*100
  }
}

head(HS_ts)
tail(HS_ts)
str(HS_ts)
colnames(HS_ts)

#Combine relative bias, parents detected, and truth into one dataframe
total_abundance <- c(3000, 5000, 7000, 9000, 2000) #Can't estimate for yr=1 because abundance is calculated at time of younger sibling's birth, and there is no scenario where the younger sibling was born in yr1. Also unlikely to get estimate for yr=2 because there are relatively few pairwise comparisons where the younger sibling was born in yr2. So length of vector should be n_yrs-2
N_f <- c(total_abundance/2.5)
N_m <- c(total_abundance-N_f)

#Create dataframe where males and females are combined into the same column
HS_ts2 <- NULL
HS_ts2 <- data.frame(cbind(Yr3_rel_bias=c(HS_ts[,41], HS_ts[,42]),parents_detected_yr3=c(HS_ts[,4],HS_ts[,24]), Yr4_rel_bias=c(HS_ts[,43], HS_ts[,44]), parents_detected_yr4=c(HS_ts[,8],HS_ts[,28]), Yr5_rel_bias=c(HS_ts[,45], HS_ts[,46]), parents_detected_yr5=c(HS_ts[,12],HS_ts[,32]), Yr6_rel_bias=c(HS_ts[,47], HS_ts[,48]), parents_detected_yr6=c(HS_ts[,16],HS_ts[,36]), Yr7_rel_bias=c(HS_ts[,49], HS_ts[,50])), parents_detected_yr7=c(HS_ts[,20],HS_ts[,40]), yr3_truth=rep(c(N_f[1],N_m[1]), each=500), yr4_truth=rep(c(N_f[2],N_m[2]), each=500), yr5_truth=rep(c(N_f[3],N_m[3]), each=500), yr6_truth=rep(c(N_f[4],N_m[4]), each=500), yr7_truth=rep(c(N_f[5],N_m[5]), each=500), yr3_total_truth=total_abundance[1], yr4_total_truth=total_abundance[2], yr5_total_truth=total_abundance[3], yr6_total_truth=total_abundance[4], yr7_total_truth=total_abundance[5])

HS_ts2$sex <- rep(c("F","M"), each=500) #Add column for sex for visualizing
head(HS_ts)
head(HS_ts2)
tail(HS_ts)
tail(HS_ts2)
#mean(HS_ts$Nm_yr7_rel_bias[HS_ts$Dads_detected_yr7>40])

HS_ts2 <- as.data.table(HS_ts2) #to melt multiple columns, need to convert dataframe to data.table
colnames(HS_ts2)
head(HS_ts2)

#Melt columns together so different years are factors
var1 <- colnames(HS_ts2)[c(1,3,5,7,9)] #store column names for relative bias
var2 <- colnames(HS_ts2)[c(2, 4, 6, 8, 10)] #store column names for parents detected
var3 <- colnames(HS_ts2)[c(11:15)]
var4 <- colnames(HS_ts2)[c(16:20)]
  
HS.m1 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var1, value.name="relative_bias")
HS.m2 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var2, value.name="parents_detected")
HS.m3 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var3, value.name="sex_truth")
HS.m4 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var4, value.name="total_truth")
HS.m <- cbind(HS.m1, parents_detected=HS.m2$parents_detected, sex_truth=HS.m3$sex_truth, total_truth=HS.m4$total_truth)

HS.m <- cbind(HS.m, prop_sampled=round(949/HS.m$total_truth*100, 0))

#Make bins for kin detected
HS.m$rent_bins <- cut(HS.m$parents_detected, breaks=c(0, 30, 40, 50, 60, 70, 120), labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
tail(HS.m,50)

head(HS.m)
tail(HS.m)
tail(HS_ts2)
nrow(HS.m)

#Subset for relative bias columns
#HS_ts_sub <- HS_ts[, grep("rel_bias$", colnames(HS_ts))]

#apply(HS_ts_sub, 2, median) #Calculate mean relative bias
#which(HS_ts_sub$Nm_yr3_rel_bias == max(HS_ts_sub$Nm_yr3_rel_bias)) #Look for outliers

#Combine relative bias columns so we can make factor for sex
#HT <- NULL
#HT <- data.frame(cbind(Yr3_rel_bias=c(HS_ts_sub[,1], HS_ts_sub[,2]),Yr4_rel_bias=c(HS_ts_sub[,3], HS_ts_sub[,4]), Yr5_rel_bias=c(HS_ts_sub[,5], HS_ts_sub[,6]), Yr6_rel_bias=c(HS_ts_sub[,7], HS_ts_sub[,8]), Yr7_rel_bias=c(HS_ts_sub[,9], HS_ts_sub[,10])))
#HT$sex <- rep(c("F","M"), each=500)

#Rearrange dataframe so sex, yr, and relative bias are the (only) columns
#HT.m <- reshape2::melt(HT, id.vars='sex', measure.vars=c(colnames(HT)[1:5]))
#head(HT.m)

#Plot relative bias by year
ggplot(data=HS.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  theme(legend.position="none", plot.title = element_text(hjust=0.5)) +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 3", "Year 4", "Year 5", "Year 6", "Year 7"))

#Need to understand how the bias relates to number of half-siblings detected
#Use dataframe HS.m; HS_ts is the original
apply(HS_ts[, grep("^Dads", colnames(HS_ts))], 2, mean) #Calculate mean detected dads
apply(HS_ts[, grep("^Moms", colnames(HS_ts))], 2, mean) #Calculate mean detected moms

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=HS.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias, color=sex)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")
head(HS.m)
tail(HS.m)

G + facet_wrap(vars(variable))

#Plot relative bias by kin pairs - binned + box plot
ggplot(data=HS.m, aes(x=rent_bins)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Kin Pairs", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
View(HS.m)
```


Maturity age vs. Sample size simulations
Import results
```{r, echo=FALSE}
library(data.table)
library(tidyverse)

#Read all the csv files at once -- must be in the directory where the files are stored
setwd("../Results/non_lethal_POP/mat_age_vs_samp_size/")
temp <- list.files(pattern="*.csv")
POPlist <- lapply(temp, read.csv)
setwd("../../HS/mat_age_vs_samp_size/")
temp2 <- list.files(pattern="*.csv")
HSlist <- lapply(temp2, read.csv)

#Merge all simulations into one dataframe
POP_df <- data.table::rbindlist(POPlist)
HS_df <- data.table::rbindlist(HSlist)

#Remove N/As
POP_df <- POP_df[which(is.na(POP_df[,1])==FALSE),]
HS_df <- HS_df[which(is.na(HS_df[,1])==FALSE),]

#Calculate relative bias for each estimate
truth=1500
POP_df$m_rel_bias <- ((POP_df$Nm - truth)/truth)*100
HS_df$m_rel_bias <- ((HS_df$Nm - truth)/truth)*100
POP_df$f_rel_bias <- ((POP_df$Nf - truth)/truth)*100
HS_df$f_rel_bias <- ((HS_df$Nf - truth)/truth)*100

#Add column for method
POP_df$method <- factor("Parent-offspring")
HS_df$method <- factor("Half-sibling")

#Apparently rounded to different numbers in simulation script, so fix here ...
POP_df$prop_mature <- round(POP_df$prop_mature, 2)
HS_df$prop_mature <- round(HS_df$prop_mature, 2)

#Examine how relative bias varies with kin pairs found
#Count number of observations with relative bias < x
nrow(HS_df[HS_df$f_rel_bias < abs(10),])
nrow(POP_df[POP_df$f_rel_bias < abs(10),])
nrow(HS_df[HS_df$m_rel_bias < abs(10),])
nrow(POP_df[POP_df$m_rel_bias < abs(10),])

#Get mean relative bias of observations with x number kin paris found, and count number of those observations
#Half-sibling
mean(HS_df$f_rel_bias[HS_df$POPs_found < 50 & HS_df$POPs_found >= 40])
nrow(HS_df[HS_df$POPs_found == 40,])

#Parent-offspring
mean(POP_df$f_rel_bias[POP_df$POPs_found < 50 & POP_df$POPs_found >= 40])
nrow(POP_df[POP_df$POPs_found == 40,])

#Group mat age and samp prop for histogram - POP
POP_df$perc <- cut(POP_df$prop_sampled, breaks=c(0, 0.1, 0.2), labels=c("1-10%","11-20%"))
POP_df$mat <- cut(POP_df$prop_mature, breaks=c(0, 0.25, 0.6), labels=c("<25%", ">25%"))
POP_lines <- POP_df %>%
  dplyr::group_by(perc, mat) %>% 
  summarise(mean = mean(POPs_found))

#Group mat age and samp prop for histogram - HS
HS_df$perc <- cut(HS_df$prop_sampled, breaks=c(0, 0.04, 0.08, 0.12, 0.16, 0.2), labels=c("4%","8%", "12%", "16%", "20%"))
HS_df$mat <- cut(HS_df$prop_mature, breaks=c(0, 0.25, 0.6), labels=c("<25%", ">25%"))
HS_mean_kin <- HS_df %>%
  dplyr::group_by(prop_sampled) %>% 
  summarise(mean = mean(POPs_found))

#Check values in this column
levels(factor(HS_df$prop_mature))
levels(factor(POP_df$prop_mature))

#Subset for different species
#Scalloped hammerhead, thorny skate
Group1 <- rbind(HS_df[which(HS_df$prop_mature == 0.08 | HS_df$prop_mature == 0.1),], POP_df[which(POP_df$prop_mature == 0.08 | POP_df$prop_mature == 0.1),])
#Categories for plotting
Group1$perc <- cut(Group1$prop_sampled, breaks=c(0, 0.05, 0.1, 0.15, 0.2), labels=c("1-5%","6-10%","11-15%","16-20%"))
Group1$Group <- "S. lewini"

#Blue shark, cownose ray
Group2 <- rbind(HS_df[which(HS_df$prop_mature == 0.34),], POP_df[which(POP_df$prop_mature == 0.34),])
#Categories for plotting
Group2$perc <- cut(Group2$prop_sampled, breaks=c(0, 0.05, 0.1, 0.15, 0.2), labels=c("1-5%","6-10%","11-15%","16-20%"))
Group2$Group <- "P. glauca"

#Group2$kin_pairs <- cut(Group2$POPs_found, breaks=c(0, 25, 35, 45, 55, 65, 75, 85, 95, 150), labels=c("<25","26-35","36-45","46-55", "55-65", "65-75", "75-85", "85-95", ">95"))
#Calculate CV
Group2 %>%
  dplyr::group_by(kin_pairs) %>% 
  summarise(sd = sd(Nf), mean = mean(Nf), CV = sd/mean*100)

#Thresher shark
Group3 <- rbind(HS_df[which(HS_df$prop_mature == 0.4),], POP_df[which(POP_df$prop_mature == 0.4),])
#Categories for plotting
Group3$perc <- cut(Group3$prop_sampled, breaks=c(0, 0.05, 0.1, 0.15, 0.2), labels=c("1-5%","6-10%","11-15%","16-20%"))
Group3$Group <- "A. vulpinus"

#Combine groups
All_groups <- rbind(Group1, Group2, Group3)
nrow(All_groups)
```

Maturity age vs. Sample size simulations
Visualize results
```{r, echo=FALSE}
library(gridExtra)
library(ggpubr)
library(RColorBrewer)

#Proportion sampled by relative bias for different life histories
G <- ggplot(data=All_groups, aes(x=perc)) +
  geom_boxplot(aes(y=f_rel_bias, fill=Group)) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-10, ymax=10, alpha=.5, col="red") +
  labs(x="Proportion sampled", y="Relative bias", title="Relative Bias by Sample Size") +
  ylim(-100, 100) +
  theme(legend.position="none", plot.title = element_text(hjust=0.5)) +
  scale_fill_brewer(palette="Set2")

G + facet_grid(rows=vars(Group), cols=vars(method))

#Relative bias by kin pairs found - cownose rays
ggplot(data=Group2, aes(x=kin_pairs)) +
  geom_boxplot(aes(y=m_rel_bias)) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-10, ymax=10, alpha=.5, col="red") +
  labs(x="Kin pairs found", y="Relative bias", title="Relative Bias by Kin Pairs Detected") +
  ylim(-100, 200) +
  theme(legend.position="none", plot.title = element_text(hjust=0.5)) +
  scale_fill_brewer(palette="Dark2")

#Histogram of kin pairs
P_hist <- ggplot(data=POP_df, aes(x=POPs_found, y=..density..)) + 
  geom_histogram(binwidth=1, color="black", fill="white") +
  labs(x="Kin pairs detected", title="Number kin pairs detected - Parent-offspring") +
  geom_density(alpha=.3, fill="red") +
  xlim(0, max(HS_df$POPs_found)) +
  scale_y_continuous(limits = c(0,0.07), expand = c(0, 0))
P_hist
  
H_hist <- ggplot(data=HS_df, aes(x=POPs_found, y=..density..)) + 
  geom_histogram(binwidth=1, color="black", fill="white") +
  labs(x="Kin pairs detected", title="Number kin pairs detected - Half-sib") +
  geom_density(alpha=.4, fill="light blue") +
    xlim(0, max(HS_df$POPs_found)) +
  scale_y_continuous(limits = c(0,0.03), expand = c(0, 0))
H_hist

grid.arrange(P_hist, H_hist, nrow=2)

```




GGplot
```{r, echo=FALSE}
library(ggplot2)
library(lattice)

#Scatter plot with POPs_found
ggplot(data=HS_df, aes(x=prop_sampled, y=POPs_found)) +
  geom_point() +
  geom_smooth() +
  labs(x="Proportion sampled", y="Kin pairs found", title="Bias by kin pairs Half-Sib")
  

ggplot(data=POP_df, aes(x=POPs_found, y=f_rel_bias)) +
  geom_point() + 
  labs(x="Kin pairs detected", y="Relative bias", title="Bias by kin pairs Parent-offspring") +
  ylim(-100, 200)

```



Test some other methods ... 
```{r, echo=FALSE}
library(ggplot2)
library(lattice)

#Edit values so they're more friendly for the heat map (maybe do log of values?)
HS_df$m_log_bias <- log(abs(HS_df$m_rel_bias))
HS_df$f_log_bias <- log(abs(HS_df$f_rel_bias))

for(i in 1:nrow(HS_df)){
  if(abs(HS_df$f_rel_bias) > 10) HS_df$f_rel_bias2[i] <- 10 else HS_df$f_rel_bias2[i] <- HS_df$f_rel_bias[i]
}

#Heat map
f_heatmap <- ggplot(data=HS_df, mapping=aes(x=as.character(round(prop_mature,2)),
                                           y=as.character(round(POPs_found,2)),
                                           fill=f_log_bias)) +
  geom_tile() +
  xlab(label = "prop_mature")
f_heatmap

#Box plot of relative bias of abundance estimate
ggplot(data=HS_df, aes(x=factor(prop_mature), y=f_rel_bias)) +
  geom_boxplot() +
  geom_abline(intercept = 0, slope = 0, color="dark red") +
  ggtitle("CKMR Non-lethal Null Model Simulations") +
  xlab("Proportion mature") +
  ylab("Relative bias") #+
  geom_label(aes(label=paste0("Relative bias: ",non_m_rel_bias_mean), x=2, y=50), fill="lightskyblue1", colour="darkslategray", fontface="bold", show.legend=NA) +
  geom_label(aes(label=paste0("Relative bias: ",non_f_rel_bias_mean), x=1, y=50), fill="indianred1", colour="darkred", fontface="bold", show.legend=NA)

```






500 iteration simulations
Import results - Non-lethal POP
```{r, echo=FALSE}
f_truth <- 1000
m_truth <- 1500
non_sim <- read.csv("results/Nonlethal_sim_500_samps_11.30.19.csv")

head(non_sim)

#Check for NAs
length(which(is.na(non_sim[,1])==TRUE))

#Calculate means
non_m_mean <- mean(non_sim$Nm)
non_m_SE <- mean(non_sim$NmSE)
non_f_mean <- mean(non_sim$Nf)
non_f_SE <- mean(non_sim$NfSE)

#Reformat dataframes for ggplot
F_truth <- 1000
M_truth <- 1500

non_m_df <- non_sim[,3:6]
non_m_df$Sex <- "M"
non_m_df$rel_bias <- ((non_sim$Nm - M_truth)/M_truth)*100
non_m_rel_bias_mean <- round(mean(non_m_df$rel_bias, na.rm=TRUE),1)

non_f_df <- non_sim[,c(1:2, 5:6)]
non_f_df$Sex <- "F"
non_f_df$rel_bias <- ((non_sim$Nf - F_truth)/F_truth)*100
non_f_rel_bias_mean <- round(mean(non_f_df$rel_bias, na.rm=TRUE),1)

colnames(non_f_df)[1:2] = colnames(non_m_df)[1:2] <-  c("Abund","SE")
head(non_f_df)
head(non_m_df)

non_sim_plot <- rbind(non_m_df, non_f_df)
```

Visualize results - Non-lethal POP
```{r, echo=FALSE}
library(ggplot2)
head(non_sim_plot)
#Box plot of relative bias of abundance estimate
ggplot(data=non_sim_plot, aes(x=Sex, y=rel_bias)) +
  geom_boxplot() +
  geom_abline(intercept = 0, slope = 0, color="dark red") +
  ggtitle("CKMR Non-lethal Null Model Simulations (500 samples)") +
  xlab("Sex") +
  ylab("Relative bias") +
  geom_label(aes(label=paste0("Relative bias: ",non_m_rel_bias_mean), x=2, y=50), fill="lightskyblue1", colour="darkslategray", fontface="bold", show.legend=NA) +
  geom_label(aes(label=paste0("Relative bias: ",non_f_rel_bias_mean), x=1, y=50), fill="indianred1", colour="darkred", fontface="bold", show.legend=NA)  

####Visualize relative bias by POPs detected
ggplot(data=non_sim_plot)
```

Import results - Half-sib
```{r, echo=FALSE}
f_truth <- 1000
m_truth <- 1500
half_sim <- read.csv("results/Halfsib_sim_500samps_11.30.2019.csv")
head(half_sim)

#Check for NAs
length(which(is.na(half_sim[,1])==TRUE))

#Calculate means
half_m_mean <- mean(half_sim$Nm)
half_m_SE <- mean(half_sim$NmSE)
half_f_mean <- mean(half_sim$Nf)
half_f_SE <- mean(half_sim$NfSE)

#Reformat dataframes for ggplot
F_truth <- 1000
M_truth <- 1500

half_m_df <- half_sim[,c(3:5,7)]
half_m_df$Sex <- "M"
half_m_df$rel_bias <- ((half_sim$Nm - M_truth)/M_truth)*100
half_m_rel_bias_mean <- round(mean(half_m_df$rel_bias, na.rm=TRUE),1)

half_f_df <- half_sim[,c(1:2,6:7)]
half_f_df$Sex <- "F"
half_f_df$rel_bias <- ((half_sim$Nf - F_truth)/F_truth)*100
half_f_rel_bias_mean <- round(mean(half_f_df$rel_bias, na.rm=TRUE),1)

colnames(half_f_df)[1:3] = colnames(half_m_df)[1:3] <-  c("Abund","SE", "Parent_detected") #For rows where the sex of the parent is female, "Parent detected" will refer to the mothers detected only, and same with males and fathers
head(half_f_df)
head(half_m_df)

half_sim_plot <- rbind(half_m_df, half_f_df)
```

Visualize results
```{r, echo=FALSE}
library(ggplot2)
head(half_sim_plot)
#Box plot of relative bias of abundance estimate
ggplot(data=half_sim_plot, aes(x=Sex, y=rel_bias)) +
  geom_boxplot() +
  geom_abline(intercept = 0, slope = 0, color="dark red") +
  ggtitle("CKMR half-lethal Null Model Simulations (500 samples)") +
  xlab("Sex") +
  ylab("Relative bias") +
  geom_label(aes(label=paste0("Relative bias: ",half_m_rel_bias_mean), x=2, y=50), fill="lightskyblue1", colour="darkslategray", fontface="bold", show.legend=NA) +
  geom_label(aes(label=paste0("Relative bias: ",half_f_rel_bias_mean), x=1, y=50), fill="indianred1", colour="darkred", fontface="bold", show.legend=NA)  

####Visualize relative bias by POPs detected
ggplot(data=non_sim_plot)
```