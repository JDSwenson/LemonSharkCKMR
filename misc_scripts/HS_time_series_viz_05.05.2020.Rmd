---
title: "HS_time_series_viz"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir = "~/R/Results")
```

HS time-series null model simulations - TAKE 2
- Took 1414 samples total
- Just simulated sampling of cohorts; didn't bother repeating over years (don't need year of capture in the final model anyway)
- With seven cohorts represented (years 1:7)
- Same abundance each year: 5000 total: 3000 male and 2000 female
- Estimated abundance for years 4:7. Abundance is estimated for the youngest sibling.
```{r, echo=FALSE}
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#Set working directory
getwd()
setwd("../Results")
HS_ts <- read.csv(file="~/R/Results/HS_time_series_null_poisson_05.01.2020.csv", header=TRUE)
HS_ts2 <- read.csv(file="~/R/Results/HS_time_series_null_5.04.2020.csv", header=TRUE)
HS_ts <- rbind(HS_ts, HS_ts2)

head(HS_ts)
tail(HS_ts)

#Make vectors of column names
col_f_yrs <- paste0("Nf_yr",4:7)
col_f_truth <- paste0("NfTruth_yr",4:7)
col_m_yrs <- paste0("Nm_yr",4:7)
col_m_truth <- paste0("NmTruth_yr",4:7)
colname <- paste0(col_f_yrs[1],"_rel_bias")

#This syntax works for subsetting ... for reference.
#HS_ts[,col_f_yrs[1]]
#And this works for assigning a name with a variable
#assign(paste0(col_f_yrs[1],"_rel_bias"), c(11:20))

#Create columns for relative bias for each abundance estimate
for(i in 1:length(col_f_yrs)){ #years analyzed
  colname_f <- paste0(col_f_yrs[i],"_rel_bias")
  colname_m <- paste0(col_m_yrs[i],"_rel_bias")
  for(j in 1:nrow(HS_ts)){
    HS_ts[j, colname_f] <- ((HS_ts[j, col_f_yrs[i]] - HS_ts[j,col_f_truth[i]])/HS_ts[j,col_f_truth[i]])*100
        HS_ts[j, colname_m] <- ((HS_ts[j, col_m_yrs[i]] - HS_ts[j,col_m_truth[i]])/HS_ts[j,col_m_truth[i]])*100
  }
}

head(HS_ts)
tail(HS_ts)
str(HS_ts)
colnames(HS_ts)

#Combine relative bias, parents detected, and truth into one dataframe
total_abundance <- c(rep(5000, 4)) #Can't estimate for yr=1 because abundance is calculated at time of younger sibling's birth, and there is no scenario where the younger sibling was born in yr1. Also unlikely to get estimate for yr=2 because there are relatively few pairwise comparisons where the younger sibling was born in yr2. So length of vector should be n_yrs-2
N_f <- c(total_abundance/2.5)
N_m <- c(total_abundance-N_f)

#Create dataframe where females and males are combined into the same column - females first
HS_ts2 <- NULL
HS_ts2 <- data.frame(cbind(Yr4_rel_bias=c(HS_ts[,40], HS_ts[,41]), parents_detected_yr4=c(HS_ts[,4],HS_ts[,20]), Yr5_rel_bias=c(HS_ts[,42], HS_ts[,43]), parents_detected_yr5=c(HS_ts[,8],HS_ts[,24]), Yr6_rel_bias=c(HS_ts[,44], HS_ts[,45]), parents_detected_yr6=c(HS_ts[,12],HS_ts[,28]), Yr7_rel_bias=c(HS_ts[,46], HS_ts[,47]), parents_detected_yr7=c(HS_ts[,16],HS_ts[,32]), sex_truth=rep(c(N_f[1],N_m[1]), each=500), total_truth=total_abundance[1]))

HS_ts2$sex <- rep(c("F","M"), each=500) #Add column for sex for visualizing
head(HS_ts)
head(HS_ts2)
tail(HS_ts)
tail(HS_ts2)
#mean(HS_ts$Nm_yr7_rel_bias[HS_ts$Dads_detected_yr7>40])

HS_ts2 <- as.data.table(HS_ts2) #to melt multiple columns, need to convert dataframe to data.table
head(HS_ts2)
colnames(HS_ts2)

#Melt columns together so different years are factors
var1 <- colnames(HS_ts2)[c(1,3,5,7)] #store column names for relative bias
var2 <- colnames(HS_ts2)[c(2, 4, 6, 8)] #store column names for parents detected

HS.m1 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var1, value.name="relative_bias")
HS.m2 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var2, value.name="parents_detected")

HS.m <- NULL
HS.m <- cbind(HS.m1, parents_detected=HS.m2$parents_detected, sex_truth=HS_ts2$sex_truth, total_truth=HS_ts2$total_truth)

#Make bins for kin detected
#HS.m$rent_bins <- cut(HS.m$parents_detected, breaks=c(0, 30, 40, 50, 60, 70, 120), labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
#tail(HS.m,50)

#check that values match
head(HS.m) 
head(HS_ts2) #line above should match first rows of females
tail(HS.m)
tail(HS_ts2) #line above should match last rows of males
nrow(HS.m) #should be iterations x 2(M+F) x number of years estimated (e.g. 500 iterations estimating 4 years should be 4,000 rows long)

#Subset for relative bias columns
#HS_ts_sub <- HS_ts[, grep("rel_bias$", colnames(HS_ts))]

#apply(HS_ts_sub, 2, median) #Calculate mean relative bias
#which(HS_ts_sub$Nm_yr3_rel_bias == max(HS_ts_sub$Nm_yr3_rel_bias)) #Look for outliers

#Combine relative bias columns so we can make factor for sex
#HT <- NULL
#HT <- data.frame(cbind(Yr3_rel_bias=c(HS_ts_sub[,1], HS_ts_sub[,2]),Yr4_rel_bias=c(HS_ts_sub[,3], HS_ts_sub[,4]), Yr5_rel_bias=c(HS_ts_sub[,5], HS_ts_sub[,6]), Yr6_rel_bias=c(HS_ts_sub[,7], HS_ts_sub[,8]), Yr7_rel_bias=c(HS_ts_sub[,9], HS_ts_sub[,10])))
#HT$sex <- rep(c("F","M"), each=500)

#Rearrange dataframe so sex, yr, and relative bias are the (only) columns
#HT.m <- reshape2::melt(HT, id.vars='sex', measure.vars=c(colnames(HT)[1:5]))
#head(HT.m)

#Plot relative bias by year
ggplot(data=HS.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 4", "Year 5", "Year 6", "Year 7"))

#Need to understand how the bias relates to number of half-siblings detected
#Use dataframe HS.m; HS_ts is the original
apply(HS_ts[, grep("^Dads", colnames(HS_ts))], 2, mean) #Calculate mean detected dads
apply(HS_ts[, grep("^Moms", colnames(HS_ts))], 2, mean) #Calculate mean detected moms

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=HS.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias, color=sex)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")
head(HS.m)
tail(HS.m)

G + facet_wrap(vars(variable))
```

HS time-series null model simulations - TAKE 1
- Took 949 samples total
- Over four years (years 4:7)
- With seven cohorts represented (years 1:7)
- Different abundance each year
- Estimated abundance for years 3:7. Abundance is estimated for the youngest sibling, so can't use 1. And have few enough pairwise comparisons between 1 & 2 that using year 2 often reveals no kin pairs and throws an error.
```{r, echo=FALSE}
library(data.table)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(RColorBrewer)

#Set working directory
list.files()
setwd("../Results/time_series/")
HS_ts <- read.csv(file="HS_time_series_null_4.24.2020.csv", header=TRUE)

head(HS_ts)
tail(HS_ts)
HS_ts[HS_ts$Dads_detected_yr7>70,]

#Make vectors of column names
col_f_yrs <- paste0("Nf_yr",3:7)
col_f_truth <- paste0("NfTruth_yr",3:7)
col_m_yrs <- paste0("Nm_yr",3:7)
col_m_truth <- paste0("NmTruth_yr",3:7)
colname <- paste0(col_f_yrs[1],"_rel_bias")

#This syntax works for subsetting ... for reference.
#HS_ts[,col_f_yrs[1]]
#And this works for assigning a name with a variable
#assign(paste0(col_f_yrs[1],"_rel_bias"), c(11:20))

#Create columns for relative bias for each abundance estimate
for(i in 1:length(col_f_yrs)){ #years analyzed
  colname_f <- paste0(col_f_yrs[i],"_rel_bias")
  colname_m <- paste0(col_m_yrs[i],"_rel_bias")
  for(j in 1:nrow(HS_ts)){
    HS_ts[j, colname_f] <- ((HS_ts[j, col_f_yrs[i]] - HS_ts[j,col_f_truth[i]])/HS_ts[j,col_f_truth[i]])*100
        HS_ts[j, colname_m] <- ((HS_ts[j, col_m_yrs[i]] - HS_ts[j,col_m_truth[i]])/HS_ts[j,col_m_truth[i]])*100
  }
}

head(HS_ts)
tail(HS_ts)
str(HS_ts)
colnames(HS_ts)

#Combine relative bias, parents detected, and truth into one dataframe
total_abundance <- c(3000, 5000, 7000, 9000, 2000) #Can't estimate for yr=1 because abundance is calculated at time of younger sibling's birth, and there is no scenario where the younger sibling was born in yr1. Also unlikely to get estimate for yr=2 because there are relatively few pairwise comparisons where the younger sibling was born in yr2. So length of vector should be n_yrs-2
N_f <- c(total_abundance/2.5)
N_m <- c(total_abundance-N_f)

#Create dataframe where males and females are combined into the same column
HS_ts2 <- NULL
HS_ts2 <- data.frame(cbind(Yr3_rel_bias=c(HS_ts[,41], HS_ts[,42]),parents_detected_yr3=c(HS_ts[,4],HS_ts[,24]), Yr4_rel_bias=c(HS_ts[,43], HS_ts[,44]), parents_detected_yr4=c(HS_ts[,8],HS_ts[,28]), Yr5_rel_bias=c(HS_ts[,45], HS_ts[,46]), parents_detected_yr5=c(HS_ts[,12],HS_ts[,32]), Yr6_rel_bias=c(HS_ts[,47], HS_ts[,48]), parents_detected_yr6=c(HS_ts[,16],HS_ts[,36]), Yr7_rel_bias=c(HS_ts[,49], HS_ts[,50])), parents_detected_yr7=c(HS_ts[,20],HS_ts[,40]), yr3_truth=rep(c(N_f[1],N_m[1]), each=500), yr4_truth=rep(c(N_f[2],N_m[2]), each=500), yr5_truth=rep(c(N_f[3],N_m[3]), each=500), yr6_truth=rep(c(N_f[4],N_m[4]), each=500), yr7_truth=rep(c(N_f[5],N_m[5]), each=500), yr3_total_truth=total_abundance[1], yr4_total_truth=total_abundance[2], yr5_total_truth=total_abundance[3], yr6_total_truth=total_abundance[4], yr7_total_truth=total_abundance[5])

HS_ts2$sex <- rep(c("F","M"), each=500) #Add column for sex for visualizing
head(HS_ts)
head(HS_ts2)
tail(HS_ts)
tail(HS_ts2)
#mean(HS_ts$Nm_yr7_rel_bias[HS_ts$Dads_detected_yr7>40])

HS_ts2 <- as.data.table(HS_ts2) #to melt multiple columns, need to convert dataframe to data.table
colnames(HS_ts2)
head(HS_ts2)

#Melt columns together so different years are factors
var1 <- colnames(HS_ts2)[c(1,3,5,7,9)] #store column names for relative bias
var2 <- colnames(HS_ts2)[c(2, 4, 6, 8, 10)] #store column names for parents detected
var3 <- colnames(HS_ts2)[c(11:15)]
var4 <- colnames(HS_ts2)[c(16:20)]
  
HS.m1 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var1, value.name="relative_bias")
HS.m2 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var2, value.name="parents_detected")
HS.m3 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var3, value.name="sex_truth")
HS.m4 <- reshape2::melt(HS_ts2, id.vars='sex', measure.vars=var4, value.name="total_truth")
HS.m <- cbind(HS.m1, parents_detected=HS.m2$parents_detected, sex_truth=HS.m3$sex_truth, total_truth=HS.m4$total_truth)

HS.m <- cbind(HS.m, prop_sampled=round(949/HS.m$total_truth*100, 0))

#Make bins for kin detected
HS.m$rent_bins <- cut(HS.m$parents_detected, breaks=c(0, 30, 40, 50, 60, 70, 120), labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
tail(HS.m,50)

head(HS.m)
tail(HS.m)
tail(HS_ts2)
nrow(HS.m)

#Subset for relative bias columns
#HS_ts_sub <- HS_ts[, grep("rel_bias$", colnames(HS_ts))]

#apply(HS_ts_sub, 2, median) #Calculate mean relative bias
#which(HS_ts_sub$Nm_yr3_rel_bias == max(HS_ts_sub$Nm_yr3_rel_bias)) #Look for outliers

#Combine relative bias columns so we can make factor for sex
#HT <- NULL
#HT <- data.frame(cbind(Yr3_rel_bias=c(HS_ts_sub[,1], HS_ts_sub[,2]),Yr4_rel_bias=c(HS_ts_sub[,3], HS_ts_sub[,4]), Yr5_rel_bias=c(HS_ts_sub[,5], HS_ts_sub[,6]), Yr6_rel_bias=c(HS_ts_sub[,7], HS_ts_sub[,8]), Yr7_rel_bias=c(HS_ts_sub[,9], HS_ts_sub[,10])))
#HT$sex <- rep(c("F","M"), each=500)

#Rearrange dataframe so sex, yr, and relative bias are the (only) columns
#HT.m <- reshape2::melt(HT, id.vars='sex', measure.vars=c(colnames(HT)[1:5]))
#head(HT.m)

#Plot relative bias by year
ggplot(data=HS.m, aes(x=variable)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Year", y="Relative bias", title="Relative Bias Per Year") +
  theme(legend.position="none", plot.title = element_text(hjust=0.5)) +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels = c("Year 3", "Year 4", "Year 5", "Year 6", "Year 7"))

#Need to understand how the bias relates to number of half-siblings detected
#Use dataframe HS.m; HS_ts is the original
apply(HS_ts[, grep("^Dads", colnames(HS_ts))], 2, mean) #Calculate mean detected dads
apply(HS_ts[, grep("^Moms", colnames(HS_ts))], 2, mean) #Calculate mean detected moms

#Plot relative bias by kin pairs detected - scatter plot
G <- ggplot(data=HS.m, aes(x=parents_detected)) +
  geom_point(aes(y=relative_bias, color=sex)) +
  ylim(-100, 100) +
  labs(x="Parents detected", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_colour_brewer(palette="Set2")
head(HS.m)
tail(HS.m)

G + facet_wrap(vars(variable))

#Plot relative bias by kin pairs - binned + box plot
ggplot(data=HS.m, aes(x=rent_bins)) +
  geom_boxplot(aes(y=relative_bias, fill=sex)) +
  ylim(-100, 100) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Kin Pairs", y="Relative bias", title="Relative Bias by Kin Pairs") +
  scale_fill_brewer(palette="Set2") +
  scale_x_discrete(labels=c("<30","31-40", "41-50", "51-60", "61-70", ">70"))
View(HS.m)
```

