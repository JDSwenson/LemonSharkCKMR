---
title: "CKMR results 07/21/2022"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 3
    fig_caption: yes
---

Hi Liz,

Apologies I'm sending this so late - it took me awhile to figure out how to visualize things for the lambda trials; there are so many dimensions to the data! Understanding that you probably won't have a chance to look at this before we meet, I've still included my interpretations for each graph below :)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(scales)
library(ggridges)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

```



```{r set-file-locations and read in files, include = FALSE}
#------------- Simulation parameters and labels  ----------------#
objective_1_MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.validation/Model.output/"
objective_1_results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.validation/Model.results/"
objective_1_results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.validation/Model.results/figures/"

objective_2_MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.2_population.growth/Model.output/"
objective_2_results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.2_population.growth/Model.results/"
objective_2_results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.2_population.growth/Model.results/figures/"

results_prefix <- "CKMR_results"
MCMC_prefix <- "CKMR_modelout"
parents_prefix <- "parents_breakdown/CKMR_parents.breakdown"
sample.prefix <- "sample_info/CKMR_sample.info"
pop.size.prefix <- "pop_size/CKMR_pop.size"
mom.comps.prefix <- "comparisons/mom.comps"
dad.comps.prefix <- "comparisons/dad.comps"


#-------------Objective 1.1 --------------------#
date.of.simulation.scenario_1.1Y <- "12Jul2022"
purpose.obj1.1Y <- "Obj1.1_model.validation_Target.YOY"
file.scenario_1.1Y <- "scenario_1.1_model.validation_Target.YOY"
purpose.obj1.1.labY <- "Target YOY"
model.type.obj1.1Y <- "HS.only"

date.of.simulation.scenario_1.1J <- "12Jul2022"
purpose.obj1.1J <- "Obj1.1_model.validation_sample.all.juvenile.ages"
file.scenario_1.1J <- "scenario_1.1_model.validation_sample.all.juvenile.ages"
purpose.obj1.1.labJ <- "Sample all juvenile ages"
model.type.obj1.1J <- "HS.only"

date.of.simulation.scenario_1.1A <- "13Jul2022"
purpose.obj1.1A <- "Obj1.1_model.validation_sample.ALL.ages"
file.scenario_1.1A <- "scenario_1.1_model.validation_sample.ALL.ages"
purpose.obj1.1.labA <- "Sample all age classes"
model.type.obj1.1A <- "HS + PO"


#-------------Objective 1.2 --------------------#
date.of.simulation.scenario_1.2Y <- "13Jul2022"
purpose.obj1.2Y <- "Obj1.2_model.validation_Target.YOY"
file.scenario_1.2Y <- "scenario_1.2_model.validation_Target.YOY"
purpose.obj1.2.labY <- "Target YOY"
model.type.obj1.2Y <- "HS.only"

date.of.simulation.scenario_1.2J <- "13Jul2022"
purpose.obj1.2J <- "Obj1.2_model.validation_sample.all.juvenile.ages"
file.scenario_1.2J <- "scenario_1.2_model.validation_sample.all.juvenile.ages"
purpose.obj1.2.labJ <- "Sample all juvenile ages"
model.type.obj1.2J <- "HS.only"

date.of.simulation.scenario_1.2A <- "13Jul2022"
purpose.obj1.2A <- "Obj1.2_model.validation_sample.ALL.ages"
file.scenario_1.2A <- "scenario_1.2_model.validation_sample.ALL.ages"
purpose.obj1.2.labA <- "Sample all age classes"
model.type.obj1.2A <- "HS + PO"


#-------------Objective 2.1 --------------------#
date.of.simulation.scenario_2.1Y <- "13Jul2022"
purpose.obj2.1Y <- "Obj2.1_lambda.trial_Target.YOY"
file.scenario_2.1Y <- "scenario_2.1_lambda.trial_Target.YOY"
purpose.obj2.1.labY <- "Target YOY"
model.type.obj2.1Y <- "HS.only"

date.of.simulation.scenario_2.1J <- "13Jul2022"
purpose.obj2.1J <- "Obj2.1_lambda.trial_sample.all.juvenile.ages"
file.scenario_2.1J <- "scenario_2.1_lambda.trial_sample.all.juvenile.ages"
purpose.obj2.1.labJ <- "Sample all juvenile ages"
model.type.obj2.1J <- "HS.only"

date.of.simulation.scenario_2.1A <- "13Jul2022"
purpose.obj2.1A <- "Obj2.1_lambda.trial_sample.ALL.ages"
file.scenario_2.1A <- "scenario_2.1_lambda.trial_sample.ALL.ages"
purpose.obj2.1.labA <- "Sample all age classes"
model.type.obj2.1A <- "HS + PO"


#-------------Objective 2.2.1 --------------------#
date.of.simulation.scenario_2.2.1Y <- "13Jul2022"
purpose.obj2.2.1Y <- c("Obj2.2.1_lambda.trial_Target.YOY_stablePopSimLambda","Obj2.2.1_lambda.trial_Target.YOY_variablePopSimLambda")
file.scenario_2.2.1Y <- c("scenario_2.2.1_lambda.trial_Target.YOY_stablePopSimLambda","scenario_2.2.1_lambda.trial_Target.YOY_variablePopSimLambda")
purpose.obj2.2.1.labY <- "Target YOY"
model.type.obj2.2.1Y <- "HS.only"

date.of.simulation.scenario_2.2.1J <- "13Jul2022"
purpose.obj2.2.1J <- c("Obj2.2.1_lambda.trial_sample.all.juvenile.ages_stablePopSimLambda", "Obj2.2.1_lambda.trial_sample.all.juvenile.ages_variablePopSimLambda")
file.scenario_2.2.1J <- c("scenario_2.2.1_lambda.trial_sample.all.juvenile.ages_stablePopSimLambda", "scenario_2.2.1_lambda.trial_sample.all.juvenile.ages_variablePopSimLambda")
purpose.obj2.2.1.labJ <- "Sample all juvenile ages"
model.type.obj2.2.1J <- "HS.only"

date.of.simulation.scenario_2.2.1A <- "13Jul2022"
purpose.obj2.2.1A <- c("Obj2.2.1_lambda.trial_sample.ALL.ages_stablePopSimLambda", "Obj2.2.1_lambda.trial_sample.ALL.ages_variablePopSimLambda")
file.scenario_2.2.1A <- c("scenario_2.2.1_lambda.trial_sample.ALL.ages_stablePopSimLambda", "scenario_2.2.1_lambda.trial_sample.ALL.ages_variablePopSimLambda")
purpose.obj2.2.1.labA <- "Sample all age classes"
model.type.obj2.2.1A <- "HS + PO"


#-------------Objective 2.2.2 --------------------#
#Named some of these with the wrong purpose. The popsim variable files did not include "variablePopSim" in the purpose, but the stable popsim simulations did include "stablePopSim". Also, the Target.YOY files were not capitalized.

date.of.simulation.scenario_2.2.2Y <- "14Jul2022"
purpose.obj2.2.2Y <- c("Obj2.2.2_lambda.trial_target.YOY_change.est.yr", "Obj2.2.2_lambda.trial_target.YOY_stablePopSimLambda_change.est.yr")
file.scenario_2.2.2Y <- c("scenario_2.2.2_lambda.trial_target.YOY_change.est.yr", "scenario_2.2.2_lambda.trial_target.YOY_stablePopSimLambda_change.est.yr")
purpose.obj2.2.2.labY <- "Target YOY"
model.type.obj2.2.2Y <- "HS.only"

date.of.simulation.scenario_2.2.2J <- "14Jul2022"
purpose.obj2.2.2J <- c("Obj2.2.2_lambda.trial_sample.all.juvenile.ages_change.est.yr", "Obj2.2.2_lambda.trial_sample.all.juvenile.ages_stablePopSimLambda_change.est.yr")
file.scenario_2.2.2J <- c("scenario_2.2.2_lambda.trial_sample.all.juvenile.ages_change.est.yr", "scenario_2.2.2_lambda.trial_sample.all.juvenile.ages_stablePopSimLambda_change.est.yr")
purpose.obj2.2.2.labJ <- "Sample all juvenile ages"
model.type.obj2.2.2J <- "HS.only"

date.of.simulation.scenario_2.2.2A <- "14Jul2022"
purpose.obj2.2.2A <- c("Obj2.2.2_lambda.trial_sample.ALL.ages_change.est.yr", "Obj2.2.2_lambda.trial_sample.ALL.ages_stablePopSimLambda_change.est.yr")
file.scenario_2.2.2A <- c("scenario_2.2.2_lambda.trial_sample.ALL.ages_change.est.yr", "scenario_2.2.2_lambda.trial_sample.ALL.ages_stablePopSimLambda_change.est.yr")
purpose.obj2.2.2.labA <- "Sample all age classes"
model.type.obj2.2.2A <- "HS + PO"


#---------------------Objective 1: read in files--------------------------#
#---------------------Truth files-----------------------------------------#
seeds <- "Seeds2022.04.15"
# sim.samples.obj1 <- "1prop.sampled" #Label on file output
# samples.obj1.lab <- "1 percent sampled" #Label for dataframe and figures

source(file = "~/R/working_directory/LemonSharkCKMR/02_DataViz/functions/truth_calcs.R")
obj1.truth.df
obj2.truth.df

#--------------------- Objective 1.1 ---------------------------------#
#Files
scenario_1.1_files <- list.files(path = objective_1_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_1.1_*",
                            full.names = TRUE)

#Results
scenario_1.1_results <- map_dfr(scenario_1.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose == purpose.obj1.1Y, "target YOY",
                                  ifelse(purpose == purpose.obj1.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "informed",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs)) %>% 
  mutate(sampling.scheme = factor(sampling.scheme))

#--------------------- Objective 1.2 ---------------------------------#
#Files
scenario_1.2_files <- list.files(path = objective_1_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_1.2_*",
                            full.names = TRUE)

#Results
scenario_1.2_results <- map_dfr(scenario_1.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose == purpose.obj1.2Y, "target YOY",
                                  ifelse(purpose == purpose.obj1.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs)) %>% 
  mutate(sampling.scheme = factor(sampling.scheme))
  

obj1_results <- scenario_1.1_results %>% bind_rows(scenario_1.2_results) %>% 
  inner_join(obj1.truth.df, by = c("iteration", "sampling.scheme")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", male.truth,
                            ifelse(parameter == "Nf", female.truth, all.truth))) %>% 
  dplyr::select(-c(male.truth, female.truth)) %>% 
  mutate(prop.sampled.lab = paste0(prop.sampled, " percent sampled"))




#--------------------- Objective 2.1 ---------------------------------#
scenario_2.1_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.1_*",
                            full.names = TRUE)

scenario_2.1_neutral <- scenario_1.2_results

#Read in files for objective 2.1 - which only includes positive and negative growth - and add neutral growth to the dataframe
#Also add truth
scenario_2.1_results <- map_dfr(scenario_2.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose == purpose.obj2.1Y, "target YOY",
                                  ifelse(purpose == purpose.obj2.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,)) %>%
  bind_rows(scenario_2.1_neutral) %>% #Add in neutral growth scenario
  mutate(population.growth = ifelse(female.fecundity > 3, "positive", #neutral is 2.9
                                    ifelse(female.fecundity < 2.8, "negative", "neutral"))) %>% 
    inner_join(obj2.truth.df, by = c("iteration", "population.growth", "seed")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop))



#--------------------- Objective 2.2.1 ---------------------------------#
#Same scenario as 2.1, but add lambda to the model
scenario_2.2.1_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.2.1_*",
                            full.names = TRUE)

scenario_2.2.1_results <- map_dfr(scenario_2.2.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.2.1Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.2.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "diffuse",
         est.yr = 85,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs),
         population.growth = ifelse(female.fecundity > 3, "positive",
                                    ifelse(female.fecundity < 2.8, "negative", "neutral")))

#--------------------- Objective 2.2.2 ---------------------------------#
#Same scenario as 2.2.1, except estimate in different years
scenario_2.2.2_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.2.2_*",
                            full.names = TRUE)

scenario_2.2.2_results <- map_dfr(scenario_2.2.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.2.2Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.2.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "diffuse",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs),
         population.growth = ifelse(female.fecundity > 3, "positive",
                                    ifelse(female.fecundity < 2.8, "negative", "neutral")))

#Combine results for objective 2
obj2_results <- scenario_2.2.2_results %>% bind_rows(scenario_2.2.1_results, scenario_2.1_results) %>% 
  inner_join(obj2.truth.df, by = c("population.growth", "iteration", "est.yr", "seed")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop)) %>% 
  mutate(sampling.scheme = factor(sampling.scheme),
         population.growth = factor(population.growth)) %>% 
  mutate(prop.sampled.lab = paste0(prop.sampled, " percent sampled")) %>% 
  replace_na(list(lambda.prior = "none")) %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1)) %>% 
  mutate(in_interval = ifelse(HPD2.5 < all.truth & all.truth < HPD97.5, "Y", "N"))

```



```{r quick-results-analysis-and-filtering, echo = FALSE, include = FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
#-------------Objective 1 --------------------#
#Check that all sampling schemes and population growth scenarios are represented
obj1_results %>% group_by(sampling.scheme) %>% 
  summarize(number = n())

obj1_results %>% group_by(population.growth) %>% 
  summarize(number = n())

obj1_results %>% group_by(prop.sampled) %>% 
  summarize(number = n())

obj1_results %>% group_by(parameter) %>% 
  summarize(number = n())

obj1_results %>% group_by(survival.prior) %>% 
  summarize(number = n())

#-------------Objective 2 --------------------#
#Check that all sampling schemes and population growth scenarios are represented
obj2_results %>% group_by(sampling.scheme) %>% 
  summarize(number = n())

obj2_results %>% group_by(population.growth) %>% 
  summarize(number = n())

obj2_results %>% group_by(est.yr) %>% 
  summarize(number = n())

obj2_results %>% group_by(prop.sampled) %>% 
  summarize(number = n())

obj2_results %>% group_by(parameter) %>% 
  summarize(number = n())


#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj1_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj1_results <- obj1_results %>% dplyr::filter(Rhat < 1.01)

#Check percent in interval; can change proportion sampled
obj1_results %>% dplyr::filter(prop.sampled == 2) %>% 
  group_by(parameter, sampling.scheme, survival.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100) %>%
  dplyr::arrange(percent_in_interval)

#Median relative bias by sample size
 obj1_results %>% dplyr::filter(prop.sampled == 1) %>% 
   group_by(parameter, sampling.scheme, survival.prior) %>% 
   dplyr::summarize(median.bias = median(relative_bias), n = n()) %>% 
   dplyr::arrange(desc(median.bias))


  
#-------------Objective 2 --------------------#
#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj2_results <- obj2_results %>% dplyr::filter(Rhat < 1.01)

#No parameter for lambda; only positive and negative population simulations
obj2_results %>% dplyr::filter(prop.sampled == 1, est.yr == 90) %>% 
  group_by(parameter, lambda.prior, sampling.scheme, population.growth) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100) %>%
  dplyr::arrange(percent_in_interval)


#Median relative bias by sample size
#No parameter for lambda
obj2_results %>% dplyr::filter(prop.sampled == 1, est.yr == 90) %>% 
  group_by(parameter, lambda.prior, sampling.scheme, population.growth) %>% 
   dplyr::summarize(median.bias = median(relative_bias), n = n()) %>% 
   dplyr::arrange(desc(median.bias))
```


This is the initial model validation graph, where lambda was approximately stable in the population simulations and the model didn't include lambda, but rather averaged over abundance values.
It appears to me that a) the model works well overall, and b) targeted sampling of young-of-year starts to bias a little high at higher sample sizes. I'm thinking this may arise because we are sampling from fewer cohorts, and may be oversampling some parents.
```{r Obj1-Density-Plots, echo=FALSE, out.width = "120%"}
#---------------Figure 1---------------------#
#plot.colors <- c("aquamarine", "aquamarine4", "indianred1", "indianred4", "khaki4")
plot.colors <- c("aquamarine4", "indianred1", "indianred4")
#scales::show_col(plot.colors)
#scale_fill_manual(values = plot.colors) #Add this line to use the plot colors above

#Relevel for better visualization

# obj1_results %>% group_by(survival.prior) %>% 
#   summarize(n())

#-------------------Objective 1 Density plots-------------------------#
obj1_results %>% dplyr::filter(survival.prior == "diffuse") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = sampling.scheme)) + 
  geom_density_ridges(alpha = 0.6) + 
#  theme_ridges() + 
  facet_wrap(~prop.sampled.lab) + 
  theme(legend.title = element_blank()) + 
  xlim(-100, 100)
```

```{r Obj2.make-Density-Plots, echo=FALSE, include=FALSE}
#Density plot for Nf
# (obj1.fig.Nf <- obj1_results %>% dplyr::filter(parameter == "Nf",
#                                               survival.prior == "diffuse") %>% 
#     ggplot(aes(x = relative_bias, color = sampling.scheme, fill = sampling.scheme)) +
#     geom_density(alpha = 0.6) + 
#     ggtitle("A) Nf") + 
#     labs(x = "Relative bias of posterior median") +
#     geom_vline(xintercept=c(0), linetype="dotted") +
#     theme_bw() + 
#     theme(legend.title = element_blank()) + 
#     scale_fill_manual(values = plot.colors.fig1) +
#     scale_color_manual(values = plot.colors.fig1) +
#     facet_wrap(~prop.sampled) +
#     xlim(-100, 100))

#-------------------Objective 2 Density plots-------------------------#
#Target YOY
obj2.YOY.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
  scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.YOY.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
    mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.YOY.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.YOY.plots <- ggarrange(obj2.YOY.p1, obj2.YOY.p2, obj2.YOY.p3, common.legend = TRUE, nrow = 3, legend = "bottom")



#Sample all juvenile ages
obj2.juvs.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.juvs.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.juvs.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.juv.plots <- ggarrange(obj2.juvs.p1, obj2.juvs.p2, obj2.juvs.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


#Sample ALL age classes
obj2.allages.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.allages.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.allages.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.allages.plots <- ggarrange(obj2.allages.p1, obj2.allages.p2, obj2.allages.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


# (fig1.p1.violin <- obj1_results %>% 
#   ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme))) +
#   geom_violin(aes(y=cv), draw_quantiles = 0.5) +
#   #ylim(-50, 160) +
#   geom_hline(yintercept=0, col="black", size=1.25) +
#   #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
#   labs(x="Parameter", y="CV", title="D) CV") +
#   scale_fill_manual(values = plot.colors.fig1) +
#   font("title", size = 10, face = "bold")) +
#   facet_wrap(~prop.sampled) +
#   theme(legend.title = element_blank())


```
\
\
The next graphs are examining how the model performs when population growth is positive, negative or neutral, comparing one model that accounts for this with a prior for lambda (uniform(0.95, 1.05)) and one that does not. In each case, the truth used to calculate relative bias is a specific year (vs the mean in model validation).
\
First, with targeted sampling of young-of-year, it looks like the model actually performs *worse* with lambda when the year of estimation is 10 years in the past. At 5 years past and present, the two appear to perform equivalently, suggesting that if limited population growth is expected, with targeted sampling of YOY at least, there's no real reason to include lambda in the model.
```{r Obj2.YOY-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.YOY.plots, top = text_grob("Target young-of-year", size = 14, face = "bold"))
```
\
\
The results are similar when all juvenile age classes are sampled, except estimates 10 years in the past are more accurate than with targeted sampling of young-of-year. This is likely a consequence of having more age classes over which to estimate survival and lambda.
```{r Obj2.juv-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.juv.plots, top = text_grob("Sample all juvenile ages", size = 14, face = "bold"))
```
\
\
The best performing model is the model that samples across age classes and includes parent-offspring pairs, as expected. Here, the model performs better with a diffuse prior on lambda than when lambda is not included.
```{r Obj2.allages-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.allages.plots, top = text_grob("sample all age classes", size = 14, face = "bold"))
```





Notes to self:
Objective 1: What drives bias when kin pairs match expectations?
Inconclusive so far (07/19/2022). I should return to this later
```{r, echo=FALSE, include=FALSE}
# obj1_results %>% dplyr::filter(HSPs_detected == HSPs_expected & sampling.scheme != "sample all age classes" & survival.prior == "diffuse") %>% 
#   dplyr::arrange(iteration) %>% 
#   dplyr::select(parameter, prop.sampled, iteration, sampling.scheme, relative_bias, survival.prior, HSPs_expected, HSPs_detected) %>% 
#   View()
# 
# mom_comps <- readRDS(paste0(obj1.2_results_location, mom.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# dad_comps <- readRDS(paste0(obj1.2_results_location, dad.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# plot.colors.fig1 <- c("aquamarine4", "indianred1", "indianred4")
# scales::show_col(plot.colors.fig1)
# 
# #Split "yes" up into separate rows so we can make a histogram of mort years
# mom_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)
# 
# dad_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)

#Interesting iterations: not bad bias
#iteration 36 (not bad bias): all parameters, 1_prop_sampled, sample_all_juvenile_ages;
#Nf, iteration_21, 1.0_prop_sampled, sample_all_juvenile_ages
#survival: iteration_28, 2.0_prop_sampled, sample_all_juvenile_ages
#Bad bias
##iteration 85 all parameters: 0.5_prop_sampled, sample_all_juvenile_ages;
#other bad biases: Nf, iteration 44, 1.0_prop_sampled, sample_all_juvenile_ages


```

Things to tackle next:
1. Objective 1: Look into the number of individual parents that are sampled in the initial model validation runs to see if we are oversampling some parents, particularly with targeted sampling of YOY.
