---
title: "CKMR results 07/21/2022"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 3
    fig_caption: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(scales)
library(ggridges)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

```


```{r set-file-locations and read in files, include = FALSE}
#------------- Simulation parameters and labels  ----------------#
objective_1_MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.validation/Model.output/"
objective_1_results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.validation/Model.results/"
objective_1_results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.validation/Model.results/figures/"

objective_2_MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.2_population.growth/Model.output/"
objective_2_results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.2_population.growth/Model.results/"
objective_2_results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.2_population.growth/Model.results/figures/"

objective_3_MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.3_intermittent.breeding/Model.output/"
objective_3_results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.3_intermittent.breeding/Model.results/"
objective_3_results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.3_intermittent.breeding/Model.results/figures/"


results_prefix <- "CKMR_results"
MCMC_prefix <- "CKMR_modelout"
parents_prefix <- "parents_breakdown/CKMR_parents.breakdown"
sample.prefix <- "sample_info/CKMR_sample.info"
pop.size.prefix <- "pop_size/CKMR_pop.size"
mom.comps.prefix <- "comparisons/mom.comps"
dad.comps.prefix <- "comparisons/dad.comps"


#-------------Objective 1.1 --------------------#
date.of.simulation.scenario_1.1Y <- "24Jul2022"
purpose.obj1.1Y <- "Obj1.1_model.validation_Target.YOY"
file.scenario_1.1Y <- "scenario_1.1_model.validation_Target.YOY"
purpose.obj1.1.labY <- "Target YOY"
model.type.obj1.1Y <- "HS.only"

date.of.simulation.scenario_1.1J <- "24Jul2022"
purpose.obj1.1J <- "Obj1.1_model.validation_sample.all.juvenile.ages"
file.scenario_1.1J <- "scenario_1.1_model.validation_sample.all.juvenile.ages"
purpose.obj1.1.labJ <- "Sample all juvenile ages"
model.type.obj1.1J <- "HS.only"

date.of.simulation.scenario_1.1A <- "24Jul2022"
purpose.obj1.1A <- "Obj1.1_model.validation_sample.ALL.ages"
file.scenario_1.1A <- "scenario_1.1_model.validation_sample.ALL.ages"
purpose.obj1.1.labA <- "Sample all age classes"
model.type.obj1.1A <- "HS + PO"


#-------------Objective 1.2 --------------------#
#date.of.simulation.scenario_1.2Y <- "24Jul2022"
purpose.obj1.2Y <- "Obj1.2_model.validation_Target.YOY"
file.scenario_1.2Y <- "scenario_1.2_model.validation_Target.YOY"
purpose.obj1.2.labY <- "Target YOY"
model.type.obj1.2Y <- "HS.only"

#date.of.simulation.scenario_1.2J <- "24Jul2022"
purpose.obj1.2J <- "Obj1.2_model.validation_sample.all.juvenile.ages"
file.scenario_1.2J <- "scenario_1.2_model.validation_sample.all.juvenile.ages"
purpose.obj1.2.labJ <- "Sample all juvenile ages"
model.type.obj1.2J <- "HS.only"

#date.of.simulation.scenario_1.2A <- "24Jul2022"
purpose.obj1.2A <- "Obj1.2_model.validation_sample.ALL.ages"
file.scenario_1.2A <- "scenario_1.2_model.validation_sample.ALL.ages"
purpose.obj1.2.labA <- "Sample all age classes"
model.type.obj1.2A <- "HS + PO"


#-------------Objective 2.1 --------------------#
#date.of.simulation.scenario_2.1Y <- "13Jul2022"
purpose.obj2.1Y <- c("scenario_2.1_lambda.trial_Target.YOY","scenario_2.1_lambda.extreme_Target.YOY")
file.scenario_2.1Y <- c("scenario_2.1.1_lambda.trial_Target.YOY", "scenario_2.1.2_lambda.extreme_Target.YOY")
purpose.obj2.1.labY <- "Target YOY"
model.type.obj2.1Y <- "HS.only"

#date.of.simulation.scenario_2.1J <- "13Jul2022"
purpose.obj2.1J <- c("scenario_2.1_lambda.trial_sample.all.juvenile.ages", "scenario_2.1_lambda.extreme_sample.all.juvenile.ages")
file.scenario_2.1J <- c("scenario_2.1.1_lambda.trial_sample.all.juvenile.ages", "scenario_2.1.2_lambda.extreme_sample.all.juvenile.ages")
purpose.obj2.1.labJ <- "Sample all juvenile ages"
model.type.obj2.1J <- "HS.only"

#date.of.simulation.scenario_2.1A <- "13Jul2022"
purpose.obj2.1A <- c("scenario_2.1_lambda.trial_sample.ALL.ages", "scenario_2.1_lambda.extreme_sample.ALL.ages")
file.scenario_2.1A <- c("scenario_2.1.1_lambda.trial_sample.ALL.ages", "scenario_2.1.2_lambda.extreme_sample.ALL.ages")
purpose.obj2.1.labA <- "Sample all age classes"
model.type.obj2.1A <- "HS + PO"


#-------------Objective 2.2 --------------------#
#date.of.simulation.scenario_2.2Y <- "26Jul2022"
purpose.obj2.2Y <- c("scenario_2.2.1_lambda.trial_target.YOY_change.est.yr", "scenario_2.2.2_lambda.extreme_target.YOY_change.est.yr", "scenario_2.2.3_lambda.extreme_target.YOY_change.est.yr")
file.scenario_2.2Y <- c("scenario_2.2.1_lambda.trial_target.YOY_change.est.yr", "scenario_2.2.2_lambda.extreme_target.YOY_change.est.yr", "scenario_2.2.3_lambda.extreme_target.YOY_change.est.yr")
purpose.obj2.2.labY <- "Target YOY"
model.type.obj2.2Y <- "HS.only"

#date.of.simulation.scenario_2.2J <- "26Jul2022"
purpose.obj2.2J <- c("scenario_2.2.1_lambda.trial_sample.all.juvenile.ages_change.est.yr", "scenario_2.2.2_lambda.extreme_sample.all.juvenile.ages_change.est.yr", "scenario_2.2.3_lambda.extreme_sample.all.juvenile.ages_change.est.yr")
file.scenario_2.2J <- c("scenario_2.2.1_lambda.trial_sample.all.juvenile.ages_change.est.yr", "scenario_2.2.2_lambda.extreme_sample.all.juvenile.ages_change.est.yr", "scenario_2.2.3_lambda.extreme_sample.all.juvenile.ages_change.est.yr")
purpose.obj2.2.labJ <- "Sample all juvenile ages"
model.type.obj2.2J <- "HS.only"

#date.of.simulation.scenario_2.2A <- "26Jul2022"
purpose.obj2.2A <- c("scenario_2.1_lambda.extreme_sample.ALL.ages", "scenario_2.2.2_lambda.extreme_sample.ALL.ages_change.est.yr", "scenario_2.2.3_lambda.extreme_sample.ALL.ages_change.est.yr")
file.scenario_2.2A <- c("scenario_2.2.1_lambda.trial_sample.ALL.ages_change.est.yr", "scenario_2.2.2_lambda.extreme_sample.ALL.ages_change.est.yr", "scenario_2.2.3_lambda.extreme_sample.ALL.ages_change.est.yr")
purpose.obj2.2.labA <- "Sample all age classes"
model.type.obj2.2A <- "HS + PO"



#-------------Objective 3.1 --------------------#
#date.of.simulation.scenario_2.2.1Y <- "13Jul2022"
purpose.obj3.1Y <- c("scenario_3.1.1_SB_target.YOY", "scenario_3.1.2_SB_target.YOY")
file.scenario_3.1Y <- c("", "")
purpose.obj3.1.labY <- "Target YOY"
model.type.obj3.1Y <- "HS.only"

#date.of.simulation.scenario_3.1.1J <- "13Jul2022"
purpose.obj3.1J <- c("scenario_3.1.1_SB_sample.all.juvenile.ages", "scenario_3.1.2_SB_sample.all.juvenile.ages")
file.scenario_3.1J <- c("", "")
purpose.obj3.1.labJ <- "Sample all juvenile ages"
model.type.obj3.1J <- "HS.only"

#date.of.simulation.scenario_3.1.1A <- "13Jul2022"
purpose.obj3.1A <- c("scenario_3.1.1_SB_sample.ALL.ages", "scenario_3.1.2_SB_sample.ALL.ages")
file.scenario_3.1A <- c("", "")
purpose.obj3.1.labA <- "Sample all age classes"
model.type.obj3.1A <- "HS + PO"


#-------------Objective 3.2 --------------------#
#date.of.simulation.scenario_2.2.1Y <- "13Jul2022"
purpose.obj3.2Y <- c("scenario_3.2.1_SB_target.YOY", "scenario_3.2.2_SB_target.YOY")
file.scenario_3.2Y <- c("scenario_3.2.1_SB_target.YOY", "scenario_3.2.2_SB_target.YOY")
purpose.obj3.2.labY <- "Target YOY"
model.type.obj3.2Y <- "HS.only"

#date.of.simulation.scenario_3.2.1J <- "13Jul2022"
purpose.obj3.2J <- c("scenario_3.2.1_SB_sample.all.juvenile.ages", "scenario_3.2.2_SB_sample.all.juvenile.ages")
file.scenario_3.2J <- c("scenario_3.2.1_SB_sample.all.juvenile.ages", "scenario_3.2.2_SB_sample.all.juvenile.ages")
purpose.obj3.2.labJ <- "Sample all juvenile ages"
model.type.obj3.2J <- "HS.only"

#date.of.simulation.scenario_3.2.1A <- "13Jul2022"
purpose.obj3.2A <- c("scenario_3.2.1_SB_sample.ALL.ages", "scenario_3.2.2_SB_sample.ALL.ages")
file.scenario_3.2A <- c("scenario_3.2.1_SB_sample.ALL.ages", "scenario_3.2.2_SB_sample.ALL.ages")
purpose.obj3.2.labA <- "Sample all age classes"
model.type.obj3.2A <- "HS + PO"


#-------------Scenario 3.3 --------------------#
#date.of.simulation.scenario_2.2.1Y <- "13Jul2022"
purpose.obj3.3Y <- c("scenario_3.3.1_SB_target.YOY", "scenario_3.3.2_SB_target.YOY")
file.scenario_3.3Y <- c("scenario_3.3.1_SB_target.YOY", "scenario_3.3.2_SB_target.YOY")
purpose.obj3.3.labY <- "Target YOY"
model.type.obj3.3Y <- "HS.only"

#date.of.simulation.scenario_3.3.1J <- "13Jul2022"
purpose.obj3.3J <- c("scenario_3.3.1_SB_sample.all.juvenile.ages", "scenario_3.3.2_SB_sample.all.juvenile.ages")
file.scenario_3.3J <- c("scenario_3.3.1_SB_sample.all.juvenile.ages", "scenario_3.3.2_SB_sample.all.juvenile.ages")
purpose.obj3.3.labJ <- "Sample all juvenile ages"
model.type.obj3.3J <- "HS.only"

#date.of.simulation.scenario_3.3.1A <- "13Jul2022"
purpose.obj3.3A <- c("scenario_3.3.1_SB_sample.ALL.ages", "scenario_3.3.2_SB_sample.ALL.ages")
file.scenario_3.3A <- c("scenario_3.3.1_SB_sample.ALL.ages", "scenario_3.3.2_SB_sample.ALL.ages")
purpose.obj3.3.labA <- "Sample all age classes"
model.type.obj3.3A <- "HS + PO"


# #-------------Objective 2.2.2 --------------------#
# #Named some of these with the wrong purpose. The popsim variable files did not include "variablePopSim" in the purpose, but the stable popsim simulations did include "stablePopSim". Also, the Target.YOY files were not capitalized.
# 
# date.of.simulation.scenario_2.2.2Y <- "14Jul2022"
# purpose.obj2.2.2Y <- c("Obj2.2.2_lambda.trial_target.YOY_change.est.yr", "Obj2.2.2_lambda.trial_target.YOY_stablePopSimLambda_change.est.yr")
# file.scenario_2.2.2Y <- c("scenario_2.2.2_lambda.trial_target.YOY_change.est.yr", "scenario_2.2.2_lambda.trial_target.YOY_stablePopSimLambda_change.est.yr")
# purpose.obj2.2.2.labY <- "Target YOY"
# model.type.obj2.2.2Y <- "HS.only"
# 
# date.of.simulation.scenario_2.2.2J <- "14Jul2022"
# purpose.obj2.2.2J <- c("Obj2.2.2_lambda.trial_sample.all.juvenile.ages_change.est.yr", "Obj2.2.2_lambda.trial_sample.all.juvenile.ages_stablePopSimLambda_change.est.yr")
# file.scenario_2.2.2J <- c("scenario_2.2.2_lambda.trial_sample.all.juvenile.ages_change.est.yr", "scenario_2.2.2_lambda.trial_sample.all.juvenile.ages_stablePopSimLambda_change.est.yr")
# purpose.obj2.2.2.labJ <- "Sample all juvenile ages"
# model.type.obj2.2.2J <- "HS.only"
# 
# date.of.simulation.scenario_2.2.2A <- "14Jul2022"
# purpose.obj2.2.2A <- c("Obj2.2.2_lambda.trial_sample.ALL.ages_change.est.yr", "Obj2.2.2_lambda.trial_sample.ALL.ages_stablePopSimLambda_change.est.yr")
# file.scenario_2.2.2A <- c("scenario_2.2.2_lambda.trial_sample.ALL.ages_change.est.yr", "scenario_2.2.2_lambda.trial_sample.ALL.ages_stablePopSimLambda_change.est.yr")
# purpose.obj2.2.2.labA <- "Sample all age classes"
# model.type.obj2.2.2A <- "HS + PO"


#---------------------Objective 1: read in files--------------------------#
#---------------------Truth files-----------------------------------------#
seeds <- "Seeds2022.04.15"
# sim.samples.obj1 <- "1prop.sampled" #Label on file output
# samples.obj1.lab <- "1 percent sampled" #Label for dataframe and figures

source(file = "~/R/working_directory/LemonSharkCKMR/02_DataViz/functions/truth_calcs.R")
obj1.truth.df
obj2.truth.df
obj3.truth.df.1
obj3.truth.df.2

#--------------------- Objective 1.1 ---------------------------------#
#Files
scenario_1.1_files <- list.files(path = objective_1_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_1.1_*",
                            full.names = TRUE)

#Results
scenario_1.1_results <- map_dfr(scenario_1.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose == purpose.obj1.1Y, "target YOY",
                                  ifelse(purpose == purpose.obj1.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "informed",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs)) %>% 
  mutate(sampling.scheme = factor(sampling.scheme))

#--------------------- Objective 1.2 ---------------------------------#
#Files
scenario_1.2_files <- list.files(path = objective_1_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_1.2_*",
                            full.names = TRUE)

#Results
scenario_1.2_results <- map_dfr(scenario_1.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose == purpose.obj1.2Y, "target YOY",
                                  ifelse(purpose == purpose.obj1.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs)) %>% 
  mutate(sampling.scheme = factor(sampling.scheme))
  

obj1_results <- scenario_1.1_results %>% bind_rows(scenario_1.2_results) %>% 
  inner_join(obj1.truth.df, by = c("iteration", "sampling.scheme")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", male.truth,
                            ifelse(parameter == "Nf", female.truth, all.truth))) %>% 
  dplyr::select(-c(male.truth, female.truth)) %>% 
  mutate(prop.sampled.lab = paste0(prop.sampled, " percent sampled"))




#--------------------- Objective 2.1 ---------------------------------#
scenario_2.1.1_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.1.1_*",
                            full.names = TRUE)

scenario_2.1.1_files #Double-check that the correct files are imported

scenario_2.1.2_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.1.2_*",
                            full.names = TRUE)

scenario_2.1.2_files #Double-check that the correct files are imported



#scenario_2.1_neutral <- scenario_1.2_results
#Read in files for objective 2.1 - which only includes positive and negative growth - and add neutral growth to the dataframe
#Also add truth
#Minor population growth
scenario_2.1.1_results <- map_dfr(scenario_2.1.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.1Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         adult.survival.adj = 0.825,
         juvenile.survival.adj = 0.8,
         population.growth = ifelse(iteration <= 500, "slight negative", "slight positive")) %>% 
  dplyr::filter(prop.sampled == 1.5)

#Extreme population decline
scenario_2.1.2_results <- map_dfr(scenario_2.1.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.1Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "extreme negative") %>% 
  dplyr::select(-(c(est.yr))) #Don't want to have this in the dataframe; want it to come in when joining with the truth


scenario_2.1_results.all <- scenario_2.1.1_results %>% bind_rows(scenario_2.1.2_results) %>% 
#  bind_rows(scenario_2.1_neutral) %>% #Add in neutral growth scenario
  inner_join(obj2.truth.df, by = c("iteration", "seed", "population.growth")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop))






#--------------------- Objective 2.2 ---------------------------------#
#Same scenario as 2.1, but add lambda to the model; small variations
scenario_2.2.1_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.2.1_*",
                            full.names = TRUE)

scenario_2.2.1_results <- map_dfr(scenario_2.2.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.2Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "tight",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs),
         adult.survival.adj = 0.825,
         juvenile.survival.adj = 0.8,
         population.growth = ifelse(iteration <= 500, "slight negative", "slight positive"))

#--------------------- Objective 2.2.2 ---------------------------------#
#Bigger variations in lambda; prior expecting population decline
scenario_2.2.2_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.2.2_*",
                            full.names = TRUE)

#Extreme population decline
scenario_2.2.2_results <- map_dfr(scenario_2.2.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.2Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "informed",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "extreme negative")



#--------------------- Objective 2.2.3 ---------------------------------#
#Same scenario as 2.2.2 except make prior more diffuse
scenario_2.2.3_files <- list.files(path = objective_2_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_2.2.3_*",
                            full.names = TRUE)

#Extreme population decline
scenario_2.2.3_results <- map_dfr(scenario_2.2.3_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj2.2Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj2.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "diffuse",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "extreme negative")


scenario_2.2_results.all <- scenario_2.2.1_results %>% bind_rows(scenario_2.2.2_results, scenario_2.2.3_results) %>% 
#  bind_rows(scenario_2.1_neutral) %>% #Add in neutral growth scenario
  inner_join(obj2.truth.df, by = c("iteration", "seed", "population.growth", "est.yr")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop))

#Combine results for objective 2
obj2_results <- scenario_2.1_results.all %>% bind_rows(scenario_2.2_results.all) %>% 
  # inner_join(obj2.truth.df, by = c("population.growth", "iteration", "est.yr", "seed")) %>% 
  # mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
  #                           ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  #dplyr::select(-c(Male.adult.pop, Female.adult.pop)) %>% 
  replace_na(list(lambda.prior = "none")) %>% 
  mutate(sampling.scheme = factor(sampling.scheme),
         population.growth = factor(population.growth),
         lambda.prior = factor(lambda.prior, levels = c("none", "tight", "informed", "diffuse"))) %>% 
  mutate(prop.sampled.lab = paste0(prop.sampled, " percent sampled")) %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1)) %>% 
  mutate(in_interval = ifelse(HPD2.5 < all.truth & all.truth < HPD97.5, "Y", "N"))


#--------------------- Objective 3 ---------------------------------#
#Objective 3.1
scenario_3.1.1_files <- list.files(path = objective_3_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_3.1.1_*",
                            full.names = TRUE)

scenario_3.1.2_files <- list.files(path = objective_3_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_3.1.2_*",
                            full.names = TRUE)

scenario_3.1.1_results <- map_dfr(scenario_3.1.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj3.1Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj3.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "neutral")

scenario_3.1.2_results <- map_dfr(scenario_3.1.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj3.1Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj3.1J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "diffuse",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "neutral")


scenario_3.1_results.all <- scenario_3.1.1_results %>% bind_rows(scenario_3.1.2_results) %>% 
  mutate(model = "base") %>% 
  inner_join(obj3.truth.df.1, by = c("iteration", "seed", "est.yr", "population.growth")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop)) %>% 
  dplyr::filter(prop.sampled == 1.5)

#Objective 3.2
scenario_3.2.1_files <- list.files(path = objective_3_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_3.2.1_*",
                            full.names = TRUE)

scenario_3.2.2_files <- list.files(path = objective_3_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_3.2.2_*",
                            full.names = TRUE)

scenario_3.2.1_results <- map_dfr(scenario_3.2.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj3.2Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj3.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "neutral")


scenario_3.2.2_results <- map_dfr(scenario_3.2.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj3.2Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj3.2J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "diffuse",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "neutral")


scenario_3.2_results.all <- scenario_3.2.1_results %>% bind_rows(scenario_3.2.2_results) %>% 
  mutate(model = "adapted") %>% 
  inner_join(obj3.truth.df.1, by = c("iteration", "seed", "est.yr", "population.growth")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop))


#Objective 3.3
scenario_3.3.1_files <- list.files(path = objective_3_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_3.3.1_*",
                            full.names = TRUE)

scenario_3.3.2_files <- list.files(path = objective_3_results_location,
                            recursive = FALSE,
                            pattern = "*scenario_3.3.2_*",
                            full.names = TRUE)

scenario_3.3.1_results <- map_dfr(scenario_3.3.1_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj3.3Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj3.3J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = NA,
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "neutral")


scenario_3.3.2_results <- map_dfr(scenario_3.3.2_files, read_csv) %>% 
  mutate(sampling.scheme = ifelse(purpose %in% purpose.obj3.3Y, "target YOY",
                                  ifelse(purpose %in% purpose.obj3.3J, "sample all juvenile ages",
                                         "sample all age classes")),
         survival.prior = "diffuse",
         lambda.prior = "diffuse",
         cv = (sd/mean)*100,
         prop.sampled = factor(sample.prop.juvs,),
         population.growth = "neutral")


scenario_3.3_results.all <- scenario_3.3.1_results %>% bind_rows(scenario_3.3.2_results) %>% 
  mutate(model = "adapted") %>% 
  inner_join(obj3.truth.df.2, by = c("iteration", "seed", "est.yr", "population.growth")) %>% 
  mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
                            ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  dplyr::select(-c(Male.adult.pop, Female.adult.pop, Num.mothers, Num.fathers))




#Combine results for objective 3
obj3_results <- scenario_3.1_results.all %>% bind_rows(scenario_3.2_results.all, scenario_3.3_results.all) %>% 
  # inner_join(obj2.truth.df, by = c("population.growth", "iteration", "est.yr", "seed")) %>% 
  # mutate(all.truth = ifelse(parameter == "Nm", Male.adult.pop,
  #                           ifelse(parameter == "Nf", Female.adult.pop, all.truth))) %>% 
  #dplyr::filter(year == 85) %>% 
  #dplyr::select(-c(Male.adult.pop, Female.adult.pop)) %>% 
  mutate(sampling.scheme = factor(sampling.scheme),
         population.growth = factor(population.growth)) %>% 
  mutate(prop.sampled.lab = paste0(prop.sampled, " percent sampled")) %>% 
  replace_na(list(lambda.prior = "none")) %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1)) %>% 
  mutate(in_interval = ifelse(HPD2.5 < all.truth & all.truth < HPD97.5, "Y", "N"))

```



```{r quick-results-analysis-and-filtering, echo = FALSE, include = FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
#-------------Objective 1 --------------------#
#Check that all sampling schemes and population growth scenarios are represented
obj1_results %>% group_by(sampling.scheme) %>% 
  summarize(number = n())

obj1_results %>% group_by(population.growth) %>% 
  summarize(number = n())

obj1_results %>% group_by(prop.sampled) %>% 
  summarize(number = n())

obj1_results %>% group_by(parameter) %>% 
  summarize(number = n())

obj1_results %>% group_by(survival.prior) %>% 
  summarize(number = n())

#-------------Objective 2 --------------------#
#Check that all sampling schemes and population growth scenarios are represented
obj2_results %>% group_by(sampling.scheme) %>% 
  summarize(number = n())

obj2_results %>% group_by(population.growth) %>% 
  summarize(number = n())

obj2_results %>% group_by(est.yr) %>% 
  summarize(number = n())

obj2_results %>% group_by(prop.sampled) %>% 
  summarize(number = n())

obj2_results %>% group_by(parameter) %>% 
  summarize(number = n())

obj2_results %>% group_by(parameter) %>% 
  summarize(number = n())

#-------------Objective 3 --------------------#
#Check that all sampling schemes and population growth scenarios are represented
obj3_results %>% group_by(sampling.scheme) %>% 
  summarize(number = n())

obj3_results %>% group_by(population.growth) %>% 
  summarize(number = n())

obj3_results %>% group_by(est.yr) %>% 
  summarize(number = n())

obj3_results %>% group_by(prop.sampled) %>% 
  summarize(number = n())

obj3_results %>% group_by(parameter) %>% 
  summarize(number = n())


#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj1_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()
obj3_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj1_results <- obj1_results %>% dplyr::filter(Rhat < 1.01)
obj2_results <- obj2_results %>% dplyr::filter(Rhat < 1.01)
obj3_results <- obj3_results %>% dplyr::filter(Rhat < 1.01)


```


This is the initial model validation graph, where lambda was approximately stable in the population simulations and the model didn't include lambda, but rather averaged over abundance values.
It appears to me that a) the model works well overall, and b) targeted sampling of young-of-year starts to bias a little high at higher sample sizes. I'm thinking this may arise because we are sampling from fewer cohorts, and may be oversampling some parents.
```{r Obj1, echo=FALSE, out.width = "120%"}
#---------------Figure 1---------------------#
#plot.colors <- c("aquamarine", "aquamarine4", "indianred1", "indianred4", "khaki4")
plot.colors.fig1 <- c("aquamarine4", "indianred1", "lightyellow2")
scales::show_col(plot.colors.fig1)
#scale_fill_manual(values = plot.colors) #Add this line to use the plot colors above

#Relevel for better visualization

 obj1_results %>% group_by(survival.prior) %>% 
   summarize(n())

#-------------------Objective 1 Density plots-------------------------#
fig1.a <- obj1_results %>% dplyr::filter(survival.prior == "informed",
                               parameter != "survival") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = sampling.scheme)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Parameter", title="A)") +
#  theme_ridges() + 
  facet_wrap(~prop.sampled.lab) + 
  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
  scale_fill_manual(values = plot.colors.fig1)


fig1.b <- obj1_results %>% dplyr::filter(survival.prior == "informed",
                               parameter != "survival") %>% 
ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme))) +
  geom_violin(aes(y=cv), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="CV", title="B)") +
  scale_fill_manual(values = plot.colors.fig1) +
  ggtitle("B)") +
  facet_wrap(~prop.sampled.lab) +
  theme(legend.title = element_blank()) +
  scale_y_log10()


fig1.c <- obj1_results %>% dplyr::filter(survival.prior == "informed",
                               parameter != "survival") %>% 
  ggplot(aes(x = HSPs_detected, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("C)") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank(), axis.title.y = element_blank()) + 
    scale_fill_manual(values = plot.colors.fig1) +
    scale_color_manual(values = plot.colors.fig1) +
    facet_wrap(~prop.sampled.lab) + 
  scale_x_continuous(breaks = c(50, 100, 150, 200, 250, 300, 350))


fig1.d <- obj1_results %>% dplyr::filter(survival.prior == "informed",
                               parameter != "survival") %>% 
  ggplot(aes(x = POPs_detected, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("D)") + 
    labs(x = "POPs") +
    theme_bw() + 
    theme(legend.title = element_blank(), axis.title.y = element_blank()) + 
    scale_fill_manual(values = plot.colors.fig1) +
    scale_color_manual(values = plot.colors.fig1) +
    facet_wrap(~prop.sampled.lab)


ggarrange(fig1.a, fig1.b, fig1.c, fig1.d, common.legend = TRUE, nrow = 2, ncol = 2, legend = "bottom")
```


```{r Obj2, echo=FALSE, out.width = "120%"}
plot.colors.fig2 <- c("lightslateblue", "lightblue1", "darkslateblue")
scales::show_col(plot.colors.fig2)

#-------------------Objective 2 Density plots-------------------------#
fig2.a <- obj2_results %>% dplyr::filter(parameter %in% c("Nf", "Nm"),
                                         population.growth != "extreme negative") %>% 
  ggplot(aes(x = relative_bias,
             y = est.yr.lab, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year", title="A)") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme)) +
  theme(strip.text.y = element_blank()) + 
  xlim(-100, 100) +
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  scale_fill_manual(values = plot.colors.fig2, 
                    name = "Lambda prior") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05)))


fig2.b <- obj2_results %>% dplyr::filter(parameter %in% c("Nf", "Nm"),
                                         population.growth == "extreme negative") %>% 
  ggplot(aes(x = relative_bias,
             y = est.yr.lab, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6) + 
  labs(x="Relative bias", y="Estimation year", title="B)") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  geom_vline(xintercept = 0, color = "blue", linetype = "dashed", size = 1.1) + 
  facet_grid(rows = vars(parameter), cols = vars(sampling.scheme)) +
  theme(legend.title = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) + 
  xlim(-100, 200) +
  scale_fill_manual(values = plot.colors.fig2,
                    name = "Lambda prior") +
  scale_y_discrete(expand = expansion(mult = c(0.01, .05)))


#Plot comparisons
source(file = "~/R/working_directory/LemonSharkCKMR/02_DataViz/functions/Truth_comps_samples_analysis_ToSource.R")

fig2.c <- scenario_2.2.2_comps4viz %>% ggplot(aes(x = ref.yrs, fill = sampling.scheme)) +
  geom_histogram(binwidth = 1, 
                 alpha = 0.8, 
                 position = "identity", 
                 lwd = 0.75, 
                 linetype = 1,
                 colour = "black") + 
  labs(x="Reference year gap", title="C)") +
  facet_wrap(~est.yr.lab) +
    scale_fill_manual(values = plot.colors.fig1,
                    name = "Sampling scheme")
  #geom_density(alpha = 0.6) +
  

fig2.d <- obj2_results %>% dplyr::filter(parameter %in% c("lambda"),
                                         population.growth == "extreme negative",
                                         lambda.prior == "diffuse" | lambda.prior == "informed") %>% 
  ggplot(aes(x = relative_bias,
             y = est.yr.lab, 
             fill = sampling.scheme)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
  labs(x="Relative bias", y="Estimation year", title="D)") +
#  theme_ridges() + 
  #facet_wrap(~sampling.scheme) + 
  facet_wrap(~lambda.prior) +
  theme(legend.title = element_blank()) + 
  scale_y_discrete(expand = expansion(mult = c(0.01, .05))) +
  #xlim(-100, 200) +
  scale_fill_manual(values = plot.colors.fig1)

Fig2ab <- ggarrange(fig2.a, fig2.b, common.legend = TRUE)
Fig2cd <- ggarrange(fig2.c, fig2.d, common.legend = TRUE, legend = "bottom")
```



```{r calculate relative bias and % in HPDI}
#To get this in the table, I ran the script and then manually translated over the to table in Word. Perhaps there's a way I can just export this to a CSV file and copy and paste ... 
#Check percent in interval; can change proportion sampled
obj1_results %>% dplyr::filter(prop.sampled == 1.5) %>% 
  dplyr::filter(survival.prior == "informed") %>% 
  group_by(parameter, sampling.scheme, prop.sampled) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#-------------Objective 2 --------------------#
#See how many instances failed to converge so they can be removed later from the HPDI dataframes
obj2_results %>% dplyr::filter(Rhat > 1.01) %>% nrow()

#Remove instances that failed to converge
obj2_results <- obj2_results %>% dplyr::filter(Rhat < 1.01)

#2.1 naive
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 85, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3 naive
obj3_results %>% dplyr::filter(prop.sampled == 1.5, lambda.prior == "diffuse", model == "base") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#3 adapted
obj3_results %>% dplyr::filter(prop.sampled == 1.5, lambda.prior == "diffuse", model == "adapted") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

```



```{r Supplementary calculations}
#2.1 naive - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted - yr 80
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 80, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)


#2.1 naive - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth != "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.1 adapted - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth != "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 naive - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth == "extreme negative", lambda.prior == "none") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

#2.2 adapted - yr 90
obj2_results %>% dplyr::filter(prop.sampled == 1.5, est.yr == 90, population.growth == "extreme negative", lambda.prior == "diffuse") %>% 
  group_by(parameter, sampling.scheme, lambda.prior) %>% 
  dplyr::summarize(percent_in_interval = sum(in_interval == "Y")/n() * 100,
                   mean.bias = mean(relative_bias),
                   mean.cv = mean(cv)) %>%
  dplyr::arrange(parameter, sampling.scheme)

```















```{r Obj2.make-Density-Plots, echo=FALSE, include=FALSE}
#Density plot for Nf
# (obj1.fig.Nf <- obj1_results %>% dplyr::filter(parameter == "Nf",
#                                               survival.prior == "diffuse") %>% 
#     ggplot(aes(x = relative_bias, color = sampling.scheme, fill = sampling.scheme)) +
#     geom_density(alpha = 0.6) + 
#     ggtitle("A) Nf") + 
#     labs(x = "Relative bias of posterior median") +
#     geom_vline(xintercept=c(0), linetype="dotted") +
#     theme_bw() + 
#     theme(legend.title = element_blank()) + 
#     scale_fill_manual(values = plot.colors.fig1) +
#     scale_color_manual(values = plot.colors.fig1) +
#     facet_wrap(~prop.sampled) +
#     xlim(-100, 100))

#-------------------Objective 2 Density plots-------------------------#
#Target YOY
obj2.YOY.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
  scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.YOY.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
    mutate(est.yr.lab = ifelse(est.yr == 80, "10 years past",
                             ifelse(est.yr == 85, "5 years past", "present"))) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.YOY.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "target YOY") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.YOY.plots <- ggarrange(obj2.YOY.p1, obj2.YOY.p2, obj2.YOY.p3, common.legend = TRUE, nrow = 3, legend = "bottom")



#Sample all juvenile ages
obj2.juvs.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.juvs.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.juvs.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all juvenile ages") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.juv.plots <- ggarrange(obj2.juvs.p1, obj2.juvs.p2, obj2.juvs.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


#Sample ALL age classes
obj2.allages.p1 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="negative",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
    dplyr::rename(`Lambda prior` = lambda.prior) %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = `Lambda prior`)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Negative population growth")

obj2.allages.p2 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="neutral",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
    ggtitle("Neutral population growth")



obj2.allages.p3 <- obj2_results %>% dplyr::filter(!parameter %in% c("lambda", "survival"), 
                               population.growth =="positive",
                               prop.sampled.lab == "1.5 percent sampled",
                               sampling.scheme == "sample all age classes") %>% 
  ggplot(aes(x = relative_bias,
             y = parameter, 
             fill = lambda.prior)) + 
  geom_density_ridges(alpha = 0.6, scale = 0.9) + 
#  theme_ridges() + 
  facet_wrap(~est.yr.lab) + 
#  theme(legend.title = element_blank()) + 
  xlim(-100, 100) +
    scale_y_discrete(expand = expansion(mult = c(0.01, .7))) +
  ggtitle("Positive population growth")


obj2.allages.plots <- ggarrange(obj2.allages.p1, obj2.allages.p2, obj2.allages.p3, common.legend = TRUE, nrow = 3, legend = "bottom")


# (fig1.p1.violin <- obj1_results %>% 
#   ggplot(aes(x=factor(parameter), fill = factor(sampling.scheme))) +
#   geom_violin(aes(y=cv), draw_quantiles = 0.5) +
#   #ylim(-50, 160) +
#   geom_hline(yintercept=0, col="black", size=1.25) +
#   #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
#   labs(x="Parameter", y="CV", title="D) CV") +
#   scale_fill_manual(values = plot.colors.fig1) +
#   font("title", size = 10, face = "bold")) +
#   facet_wrap(~prop.sampled) +
#   theme(legend.title = element_blank())


```
\
\
The next graphs are examining how the model performs when population growth is positive, negative or neutral, comparing one model that accounts for this with a prior for lambda (uniform(0.95, 1.05)) and one that does not. In each case, the truth used to calculate relative bias is a specific year (vs the mean in model validation).
\
First, with targeted sampling of young-of-year, it looks like the model actually performs *worse* with lambda when the year of estimation is 10 years in the past. At 5 years past and present, the two appear to perform equivalently, suggesting that if limited population growth is expected, with targeted sampling of YOY at least, there's no real reason to include lambda in the model.
```{r Obj2.YOY-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.YOY.plots, top = text_grob("Target young-of-year", size = 14, face = "bold"))
```
\
\
The results are similar when all juvenile age classes are sampled, except estimates 10 years in the past are more accurate than with targeted sampling of young-of-year. This is likely a consequence of having more age classes over which to estimate survival and lambda.
```{r Obj2.juv-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.juv.plots, top = text_grob("Sample all juvenile ages", size = 14, face = "bold"))
```
\
\
The best performing model is the model that samples across age classes and includes parent-offspring pairs, as expected. Here, the model performs better with a diffuse prior on lambda than when lambda is not included.
```{r Obj2.allages-Density-Plots, echo=FALSE, out.width = "120%", fig.height = 10}
annotate_figure(obj2.allages.plots, top = text_grob("sample all age classes", size = 14, face = "bold"))
```





Notes to self:
Objective 1: What drives bias when kin pairs match expectations?
Inconclusive so far (07/19/2022). I should return to this later
```{r, echo=FALSE, include=FALSE}
# obj1_results %>% dplyr::filter(HSPs_detected == HSPs_expected & sampling.scheme != "sample all age classes" & survival.prior == "diffuse") %>% 
#   dplyr::arrange(iteration) %>% 
#   dplyr::select(parameter, prop.sampled, iteration, sampling.scheme, relative_bias, survival.prior, HSPs_expected, HSPs_detected) %>% 
#   View()
# 
# mom_comps <- readRDS(paste0(obj1.2_results_location, mom.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# dad_comps <- readRDS(paste0(obj1.2_results_location, dad.comps.prefix, "_", date.of.simulation.obj1.2J, "_", seeds, "_", purpose.obj1.2J)) %>% 
#   dplyr::filter(iteration == 36 & sample.prop.juvs == 1 | iteration == 85 & sample.prop.juvs == 0.5) %>% 
#   dplyr::filter(yes > 0) %>% 
#   mutate(iteration = factor(iteration))
# 
# plot.colors.fig1 <- c("aquamarine4", "indianred1", "indianred4")
# scales::show_col(plot.colors.fig1)
# 
# #Split "yes" up into separate rows so we can make a histogram of mort years
# mom_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)
# 
# dad_comps %>% uncount(yes) %>% 
#   ggplot(aes(x = mort.yrs, fill = iteration)) +
#   geom_density(alpha = 0.6) +
#   scale_color_manual(values = plot.colors.fig1)

#Interesting iterations: not bad bias
#iteration 36 (not bad bias): all parameters, 1_prop_sampled, sample_all_juvenile_ages;
#Nf, iteration_21, 1.0_prop_sampled, sample_all_juvenile_ages
#survival: iteration_28, 2.0_prop_sampled, sample_all_juvenile_ages
#Bad bias
##iteration 85 all parameters: 0.5_prop_sampled, sample_all_juvenile_ages;
#other bad biases: Nf, iteration 44, 1.0_prop_sampled, sample_all_juvenile_ages


```

Things to tackle next:
1. Objective 1: Look into the number of individual parents that are sampled in the initial model validation runs to see if we are oversampling some parents, particularly with targeted sampling of YOY.
