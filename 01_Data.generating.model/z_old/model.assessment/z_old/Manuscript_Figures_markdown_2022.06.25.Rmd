---
title: "Results for CKMR manuscript 06/19/2022"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 3
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)
library(scales)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

```
Hi Liz and Lisa,
Here is the results section for the manuscript. I know there are myriad formatting issues here and **lots** of ways the figures could be optimized and re-arranged. I will be ironing these out as I continue to produce results and work on the manuscript over the coming weeks. Once we decide which figures we ultimately want to include over the next couple drafts, I'll start pulling the figures into Illustrator and cleaning them up :)
\
In the meantime, any suggestions for how to optimize what we have (besides the obvious things that I'm already aware of, like making font size consistent) would be very welcome. 
\
I look forward to your feedback!


## Results
### Objective 1:  Model construction and validation
_Model validation_  
To validate our model, we assumed a data-poor scenario and gave all parameters in the model a diffuse prior (Fig. S4). To determine the best prior for population growth, we compared the precision and accuracy of two distinct methods of setting a diffuse prior on lambda under two sampling schemes (Fig. 1). We found small but substantial differences in precision among scenarios: sampling all juvenile age classes gave more precise estimates of abundance than did sampling young-of-year only, while giving a uniform prior to population growth gave slightly more precise estimates than fixing lambda to three values in turn (Fig 1A).

Regardless of prior or sampling scheme, in most cases instances, the model captured the true value of abundance within the highest posterior density interval (HPDI) at the expected rate (Fig. 1: B, C), while the median of the posterior distributions was unbiased (Fig 1. D, E). These results demonstrate that our CKMR model reliably estimates abundance in data-poor scenarios.



```{r Obj1-read-in-files, include = FALSE}
#------------- Simulation parameters and labels  ----------------#
date.of.simulation.obj1.1 <- "24Jun2022"
purpose.obj1.1 <- "Obj1.1_model.validation_uniform.lambda_target.YOY"
purpose.obj1.1.lab <- "Target YOY | Uniform lambda"
model.type.obj1.1 <- "HS.only"

date.of.simulation.obj1.2 <- "24Jun2022"
purpose.obj1.2 <- "Obj1.1_model.validation_uniform.lambda_sample.all.ages"
purpose.obj1.2.lab <- "All ages sampled | Uniform lambda"
model.type.obj1.2 <- "HS.only"

date.of.simulation.obj1.3 <- "25Jun2022"
purpose.obj1.3 <- "Obj1.2_test.fixed.lambda_target.YOY"
purpose.obj1.3.lab <- "Target YOY | Fixed lambda"
model.type.obj1.3 <- "HS.only"

date.of.simulation.obj1.4 <- "25Jun2022"
purpose.obj1.4 <- "Obj1.2_test.fixed.lambda_sample.all.ages"
purpose.obj1.4.lab <- "All ages sampled | Fixed lambda"
model.type.obj1.4 <- "HS.only"

date.of.simulation.obj1.5 <- "25Jun2022"
purpose.obj1.5 <- "Obj1.Supp_model.validation_uniform.lambda_sample.all.ages_downsample"
purpose.obj1.5.lab <- "All ages sampled + downsample | Uniform lambda"
model.type.obj1.5 <- "HS.only"


seeds <- "Seeds2022.04.15"
sim.samples.obj1.1 <- "0.5prop.sampled" #Label on file output
samples.obj1.1.lab <- "0.5 percent sampled" #Label for dataframe and figures
sim.samples.obj1.2 <- "1prop.sampled" #Label on file output
samples.obj1.2.lab <- "1 percent sampled" #Label for dataframe and figures
sim.samples.obj1.3 <- "1.5prop.sampled"  #Label on file output
samples.obj1.3.lab <- "1.5 percent sampled" #Label for dataframe and figures
sim.samples.obj1.4 <- "2prop.sampled" #Label on file output
samples.obj1.4.lab <- "2 percent sampled" #Label for dataframe and figures
sim.samples.all <- c(0.5, 1, 1.5, 2) #This is the number of samples when sampling specific proportions of the juvenile population for the HS only model. Current as of 05/03/2022

sim.samples.labs.all <- c(samples.obj1.1.lab, samples.obj1.2.lab, samples.obj1.3.lab, samples.obj1.4.lab)

MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.results/"
results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.results/figures/"
results_prefix <- "CKMR_results"
MCMC_prefix <- "CKMR_modelout"
parents_prefix <- "parents_breakdown/CKMR_parents.breakdown"
sample.prefix <- "sample_info/CKMR_sample.info"
survival.prefix <- "survival/CKMR_survival"
pop.size.prefix <- "pop_size/CKMR_pop.size"
mom.comps.prefix <- "comparisons/mom.comps"
dad.comps.prefix <- "comparisons/dad.comps"


#Set results to NULL and the script will run regardless of how many actual results are being compared
results.obj1.1 = results.obj1.2 = results.obj1.3 = results.obj1.4 <- results.obj1.5 <- NULL

results.obj1.1 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation.obj1.1, "_", seeds, "_", purpose.obj1.1, ".csv")) %>% 
  mutate(model_type = model.type.obj1.1, 
         purpose.lab = purpose.obj1.1.lab)

results.obj1.2 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation.obj1.2, "_", seeds, "_", purpose.obj1.2, ".csv")) %>% 
  mutate(model_type = model.type.obj1.2,
         purpose.lab = purpose.obj1.2.lab)

results.obj1.3 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation.obj1.3, "_", seeds, "_", purpose.obj1.3, "allCombined.csv")) %>%
  mutate(model_type = model.type.obj1.3,
         purpose.lab = purpose.obj1.3.lab)

results.obj1.4 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation.obj1.4, "_", seeds, "_", purpose.obj1.4, "allCombined.csv")) %>%
  mutate(model_type = model.type.obj1.4,
         purpose.lab = purpose.obj1.4.lab)

results.obj1.5 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation.obj1.5, "_", seeds, "_", purpose.obj1.5, ".csv")) %>% 
  mutate(model_type = model.type.obj1.5, 
         purpose.lab = purpose.obj1.5.lab)
```

```{r Obj1-analyze-results, echo = FALSE, include = FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
####------------------------------- Quick analysis of results -----------------------------------####
results.obj1.all <- results.obj1.1 %>% 
  bind_rows(results.obj1.2, results.obj1.3, results.obj1.4, results.obj1.5) %>% 
  #mutate(total_samples = total_juvenile_samples + total_adult_samples) %>%
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1)) %>% #Can change truth to breed.truth if looking for number of active breeders
  mutate(in_interval = ifelse(HPD2.5 < all.truth & all.truth < HPD97.5, "Y", "N")) %>% 
  mutate(cv = (sd/mean)*100) %>% 
  mutate(samples.lab = paste0(sample.prop.juvs, " percent sampled")) %>% 
  separate(col = purpose.lab, into = "sampling.scheme", sep = " -", remove = FALSE)

mean_cv.obj1 <-  results.obj1.all %>% group_by(parameter, purpose.lab, samples.lab) %>% summarize(mean.cv = round(mean(cv), 1))

results.obj1.all <- results.obj1.all %>% inner_join(mean_cv.obj1, by = c("parameter", "purpose.lab", "samples.lab"))

results.obj1.all$samples.lab <- factor(results.obj1.all$samples.lab, levels = c(samples.obj1.1.lab, samples.obj1.2.lab, samples.obj1.3.lab, samples.obj1.4.lab))

results.obj1.all$purpose.lab <- factor(results.obj1.all$purpose.lab, levels = c(purpose.obj1.1.lab, purpose.obj1.2.lab, purpose.obj1.3.lab, purpose.obj1.4.lab, purpose.obj1.5.lab))

#Specify parameters
#jags_params <- c("Nfa", "Nfb", "Nm", "surv", "lam", "psi", "pb") #if estimating all parameters with the HS|PO model
jags_params <- c("Nf", "psi", "Nm", "survival", "lambda") #If estimating all parameters with the HS only model

#Save instances that failed to converge so they can be removed later from the HPDI dataframes
no.convergence.obj1 <- results.obj1.all %>% dplyr::filter(Rhat > 1.01) %>% 
  mutate(purp = ifelse(purpose.lab == purpose.obj1.1.lab, 1,
                       ifelse(purpose.lab == purpose.obj1.2.lab, 2,
                              ifelse(purpose.lab == purpose.obj1.3.lab, 3, 4)))) %>% 
  mutate(samps = ifelse(sample.prop.juvs == sim.samples.all[1], 1,
                        ifelse(sample.prop.juvs == sim.samples.all[2], 2,
                               ifelse(sample.prop.juvs == sim.samples.all[3], 3, 4)))) %>% 
  distinct(purpose.lab, purp, sample.prop.juvs, iteration, samps)

#Print the number of instances that failed to converge
#cat(paste0("Of the ", nrow(results.all), " parameter estimates from these simulations, ", nrow(no.convergence), " instances failed to converge at Rhat > 1.01"))

#Remove instances that failed to converge
results.obj1.all <- results.obj1.all %>% dplyr::filter(Rhat < 1.01)
```

```{r Obj1-calculate-HPDI-intervals, echo=FALSE, include = FALSE}
HPD.obj1.1.summary.tidy = HPD.obj1.2.summary.tidy = HPD.obj1.3.summary.tidy = HPD.obj1.4.summary.tidy <- HPD.obj1.5.summary.tidy <-  NULL

#Read in previously saved file
HPD.obj1.1.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation.obj1.1, "_", purpose.obj1.1, ".csv"))

HPD.obj1.1.summary.tidy <- HPD.obj1.1.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "samples.lab",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
    ) %>% 
  mutate(model_type = model.type.obj1.1,
         purpose.lab = purpose.obj1.1.lab) %>% 
  mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>% 
  inner_join(mean_cv.obj1, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------------------Purpose 2 --------------------------------#    
#Read in previously saved file
HPD.obj1.2.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation.obj1.2, "_", purpose.obj1.2, ".csv"))

HPD.obj1.2.summary.tidy <- HPD.obj1.2.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "samples.lab",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>% 
  mutate(model_type = model.type.obj1.2,
         purpose.lab = purpose.obj1.2.lab) %>% 
    mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>% 
  inner_join(mean_cv.obj1, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------------------Purpose 3 --------------------------------#    
#Read in previously saved file
HPD.obj1.3.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation.obj1.3, "_", purpose.obj1.3, ".csv"))

HPD.obj1.3.summary.tidy <- HPD.obj1.3.summary_all %>%
  mutate(model_type = model.type.obj1.3,
         purpose.lab = purpose.obj1.3.lab,
         samples.lab = samples.obj1.2.lab) %>%
 mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>%
  inner_join(mean_cv.obj1, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------------------Purpose 4 --------------------------------#    
#Read in previously saved file
HPD.obj1.4.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation.obj1.4, "_", purpose.obj1.4, ".csv"))

HPD.obj1.4.summary.tidy <- HPD.obj1.4.summary_all %>%
  mutate(model_type = model.type.obj1.4,
         purpose.lab = purpose.obj1.4.lab,
         samples.lab = samples.obj1.2.lab) %>%
 mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>%
  inner_join(mean_cv.obj1, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------------------Purpose 5 --------------------------------#    
#Read in previously saved file
HPD.obj1.5.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation.obj1.5, "_", purpose.obj1.5, ".csv"))

HPD.obj1.5.summary.tidy <- HPD.obj1.5.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "samples.lab",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>% 
  mutate(model_type = model.type.obj1.5,
         purpose.lab = purpose.obj1.5.lab) %>% 
    mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>% 
  inner_join(mean_cv.obj1, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------Create dataframes to plot by sample size--------#
#Set eveyrthing to Null so the below scripts will run
HPD.samples1.obj1.1.4viz = HPD.samples2.obj1.1.4viz = HPD.samples3.obj1.1.4viz = HPD.samples4.obj1.1.4viz = HPD.samples1.obj1.2.4viz = HPD.samples2.obj1.2.4viz = HPD.samples3.obj1.2.4viz = HPD.samples4.obj1.2.4viz = HPD.samples1.obj1.3.4viz = HPD.samples2.obj1.3.4viz = HPD.samples3.obj1.3.4viz = HPD.samples4.obj1.3.4viz = HPD.samples1.obj1.4.4viz = HPD.samples2.obj1.4.4viz = HPD.samples3.obj1.4.4viz = HPD.samples4.obj1.4.4viz = HPD.samples1.obj1.5.4viz = HPD.samples2.obj1.5.4viz = HPD.samples3.obj1.5.4viz = HPD.samples4.obj1.5.4viz <- NULL


HPD.samples1.obj1.1.4viz <- HPD.obj1.1.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.1.lab)
HPD.samples2.obj1.1.4viz <- HPD.obj1.1.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.2.lab)
HPD.samples3.obj1.1.4viz <- HPD.obj1.1.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.3.lab)
HPD.samples4.obj1.1.4viz <- HPD.obj1.1.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.4.lab)

HPD.samples1.obj1.2.4viz <- HPD.obj1.2.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.1.lab)
HPD.samples2.obj1.2.4viz <- HPD.obj1.2.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.2.lab)
HPD.samples3.obj1.2.4viz <- HPD.obj1.2.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.3.lab)
HPD.samples4.obj1.2.4viz <- HPD.obj1.2.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.4.lab)

HPD.samples2.obj1.3.4viz <- HPD.obj1.3.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.2.lab)

HPD.samples2.obj1.4.4viz <- HPD.obj1.4.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.2.lab)


HPD.samples1.obj1.5.4viz <- HPD.obj1.5.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.1.lab)
HPD.samples2.obj1.5.4viz <- HPD.obj1.5.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.2.lab)
HPD.samples3.obj1.5.4viz <- HPD.obj1.5.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.3.lab)
HPD.samples4.obj1.5.4viz <- HPD.obj1.5.summary.tidy %>% dplyr::filter(samples.lab == samples.obj1.4.lab)

#Combine above dataframes, and re-order purpose as factors
all.samples1.obj1.4viz <- HPD.samples1.obj1.1.4viz %>% bind_rows(HPD.samples1.obj1.2.4viz, HPD.samples1.obj1.3.4viz, HPD.samples1.obj1.4.4viz, HPD.samples1.obj1.5.4viz) 
all.samples1.obj1.4viz$purpose.lab <- factor(all.samples1.obj1.4viz$purpose.lab, levels = c(purpose.obj1.1.lab, purpose.obj1.2.lab, purpose.obj1.3.lab, purpose.obj1.4.lab, purpose.obj1.5.lab))

all.samples2.obj1.4viz <- HPD.samples2.obj1.1.4viz %>% bind_rows(HPD.samples2.obj1.2.4viz, HPD.samples2.obj1.3.4viz, HPD.samples2.obj1.4.4viz, HPD.samples2.obj1.5.4viz) 
all.samples2.obj1.4viz$purpose.lab <- factor(all.samples2.obj1.4viz$purpose.lab, levels = c(purpose.obj1.1.lab, purpose.obj1.2.lab, purpose.obj1.3.lab, purpose.obj1.4.lab, purpose.obj1.5.lab))

all.samples3.obj1.4viz <- HPD.samples3.obj1.1.4viz %>% bind_rows(HPD.samples3.obj1.2.4viz, HPD.samples3.obj1.3.4viz, HPD.samples3.obj1.4.4viz, HPD.samples3.obj1.5.4viz) 
all.samples3.obj1.4viz$purpose.lab <- factor(all.samples3.obj1.4viz$purpose.lab, levels = c(purpose.obj1.1.lab, purpose.obj1.2.lab, purpose.obj1.3.lab, purpose.obj1.4.lab, purpose.obj1.5.lab))

all.samples4.obj1.4viz <- HPD.samples4.obj1.1.4viz %>% bind_rows(HPD.samples4.obj1.2.4viz, HPD.samples4.obj1.3.4viz, HPD.samples4.obj1.4.4viz, HPD.samples4.obj1.5.4viz)
all.samples4.obj1.4viz$purpose.lab <- factor(all.samples4.obj1.4viz$purpose.lab, levels = c(purpose.obj1.1.lab, purpose.obj1.2.lab, purpose.obj1.3.lab, purpose.obj1.4.lab, purpose.obj1.5.lab))

#For when we need everything together
obj1.all.4viz <- HPD.obj1.1.summary.tidy %>% bind_rows(HPD.obj1.2.summary.tidy, HPD.obj1.3.summary.tidy, HPD.obj1.4.summary.tidy, HPD.obj1.5.summary.tidy)
obj1.all.4viz$purpose.lab <- factor(obj1.all.4viz$purpose.lab, levels = c(purpose.obj1.1.lab, purpose.obj1.2.lab, purpose.obj1.3.lab, purpose.obj1.4.lab, purpose.obj1.5.lab))

fig1.4viz <- obj1.all.4viz %>% dplyr::filter(samples.lab == samples.obj1.2.lab)

results.obj1.4viz <- results.obj1.all %>% dplyr::filter(samples.lab == samples.obj1.2.lab) %>% 
  separate(purpose.lab, into = c("sampling.scheme", "prior"), sep = " \\| ", remove = FALSE)

```


```{r Fig1-HPDI-and-Density-Plots, echo=FALSE, include=FALSE}
#Order is Target YOY|Uniform, all ages sampled | Uniform, Target YOY | Fixed, All ages sampled | Fixed
plot.colors <- c("aquamarine", "aquamarine4", "indianred1", "indianred4", "khaki4")
scales::show_col(plot.colors)
#Relevel for better visualization
# results.obj1.4viz$purpose.lab <- factor(results.obj1.4viz$purpose.lab, levels = c(purpose1.lab, purpose3.lab, purpose2.lab, purpose4.lab))

(p1.violin <- results.obj1.4viz %>% dplyr::filter(parameter == "Nf" | parameter == "Nm",
                                                  purpose.lab != purpose.obj1.5.lab) %>% 
  ggplot(aes(x=factor(parameter), fill = factor(purpose.lab))) +
  geom_violin(aes(y=cv), draw_quantiles = 0.5) +
  #ylim(-50, 160) +
  geom_hline(yintercept=0, col="black", size=1.25) +
  #annotate("rect", xmin=0, xmax=Inf, ymin=-20, ymax=20, alpha=.5, col="red") +
  labs(x="Parameter", y="CV", title="A)") +
  scale_fill_manual(values = plot.colors) +
  font("title", size = 10, face = "bold")) +
  theme(legend.title = element_blank())

#HPDI line plot
(p.Nf <- fig1.4viz %>% dplyr::filter(parameter == "Nf",
                                     purpose.lab != purpose.obj1.5.lab) %>% 
   ggplot(aes(x = interval.scale)) +
   geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
   geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
   geom_line(aes(y = interval.scale), size = 1.5) + 
   ggtitle("B) Nf") + 
   labs(x = "HPDI",
        y = "Percent in HPDI") +
   theme_bw() + 
   theme(legend.title = element_blank()) + 
  scale_color_manual(values = plot.colors) +
   #facet_wrap(~proportion_sampled) + 
  guides(color = guide_legend(nrow = 2)))

#HPDI line plot
(p.Nm <- fig1.4viz %>% dplyr::filter(parameter == "Nm",
                                     purpose.lab != purpose.obj1.5.lab) %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("C) Nm") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_color_manual(values = plot.colors))

#Density plot of relative bias of median
(p2.Nf <- results.obj1.4viz %>% dplyr::filter(parameter == "Nf",
                                              purpose.lab != purpose.obj1.5.lab) %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("D) Nf") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_manual(values = plot.colors) +
    scale_color_manual(values = plot.colors) +
    xlim(-100, 100))



#-------------------Density plots-------------------------#
#Density plot of relative bias of median
(p2.Nm <- results.obj1.4viz %>% dplyr::filter(parameter == "Nm",
                                              purpose.lab != purpose.obj1.5.lab) %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("E) Nm") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = plot.colors) +
  scale_color_manual(values = plot.colors) +
  xlim(-100, 100))


```


```{r Fig1 - print-lambda-plots1, echo = FALSE}
p1.violin
```

```{r Fig1-print-lambda-plots2, echo=FALSE, out.width = "120%", fig.height = 7, fig.cap = "**Figure 1:** Model performance estimating abundance when population growth is unknown. **A)** Violin plot showing CVs on abundance estimates for two sampling schemes and two different approaches for setting a diffuse prior on lambda. **B & C)** Model accuracy and bias for number of mature females (Nf). **D & E)** Model accuracy and bias for number of mature males (Nm)"}
#Survival HPDI and relative bias for all four sample sizes
ggarrange(p.Nf, p.Nm, p2.Nf, p2.Nm, common.legend = TRUE, nrow = 2, ncol = 2, legend = "none")
```

\
\
----------------------------------------------------------------------------------------------
\
\

### Objective 2: Assess model performance in stochastic populations with uncertain vital rates.
_Sample size_  
To test the effect of sample size and sampling scheme on parameter estimates, we sampled at four different intensities, ranging from 0.5% of the population to 2% of the population (Figure 2). The model captured the true parameter values within the HPDI the majority of times for both sampling schemes and at all sampling intensities.  There was a slight difference in model performance between sampling schemes, with targeted sampling of YOY more accurately capturing the uncertainty of abundance estimates (Fig 2A, B), while sampling all juvenile age classes better captured the uncertainty of survival estimates (Fig 1C). The medians of the posterior distributions for abundance and survival generally showed a tighter distribution around 0% relative bias when sampling all juvenile age classes (Fig 2 D-F). Taken together, these results suggest that the CKMR model works well for scenarios that are conducive to focused sampling of YOY (e.g. nursery areas) as well as scenarios where all juvenile age classes are available to sample, though it is worth noting that differences in the number of HSPs between males and females (Fig 2 G, H) are expected when sex-specific dynamics are present (e.g. female skipped-breeding)




\
\
\
\
```{r Fig2-make-HPDI-and-Density-Plots, echo=FALSE, include = FALSE}
#Prep files
fig.Fig2.4viz <- obj1.all.4viz %>% dplyr::filter(purpose.lab == purpose.obj1.1.lab | purpose.lab == purpose.obj1.2.lab)

results.Fig2.4viz <- results.obj1.all %>% dplyr::filter(purpose.lab == purpose.obj1.1.lab | purpose.lab == purpose.obj1.2.lab) %>% 
  separate(purpose.lab, into = c("sampling.scheme", "prior"), sep = " \\| ", remove = FALSE)

#plot HPDI line plot
(Fig2.p.Nf <- fig.Fig2.4viz %>% dplyr::filter(parameter == "Nf") %>% 
   ggplot(aes(x = interval.scale)) +
   geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
   geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
   geom_line(aes(y = interval.scale), size = 1.5) + 
   ggtitle("A) Nf") + 
   labs(x = "HPDI",
        y = "Percent in HPDI") +
   theme_bw() + 
   theme(legend.title = element_blank()) + 
  scale_fill_manual(values = plot.colors) +
  scale_color_manual(values = plot.colors) +
  facet_wrap(~samples.lab) + 
  guides(color = guide_legend(nrow = 2)))

#HPDI line plot - Nm
(Fig2.p.Nm <- fig.Fig2.4viz %>% dplyr::filter(parameter == "Nm") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("B) Nm") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
    scale_fill_manual(values = plot.colors) +
  scale_color_manual(values = plot.colors) +
  facet_wrap(~samples.lab))

#HPDI line plot - survival
(Fig2.p.surv <- fig.Fig2.4viz %>% dplyr::filter(parameter == "survival") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("C) Survival") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = plot.colors) +
  scale_color_manual(values = plot.colors) +
  facet_wrap(~samples.lab) +
  guides(color = guide_legend(nrow = 2)))

#Density plot - Nf
(Fig2.p2.Nf <- results.Fig2.4viz %>% dplyr::filter(parameter == "Nf") %>% 
    ggplot(aes(x = relative_bias, fill = purpose.lab)) +
    geom_density(alpha = 0.6, aes(fill = purpose.lab)) + 
    ggtitle("D) Nf") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_manual(values = plot.colors) +
    scale_color_manual(values = plot.colors) +
    facet_wrap(~samples.lab) +
    xlim(-100, 100))
    

#Density plot - Nm
(Fig2.p2.Nm <- results.Fig2.4viz %>% dplyr::filter(parameter == "Nm") %>% 
  ggplot(aes(x = relative_bias, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("E) Nm") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = plot.colors) +
  scale_color_manual(values = plot.colors) +
  facet_wrap(~samples.lab) +
  xlim(-100, 100)) 



#-------------------Density plots-------------------------#
#Density plot - survival
(Fig2.p2.surv <- results.Fig2.4viz %>% dplyr::filter(parameter == "survival") %>% 
  ggplot(aes(x = relative_bias, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("F) Survival") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_manual(values = plot.colors) +
  scale_color_manual(values = plot.colors) +
  facet_wrap(~samples.lab) +
  xlim(-25, 25))

```

```{r Fig2-print-HSP-plots, echo=FALSE, include = FALSE, out.width = "120%", fig.height = 7}
####---------------------Density plots of kin detected----------------------------------------------####
#Prep files
ff1 <- results.obj1.all %>% 
  distinct(female.fecundity) %>% 
  arrange(female.fecundity) %>% 
  slice(2) %>% 
  pull()

results.S1.4viz <- results.obj1.all %>% dplyr::filter(purpose.lab == purpose.obj1.1.lab | purpose.lab == purpose.obj1.2.lab | purpose.lab == purpose.obj1.5.lab,
                                                      female.fecundity == ff1) %>% 
  separate(purpose.lab, into = c("sampling.scheme", "prior"), sep = " \\| ", remove = FALSE)

results.S1.4viz$sampling.scheme <- factor(results.S1.4viz$sampling.scheme, levels = c("Target YOY", "All ages sampled", "All ages sampled + downsample"))

#Distribution of MHSPs
(Nf_HSPs <- results.S1.4viz %>% dplyr::filter(parameter == "Nf") %>% 
  ggplot(aes(x = HSPs_detected, color = sampling.scheme, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("G) Maternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_manual(values = plot.colors) +
    scale_color_manual(values = plot.colors) +
    facet_wrap(~samples.lab) + 
  scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250)))
                     

(Nm_HSPs <- results.S1.4viz %>% dplyr::filter(parameter == "Nm") %>% 
  ggplot(aes(x = HSPs_detected, color = sampling.scheme, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("H) Paternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_manual(values = plot.colors) +
    scale_color_manual(values = plot.colors) +
    facet_wrap(~samples.lab) + 
    scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250)))
```


```{r Fig2-print-plots, echo=FALSE, out.width = "250%", fig.height = 12, fig.cap = "**Figure 2:** Model performance under different sampling scenarios.**A, B, C** Percentage of times the true parameter value fell within the HPDI. Colored lines that are at or above the black line represent instances where the model captured the truth as often or more often than expected; colored lines that are below the black line represent instances where the model captured the truth less often than expected. **D, E, F:** Relative bias of the medians of the posterior distributions. **G, H:** Number of half-sibling pairs (HSPs) detected for each sex."}
#Survival HPDI and relative bias for all four sample sizes
ggarrange(Fig2.p.Nf, Fig2.p2.Nf, Fig2.p.Nm, Fig2.p2.Nm, Fig2.p.surv, Fig2.p2.surv, Nf_HSPs, Nm_HSPs, common.legend = TRUE, nrow = 4, ncol = 2, legend = "bottom")
```
\
\
----------------------------------------------------------------------------------------------
\
\
**Other figures:**
<span style="color:orange"> **Figure 3:** Model performance when life history parameters are uncertain. A 3d figure that has the CV on the three major parameters (YOY/juvenile survival, Adult survival, and fecundity) as the axes and the relative bias of the median from the associated lambda values/simulations as the landscape. Include a slice through the plane that represents 0% relative bias and/or dotted lines indicating the precision/accuracy needed to attain a relative bias of 20% or less.
</span>

<span style="color:orange"> **Figure 4 (to be added): Parameter estimates for lemon shark data with credible intervals, with and without catch rate data**
</span>


  

### Supplementary material


\
\
----------------------------------------------------------------------------------------------
\
\
```{r FigS1-print-plots, echo=FALSE, out.width = "120%", fig.cap = "**Figure S1:** Elasticity analysis of lemon shark vital rates, showing that population growth is most sensitive to juvenile survival and fecundity at younger mature age classes."}

S3.E <- readRDS(file = "G://My Drive/Personal_Drive/R/CKMR/Objective.2_Sensitivity.elasticity/elasticity_tidy_df")

(S3.E %>% ggplot(aes(x = age, y = elasticity, group = parameter)) + 
  geom_point(aes(colour = parameter)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90, vjust = -.15),
        legend.title = element_blank()))
    
```
\
\
----------------------------------------------------------------------------------------------
\
\
<span style="color:orange"> **Figure S2 (to be added): Mean correlation among parameter estimates.**
</span>

```{r FigS-print-HSP-plots, echo=FALSE, include = FALSE, out.width = "120%", fig.height = 7}
#-----------------------Examine expected vs observed kin pairs--------------------
#Calculate % difference in expected vs observed kin
results.all2 <- results.S1.4viz %>% mutate(HS_exp_obs_diff = (HSPs_expected - HSPs_detected)/HSPs_expected)



#----------------Make scatter plot of expected vs observed 
#Purpose 1
(EO1 <- results.all2 %>% dplyr::filter(parameter == "Nf" | parameter == "Nm") %>% 
  ggplot(aes(x = HS_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = "C)", x = "Percent difference (Exp - Obs)/Exp", y = "Relative bias") + 
  theme(legend.title = element_blank()))

```

```{r FigS1-print-plot2, echo=FALSE, out.width = "120%", fig.height = 7, fig.cap = "**Figure S2:** Kin pairs detected by sampling scheme and bias", include = FALSE}
EO1
```




