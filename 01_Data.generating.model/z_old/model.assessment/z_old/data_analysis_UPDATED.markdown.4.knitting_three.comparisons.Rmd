---
title: "CKMR simulation results"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")

#NEXT TO DO
#Add label for mean cv to the graphs - need to have different colors
```

```{r read-in-files, include=FALSE}
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")
purpose.combo <- "Determine_optimal_sampling_scheme_and_performance_w_psi_and_surv" #What am I comparing right now? This will be used to name output files


#----------------Read in files ------------------------------
#------------- MCMC parameters ----------------#
ni <- 40000 # number of post-burn-in samples per chain
nb <- 50000 # number of burn-in samples
nt <- 20     # thinning rate
nc <- 2      # number of chains
MCMC.settings <- paste0("thin", nt, "_draw", ni, "_burn", nb)

#Initialize values
purpose1.lab = purpose2.lab = purpose3.lab = purpose4.lab <- NULL

#------------- Simulation parameters and labels  ----------------#
date.of.simulation1 <- "06Jun2022"
purpose1 <- "psi1_0.05non.conform_target.YOY_no.downsample_UpdatedEquation"
purpose1.lab <- "Target YOY"
model.type1 <- "HS.only"

date.of.simulation2 <- "06Jun2022"
purpose2 <- "psi1_0.05non.conform_all.ages.sampled_no.downsample_UpdatedEquation"
purpose2.lab <- "All ages sampled"
model.type2 <- "HS.only"

date.of.simulation3 <- "07Jun2022"
purpose3 <- "psi1_0.05non.conform_all.ages.sampled_yes.downsample_UpdatedEquation"
purpose3.lab <- "All ages sampled + downsample"
model.type3 <- "HS.only"

seeds <- "Seeds2022.04.15"
sim.samples.1 <- "0.5prop.sampled" #Label on file output
samples1.lab <- "0.5 percent sampled" #Label for dataframe and figures
sim.samples.2 <- "1prop.sampled" #Label on file output
samples2.lab <- "1 percent sampled" #Label for dataframe and figures
sim.samples.3 <- "1.5prop.sampled"  #Label on file output
samples3.lab <- "1.5 percent sampled" #Label for dataframe and figures
sim.samples.4 <- "2prop.sampled" #Label on file output
samples4.lab <- "2 percent sampled" #Label for dataframe and figures
sim.samples.all <- c(0.5, 1, 1.5, 2) #This is the number of samples when sampling specific proportions of the juvenile population for the HS only model. Current as of 05/03/2022

sim.samples.labs.all <- c(samples1.lab, samples2.lab, samples3.lab, samples4.lab)

MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.results/"
results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.results/figures/"
results_prefix <- "CKMR_results"
MCMC_prefix <- "CKMR_modelout"
parents_prefix <- "parents_breakdown/CKMR_parents.breakdown"
sample.prefix <- "sample_info/CKMR_sample.info"
survival.prefix <- "survival/CKMR_survival"
pop.size.prefix <- "pop_size/CKMR_pop.size"
mom.comps.prefix <- "comparisons/mom.comps"
dad.comps.prefix <- "comparisons/dad.comps"


#Set results to NULL and the script will run regardless of how many actual results are being compared
results.1 = results.2 = results.3 = results.4 <- NULL

results.1 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation1, "_", seeds, "_", purpose1, ".csv")) %>% 
  mutate(model_type = model.type1, 
         purpose.lab = purpose1.lab) %>% 
  mutate(total_samples = total_juvenile_samples + total_adult_samples)

results.2 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation2, "_", seeds, "_", purpose2, ".csv")) %>% 
  mutate(model_type = model.type2,
         purpose.lab = purpose2.lab) %>% 
    mutate(total_samples = total_juvenile_samples + total_adult_samples)

results.3 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation3, "_", seeds, "_", purpose3, ".csv")) %>%
  mutate(model_type = model.type3,
         purpose.lab = purpose3.lab) %>%
    mutate(total_samples = total_juvenile_samples + total_adult_samples)
```

```{r Quick-analysis-of-results, echo = FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
####------------------------------- Quick analysis of results -----------------------------------####

results.all <- results.1 %>% 
  bind_rows(results.2, results.3) %>% 
  #mutate(total_samples = total_juvenile_samples + total_adult_samples) %>%
  mutate(relative_bias = round(((Q50 - all.truth)/all.truth)*100, 1)) %>% #Can change truth to breed.truth if looking for number of active breeders
  mutate(in_interval = ifelse(HPD2.5 < all.truth & all.truth < HPD97.5, "Y", "N")) %>% 
  mutate(cv = (sd/mean)*100) %>% 
  mutate(samples.lab = paste0(prop_sampled_juvs, " percent sampled")) %>% 
  separate(col = purpose.lab, into = "sampling.scheme", sep = " -", remove = FALSE)

mean_cv <-  results.all %>% group_by(parameter, purpose.lab, samples.lab) %>% summarize(mean.cv = round(mean(cv), 1))

results.all <- results.all %>% inner_join(mean_cv, by = c("parameter", "purpose.lab", "samples.lab"))

results.all$samples.lab <- factor(results.all$samples.lab, levels = c(samples1.lab, samples2.lab, samples3.lab, samples4.lab))

results.all$purpose.lab <- factor(results.all$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab))

#Specify parameters
#jags_params <- c("Nfa", "Nfb", "Nm", "surv", "lam", "psi", "pb") #if estimating all parameters with the HS|PO model
jags_params <- c("Nfb", "psi", "Nm", "surv", "lam") #If estimating all parameters with the HS only model

#Save instances that failed to converge so they can be removed later from the HPDI dataframes
no.convergence <- results.all %>% dplyr::filter(Rhat > 1.01) %>% 
  mutate(purp = ifelse(purpose.lab == purpose1.lab, 1,
                       ifelse(purpose.lab == purpose2.lab, 2,
                              ifelse(purpose.lab == purpose3.lab, 3, 4)))) %>% 
  mutate(samps = ifelse(total_samples == sim.samples.all[1], 1,
                        ifelse(total_samples == sim.samples.all[2], 2,
                               ifelse(total_samples == sim.samples.all[3], 3, 4)))) %>% 
  distinct(purpose.lab, purp, total_samples, iteration, samps)

#Print the number of instances that failed to converge
cat(paste0("Of the ", nrow(results.all), " parameter estimates from these simulations, ", nrow(no.convergence), " instances failed to converge at Rhat > 1.01"))

#Remove instances that failed to converge
results.all <- results.all %>% dplyr::filter(Rhat < 1.01)

#Any other metrics to show here?
```

```{r Calcualte HPDI intervals, echo=FALSE}
HPD.1.summary.tidy = HPD.2.summary.tidy = HPD.3.summary.tidy = HPD.4.summary.tidy <- NULL

#Read in previously saved file
HPD.1.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation1, "_", purpose1, ".csv"))

HPD.1.summary.tidy <- HPD.1.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "samples.lab",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
    ) %>% 
  mutate(model_type = model.type1,
         purpose.lab = purpose1.lab) %>% 
  mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>% 
  inner_join(mean_cv, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------------------Purpose 2 --------------------------------#    
#Read in previously saved file
HPD.2.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation2, "_", purpose2, ".csv"))

HPD.2.summary.tidy <- HPD.2.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "samples.lab",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>% 
  mutate(model_type = model.type2,
         purpose.lab = purpose2.lab) %>% 
    mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>% 
  inner_join(mean_cv, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------------------Purpose 3 --------------------------------#    
#Read in previously saved file
HPD.3.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation3, "_", purpose3, ".csv"))

HPD.3.summary.tidy <- HPD.3.summary_all %>%
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "samples.lab",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>%
  mutate(model_type = model.type3,
         purpose.lab = purpose3.lab) %>%
 mutate_if(is.character, str_replace_all, pattern = "_", replacement = " ") %>%
  inner_join(mean_cv, by = c("parameter", "purpose.lab", "samples.lab"))

#---------------Create dataframes to plot by sample size--------#
#Set eveyrthing to Null so the below scripts will run
HPD.samples1.1.4viz = HPD.samples2.1.4viz = HPD.samples3.1.4viz = HPD.samples4.1.4viz = HPD.samples1.2.4viz = HPD.samples2.2.4viz = HPD.samples3.2.4viz = HPD.samples4.2.4viz = HPD.samples1.3.4viz = HPD.samples2.3.4viz = HPD.samples3.3.4viz = HPD.samples4.3.4viz = HPD.samples1.4.4viz = HPD.samples2.4.4viz = HPD.samples3.4.4viz = HPD.samples4.4.4viz <- NULL


HPD.samples1.1.4viz <- HPD.1.summary.tidy %>% dplyr::filter(samples.lab == samples1.lab)
HPD.samples2.1.4viz <- HPD.1.summary.tidy %>% dplyr::filter(samples.lab == samples2.lab)
HPD.samples3.1.4viz <- HPD.1.summary.tidy %>% dplyr::filter(samples.lab == samples3.lab)
HPD.samples4.1.4viz <- HPD.1.summary.tidy %>% dplyr::filter(samples.lab == samples4.lab)

HPD.samples1.2.4viz <- HPD.2.summary.tidy %>% dplyr::filter(samples.lab == samples1.lab)
HPD.samples2.2.4viz <- HPD.2.summary.tidy %>% dplyr::filter(samples.lab == samples2.lab)
HPD.samples3.2.4viz <- HPD.2.summary.tidy %>% dplyr::filter(samples.lab == samples3.lab)
HPD.samples4.2.4viz <- HPD.2.summary.tidy %>% dplyr::filter(samples.lab == samples4.lab)

HPD.samples1.3.4viz <- HPD.3.summary.tidy %>% dplyr::filter(samples.lab == samples1.lab)
HPD.samples2.3.4viz <- HPD.3.summary.tidy %>% dplyr::filter(samples.lab == samples2.lab)
HPD.samples3.3.4viz <- HPD.3.summary.tidy %>% dplyr::filter(samples.lab == samples3.lab)
HPD.samples4.3.4viz <- HPD.3.summary.tidy %>% dplyr::filter(samples.lab == samples4.lab)

#Combine above dataframes, and re-order purpose as factors
all.samples1.4viz <- HPD.samples1.1.4viz %>% bind_rows(HPD.samples1.2.4viz, HPD.samples1.3.4viz, HPD.samples1.4.4viz) 
all.samples1.4viz$purpose.lab <- factor(all.samples1.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

all.samples2.4viz <- HPD.samples2.1.4viz %>% bind_rows(HPD.samples2.2.4viz, HPD.samples2.3.4viz, HPD.samples2.4.4viz) 
all.samples2.4viz$purpose.lab <- factor(all.samples2.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

all.samples3.4viz <- HPD.samples3.1.4viz %>% bind_rows(HPD.samples3.2.4viz, HPD.samples3.3.4viz, HPD.samples3.4.4viz) 
all.samples3.4viz$purpose.lab <- factor(all.samples3.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

all.samples4.4viz <- HPD.samples4.1.4viz %>% bind_rows(HPD.samples4.2.4viz, HPD.samples4.3.4viz, HPD.samples4.4.4viz)
all.samples4.4viz$purpose.lab <- factor(all.samples4.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

#For when we need everything together
all.4viz <- HPD.1.summary.tidy %>% bind_rows(HPD.2.summary.tidy, HPD.3.summary.tidy, HPD.4.summary.tidy)
all.4viz$purpose.lab <- factor(all.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))
```

```{r HPDI-and-Density-Plots, echo=FALSE}
p.Nfb <- all.4viz %>% dplyr::filter(parameter == "Nfb", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
   ggplot(aes(x = interval.scale)) +
   geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
   geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
   geom_line(aes(y = interval.scale), size = 1.5) + 
   ggtitle("A) Nf") + 
   labs(x = "HPDI",
        y = "Percent in HPDI") +
   theme_bw() + 
   theme(legend.title = element_blank()) + 
   scale_colour_brewer(palette = "Set1") +
   facet_wrap(~samples.lab) + 
  guides(color = guide_legend(nrow = 2))


p.Nm <- all.4viz %>% dplyr::filter(parameter == "Nm", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("C) Nm") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(~samples.lab)


p.surv <- all.4viz %>% dplyr::filter(parameter == "surv") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("A) Survival") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(~samples.lab) +
  guides(color = guide_legend(nrow = 2))

#May want to add this: purpose.lab != purpose3.lab to the first line to filter out PO from lambda
p.lam <- all.4viz %>% dplyr::filter(parameter == "lam") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("Lambda") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(~samples.lab)

p.psi <- all.4viz %>% dplyr::filter(parameter == "psi") %>% 
    ggplot(aes(x = interval.scale)) +
    geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
    geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
    geom_line(aes(y = interval.scale), size = 1.5) + 
    ggtitle("A) Percent biennial breeders (psi)") + 
    labs(x = "HPDI",
         y = "Percent in HPDI") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_colour_brewer(palette = "Set1") +
    facet_wrap(~samples.lab)

#-------------------Density plots-------------------------#
#Density plots
p2.Nfb <- results.all %>% dplyr::filter(parameter == "Nfb", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("B) Nf") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-100, 100) + 
    facet_wrap(~samples.lab)

p2.Nm <- results.all %>% dplyr::filter(parameter == "Nm", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("D) Nm - total") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Set1") +
  xlim(-100, 100) + 
  facet_wrap(~samples.lab)

p2.surv <- results.all %>% dplyr::filter(parameter == "surv") %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("B) Survival") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Set1") +
  xlim(-25, 25) + 
  facet_wrap(~samples.lab)


p2.psi <- results.all %>% dplyr::filter(parameter == "psi") %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("B) Percent biennial breeders (psi)") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-50, 50) + 
    facet_wrap(~samples.lab)


p2.lam <- results.all %>% dplyr::filter(parameter == "lam") %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("Lambda") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-10, 10) + 
    facet_wrap(~samples.lab)


```

## Background info
One hundred different populations were simulated where 95% of females in the population bred biennially, and 5% bred annually. Each population was sampled at four different sampling intensities corresponding to 0.5, 1, 1.5, and 2 percent of the juvenile population each year over four consecutive years. Samples were either targeted to the young-of-year (YOY) portion of the population only, or included juveniles of all age classes. Lambda was given a normal prior with a mean of 1. The sd was derived by running 100 iterations of a Leslie matrix where values for fecundity and survival were drawn from a multivariate normal distribution assuming a 10% CV on both parameters and potential correlations of -0.5, -0.25 and 0.

**Sampling scheme:** Red reflects a sampling scheme that targeted YOY only; blue reflects a sampling scheme where the entire juvenile population (ages 0-11) were available for sampling each year; green reflects the same sampling scheme as blue, but when more than 150 HSPs were detected, I downsampled to ~150 HSPs.


## Figure 1: Model performance estimating abundance based on sampling scheme and priors.
**Prior information:** Abundance was given a diffuse hierarchical Normal prior for both males and females, with the mean and SD coming from a uniform distribution bounded from 0-10000.
**Main takeaways:** This figure shows results for the lowest and highest sample schemes employed only (i.e. 0.5% and 2% of the juvenile population). For females, when all age classes are sampled, the HPDI is slightly less likely to capture the truth, suggesting that the model may converge on inaccurate values in some instances. The density plots show a tendency towards an upward bias when 0.5% of the population is sampled for both sampling schemes; when 2 percent of the population is sampled, targeted sampling of YOY produces estimates that are unbiased on average while sampling of all age classes gives a slightly negative bias; however, this issue is rectified by downsampling, suggesting that the bias may arise from oversampling and potentially violating independence among comparisons.

For males, the HPDI captures the truth at the expected rate under all scenarios and sampling schemes, while the medians are (mostly) unbiased.

```{r print-N-plots, echo=FALSE, out.width = "120%", fig.height = 12}
#Male and female HPDI and relative bias for low and high sample sizes
ggarrange(p.Nfb, p2.Nfb, p.Nm, p2.Nm, common.legend = TRUE, nrow = 4, ncol = 1, legend = "bottom")
```

## Figure 2: Model performance estimating survival based on sampling scheme and priors.
**Prior information:** The prior on survival was a truncated normal distribution with an upper bound at 1. The mean was equal to the value given to the simulation, and the sd was derived from the CV given to the Leslie matrix.
**Main takeaways:** The updated model does well estimating survival, with the HPDI capturing the truth at the expected rate, while the medians of the posteriors are generally unbiased. This may arise as a consequence of the updated equation, or because the parameter is given a more informed prior than in the past (because it is now consistent with input to the Leslie matrix).

```{r print-surv-plots, echo=FALSE, out.width = "120%", fig.height = 12}
#Survival HPDI and relative bias for all four sample sizes
ggarrange(p.surv, p2.surv, common.legend = TRUE, nrow = 2, legend = "bottom")
```

## Figure 3: Model performance estimating percent biennial breeders (psi) based on sampling scheme
**Prior information:** Psi was given a diffuse prior (beta (1,1)).
**Main takeaways:** The updated model still struggles to estimate the percent of biennial breeders, as the HPDI does not capture the truth as often as expected. Still, the relative bias of the medians is very close to 0, with a slight tendency towards negative bias that grows as a greater proportion of the population is sampled.  

I need to look more closely into these results and into how the true vlaue of psi is calculated.
```{r print-psi-plots, echo=FALSE, out.width = "120%", fig.height = 12}
#Survival HPDI and relative bias for all four sample sizes
ggarrange(p.psi, p2.psi, common.legend = TRUE, nrow = 2, legend = "bottom")
```

## Figure 4
**A and B:** Number of HSPs detected based on sampling scheme. **A)** For females that breed intermittently, more HSPs are found when sampling across juvenile age classes, likely because there are more cohorts available to yield HSPs. When sampling is limited to YOY over four years of sampling, and females breed every other year, there are only two potential comparisons that would be expected to yield HSPs (cohorts 1 & 3; cohorts 2 & 4). When sampling across age classes **B)** For males that breed annually, there is no difference in the number of HSPs detected based on sampling scheme. Note that for both males and females, the lowest sampling intensity results in fewer than 25 HSPs, which is half the recommended target of 50. This is why results at this sampling intensity are so varied.
**C:** Relative bias of abundance estimate by the percent difference between observed and expected HSPs.
Here, we see that as the observed number of HSPs deviates from expectations, results become more biased, as expected. Interestingly, we see an exponential rise in bias in the positive direction at the lowest sampling intensity, but this trend is not apparent in the negative direction.

```{r Kin pairs, echo=FALSE}
####---------------------Density plots of kin detected----------------------------------------------####

#Distribution of MHSPs
(Nfb_HSPs <- results.all %>% dplyr::filter(parameter == "Nfb") %>% 
  ggplot(aes(x = HSPs_detected, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("A) Maternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    facet_wrap(~samples.lab) + 
  scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250)))
                     

(Nm_HSPs <- results.all %>% dplyr::filter(parameter == "Nm") %>% 
  ggplot(aes(x = HSPs_detected, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("B) Paternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    facet_wrap(~samples.lab) + 
    scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250)))


#-----------------------Examine expected vs observed kin pairs--------------------
#Calculate % difference in expected vs observed kin
results.all2 <- results.all %>% mutate(HS_exp_obs_diff = (Exp_HSPs - HSPs_detected)/Exp_HSPs,
                                      PO_exp_obs_diff = (Exp_POPs - POPs_detected)/Exp_POPs) %>%
  mutate(PO_exp_obs_diff = replace_na(PO_exp_obs_diff, 0)) %>% 
  mutate(all_exp_obs_diff = HS_exp_obs_diff + PO_exp_obs_diff)


#----------------Make scatter plot of expected vs observed 
#Purpose 1
(EO1 <- results.all2 %>% dplyr::filter(parameter == "Nfb" | parameter == "Nm") %>% 
  ggplot(aes(x = HS_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = "C) Expected vs Observed kin HSPs", x = "Percent difference (Exp - Obs)/Exp", y = "Relative bias") + 
  theme(legend.title = element_blank()))

```