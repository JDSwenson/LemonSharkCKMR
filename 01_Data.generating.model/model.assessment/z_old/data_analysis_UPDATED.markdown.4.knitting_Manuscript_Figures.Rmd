---
title: "Results for CKMR manuscript"
output: 
  html_document:
    df_print: tibble
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
#devtools::install_github("pconn/HierarchicalGOF/HierarchicalGOF")
#install.packages("ggmcmc")
```

```{r read-in-files, include=FALSE}
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(coda)
library(runjags)
library(ggmcmc)
library(viridis)

rm(list=ls())
today <- format(Sys.Date(), "%d%b%Y")

#----------------Read in files ------------------------------
#------------- MCMC parameters ----------------#
ni <- 40000 # number of post-burn-in samples per chain
nb <- 50000 # number of burn-in samples
nt <- 20     # thinning rate
nc <- 2      # number of chains
MCMC.settings <- paste0("thin", nt, "_draw", ni, "_burn", nb)

#Initialize values
purpose1.lab = purpose2.lab = purpose3.lab = purpose4.lab <- NULL

#------------- Simulation parameters and labels  ----------------#
date.of.simulation1 <- "16May2022"
purpose1 <- "psi1_0.05non.conform_target.YOY_no.downsample"
purpose1.lab <- "Target YOY | diffuse priors"
model.type1 <- "HS.only"

date.of.simulation2 <- "16May2022"
purpose2 <- "psi1_0.05non.conform_target.YOY_no.downsample_informative.priors"
purpose2.lab <- "Target YOY | informed priors"
model.type2 <- "HS.only"

date.of.simulation3 <- "16May2022"
purpose3 <- "psi1_0.05non.conform_all.ages.sampled_no.downsample"
purpose3.lab <- "All ages sampled | diffuse priors"
model.type3 <- "HS.only"

date.of.simulation4 <- "16May2022"
purpose4 <- "psi1_0.05non.conform_all.ages.sampled_no.downsample_informative.priors"
purpose4.lab <- "All ages sampled | informed priors"
model.type4 <- "HS.only"

seeds <- "Seeds2022.04.15"
sim.samples.1 <- "0.5prop.sampled" #Label on file output
samples1.lab <- "0.5 percent sampled" #Label for dataframe and figures
sim.samples.2 <- "1prop.sampled" #Label on file output
samples2.lab <- "1 percent sampled" #Label for dataframe and figures
sim.samples.3 <- "1.5prop.sampled"  #Label on file output
samples3.lab <- "1.5 percent sampled" #Label for dataframe and figures
sim.samples.4 <- "2prop.sampled" #Label on file output
samples4.lab <- "2 percent sampled" #Label for dataframe and figures
sim.samples.all <- c(0.5, 1, 1.5, 2) #This is the number of samples when sampling specific proportions of the juvenile population for the HS only model. Current as of 05/03/2022

sim.samples.labs.all <- c(samples1.lab, samples2.lab, samples3.lab, samples4.lab)

MCMC_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.output/"
results_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.results/"
results_plots_location <- "G://My Drive/Personal_Drive/R/CKMR/Objective.1_model.construction/Model.results/figures/"
results_prefix <- "CKMR_results"
MCMC_prefix <- "CKMR_modelout"
parents_prefix <- "parents_breakdown/CKMR_parents.breakdown"
sample.prefix <- "sample_info/CKMR_sample.info"
survival.prefix <- "survival/CKMR_survival"
pop.size.prefix <- "pop_size/CKMR_pop.size"
mom.comps.prefix <- "comparisons/mom.comps"
dad.comps.prefix <- "comparisons/dad.comps"


#Set results to NULL and the script will run regardless of how many actual results are being compared
results.1 = results.2 = results.3 = results.4 <- NULL

results.1 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation1, "_", seeds, "_", purpose1, ".csv")) %>% 
  mutate(model_type = model.type1, 
         purpose.lab = purpose1.lab) %>% 
  mutate(total_samples = total_juvenile_samples + total_adult_samples)

results.2 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation2, "_", seeds, "_", purpose2, ".csv")) %>% 
  mutate(model_type = model.type2,
         purpose.lab = purpose2.lab) %>% 
    mutate(total_samples = total_juvenile_samples + total_adult_samples)


results.3 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation3, "_", seeds, "_", purpose3, ".csv")) %>% 
  mutate(model_type = model.type3,
         purpose.lab = purpose3.lab) %>% 
      mutate(total_samples = total_juvenile_samples + total_adult_samples)

results.4 <- read_csv(paste0(results_location, results_prefix, "_", date.of.simulation4, "_", seeds, "_", purpose4, ".csv")) %>% 
    mutate(model_type = model.type4,
           purpose.lab = purpose4.lab) %>% 
      mutate(total_samples = total_juvenile_samples + total_adult_samples)

#Load MCMC results for one group - 1% sampled group - so I can add cross-correlation plots
s1.2 <- readRDS(paste0(MCMC_location, MCMC_prefix, "_", date.of.simulation1, "_", seeds, "_", sim.samples.2, "_", MCMC.settings, "_", purpose1))
```

```{r Quick-analysis-of-results, echo = FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
####------------------------------- Quick analysis of results -----------------------------------####

results.all <- results.1 %>% 
  bind_rows(results.2, results.3, results.4) %>% 
  #mutate(total_samples = total_juvenile_samples + total_adult_samples) %>% 
  #mutate(relative_bias = round(((Q50 - truth)/truth)*100,1)) %>%
  #mutate(in_interval = ifelse(HPD2.5 < truth & truth < HPD97.5, "Y", "N")) %>% 
  mutate(cv = (sd/mean)*100) %>% 
  mutate(samples.lab = paste0(prop_sampled_juvs, " percent sampled")) %>% 
  separate(purpose.lab, into = c("sampling.scheme", "prior"), sep = " \\| ", remove = FALSE) #Have to use two escape characters to cancel the "or" command from the "|"

results.all$samples.lab <- factor(results.all$samples.lab, levels = c(samples1.lab, samples2.lab, samples3.lab, samples4.lab))

results.all$purpose.lab <- factor(results.all$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

#Specify parameters
#jags_params <- c("Nfa", "Nfb", "Nm", "surv", "lam", "psi", "pb") #if estimating all parameters with the HS|PO model
jags_params <- c("Nfb", "psi", "Nm", "surv", "lam") #If estimating all parameters with the HS only model

#Save instances that failed to converge so they can be removed later from the HPDI dataframes
no.convergence <- results.all %>% dplyr::filter(Rhat > 1.01) %>% 
  mutate(purp = ifelse(purpose.lab == purpose1.lab, 1,
                       ifelse(purpose.lab == purpose2.lab, 2,
                              ifelse(purpose.lab == purpose3.lab, 3, 4)))) %>% 
  mutate(samps = ifelse(total_samples == sim.samples.all[1], 1,
                        ifelse(total_samples == sim.samples.all[2], 2,
                               ifelse(total_samples == sim.samples.all[3], 3, 4)))) %>% 
  distinct(purpose.lab, purp, total_samples, iteration, samps)

#Print the number of instances that failed to converge
cat(paste0("Of the ", nrow(results.all), " parameter estimates from these simulations, ", nrow(no.convergence), " instances failed to converge at Rhat > 1.01"))

#Remove instances that failed to converge
results.all <- results.all %>% dplyr::filter(Rhat < 1.01)

#Any other metrics to show here?
```

```{r Calcualte HPDI intervals, echo=FALSE}
#Read in previously saved file
HPD.1.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation1, "_", purpose1, ".csv"))

HPD.1.summary.tidy <- HPD.1.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "proportion_sampled",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
    ) %>% 
  mutate(model_type = model.type1,
         purpose.lab = purpose1.lab)

#---------------------------Purpose 2 --------------------------------#    
#Read in previously saved file
HPD.2.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation2, "_", purpose2, ".csv"))

HPD.2.summary.tidy <- HPD.2.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "proportion_sampled",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>% 
  mutate(model_type = model.type2,
                  purpose.lab = purpose2.lab)

#---------------------------Purpose 3 --------------------------------#    

#Read in previously saved file
HPD.3.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation3, "_", purpose3, ".csv"))

HPD.3.summary.tidy <- HPD.3.summary_all %>% 
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "proportion_sampled",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>% 
  mutate(model_type = model.type3,
         purpose.lab = purpose3.lab)


#---------------------------Purpose 4 --------------------------------# 
#Read in previously saved file
HPD.4.summary_all <- read_csv(file = paste0(results_location, "HPD.summaries/HPD.summary_", date.of.simulation4, "_", purpose4, ".csv"))

HPD.4.summary.tidy <- HPD.4.summary_all %>%
  pivot_longer(
    cols = starts_with("percent"),
    names_to = "proportion_sampled",
    names_prefix = "percent_in_interval.",
    values_to = "percent_in_interval"
  ) %>%
  mutate(model_type = model.type4,
         purpose.lab = purpose4.lab)

#---------------Create dataframes to plot by sample size--------#
#Set eveyrthing to Null so the below scripts will run
HPD.samples1.1.4viz = HPD.samples2.1.4viz = HPD.samples3.1.4viz = HPD.samples4.1.4viz = HPD.samples1.2.4viz = HPD.samples2.2.4viz = HPD.samples3.2.4viz = HPD.samples4.2.4viz = HPD.samples1.3.4viz = HPD.samples2.3.4viz = HPD.samples3.3.4viz = HPD.samples4.3.4viz = HPD.samples1.4.4viz = HPD.samples2.4.4viz = HPD.samples3.4.4viz = HPD.samples4.4.4viz <- NULL

HPD.samples1.1.4viz <- HPD.1.summary.tidy %>% filter(proportion_sampled == "0.5_percent_sampled")
HPD.samples2.1.4viz <- HPD.1.summary.tidy %>% filter(proportion_sampled == "1_percent_sampled")
HPD.samples3.1.4viz <- HPD.1.summary.tidy %>% filter(proportion_sampled == "1.5_percent_sampled")
HPD.samples4.1.4viz <- HPD.1.summary.tidy %>% filter(proportion_sampled == "2_percent_sampled")

HPD.samples1.2.4viz <- HPD.2.summary.tidy %>% filter(proportion_sampled == "0.5_percent_sampled")
HPD.samples2.2.4viz <- HPD.2.summary.tidy %>% filter(proportion_sampled == "1_percent_sampled")
HPD.samples3.2.4viz <- HPD.2.summary.tidy %>% filter(proportion_sampled == "1.5_percent_sampled")
HPD.samples4.2.4viz <- HPD.2.summary.tidy %>% filter(proportion_sampled == "2_percent_sampled")

HPD.samples1.3.4viz <- HPD.3.summary.tidy %>% filter(proportion_sampled == "0.5_percent_sampled")
HPD.samples2.3.4viz <- HPD.3.summary.tidy %>% filter(proportion_sampled == "1_percent_sampled")
HPD.samples3.3.4viz <- HPD.3.summary.tidy %>% filter(proportion_sampled == "1.5_percent_sampled")
HPD.samples4.3.4viz <- HPD.3.summary.tidy %>% filter(proportion_sampled == "2_percent_sampled")

HPD.samples1.4.4viz <- HPD.4.summary.tidy %>% filter(proportion_sampled == "0.5_percent_sampled")
HPD.samples2.4.4viz <- HPD.4.summary.tidy %>% filter(proportion_sampled == "1_percent_sampled")
HPD.samples3.4.4viz <- HPD.4.summary.tidy %>% filter(proportion_sampled == "1.5_percent_sampled")
HPD.samples4.4.4viz <- HPD.4.summary.tidy %>% filter(proportion_sampled == "2_percent_sampled")


#Combine above dataframes, and re-order purpose as factors
all.samples1.4viz <- HPD.samples1.1.4viz %>% bind_rows(HPD.samples1.2.4viz, HPD.samples1.3.4viz, HPD.samples1.4.4viz) 
all.samples1.4viz$purpose.lab <- factor(all.samples1.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

all.samples2.4viz <- HPD.samples2.1.4viz %>% bind_rows(HPD.samples2.2.4viz, HPD.samples2.3.4viz, HPD.samples2.4.4viz) 
all.samples2.4viz$purpose.lab <- factor(all.samples2.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

all.samples3.4viz <- HPD.samples3.1.4viz %>% bind_rows(HPD.samples3.2.4viz, HPD.samples3.3.4viz, HPD.samples3.4.4viz) 
all.samples3.4viz$purpose.lab <- factor(all.samples3.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

all.samples4.4viz <- HPD.samples4.1.4viz %>% bind_rows(HPD.samples4.2.4viz, HPD.samples4.3.4viz, HPD.samples4.4.4viz)
all.samples4.4viz$purpose.lab <- factor(all.samples4.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))

#For when we need everything together
all.4viz <- HPD.1.summary.tidy %>% bind_rows(HPD.2.summary.tidy, HPD.3.summary.tidy, HPD.4.summary.tidy) %>% 
  separate(purpose.lab, into = c("sampling.scheme", "prior"), sep = " \\| ", remove = FALSE)

all.4viz$purpose.lab <- factor(all.4viz$purpose.lab, levels = c(purpose1.lab, purpose2.lab, purpose3.lab, purpose4.lab))
```

```{r HPDI-and-Density-Plots, echo=FALSE}
p.Nfb <- all.4viz %>% dplyr::filter(parameter == "Nfb", proportion_sampled == "0.5_percent_sampled" | proportion_sampled == "2_percent_sampled") %>% 
   ggplot(aes(x = interval.scale)) +
   geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
   geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
   geom_line(aes(y = interval.scale), size = 1.5) + 
   ggtitle("A) Nf - breeders") + 
   labs(x = "HPDI",
        y = "Percent in HPDI") +
   theme_bw() + 
   theme(legend.title = element_blank()) + 
   scale_colour_brewer(palette = "Set1") +
   facet_wrap(~proportion_sampled) + 
  guides(color = guide_legend(nrow = 2))


p.Nm <- all.4viz %>% dplyr::filter(parameter == "Nm", proportion_sampled == "0.5_percent_sampled" | proportion_sampled == "2_percent_sampled") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("C) Nm - total") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(~proportion_sampled)


p.surv <- all.4viz %>% dplyr::filter(parameter == "surv", proportion_sampled == "0.5_percent_sampled" | proportion_sampled == "2_percent_sampled") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("A) Survival") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(~proportion_sampled) +
  guides(color = guide_legend(nrow = 2))

#May want to add this: purpose.lab != purpose3.lab to the first line to filter out PO from lambda
p.lam <- all.4viz %>% dplyr::filter(parameter == "lam") %>% 
  ggplot(aes(x = interval.scale)) +
  geom_point(aes(y = percent_in_interval, color = purpose.lab, fill = purpose.lab, shape = purpose.lab), size = 2.5, alpha = .7) + 
  geom_smooth(aes(y = percent_in_interval, color = purpose.lab, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
  geom_line(aes(y = interval.scale), size = 1.5) + 
  ggtitle("Lambda") + 
  labs(x = "HPDI",
       y = "Percent in HPDI") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(~proportion_sampled)

p.psi <- all.4viz %>% dplyr::filter(parameter == "psi", proportion_sampled == "0.5_percent_sampled" | proportion_sampled == "2_percent_sampled") %>% 
    ggplot(aes(x = interval.scale)) +
    geom_point(aes(y = percent_in_interval, color = sampling.scheme, fill = sampling.scheme, shape = sampling.scheme), size = 2.5, alpha = .7) + 
    geom_smooth(aes(y = percent_in_interval, color = sampling.scheme, linetype = ), se = FALSE, size = 1.5, show.legend = FALSE) + 
    geom_line(aes(y = interval.scale), size = 1.5) + 
    ggtitle("C) Percent biennial breeders (psi)") + 
    labs(x = "HPDI",
         y = "Percent in HPDI") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_colour_brewer(palette = "Set1") +
    facet_wrap(~proportion_sampled)

#-------------------Density plots-------------------------#
#Density plots
p2.Nfb <- results.all %>% dplyr::filter(parameter == "Nfb", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("B) Nf - breeders") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-100, 100) + 
    facet_wrap(~samples.lab)

p2.Nm <- results.all %>% dplyr::filter(parameter == "Nm", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("D) Nm - total") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Set1") +
  xlim(-100, 100) + 
  facet_wrap(~samples.lab)

p2.surv <- results.all %>% dplyr::filter(parameter == "surv", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
  ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
  geom_density(alpha = 0.6) + 
  ggtitle("B) Survival") + 
  labs(x = "Relative bias of posterior median") +
  geom_vline(xintercept=c(0), linetype="dotted") +
  theme_bw() + 
  theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Set1") +
  xlim(-25, 25) + 
  facet_wrap(~samples.lab)


p2.psi <- results.all %>% dplyr::filter(parameter == "psi", samples.lab == samples1.lab | samples.lab == samples4.lab) %>% 
    ggplot(aes(x = relative_bias, color = sampling.scheme, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("D) Percent biennial breeders (psi)") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-25, 25) + 
    facet_wrap(~samples.lab)




p2.lam <- results.all %>% dplyr::filter(parameter == "lam") %>% 
    ggplot(aes(x = relative_bias, color = purpose.lab, fill = purpose.lab)) +
    geom_density(alpha = 0.6) + 
    ggtitle("Lambda") + 
    labs(x = "Relative bias of posterior median") +
    geom_vline(xintercept=c(0), linetype="dotted") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    xlim(-10, 10) + 
    facet_wrap(~samples.lab)


```

***Note to self: Only show results from diffuse priors and down-sampling for now.


## Results
### Objective 1:  Model construction and sampling requirements\
*Effect of sample size on abundance estimates*
We used individual-based simulation to assess model performance under two different sampling schemes of a small population (~10,000 individuals total) of lemon sharks. At low sample sizes, the highest posterior density interval (HPDI) captured the true abundance regardless of sampling scheme (Fig 1A, Fig 1B), while the relative bias of the posterior median exhibited a slight positive bias (Fig 1C, Fig 1D). At higher sample sizes, disparities between sampling scheme are more apparent. While targeted sampling of YOY gives a better measure of the uncertainty surrounding the truth relative to sampling across all juvenile age classes, the same scenario results in a slightly elevated posterior median, suggesting that results are best interpreted as the range of values captured within the HPDI, while less weight should be given to point estimates.



With survival, we found a distinct difference in model performance depending on the sampling scheme employed (Fig 2). Scenarios where survival was given a tight prior (blue and purple) performed well with regards to a posterior estimate of survival, as expected. However, without any prior information for survival, estimates were more likely to be captured by the HPDI and also give rise to an unbiased median when all age classes were sampled (green) relative to when sampling was targeted to young-of-year (red). Combined, these results suggest that in the absence of prior information regarding survival rate and breeding schedule, there may be a trade-off between sampling schemes whereby sampling more age classes may give better estimates of survival rates, at the potential cost of missing the true abundance in the HPDI. Alternatively, when sampling is focused on young-of-year, there are fewer years available for the model to estimate survival rate, which may result in wider HPDIs that better capture the true value of abundance.

## Figure 1: Model performance estimating abundance based on sampling scheme and priors

**Sampling scheme:** <span style="color:red">**Red**</span> and <span style="color:blue">**blue**</span> reflect sampling schemes that target YOY only; <span style="color:green">**green**</span> and <span style="color:#800080">**purple**</span> reflect sampling schemes where the entire juvenile population (ages 0-11) were available for sampling.\
**Prior information:** <span style="color:red">**Red**</span> and <span style="color:green">**green**</span> results come from a model that assumed no prior information for psi or survival; <span style="color:blue">**blue**</span> and <span style="color:#800080">**purple**</span> results come from a model that assumed psi was known without error and gave a tight prior to survival.\
**Main takeaways:** With diffuse priors on psi and survival, there is a difference in the potential for the HPDI to capture the truth, with <span style="color:red">**targeted sampling**</span> performing better than <span style="color:green">**sampling across age classes**</span>. Regardless of sampling scheme, when using a diffuse prior on survival and psi, the posterior modes for abundance estimates have a tendency to get pulled upward, similar to survival (Fig 2), though this effect is slightly reduced when all age classes are sampled relative to targeted sampling of YOY.\



```{r print-N-plots, echo=FALSE, out.width = "120%", fig.height = 12}
#Male and female HPDI and relative bias for low and high sample sizes
ggarrange(p.Nfb, p2.Nfb, p.Nm, p2.Nm, common.legend = TRUE, nrow = 4, ncol = 1, legend = "bottom")
```

## Figure 2: Model performance estimating survival based on sampling scheme and priors
**Sampling scheme:** <span style="color:red">**Red**</span> and <span style="color:blue">**blue**</span> reflect sampling schemes that target YOY only; <span style="color:green">**green**</span> and <span style="color:#800080">**purple**</span> reflect sampling schemes where the entire juvenile population (ages 0-11) were available for sampling.\
**Prior information:** <span style="color:red">**Red**</span> and <span style="color:green">**green**</span> results come from a model that assumed no prior information for psi or survival (diffuse priors); <span style="color:blue">**blue**</span> and <span style="color:#800080">**purple**</span> results come from a model that assumed psi was known without error and gave a tight prior to survival.\
**Main takeaways**\
**A & B: **When priors are diffuse, survival estimates have a tendency to get pulled upward. This tendency is amplified when sampling is targeted to YOY (red), likely because there are fewer age gaps represented in the data as well as fewer half-siblings available to inform survival estimates. These results suggest that accurate estimates of survival are more likely when there are multiple age classes represented in the data.\
**C & D:**The model still struggles to estimate psi, even though the interpretation of psi is straightforward in this scenario (95% of individuals breed biennially; 5% breed annually). The main tendency seems to be to underestimate psi, though not by a lot. Not quite sure how to rectify this ...

```{r print-surv-plots, echo=FALSE, out.width = "120%", fig.height = 7}
#Survival HPDI and relative bias for all four sample sizes
ggarrange(p.surv, p2.surv, common.legend = TRUE, nrow = 2, legend = "top")
```

```{r print-psi-plots, echo=FALSE, out.width = "120%", fig.height = 7}
ggarrange(p.psi, p2.psi, common.legend = TRUE, nrow = 2, legend = "bottom")
```

## Figure 3: Cross-correlation among parameters
This plot represents one random iteration from the scenario where 1% of the juvenile population was sampled, but we see a similar trend from other sampling schemes and other iterations.\
Here, we see a couple interesting trends:\
1) psi is negatively correlated with female abundance at ~ 0.5,\
2) survival is positively correlated with both male and female abundance at ~0.70 - 0.75, and\
3) male and female abundance are positive correlated at ~ 0.70

```{r, echo = FALSE}
#randomly sample from iterations for cross-correlation plot
it <- sample(c(1:length(s1.2)), size = 1)
crosscorr.plot(s1.2[[it]][, c(1, 2, 4, 5, 6)])
crosscorr(s1.2[[it]][, c(1, 2, 4, 5, 6)])
```

## Figure 4: Number of HSPs detected by sampling scheme and bias
**A and B:** Number of HSPs detected based on sampling scheme. **A)** For females that breed intermittently, more HSPs are found when sampling across juvenile age classes. When sampling is limited to YOY over four years of sampling, and females breed every other year, there are only two potential comparisons that would be expected to yield HSPs (cohorts 1 & 3; cohorts 2 & 4). When sampling across age classes, there are more cohorts available to yield HSPs. **B)** For males that breed annually, there is no difference in the number of HSPs detected based on sampling scheme. Note that for both males and females, the lowest sampling intensity results in fewer than 25 HSPs, which is half the recommended target of 50 for a reasonable CV. This is why results at this sampling intensity are so varied.\
**C and D:** Relative bias of abundance estimate by the percent difference between observed and expected HSPs. Here, we see that as the observed number of HSPs deviates from expectations, results become more biased, as expected. Interestingly, we see an exponential rise in bias in the positive direction at the lowest sampling intensity, but this trend is not apparent in the negative direction. **C)** notice that when priors are diffuse, there remains a slight residual positive bias across sampling intensities when observed and expected HSPs match (i.e. x axis = 0) **D)** That bias remains - primarily for females - when survival and psi are given informed priors.\
**Main takeaways:** These graphs suggest that 1) sampling more age classes results in more half-siblings detected, and 2) there may be an error in my calculations of expected numbers of half-siblings for females (which makes sense because they depend on psi, and I'm not sure I'm incorporating that properly ...)

```{r Kin pairs, echo=FALSE}
####---------------------Density plots of kin detected----------------------------------------------####

#Distribution of MHSPs
(Nfb_HSPs <- results.all %>% dplyr::filter(parameter == "Nfb",
                                           purpose.lab == purpose2.lab | purpose.lab == purpose4.lab) %>% 
  ggplot(aes(x = HSPs_detected, color = sampling.scheme, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("A) Maternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    facet_wrap(~samples.lab) + 
  scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250)))
                     

(Nm_HSPs <- results.all %>% dplyr::filter(parameter == "Nm",
                                          purpose.lab == purpose2.lab | purpose.lab == purpose4.lab) %>% 
  ggplot(aes(x = HSPs_detected, color = sampling.scheme, fill = sampling.scheme)) +
    geom_density(alpha = 0.6) + 
    ggtitle("B) Paternal HSPs detected") + 
    labs(x = "HSPs") +
    theme_bw() + 
    theme(legend.title = element_blank()) + 
    scale_fill_brewer(palette = "Set1") +
    facet_wrap(~samples.lab) + 
    scale_x_continuous(breaks = c(25, 50, 100, 150, 200, 250)))

#-----------------------Examine expected vs observed kin pairs--------------------
#Calculate % difference in expected vs observed kin
results.all2 <- results.all %>% mutate(HS_exp_obs_diff = (Exp_HSPs - HSPs_detected)/Exp_HSPs,
                                      PO_exp_obs_diff = (Exp_POPs - POPs_detected)/Exp_POPs) %>%
  mutate(PO_exp_obs_diff = replace_na(PO_exp_obs_diff, 0)) %>% 
  mutate(all_exp_obs_diff = HS_exp_obs_diff + PO_exp_obs_diff)



#----------------Make scatter plot of expected vs observed 
#Purpose 1
(EO1 <- results.all2 %>% dplyr::filter(parameter == "Nfb" | parameter == "Nm",
                                       purpose.lab == purpose1.lab | purpose.lab == purpose3.lab) %>% 
  ggplot(aes(x = HS_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = "C) Expected vs Observed kin HSPs; diffuse priors", x = "Percent difference (Exp - Obs)/Exp", y = "Relative bias") + 
  theme(legend.title = element_blank()))

(EO2 <- results.all2 %>% dplyr::filter(parameter == "Nfb" | parameter == "Nm",
                                       purpose.lab == purpose2.lab | purpose.lab == purpose4.lab) %>% 
  ggplot(aes(x = HS_exp_obs_diff, y = relative_bias, fill = parameter, color = parameter)) +
  geom_point() +
  facet_wrap(~samples.lab) + 
  labs(title = "D) Expected vs Observed kin HSPs; informed priors", x = "Percent difference (Exp - Obs)/Exp", y = "Relative bias") + 
  theme(legend.title = element_blank()))
```